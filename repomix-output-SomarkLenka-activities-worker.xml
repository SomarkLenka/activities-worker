This file is a merged representation of the entire codebase, combined into a single document by Repomix.
The content has been processed where security check has been disabled.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Security check has been disabled - content may contain sensitive information
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.wrangler/
  state/
    v3/
      kv/
        6c095813078c4fb581dfd74fd2fdeda7/
          blobs/
            05785e69694ca9ba92cdd1885061034e4433a2b34c917b8eb277eea6e4ce2bd60000019999e2cfb7
            3550adb58e730571e891ff74cf6f449ebaef0d42d2bdc461196a48159a7f33c3000001999b07667f
            70587cd1d2097a70ac2b5b79cc3c3b3bdc9eb0a621002aeee3dcd63f28d78310000001999f7bfcb5
            ad5edbf0745cc278d731ff29cbdfab812642395dbb53e74dce85fb7e3608ea89000001999f7c1594
            be671f5331f4f703898fe721a2be0431fd0d6cac440bfd69b1da93d1cc808e68000001999f7c0939
            c9c44fe53eabb19f86d27fe8f59e80b505992bc0dee09a89dbb1cea3dd24b849000001999f7bd6b9
            f640056f214effea46879d2936b0c6f631685a6772376dcd40dd0f9e7c94bd70000001999f7ba2e0
        aec4d5d52a9e41d6925a94a1d1b27207/
          blobs/
            1346392e9b92dd5107e2bea14750e702298563b852ed785677c24fcb01f37e69000001999f06857f
            329879bacf712c3239ddc5dc2550be6c08fd95c16fe5c4803679760b72d4bfed000001999f01ef15
            4e8045731a82ad184b0d672933ed2f64e4712db7fb8b8d43f8ab57d34d2db1a50000019999005b03
            706f98762e07b85f1983c0fe98b1111db74f8260ac88780a47e7351c6b78db27000001999f065cc3
            e59a9017390da40328e1d13e7e6ae920e336de1417b29a0be1534fdf5588a4bc000001999b07ce4e
            f1357a9d2225b2be321aefddff71e5c8c1c29443673e0b7f1790c66f88e7cb37000001999901a97e
        KV_NAMESPACE_ID/
          blobs/
            fb8ae5b6b6d5323c43905cebd62122e1d82defcbf3ea9e442ec6c635a0e651d60000019998870e57
      r2/
        waivers/
          blobs/
            0940ac870b501361644c1b30cbd017b970577fedf9ca2052147c63cf18bcd445000001999918da24
  tmp/
    bundle-l3U5iW/
      middleware-insertion-facade.js
      middleware-loader.entry.ts
    bundle-sW1d5E/
      checked-fetch.js
      middleware-insertion-facade.js
      middleware-loader.entry.ts
    dev-0uWY0W/
      index.js
      index.js.map
    dev-qGIfSE/
      index.js
      index.js.map
docs/
  API.md
migrations/
  0008_add_error_message.sql
  backup.sql
  schema_full.sql
scripts/
  test-batch-pdf.js
src/
  routes/
    admin/
      activities.js
      api-docs.js
      debug.js
      document.js
      download-all.js
      properties.js
      releases.js
      risks.js
      search.js
      verify.js
    download.js
    root.js
    status.js
    submit.js
  services/
    async-processor.js
    mail.js
    pdf.js
    storage.js
    validation.js
  templates/
    admin.html
    archery-pin.html
    archery-pin.txt
    email-verification.html
    email-verification.txt
    email-waiver.html
    email-waiver.txt
    spa.html
    spa.js
    waiver.html
  utils/
    admin.js
    db.js
    nanoid.js
    spa.js
  index.js
.gitignore
package.json
README.md
wrangler.toml
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".wrangler/state/v3/kv/6c095813078c4fb581dfd74fd2fdeda7/blobs/05785e69694ca9ba92cdd1885061034e4433a2b34c917b8eb277eea6e4ce2bd60000019999e2cfb7">
{"id":"cabin-12","name":"Riverside Cabin 12","activities":[{"slug":"archery","label":"Archery"},{"slug":"kayaking","label":"Kayaking"},{"slug":"ziplining","label":"Ziplining"},{"slug":"snorkeling","label":"Snorkeling"},{"slug":"safari-tour","label":"Safari Tour"},{"slug":"boat-tour","label":"Boat Tour"},{"slug":"spelunking","label":"Spelunking"},{"slug":"scuba-diving","label":"Scuba Diving"},{"slug":"paragliding","label":"Paragliding"},{"slug":"bungee-jumping","label":"Bungee Jumping"}]}
</file>

<file path=".wrangler/state/v3/kv/6c095813078c4fb581dfd74fd2fdeda7/blobs/3550adb58e730571e891ff74cf6f449ebaef0d42d2bdc461196a48159a7f33c3000001999b07667f">
{"id":"cabin-12","name":"Riverside Cabin 12","activities":[{"slug":"archery","label":"Archery","risk":"low"},{"slug":"kayaking","label":"Kayaking","risk":"low"},{"slug":"ziplining","label":"Ziplining","risk":"medium"},{"slug":"snorkeling","label":"Snorkeling","risk":"low"},{"slug":"safari-tour","label":"Safari Tour","risk":"low"},{"slug":"boat-tour","label":"Boat Tour","risk":"low"},{"slug":"spelunking","label":"Spelunking","risk":"medium"},{"slug":"scuba-diving","label":"Scuba Diving","risk":"medium"},{"slug":"paragliding","label":"Paragliding","risk":"high"},{"slug":"bungee-jumping","label":"Bungee Jumping","risk":"high"}]}
</file>

<file path=".wrangler/state/v3/kv/6c095813078c4fb581dfd74fd2fdeda7/blobs/70587cd1d2097a70ac2b5b79cc3c3b3bdc9eb0a621002aeee3dcd63f28d78310000001999f7bfcb5">
{"level":"low","title":"Low Risk","description":"Suitable for all ages and fitness levels. Basic safety equipment provided."}
</file>

<file path=".wrangler/state/v3/kv/6c095813078c4fb581dfd74fd2fdeda7/blobs/ad5edbf0745cc278d731ff29cbdfab812642395dbb53e74dce85fb7e3608ea89000001999f7c1594">
{"level":"high","title":"High Risk","description":"Advanced activity. Significant physical demands and safety risks."}
</file>

<file path=".wrangler/state/v3/kv/6c095813078c4fb581dfd74fd2fdeda7/blobs/be671f5331f4f703898fe721a2be0431fd0d6cac440bfd69b1da93d1cc808e68000001999f7c0939">
{"level":"medium","title":"Medium Risk","description":"Moderate physical activity. Some experience recommended."}
</file>

<file path=".wrangler/state/v3/kv/6c095813078c4fb581dfd74fd2fdeda7/blobs/c9c44fe53eabb19f86d27fe8f59e80b505992bc0dee09a89dbb1cea3dd24b849000001999f7bd6b9">
[{"slug":"kayaking","label":"Kayaking","risk":"low"},{"slug":"ziplining","label":"Ziplining","risk":"medium"},{"slug":"archery","label":"Archery","risk":"high"}]
</file>

<file path=".wrangler/state/v3/kv/6c095813078c4fb581dfd74fd2fdeda7/blobs/f640056f214effea46879d2936b0c6f631685a6772376dcd40dd0f9e7c94bd70000001999f7ba2e0">
[{"id":"cabin-13","name":"Cabin 13"}]
</file>

<file path=".wrangler/state/v3/kv/aec4d5d52a9e41d6925a94a1d1b27207/blobs/1346392e9b92dd5107e2bea14750e702298563b852ed785677c24fcb01f37e69000001999f06857f">
[{"slug":"archery","label":"Archery","risk":"low"},{"slug":"ziplining","label":"Ziplining","risk":"medium"},{"slug":"snorkeling","label":"Snorkeling","risk":"low"},{"slug":"safari-tour","label":"Safari Tour","risk":"low"},{"slug":"boat-tour","label":"Boat Tour","risk":"low"},{"slug":"spelunking","label":"Spelunking","risk":"medium"},{"slug":"scuba-diving","label":"Scuba Diving","risk":"medium"},{"slug":"paragliding","label":"Paragliding","risk":"high"},{"slug":"bungee-jumping","label":"Bungee Jumping","risk":"high"}]
</file>

<file path=".wrangler/state/v3/kv/aec4d5d52a9e41d6925a94a1d1b27207/blobs/329879bacf712c3239ddc5dc2550be6c08fd95c16fe5c4803679760b72d4bfed000001999f01ef15">
[{"id":"cabin-12","name":"Cabin 12"}]
</file>

<file path=".wrangler/state/v3/kv/aec4d5d52a9e41d6925a94a1d1b27207/blobs/4e8045731a82ad184b0d672933ed2f64e4712db7fb8b8d43f8ab57d34d2db1a50000019999005b03">
{"id":"cabin-12","name":"Riverside Cabin 12","activities":[{"slug":"archery","label":"Archery"},{"slug":"kayaking","label":"Kayaking"},{"slug":"ziplining","label":"Ziplining"},{"slug":"snorkeling","label":"Snorkeling"},{"slug":"safari-tour","label":"Safari Tour"},{"slug":"boat-tour","label":"Boat Tour"},{"slug":"spelunking","label":"Spelunking"},{"slug":"scuba-diving","label":"Scuba Diving"},{"slug":"paragliding","label":"Paragliding"},{"slug":"bungee-jumping","label":"Bungee Jumping"}]}
</file>

<file path=".wrangler/state/v3/kv/aec4d5d52a9e41d6925a94a1d1b27207/blobs/706f98762e07b85f1983c0fe98b1111db74f8260ac88780a47e7351c6b78db27000001999f065cc3">
[{"slug":"archery","label":"Archery","risk":"low"},{"slug":"kayaking","label":"Kayaking","risk":"low"},{"slug":"ziplining","label":"Ziplining","risk":"medium"},{"slug":"snorkeling","label":"Snorkeling","risk":"low"},{"slug":"safari-tour","label":"Safari Tour","risk":"low"},{"slug":"boat-tour","label":"Boat Tour","risk":"low"},{"slug":"spelunking","label":"Spelunking","risk":"medium"},{"slug":"scuba-diving","label":"Scuba Diving","risk":"medium"},{"slug":"paragliding","label":"Paragliding","risk":"high"},{"slug":"bungee-jumping","label":"Bungee Jumping","risk":"high"}]
</file>

<file path=".wrangler/state/v3/kv/aec4d5d52a9e41d6925a94a1d1b27207/blobs/e59a9017390da40328e1d13e7e6ae920e336de1417b29a0be1534fdf5588a4bc000001999b07ce4e">
{"id":"cabin-12","name":"Riverside Cabin 12","activities":[{"slug":"archery","label":"Archery","risk":"low"},{"slug":"kayaking","label":"Kayaking","risk":"low"},{"slug":"ziplining","label":"Ziplining","risk":"medium"},{"slug":"snorkeling","label":"Snorkeling","risk":"low"},{"slug":"safari-tour","label":"Safari Tour","risk":"low"},{"slug":"boat-tour","label":"Boat Tour","risk":"low"},{"slug":"spelunking","label":"Spelunking","risk":"medium"},{"slug":"scuba-diving","label":"Scuba Diving","risk":"medium"},{"slug":"paragliding","label":"Paragliding","risk":"high"},{"slug":"bungee-jumping","label":"Bungee Jumping","risk":"high"}]}
</file>

<file path=".wrangler/state/v3/kv/aec4d5d52a9e41d6925a94a1d1b27207/blobs/f1357a9d2225b2be321aefddff71e5c8c1c29443673e0b7f1790c66f88e7cb37000001999901a97e">
{"id":"cabin-12","name":"Riverside Cabin 12","activities":[{"slug":"archery","label":"Archery"},{"slug":"kayaking","label":"Kayaking"},{"slug":"ziplining","label":"Ziplining"},{"slug":"snorkeling","label":"Snorkeling"},{"slug":"safari-tour","label":"Safari Tour"},{"slug":"boat-tour","label":"Boat Tour"},{"slug":"spelunking","label":"Spelunking"},{"slug":"scuba-diving","label":"Scuba Diving"},{"slug":"paragliding","label":"Paragliding"},{"slug":"bungee-jumping","label":"Bungee Jumping"}]}
</file>

<file path=".wrangler/state/v3/kv/KV_NAMESPACE_ID/blobs/fb8ae5b6b6d5323c43905cebd62122e1d82defcbf3ea9e442ec6c635a0e651d60000019998870e57">
[{"id": "cabin-12", "name": "Riverside Cabin 12", "activities": [{ "slug": "kayak", "label": "Kayak" }, { "slug": "pool", "label": "Pool" }, { "slug": "archery", "label": "Archery" }, { "slug": "sauna", "label": "Sauna" }]}]
</file>

<file path=".wrangler/state/v3/r2/waivers/blobs/0940ac870b501361644c1b30cbd017b970577fedf9ca2052147c63cf18bcd445000001999918da24">
Mock PDF for archery

    <!doctype html><meta charset="utf-8">
    <style>body{font-family:Arial;font-size:11pt;margin:2cm}</style>
    <h1>ARCHERY — Release of Liability</h1>
    <p>Property  : cabin-12</p>
    <p>Check-in  : 2025-09-09</p>
    <p>Guest     : somark</p>
    <p>Initials  : aa</p>
    <img src="data:image/png;base64,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" width="300">
    <footer style="position:fixed;bottom:1cm;font-size:8pt;width:100%;text-align:center">
      Version 2024-06 • hash RCeYhr4xcx
    </footer>
</file>

<file path=".wrangler/tmp/bundle-l3U5iW/middleware-insertion-facade.js">
import worker, * as OTHER_EXPORTS from "C:\\Users\\scrap\\dev\\vitaliyah\\cf\\src\\index.js";
				import * as __MIDDLEWARE_0__ from "C:\\Users\\scrap\\AppData\\Roaming\\npm\\node_modules\\wrangler\\templates\\middleware\\middleware-ensure-req-body-drained.ts";
import * as __MIDDLEWARE_1__ from "C:\\Users\\scrap\\AppData\\Roaming\\npm\\node_modules\\wrangler\\templates\\middleware\\middleware-miniflare3-json-error.ts";

				export * from "C:\\Users\\scrap\\dev\\vitaliyah\\cf\\src\\index.js";
				const MIDDLEWARE_TEST_INJECT = "__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__";
				export const __INTERNAL_WRANGLER_MIDDLEWARE__ = [
					
					__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default
				]
				export default worker;
</file>

<file path=".wrangler/tmp/bundle-l3U5iW/middleware-loader.entry.ts">
// This loads all middlewares exposed on the middleware object and then starts
// the invocation chain. The big idea is that we can add these to the middleware
// export dynamically through wrangler, or we can potentially let users directly
// add them as a sort of "plugin" system.

import ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from "C:\\Users\\scrap\\dev\\vitaliyah\\cf\\.wrangler\\tmp\\bundle-l3U5iW\\middleware-insertion-facade.js";
import { __facade_invoke__, __facade_register__, Dispatcher } from "C:\\Users\\scrap\\AppData\\Roaming\\npm\\node_modules\\wrangler\\templates\\middleware\\common.ts";
import type { WorkerEntrypointConstructor } from "C:\\Users\\scrap\\dev\\vitaliyah\\cf\\.wrangler\\tmp\\bundle-l3U5iW\\middleware-insertion-facade.js";

// Preserve all the exports from the worker
export * from "C:\\Users\\scrap\\dev\\vitaliyah\\cf\\.wrangler\\tmp\\bundle-l3U5iW\\middleware-insertion-facade.js";

class __Facade_ScheduledController__ implements ScheduledController {
	readonly #noRetry: ScheduledController["noRetry"];

	constructor(
		readonly scheduledTime: number,
		readonly cron: string,
		noRetry: ScheduledController["noRetry"]
	) {
		this.#noRetry = noRetry;
	}

	noRetry() {
		if (!(this instanceof __Facade_ScheduledController__)) {
			throw new TypeError("Illegal invocation");
		}
		// Need to call native method immediately in case uncaught error thrown
		this.#noRetry();
	}
}

function wrapExportedHandler(worker: ExportedHandler): ExportedHandler {
	// If we don't have any middleware defined, just return the handler as is
	if (
		__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||
		__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0
	) {
		return worker;
	}
	// Otherwise, register all middleware once
	for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
		__facade_register__(middleware);
	}

	const fetchDispatcher: ExportedHandlerFetchHandler = function (
		request,
		env,
		ctx
	) {
		if (worker.fetch === undefined) {
			throw new Error("Handler does not export a fetch() function.");
		}
		return worker.fetch(request, env, ctx);
	};

	return {
		...worker,
		fetch(request, env, ctx) {
			const dispatcher: Dispatcher = function (type, init) {
				if (type === "scheduled" && worker.scheduled !== undefined) {
					const controller = new __Facade_ScheduledController__(
						Date.now(),
						init.cron ?? "",
						() => {}
					);
					return worker.scheduled(controller, env, ctx);
				}
			};
			return __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);
		},
	};
}

function wrapWorkerEntrypoint(
	klass: WorkerEntrypointConstructor
): WorkerEntrypointConstructor {
	// If we don't have any middleware defined, just return the handler as is
	if (
		__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||
		__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0
	) {
		return klass;
	}
	// Otherwise, register all middleware once
	for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
		__facade_register__(middleware);
	}

	// `extend`ing `klass` here so other RPC methods remain callable
	return class extends klass {
		#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (
			request,
			env,
			ctx
		) => {
			this.env = env;
			this.ctx = ctx;
			if (super.fetch === undefined) {
				throw new Error("Entrypoint class does not define a fetch() function.");
			}
			return super.fetch(request);
		};

		#dispatcher: Dispatcher = (type, init) => {
			if (type === "scheduled" && super.scheduled !== undefined) {
				const controller = new __Facade_ScheduledController__(
					Date.now(),
					init.cron ?? "",
					() => {}
				);
				return super.scheduled(controller);
			}
		};

		fetch(request: Request<unknown, IncomingRequestCfProperties>) {
			return __facade_invoke__(
				request,
				this.env,
				this.ctx,
				this.#dispatcher,
				this.#fetchDispatcher
			);
		}
	};
}

let WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;
if (typeof ENTRY === "object") {
	WRAPPED_ENTRY = wrapExportedHandler(ENTRY);
} else if (typeof ENTRY === "function") {
	WRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);
}
export default WRAPPED_ENTRY;
</file>

<file path=".wrangler/tmp/bundle-sW1d5E/checked-fetch.js">
const urls = new Set();

function checkURL(request, init) {
	const url =
		request instanceof URL
			? request
			: new URL(
					(typeof request === "string"
						? new Request(request, init)
						: request
					).url
				);
	if (url.port && url.port !== "443" && url.protocol === "https:") {
		if (!urls.has(url.toString())) {
			urls.add(url.toString());
			console.warn(
				`WARNING: known issue with \`fetch()\` requests to custom HTTPS ports in published Workers:\n` +
					` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \`wrangler deploy\` command.\n`
			);
		}
	}
}

globalThis.fetch = new Proxy(globalThis.fetch, {
	apply(target, thisArg, argArray) {
		const [request, init] = argArray;
		checkURL(request, init);
		return Reflect.apply(target, thisArg, argArray);
	},
});
</file>

<file path=".wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js">
import worker, * as OTHER_EXPORTS from "/mnt/c/Users/scrap/dev/cf/src/index.mjs";
				import * as __MIDDLEWARE_0__ from "/home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts";
import * as __MIDDLEWARE_1__ from "/home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts";

				export * from "/mnt/c/Users/scrap/dev/cf/src/index.mjs";
				const MIDDLEWARE_TEST_INJECT = "__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__";
				export const __INTERNAL_WRANGLER_MIDDLEWARE__ = [
					
					__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default
				]
				export default worker;
</file>

<file path=".wrangler/tmp/bundle-sW1d5E/middleware-loader.entry.ts">
// This loads all middlewares exposed on the middleware object and then starts
// the invocation chain. The big idea is that we can add these to the middleware
// export dynamically through wrangler, or we can potentially let users directly
// add them as a sort of "plugin" system.

import ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from "/mnt/c/Users/scrap/dev/cf/.wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js";
import { __facade_invoke__, __facade_register__, Dispatcher } from "/home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/common.ts";
import type { WorkerEntrypointConstructor } from "/mnt/c/Users/scrap/dev/cf/.wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js";

// Preserve all the exports from the worker
export * from "/mnt/c/Users/scrap/dev/cf/.wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js";

class __Facade_ScheduledController__ implements ScheduledController {
	readonly #noRetry: ScheduledController["noRetry"];

	constructor(
		readonly scheduledTime: number,
		readonly cron: string,
		noRetry: ScheduledController["noRetry"]
	) {
		this.#noRetry = noRetry;
	}

	noRetry() {
		if (!(this instanceof __Facade_ScheduledController__)) {
			throw new TypeError("Illegal invocation");
		}
		// Need to call native method immediately in case uncaught error thrown
		this.#noRetry();
	}
}

function wrapExportedHandler(worker: ExportedHandler): ExportedHandler {
	// If we don't have any middleware defined, just return the handler as is
	if (
		__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||
		__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0
	) {
		return worker;
	}
	// Otherwise, register all middleware once
	for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
		__facade_register__(middleware);
	}

	const fetchDispatcher: ExportedHandlerFetchHandler = function (
		request,
		env,
		ctx
	) {
		if (worker.fetch === undefined) {
			throw new Error("Handler does not export a fetch() function.");
		}
		return worker.fetch(request, env, ctx);
	};

	return {
		...worker,
		fetch(request, env, ctx) {
			const dispatcher: Dispatcher = function (type, init) {
				if (type === "scheduled" && worker.scheduled !== undefined) {
					const controller = new __Facade_ScheduledController__(
						Date.now(),
						init.cron ?? "",
						() => {}
					);
					return worker.scheduled(controller, env, ctx);
				}
			};
			return __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);
		},
	};
}

function wrapWorkerEntrypoint(
	klass: WorkerEntrypointConstructor
): WorkerEntrypointConstructor {
	// If we don't have any middleware defined, just return the handler as is
	if (
		__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||
		__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0
	) {
		return klass;
	}
	// Otherwise, register all middleware once
	for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
		__facade_register__(middleware);
	}

	// `extend`ing `klass` here so other RPC methods remain callable
	return class extends klass {
		#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (
			request,
			env,
			ctx
		) => {
			this.env = env;
			this.ctx = ctx;
			if (super.fetch === undefined) {
				throw new Error("Entrypoint class does not define a fetch() function.");
			}
			return super.fetch(request);
		};

		#dispatcher: Dispatcher = (type, init) => {
			if (type === "scheduled" && super.scheduled !== undefined) {
				const controller = new __Facade_ScheduledController__(
					Date.now(),
					init.cron ?? "",
					() => {}
				);
				return super.scheduled(controller);
			}
		};

		fetch(request: Request<unknown, IncomingRequestCfProperties>) {
			return __facade_invoke__(
				request,
				this.env,
				this.ctx,
				this.#dispatcher,
				this.#fetchDispatcher
			);
		}
	};
}

let WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;
if (typeof ENTRY === "object") {
	WRAPPED_ENTRY = wrapExportedHandler(ENTRY);
} else if (typeof ENTRY === "function") {
	WRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);
}
export default WRAPPED_ENTRY;
</file>

<file path=".wrangler/tmp/dev-0uWY0W/index.js">
var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/_internal/utils.mjs
// @__NO_SIDE_EFFECTS__
function createNotImplementedError(name) {
  return new Error(`[unenv] ${name} is not implemented yet!`);
}
__name(createNotImplementedError, "createNotImplementedError");
// @__NO_SIDE_EFFECTS__
function notImplemented(name) {
  const fn = /* @__PURE__ */ __name(() => {
    throw /* @__PURE__ */ createNotImplementedError(name);
  }, "fn");
  return Object.assign(fn, { __unenv__: true });
}
__name(notImplemented, "notImplemented");
// @__NO_SIDE_EFFECTS__
function notImplementedClass(name) {
  return class {
    __unenv__ = true;
    constructor() {
      throw new Error(`[unenv] ${name} is not implemented yet!`);
    }
  };
}
__name(notImplementedClass, "notImplementedClass");

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/perf_hooks/performance.mjs
var _timeOrigin = globalThis.performance?.timeOrigin ?? Date.now();
var _performanceNow = globalThis.performance?.now ? globalThis.performance.now.bind(globalThis.performance) : () => Date.now() - _timeOrigin;
var nodeTiming = {
  name: "node",
  entryType: "node",
  startTime: 0,
  duration: 0,
  nodeStart: 0,
  v8Start: 0,
  bootstrapComplete: 0,
  environment: 0,
  loopStart: 0,
  loopExit: 0,
  idleTime: 0,
  uvMetricsInfo: {
    loopCount: 0,
    events: 0,
    eventsWaiting: 0
  },
  detail: void 0,
  toJSON() {
    return this;
  }
};
var PerformanceEntry = class {
  static {
    __name(this, "PerformanceEntry");
  }
  __unenv__ = true;
  detail;
  entryType = "event";
  name;
  startTime;
  constructor(name, options) {
    this.name = name;
    this.startTime = options?.startTime || _performanceNow();
    this.detail = options?.detail;
  }
  get duration() {
    return _performanceNow() - this.startTime;
  }
  toJSON() {
    return {
      name: this.name,
      entryType: this.entryType,
      startTime: this.startTime,
      duration: this.duration,
      detail: this.detail
    };
  }
};
var PerformanceMark = class PerformanceMark2 extends PerformanceEntry {
  static {
    __name(this, "PerformanceMark");
  }
  entryType = "mark";
  constructor() {
    super(...arguments);
  }
  get duration() {
    return 0;
  }
};
var PerformanceMeasure = class extends PerformanceEntry {
  static {
    __name(this, "PerformanceMeasure");
  }
  entryType = "measure";
};
var PerformanceResourceTiming = class extends PerformanceEntry {
  static {
    __name(this, "PerformanceResourceTiming");
  }
  entryType = "resource";
  serverTiming = [];
  connectEnd = 0;
  connectStart = 0;
  decodedBodySize = 0;
  domainLookupEnd = 0;
  domainLookupStart = 0;
  encodedBodySize = 0;
  fetchStart = 0;
  initiatorType = "";
  name = "";
  nextHopProtocol = "";
  redirectEnd = 0;
  redirectStart = 0;
  requestStart = 0;
  responseEnd = 0;
  responseStart = 0;
  secureConnectionStart = 0;
  startTime = 0;
  transferSize = 0;
  workerStart = 0;
  responseStatus = 0;
};
var PerformanceObserverEntryList = class {
  static {
    __name(this, "PerformanceObserverEntryList");
  }
  __unenv__ = true;
  getEntries() {
    return [];
  }
  getEntriesByName(_name, _type) {
    return [];
  }
  getEntriesByType(type) {
    return [];
  }
};
var Performance = class {
  static {
    __name(this, "Performance");
  }
  __unenv__ = true;
  timeOrigin = _timeOrigin;
  eventCounts = /* @__PURE__ */ new Map();
  _entries = [];
  _resourceTimingBufferSize = 0;
  navigation = void 0;
  timing = void 0;
  timerify(_fn, _options) {
    throw createNotImplementedError("Performance.timerify");
  }
  get nodeTiming() {
    return nodeTiming;
  }
  eventLoopUtilization() {
    return {};
  }
  markResourceTiming() {
    return new PerformanceResourceTiming("");
  }
  onresourcetimingbufferfull = null;
  now() {
    if (this.timeOrigin === _timeOrigin) {
      return _performanceNow();
    }
    return Date.now() - this.timeOrigin;
  }
  clearMarks(markName) {
    this._entries = markName ? this._entries.filter((e) => e.name !== markName) : this._entries.filter((e) => e.entryType !== "mark");
  }
  clearMeasures(measureName) {
    this._entries = measureName ? this._entries.filter((e) => e.name !== measureName) : this._entries.filter((e) => e.entryType !== "measure");
  }
  clearResourceTimings() {
    this._entries = this._entries.filter((e) => e.entryType !== "resource" || e.entryType !== "navigation");
  }
  getEntries() {
    return this._entries;
  }
  getEntriesByName(name, type) {
    return this._entries.filter((e) => e.name === name && (!type || e.entryType === type));
  }
  getEntriesByType(type) {
    return this._entries.filter((e) => e.entryType === type);
  }
  mark(name, options) {
    const entry = new PerformanceMark(name, options);
    this._entries.push(entry);
    return entry;
  }
  measure(measureName, startOrMeasureOptions, endMark) {
    let start;
    let end;
    if (typeof startOrMeasureOptions === "string") {
      start = this.getEntriesByName(startOrMeasureOptions, "mark")[0]?.startTime;
      end = this.getEntriesByName(endMark, "mark")[0]?.startTime;
    } else {
      start = Number.parseFloat(startOrMeasureOptions?.start) || this.now();
      end = Number.parseFloat(startOrMeasureOptions?.end) || this.now();
    }
    const entry = new PerformanceMeasure(measureName, {
      startTime: start,
      detail: {
        start,
        end
      }
    });
    this._entries.push(entry);
    return entry;
  }
  setResourceTimingBufferSize(maxSize) {
    this._resourceTimingBufferSize = maxSize;
  }
  addEventListener(type, listener, options) {
    throw createNotImplementedError("Performance.addEventListener");
  }
  removeEventListener(type, listener, options) {
    throw createNotImplementedError("Performance.removeEventListener");
  }
  dispatchEvent(event) {
    throw createNotImplementedError("Performance.dispatchEvent");
  }
  toJSON() {
    return this;
  }
};
var PerformanceObserver = class {
  static {
    __name(this, "PerformanceObserver");
  }
  __unenv__ = true;
  static supportedEntryTypes = [];
  _callback = null;
  constructor(callback) {
    this._callback = callback;
  }
  takeRecords() {
    return [];
  }
  disconnect() {
    throw createNotImplementedError("PerformanceObserver.disconnect");
  }
  observe(options) {
    throw createNotImplementedError("PerformanceObserver.observe");
  }
  bind(fn) {
    return fn;
  }
  runInAsyncScope(fn, thisArg, ...args) {
    return fn.call(thisArg, ...args);
  }
  asyncId() {
    return 0;
  }
  triggerAsyncId() {
    return 0;
  }
  emitDestroy() {
    return this;
  }
};
var performance = globalThis.performance && "addEventListener" in globalThis.performance ? globalThis.performance : new Performance();

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/@cloudflare/unenv-preset/dist/runtime/polyfill/performance.mjs
globalThis.performance = performance;
globalThis.Performance = Performance;
globalThis.PerformanceEntry = PerformanceEntry;
globalThis.PerformanceMark = PerformanceMark;
globalThis.PerformanceMeasure = PerformanceMeasure;
globalThis.PerformanceObserver = PerformanceObserver;
globalThis.PerformanceObserverEntryList = PerformanceObserverEntryList;
globalThis.PerformanceResourceTiming = PerformanceResourceTiming;

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/console.mjs
import { Writable } from "node:stream";

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/mock/noop.mjs
var noop_default = Object.assign(() => {
}, { __unenv__: true });

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/console.mjs
var _console = globalThis.console;
var _ignoreErrors = true;
var _stderr = new Writable();
var _stdout = new Writable();
var log = _console?.log ?? noop_default;
var info = _console?.info ?? log;
var trace = _console?.trace ?? info;
var debug = _console?.debug ?? log;
var table = _console?.table ?? log;
var error = _console?.error ?? log;
var warn = _console?.warn ?? error;
var createTask = _console?.createTask ?? /* @__PURE__ */ notImplemented("console.createTask");
var clear = _console?.clear ?? noop_default;
var count = _console?.count ?? noop_default;
var countReset = _console?.countReset ?? noop_default;
var dir = _console?.dir ?? noop_default;
var dirxml = _console?.dirxml ?? noop_default;
var group = _console?.group ?? noop_default;
var groupEnd = _console?.groupEnd ?? noop_default;
var groupCollapsed = _console?.groupCollapsed ?? noop_default;
var profile = _console?.profile ?? noop_default;
var profileEnd = _console?.profileEnd ?? noop_default;
var time = _console?.time ?? noop_default;
var timeEnd = _console?.timeEnd ?? noop_default;
var timeLog = _console?.timeLog ?? noop_default;
var timeStamp = _console?.timeStamp ?? noop_default;
var Console = _console?.Console ?? /* @__PURE__ */ notImplementedClass("console.Console");
var _times = /* @__PURE__ */ new Map();
var _stdoutErrorHandler = noop_default;
var _stderrErrorHandler = noop_default;

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/@cloudflare/unenv-preset/dist/runtime/node/console.mjs
var workerdConsole = globalThis["console"];
var {
  assert,
  clear: clear2,
  // @ts-expect-error undocumented public API
  context,
  count: count2,
  countReset: countReset2,
  // @ts-expect-error undocumented public API
  createTask: createTask2,
  debug: debug2,
  dir: dir2,
  dirxml: dirxml2,
  error: error2,
  group: group2,
  groupCollapsed: groupCollapsed2,
  groupEnd: groupEnd2,
  info: info2,
  log: log2,
  profile: profile2,
  profileEnd: profileEnd2,
  table: table2,
  time: time2,
  timeEnd: timeEnd2,
  timeLog: timeLog2,
  timeStamp: timeStamp2,
  trace: trace2,
  warn: warn2
} = workerdConsole;
Object.assign(workerdConsole, {
  Console,
  _ignoreErrors,
  _stderr,
  _stderrErrorHandler,
  _stdout,
  _stdoutErrorHandler,
  _times
});
var console_default = workerdConsole;

// ../../../AppData/Roaming/npm/node_modules/wrangler/_virtual_unenv_global_polyfill-@cloudflare-unenv-preset-node-console
globalThis.console = console_default;

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/process/hrtime.mjs
var hrtime = /* @__PURE__ */ Object.assign(/* @__PURE__ */ __name(function hrtime2(startTime) {
  const now = Date.now();
  const seconds = Math.trunc(now / 1e3);
  const nanos = now % 1e3 * 1e6;
  if (startTime) {
    let diffSeconds = seconds - startTime[0];
    let diffNanos = nanos - startTime[0];
    if (diffNanos < 0) {
      diffSeconds = diffSeconds - 1;
      diffNanos = 1e9 + diffNanos;
    }
    return [diffSeconds, diffNanos];
  }
  return [seconds, nanos];
}, "hrtime"), { bigint: /* @__PURE__ */ __name(function bigint() {
  return BigInt(Date.now() * 1e6);
}, "bigint") });

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/process/process.mjs
import { EventEmitter } from "node:events";

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/tty/read-stream.mjs
var ReadStream = class {
  static {
    __name(this, "ReadStream");
  }
  fd;
  isRaw = false;
  isTTY = false;
  constructor(fd) {
    this.fd = fd;
  }
  setRawMode(mode) {
    this.isRaw = mode;
    return this;
  }
};

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/tty/write-stream.mjs
var WriteStream = class {
  static {
    __name(this, "WriteStream");
  }
  fd;
  columns = 80;
  rows = 24;
  isTTY = false;
  constructor(fd) {
    this.fd = fd;
  }
  clearLine(dir3, callback) {
    callback && callback();
    return false;
  }
  clearScreenDown(callback) {
    callback && callback();
    return false;
  }
  cursorTo(x, y, callback) {
    callback && typeof callback === "function" && callback();
    return false;
  }
  moveCursor(dx, dy, callback) {
    callback && callback();
    return false;
  }
  getColorDepth(env2) {
    return 1;
  }
  hasColors(count3, env2) {
    return false;
  }
  getWindowSize() {
    return [this.columns, this.rows];
  }
  write(str, encoding, cb) {
    if (str instanceof Uint8Array) {
      str = new TextDecoder().decode(str);
    }
    try {
      console.log(str);
    } catch {
    }
    cb && typeof cb === "function" && cb();
    return false;
  }
};

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/process/node-version.mjs
var NODE_VERSION = "22.14.0";

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/process/process.mjs
var Process = class _Process extends EventEmitter {
  static {
    __name(this, "Process");
  }
  env;
  hrtime;
  nextTick;
  constructor(impl) {
    super();
    this.env = impl.env;
    this.hrtime = impl.hrtime;
    this.nextTick = impl.nextTick;
    for (const prop of [...Object.getOwnPropertyNames(_Process.prototype), ...Object.getOwnPropertyNames(EventEmitter.prototype)]) {
      const value = this[prop];
      if (typeof value === "function") {
        this[prop] = value.bind(this);
      }
    }
  }
  // --- event emitter ---
  emitWarning(warning, type, code) {
    console.warn(`${code ? `[${code}] ` : ""}${type ? `${type}: ` : ""}${warning}`);
  }
  emit(...args) {
    return super.emit(...args);
  }
  listeners(eventName) {
    return super.listeners(eventName);
  }
  // --- stdio (lazy initializers) ---
  #stdin;
  #stdout;
  #stderr;
  get stdin() {
    return this.#stdin ??= new ReadStream(0);
  }
  get stdout() {
    return this.#stdout ??= new WriteStream(1);
  }
  get stderr() {
    return this.#stderr ??= new WriteStream(2);
  }
  // --- cwd ---
  #cwd = "/";
  chdir(cwd2) {
    this.#cwd = cwd2;
  }
  cwd() {
    return this.#cwd;
  }
  // --- dummy props and getters ---
  arch = "";
  platform = "";
  argv = [];
  argv0 = "";
  execArgv = [];
  execPath = "";
  title = "";
  pid = 200;
  ppid = 100;
  get version() {
    return `v${NODE_VERSION}`;
  }
  get versions() {
    return { node: NODE_VERSION };
  }
  get allowedNodeEnvironmentFlags() {
    return /* @__PURE__ */ new Set();
  }
  get sourceMapsEnabled() {
    return false;
  }
  get debugPort() {
    return 0;
  }
  get throwDeprecation() {
    return false;
  }
  get traceDeprecation() {
    return false;
  }
  get features() {
    return {};
  }
  get release() {
    return {};
  }
  get connected() {
    return false;
  }
  get config() {
    return {};
  }
  get moduleLoadList() {
    return [];
  }
  constrainedMemory() {
    return 0;
  }
  availableMemory() {
    return 0;
  }
  uptime() {
    return 0;
  }
  resourceUsage() {
    return {};
  }
  // --- noop methods ---
  ref() {
  }
  unref() {
  }
  // --- unimplemented methods ---
  umask() {
    throw createNotImplementedError("process.umask");
  }
  getBuiltinModule() {
    return void 0;
  }
  getActiveResourcesInfo() {
    throw createNotImplementedError("process.getActiveResourcesInfo");
  }
  exit() {
    throw createNotImplementedError("process.exit");
  }
  reallyExit() {
    throw createNotImplementedError("process.reallyExit");
  }
  kill() {
    throw createNotImplementedError("process.kill");
  }
  abort() {
    throw createNotImplementedError("process.abort");
  }
  dlopen() {
    throw createNotImplementedError("process.dlopen");
  }
  setSourceMapsEnabled() {
    throw createNotImplementedError("process.setSourceMapsEnabled");
  }
  loadEnvFile() {
    throw createNotImplementedError("process.loadEnvFile");
  }
  disconnect() {
    throw createNotImplementedError("process.disconnect");
  }
  cpuUsage() {
    throw createNotImplementedError("process.cpuUsage");
  }
  setUncaughtExceptionCaptureCallback() {
    throw createNotImplementedError("process.setUncaughtExceptionCaptureCallback");
  }
  hasUncaughtExceptionCaptureCallback() {
    throw createNotImplementedError("process.hasUncaughtExceptionCaptureCallback");
  }
  initgroups() {
    throw createNotImplementedError("process.initgroups");
  }
  openStdin() {
    throw createNotImplementedError("process.openStdin");
  }
  assert() {
    throw createNotImplementedError("process.assert");
  }
  binding() {
    throw createNotImplementedError("process.binding");
  }
  // --- attached interfaces ---
  permission = { has: /* @__PURE__ */ notImplemented("process.permission.has") };
  report = {
    directory: "",
    filename: "",
    signal: "SIGUSR2",
    compact: false,
    reportOnFatalError: false,
    reportOnSignal: false,
    reportOnUncaughtException: false,
    getReport: /* @__PURE__ */ notImplemented("process.report.getReport"),
    writeReport: /* @__PURE__ */ notImplemented("process.report.writeReport")
  };
  finalization = {
    register: /* @__PURE__ */ notImplemented("process.finalization.register"),
    unregister: /* @__PURE__ */ notImplemented("process.finalization.unregister"),
    registerBeforeExit: /* @__PURE__ */ notImplemented("process.finalization.registerBeforeExit")
  };
  memoryUsage = Object.assign(() => ({
    arrayBuffers: 0,
    rss: 0,
    external: 0,
    heapTotal: 0,
    heapUsed: 0
  }), { rss: /* @__PURE__ */ __name(() => 0, "rss") });
  // --- undefined props ---
  mainModule = void 0;
  domain = void 0;
  // optional
  send = void 0;
  exitCode = void 0;
  channel = void 0;
  getegid = void 0;
  geteuid = void 0;
  getgid = void 0;
  getgroups = void 0;
  getuid = void 0;
  setegid = void 0;
  seteuid = void 0;
  setgid = void 0;
  setgroups = void 0;
  setuid = void 0;
  // internals
  _events = void 0;
  _eventsCount = void 0;
  _exiting = void 0;
  _maxListeners = void 0;
  _debugEnd = void 0;
  _debugProcess = void 0;
  _fatalException = void 0;
  _getActiveHandles = void 0;
  _getActiveRequests = void 0;
  _kill = void 0;
  _preload_modules = void 0;
  _rawDebug = void 0;
  _startProfilerIdleNotifier = void 0;
  _stopProfilerIdleNotifier = void 0;
  _tickCallback = void 0;
  _disconnect = void 0;
  _handleQueue = void 0;
  _pendingMessage = void 0;
  _channel = void 0;
  _send = void 0;
  _linkedBinding = void 0;
};

// ../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/@cloudflare/unenv-preset/dist/runtime/node/process.mjs
var globalProcess = globalThis["process"];
var getBuiltinModule = globalProcess.getBuiltinModule;
var workerdProcess = getBuiltinModule("node:process");
var isWorkerdProcessV2 = globalThis.Cloudflare.compatibilityFlags.enable_nodejs_process_v2;
var unenvProcess = new Process({
  env: globalProcess.env,
  // `hrtime` is only available from workerd process v2
  hrtime: isWorkerdProcessV2 ? workerdProcess.hrtime : hrtime,
  // `nextTick` is available from workerd process v1
  nextTick: workerdProcess.nextTick
});
var { exit, features, platform } = workerdProcess;
var {
  // Always implemented by workerd
  env,
  // Only implemented in workerd v2
  hrtime: hrtime3,
  // Always implemented by workerd
  nextTick
} = unenvProcess;
var {
  _channel,
  _disconnect,
  _events,
  _eventsCount,
  _handleQueue,
  _maxListeners,
  _pendingMessage,
  _send,
  assert: assert2,
  disconnect,
  mainModule
} = unenvProcess;
var {
  // @ts-expect-error `_debugEnd` is missing typings
  _debugEnd,
  // @ts-expect-error `_debugProcess` is missing typings
  _debugProcess,
  // @ts-expect-error `_exiting` is missing typings
  _exiting,
  // @ts-expect-error `_fatalException` is missing typings
  _fatalException,
  // @ts-expect-error `_getActiveHandles` is missing typings
  _getActiveHandles,
  // @ts-expect-error `_getActiveRequests` is missing typings
  _getActiveRequests,
  // @ts-expect-error `_kill` is missing typings
  _kill,
  // @ts-expect-error `_linkedBinding` is missing typings
  _linkedBinding,
  // @ts-expect-error `_preload_modules` is missing typings
  _preload_modules,
  // @ts-expect-error `_rawDebug` is missing typings
  _rawDebug,
  // @ts-expect-error `_startProfilerIdleNotifier` is missing typings
  _startProfilerIdleNotifier,
  // @ts-expect-error `_stopProfilerIdleNotifier` is missing typings
  _stopProfilerIdleNotifier,
  // @ts-expect-error `_tickCallback` is missing typings
  _tickCallback,
  abort,
  addListener,
  allowedNodeEnvironmentFlags,
  arch,
  argv,
  argv0,
  availableMemory,
  // @ts-expect-error `binding` is missing typings
  binding,
  channel,
  chdir,
  config,
  connected,
  constrainedMemory,
  cpuUsage,
  cwd,
  debugPort,
  dlopen,
  // @ts-expect-error `domain` is missing typings
  domain,
  emit,
  emitWarning,
  eventNames,
  execArgv,
  execPath,
  exitCode,
  finalization,
  getActiveResourcesInfo,
  getegid,
  geteuid,
  getgid,
  getgroups,
  getMaxListeners,
  getuid,
  hasUncaughtExceptionCaptureCallback,
  // @ts-expect-error `initgroups` is missing typings
  initgroups,
  kill,
  listenerCount,
  listeners,
  loadEnvFile,
  memoryUsage,
  // @ts-expect-error `moduleLoadList` is missing typings
  moduleLoadList,
  off,
  on,
  once,
  // @ts-expect-error `openStdin` is missing typings
  openStdin,
  permission,
  pid,
  ppid,
  prependListener,
  prependOnceListener,
  rawListeners,
  // @ts-expect-error `reallyExit` is missing typings
  reallyExit,
  ref,
  release,
  removeAllListeners,
  removeListener,
  report,
  resourceUsage,
  send,
  setegid,
  seteuid,
  setgid,
  setgroups,
  setMaxListeners,
  setSourceMapsEnabled,
  setuid,
  setUncaughtExceptionCaptureCallback,
  sourceMapsEnabled,
  stderr,
  stdin,
  stdout,
  throwDeprecation,
  title,
  traceDeprecation,
  umask,
  unref,
  uptime,
  version,
  versions
} = isWorkerdProcessV2 ? workerdProcess : unenvProcess;
var _process = {
  abort,
  addListener,
  allowedNodeEnvironmentFlags,
  hasUncaughtExceptionCaptureCallback,
  setUncaughtExceptionCaptureCallback,
  loadEnvFile,
  sourceMapsEnabled,
  arch,
  argv,
  argv0,
  chdir,
  config,
  connected,
  constrainedMemory,
  availableMemory,
  cpuUsage,
  cwd,
  debugPort,
  dlopen,
  disconnect,
  emit,
  emitWarning,
  env,
  eventNames,
  execArgv,
  execPath,
  exit,
  finalization,
  features,
  getBuiltinModule,
  getActiveResourcesInfo,
  getMaxListeners,
  hrtime: hrtime3,
  kill,
  listeners,
  listenerCount,
  memoryUsage,
  nextTick,
  on,
  off,
  once,
  pid,
  platform,
  ppid,
  prependListener,
  prependOnceListener,
  rawListeners,
  release,
  removeAllListeners,
  removeListener,
  report,
  resourceUsage,
  setMaxListeners,
  setSourceMapsEnabled,
  stderr,
  stdin,
  stdout,
  title,
  throwDeprecation,
  traceDeprecation,
  umask,
  uptime,
  version,
  versions,
  // @ts-expect-error old API
  domain,
  initgroups,
  moduleLoadList,
  reallyExit,
  openStdin,
  assert: assert2,
  binding,
  send,
  exitCode,
  channel,
  getegid,
  geteuid,
  getgid,
  getgroups,
  getuid,
  setegid,
  seteuid,
  setgid,
  setgroups,
  setuid,
  permission,
  mainModule,
  _events,
  _eventsCount,
  _exiting,
  _maxListeners,
  _debugEnd,
  _debugProcess,
  _fatalException,
  _getActiveHandles,
  _getActiveRequests,
  _kill,
  _preload_modules,
  _rawDebug,
  _startProfilerIdleNotifier,
  _stopProfilerIdleNotifier,
  _tickCallback,
  _disconnect,
  _handleQueue,
  _pendingMessage,
  _channel,
  _send,
  _linkedBinding
};
var process_default = _process;

// ../../../AppData/Roaming/npm/node_modules/wrangler/_virtual_unenv_global_polyfill-@cloudflare-unenv-preset-node-process
globalThis.process = process_default;

// src/utils/spa.js
async function htmlPage(env2, submissionToken = null) {
  let submissionData = null;
  if (submissionToken) {
    const result = await env2.waivers.prepare(
      "SELECT submission_id, property_id, checkin_date, guest_name, guest_email, status, token_expires_at FROM submissions WHERE verification_token = ?"
    ).bind(submissionToken).first();
    if (result && result.status === "pending") {
      const expires = new Date(result.token_expires_at);
      if (expires > /* @__PURE__ */ new Date()) {
        submissionData = result;
      }
    }
  }
  const propertiesResult = await env2.waivers.prepare(
    "SELECT id, name FROM properties WHERE id != ? ORDER BY name"
  ).bind("default").all();
  const properties = propertiesResult.results || [];
  const propsData = [];
  for (const property of properties) {
    const activitiesResult = await env2.waivers.prepare(
      "SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label"
    ).bind(property.id).all();
    propsData.push({
      id: property.id,
      name: property.name,
      activities: activitiesResult.results || []
    });
  }
  const risksResult = await env2.waivers.prepare(
    "SELECT level, description FROM risk_descriptions"
  ).all();
  const risks = {};
  for (const row of risksResult.results || []) {
    risks[row.level] = { description: row.description };
  }
  const propsJSON = JSON.stringify(propsData);
  const props64 = btoa(unescape(encodeURIComponent(propsJSON)));
  const risksJSON = JSON.stringify(risks);
  const risks64 = btoa(unescape(encodeURIComponent(risksJSON)));
  const submissionJSON = submissionData ? JSON.stringify(submissionData) : "null";
  const submission64 = btoa(unescape(encodeURIComponent(submissionJSON)));
  return new Response(`
<!doctype html>
<html lang="en"><meta charset="utf-8">
<title>Activity Waiver</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;padding:2rem 1rem;background:#f8fafc;color:#1e293b;line-height:1.6}
  .container{max-width:1200px;margin:0 auto;background:white;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);overflow:hidden}
  .header{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);padding:2.5rem 2rem;color:white;text-align:center}
  .header h1{margin:0 0 0.5rem 0;font-size:2rem;font-weight:700}
  .header p{margin:0;opacity:0.9;font-size:1rem}
  .content{padding:2rem}
  .form-group{margin-bottom:1.5rem}
  .form-group label{display:block;margin-bottom:0.5rem;font-weight:600;font-size:0.875rem;color:#475569}
  .form-group input,.form-group select{width:100%;padding:0.75rem 1rem;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;transition:all 0.2s;max-width:400px}
  .form-group input:focus,.form-group select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
  .section-title{font-size:1.25rem;font-weight:700;color:#0f172a;margin:2rem 0 1rem 0;padding-bottom:0.5rem;border-bottom:2px solid #e2e8f0}
  .activities-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;column-gap:24px;padding:0;overflow:hidden}
  .activity-row{display:flex;gap:8px;align-items:center}
  .activity-item{display:flex;align-items:center;padding:12px;background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0;cursor:pointer;transition:all 0.2s;flex:1;position:relative;min-height:68px;overflow:hidden}
  .activity-item:hover{background:#f1f5f9;border-color:#3b82f6}
  .activity-item.checked{background:#eff6ff;border-color:#3b82f6}
  .activity-item input[type="checkbox"]{margin-right:10px;cursor:pointer;width:20px;height:20px;flex-shrink:0;accent-color:#3b82f6}
  .activity-item label{margin:0;cursor:pointer;flex:1;display:flex;align-items:center;gap:8px;position:relative;z-index:1;justify-content:space-between}
  .activity-label-text{white-space:nowrap;flex-shrink:0;min-width:120px;font-weight:600;color:#1e293b}
  .risk-chip-wrapper{display:flex;align-items:center;justify-content:flex-end;min-width:360px;width:360px;transition:all 0.3s ease;position:relative;overflow:visible;z-index:10}
  .risk-chip{padding:6px 14px;border-radius:12px;color:white;font-size:11px;font-weight:600;white-space:nowrap;display:inline-block;width:100px;text-align:center;box-sizing:border-box;flex-shrink:0;position:absolute;right:0;z-index:2}
  .risk-low{background:#10b981}
  .risk-medium{background:#f59e0b}
  .risk-high{background:#ef4444}
  .risk-details{position:absolute;right:110px;width:250px;opacity:0;font-size:9px;line-height:1.3;color:#334155;transition:opacity 0.3s ease;padding:4px 8px;display:block;box-sizing:border-box;max-height:56px;overflow-y:auto;background:white;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);white-space:normal}
  .risk-chip-wrapper:hover .risk-details{opacity:1}
  .activity-initial{width:70px;height:50px;text-align:center;padding:0;border:2px solid #cbd5e1;border-radius:8px;visibility:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;background:white;transition:all 0.2s}
  .activity-initial.visible{visibility:visible;border-color:#3b82f6}
  .activity-initial:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
  .acceptance-box{background:#fef3c7;border:2px solid #fbbf24;border-radius:10px;padding:1rem;margin:1.5rem 0;display:flex;align-items:center;gap:0.75rem;position:relative}
  .acceptance-box input[type="checkbox"]{width:20px;height:20px;accent-color:#f59e0b;cursor:pointer}
  .acceptance-box label{margin:0;font-weight:600;color:#78350f;cursor:pointer}
  .acceptance-box input[type="checkbox"]:disabled{cursor:not-allowed;opacity:0.5}
  .acceptance-box .tooltip{display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#1e293b;color:white;padding:0.5rem 1rem;border-radius:6px;font-size:0.875rem;white-space:nowrap;margin-bottom:0.5rem;font-weight:400}
  .acceptance-box .tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e293b}
  .acceptance-box:has(input[type="checkbox"]:disabled):hover .tooltip{display:block}
  .signature-container{display:flex;flex-direction:column;align-items:center;gap:12px;padding:1.5rem;background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0}
  canvas{border:2px dashed #cbd5e1;border-radius:8px;width:90%;max-width:600px;touch-action:none;display:block;background:white}
  button{font-weight:600;border:none;cursor:pointer;transition:all 0.2s;font-size:1rem;border-radius:8px;font-family:inherit}
  #clearSig{padding:0.625rem 1.5rem;background:#64748b;color:white}
  #clearSig:hover{background:#475569}
  #submit{width:100%;padding:1rem;background:#3b82f6;color:white;font-size:1.125rem;margin-top:1.5rem;max-width:400px}
  #submit:hover:not(:disabled){background:#2563eb}
  #submit:disabled{opacity:0.5;cursor:not-allowed}
  .thanks{padding:2rem;text-align:center}
  .thanks h2{color:#3b82f6;font-size:1.75rem;margin-bottom:1rem}
  .info-box{background:#eff6ff;border:2px solid #3b82f6;border-radius:10px;padding:1rem;margin-bottom:1.5rem}
  .info-box p{margin:0.25rem 0;color:#1e40af}
  @media (max-width:768px){
    .content{padding:1.5rem}
    .activities-grid{grid-template-columns:1fr}
    .form-group input,.form-group select{width:100%;max-width:100%}
    canvas{width:100%}
  }
</style>

<body>
  <div class="container">
    <div class="header">
      <h1>Activity Waiver</h1>
      <p id="headerSubtitle">Complete your waiver to get started</p>
    </div>

    <div class="content">
      <!-- Initial Info Form -->
      <form id="initialForm">
        <div class="form-group">
          <label>Property</label>
          <select id="prop" required></select>
        </div>

        <div class="form-group">
          <label>Check-in Date</label>
          <input type="date" id="date" required>
        </div>

        <div class="form-group">
          <label>Full Name</label>
          <input id="name" required>
        </div>

        <div class="form-group">
          <label>Email Address</label>
          <input id="email" type="email" required>
        </div>

        <button id="initialSubmit">Continue to Activities</button>
      </form>

      <!-- Activity Selection Form (hidden initially) -->
      <form id="activityForm" hidden>
        <div class="info-box" id="guestInfo"></div>

        <h3 class="section-title">Select Activities</h3>
        <div id="activities" class="activities-grid"></div>

        <div class="acceptance-box">
          <input id="master" type="checkbox" required>
          <label for="master">I have read and accept all risks</label>
          <span class="tooltip" id="masterTooltip">Please initial all selected activities first</span>
        </div>

        <h3 class="section-title">Signature</h3>
        <div class="signature-container">
          <canvas id="sign" width="600" height="200"></canvas>
          <button id="clearSig" type="button">Clear</button>
        </div>

        <button id="submit">Submit Waiver</button>
      </form>

      <div id="thanks" class="thanks" hidden></div>
    </div>
  </div>

<script type="module">
  /* ---------- bootstrap data -------------------- */
  let props = JSON.parse(atob('${props64}'));
  const risks = JSON.parse(atob('${risks64}'));
  const submission = JSON.parse(atob('${submission64}'));

  console.log("Props:", props);
  console.log("Risks:", risks);
  console.log("Submission:", submission);

  if (!Array.isArray(props)) {
    props = [props];
  }

  const propSel = document.getElementById('prop');
  if (!props || props.length === 0) {
    propSel.add(new Option('No properties available', ''));
    propSel.disabled = true;
  } else {
    props.forEach(p => propSel.add(new Option(p.name, p.id)));
  }

  /* ---------- Determine which form to show -------------------- */
  const initialForm = document.getElementById('initialForm');
  const activityForm = document.getElementById('activityForm');
  const headerSubtitle = document.getElementById('headerSubtitle');

  if (submission) {
    // Show activity form with pre-filled info
    initialForm.hidden = true;
    activityForm.hidden = false;
    headerSubtitle.textContent = 'Select your activities and sign';

    // Pre-fill property selection
    propSel.value = submission.property_id;
    propSel.disabled = true;

    // Show guest info
    document.getElementById('guestInfo').innerHTML =
      '<p><strong>Property:</strong> ' + props.find(p => p.id === submission.property_id)?.name + '</p>' +
      '<p><strong>Check-in:</strong> ' + submission.checkin_date + '</p>' +
      '<p><strong>Name:</strong> ' + submission.guest_name + '</p>' +
      '<p><strong>Email:</strong> ' + submission.guest_email + '</p>';
  } else {
    // Show initial form
    initialForm.hidden = false;
    activityForm.hidden = true;
  }

  /* ---------- Initial form submission -------------------- */
  document.getElementById('initialForm').onsubmit = async e => {
    e.preventDefault();

    const data = {
      propertyId: propSel.value,
      checkinDate: document.getElementById('date').value,
      guestName: document.getElementById('name').value,
      guestEmail: document.getElementById('email').value
    };

    console.log("Submitting initial form:", data);

    try {
      const res = await fetch('/submit/initial', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error("Server error:", errorText);
        alert("Error: " + errorText);
        return;
      }

      const json = await res.json();
      console.log("Response:", json);

      // Show confirmation message
      initialForm.hidden = true;
      document.getElementById('thanks').hidden = false;
      document.getElementById('thanks').innerHTML =
        '<h2>\u2713 Check Your Email</h2>' +
        '<p style="color:#64748b;margin-bottom:1.5rem">We\\'ve sent a verification link to <strong>' + data.guestEmail + '</strong></p>' +
        '<p style="color:#94a3b8;font-size:0.875rem">Click the link in the email to continue with your waiver.</p>';
    } catch (error) {
      console.error("Form submission error:", error);
      alert("Error: " + error.message);
    }
  };

  /* ---------- activity checkboxes ------------------------- */
  const actsDiv = document.getElementById('activities');
  const masterCheck = document.getElementById('master');
  let chosen = new Map();

  function loadActivities() {
    const selectedProp = props.find(p => p.id === (submission ? submission.property_id : propSel.value));
    const activities = selectedProp?.activities ?? [];

    actsDiv.innerHTML = '';
    chosen.clear();
    masterCheck.disabled = true;
    masterCheck.checked = false;

    activities.forEach(a => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'activity-row';

      const itemDiv = document.createElement('div');
      itemDiv.className = 'activity-item';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = 'activity-' + a.slug;
      checkbox.value = a.slug;

      const label = document.createElement('label');
      label.htmlFor = 'activity-' + a.slug;

      const labelText = document.createElement('span');
      labelText.className = 'activity-label-text';
      labelText.textContent = a.label;
      label.appendChild(labelText);

      if (a.risk) {
        const chipWrapper = document.createElement('div');
        chipWrapper.className = 'risk-chip-wrapper';

        const riskChip = document.createElement('span');
        riskChip.className = 'risk-chip risk-' + a.risk;
        riskChip.textContent = a.risk.charAt(0).toUpperCase() + a.risk.slice(1) + ' Risk';

        const riskDetails = document.createElement('span');
        riskDetails.className = 'risk-details';

        const riskData = risks[a.risk];
        if (riskData) {
          riskDetails.textContent = riskData.description || 'Activity-specific risks apply';
        } else {
          riskDetails.textContent = 'Activity-specific risks apply';
        }

        chipWrapper.appendChild(riskChip);
        chipWrapper.appendChild(riskDetails);
        label.appendChild(chipWrapper);
      }

      const initialInput = document.createElement('input');
      initialInput.type = 'text';
      initialInput.maxLength = 4;
      initialInput.placeholder = 'Initials';
      initialInput.className = 'activity-initial';
      initialInput.dataset.slug = a.slug;
      initialInput.oninput = validateMasterCheckbox;

      checkbox.onchange = () => {
        if (checkbox.checked) {
          chosen.set(a.slug, {itemDiv, initialInput});
          initialInput.classList.add('visible');
          itemDiv.classList.add('checked');
        } else {
          chosen.delete(a.slug);
          initialInput.classList.remove('visible');
          initialInput.value = '';
          itemDiv.classList.remove('checked');
        }
        validateMasterCheckbox();
      };

      itemDiv.appendChild(checkbox);
      itemDiv.appendChild(label);

      itemDiv.onclick = () => {
        checkbox.checked = !checkbox.checked;
        checkbox.onchange();
      };

      rowDiv.appendChild(itemDiv);
      rowDiv.appendChild(initialInput);
      actsDiv.appendChild(rowDiv);
    });
  }

  function validateMasterCheckbox() {
    let allFilled = true;
    for (const [slug, {initialInput}] of chosen) {
      if (!initialInput.value.trim()) {
        allFilled = false;
        break;
      }
    }
    masterCheck.disabled = !allFilled || chosen.size === 0;
    if (masterCheck.disabled) {
      masterCheck.checked = false;
    }
  }

  if (submission) {
    loadActivities();
    validateMasterCheckbox();
  }

  /* ---------- signature pad -------------------------------- */
  const canvas = document.getElementById('sign');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  let drawing = false;

  canvas.addEventListener('pointerdown', e => {
    drawing = true;
    ctx.moveTo(e.offsetX, e.offsetY);
  });
  canvas.addEventListener('pointermove', e => {
    if (!drawing) return;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });
  canvas.addEventListener('pointerup', () => drawing = false);
  document.getElementById('clearSig').onclick =
    () => ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* ---------- activity form submit --------------------------------------- */
  document.getElementById('activityForm').onsubmit = async e => {
    e.preventDefault();

    if (!submission) {
      alert('Invalid submission. Please start over.');
      return;
    }

    const data = {
      submissionId: submission.submission_id,
      activities: [...chosen.keys()],
      initials: Object.fromEntries(
        [...chosen.entries()].map(([slug, {initialInput}]) =>
          [slug, initialInput.value])),
      signature: canvas.toDataURL(),
      accepted: document.getElementById('master').checked
    };

    console.log("Submitting activity form:", data);

    try {
      const res = await fetch('/submit/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error("Server error:", errorText);
        alert("Error submitting form: " + errorText);
        return;
      }

      const json = await res.json();
      console.log("Response data:", json);

      document.getElementById('activityForm').hidden = true;
      document.getElementById('thanks').hidden = false;

      if (json.devMode) {
        let html = '<h2>\u2713 Waivers Generated</h2>';
        html += '<p style="color:#64748b;margin-bottom:1.5rem">Your waivers are ready to download</p>';
        html += '<div style="display:flex;flex-direction:column;gap:12px">';

        json.downloads.forEach(pdf => {
          html += '<button onclick="window.open(&quot;' + pdf.url + '&quot;, &quot;_blank&quot;)" ';
          html += 'style="padding:12px 24px;background:#3b82f6;color:white;border:none;';
          html += 'border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;';
          html += 'transition:background 0.2s"';
          html += ' onmouseover="this.style.background=&quot;#2563eb&quot;"';
          html += ' onmouseout="this.style.background=&quot;#3b82f6&quot;">';
          html += '\u{1F4C4} Download ' + pdf.filename + '</button>';
        });

        html += '</div>';

        if (json.downloads.length > 1) {
          html += '<button onclick="';
          json.downloads.forEach(pdf => {
            html += 'window.open(&quot;' + pdf.url + '&quot;, &quot;_blank&quot;);';
          });
          html += '" style="padding:14px 28px;background:#10b981;color:white;border:none;';
          html += 'border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;margin-top:12px;';
          html += 'transition:background 0.2s"';
          html += ' onmouseover="this.style.background=&quot;#059669&quot;"';
          html += ' onmouseout="this.style.background=&quot;#10b981&quot;">';
          html += '\u{1F4E6} Download All (' + json.downloads.length + ' PDFs)</button>';
        }

        if (json.pin) {
          html += '<div style="margin-top:1.5rem;padding:1rem;background:#fef3c7;border:2px solid #fbbf24;border-radius:8px">';
          html += '<p style="margin:0;color:#78350f;font-weight:600">Archery PIN: <strong>' + json.pin + '</strong></p></div>';
        }

        html += '<p style="margin-top:1.5rem;color:#94a3b8;font-size:0.875rem">';
        html += '\u26A0\uFE0F Development Mode - PDFs stored locally, not emailed</p>';

        document.getElementById('thanks').innerHTML = html;
      } else {
        let html = '<h2>\u2713 Success</h2>';
        html += '<p style="color:#64748b;margin-bottom:1.5rem">Your waivers have been sent to your email</p>';
        if (json.pin) {
          html += '<div style="margin-top:1.5rem;padding:1rem;background:#fef3c7;border:2px solid #fbbf24;border-radius:8px">';
          html += '<p style="margin:0;color:#78350f;font-weight:600">Archery PIN: <strong>' + json.pin + '</strong></p></div>';
        }
        document.getElementById('thanks').innerHTML = html;
      }
    } catch (error) {
      console.error("Form submission error:", error);
      alert("Error submitting form: " + error.message);
    }
  };
<\/script>
</body>
</html>`, {
    headers: { "content-type": "text/html; charset=utf-8" }
  });
}
__name(htmlPage, "htmlPage");

// src/routes/root.js
async function handleRoot(request, env2) {
  const url = new URL(request.url);
  const token = url.searchParams.get("token");
  return await htmlPage(env2, token);
}
__name(handleRoot, "handleRoot");

// src/utils/nanoid.js
var urlAlphabet = "useandom26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";
function nanoid(size = 21) {
  let id = "";
  const bytes = crypto.getRandomValues(new Uint8Array(size));
  while (size--) {
    id += urlAlphabet[bytes[size] & 63];
  }
  return id;
}
__name(nanoid, "nanoid");

// src/utils/admin.js
var json = /* @__PURE__ */ __name((obj, status = 200) => new Response(JSON.stringify(obj), {
  status,
  headers: { "content-type": "application/json" }
}), "json");
var bad = /* @__PURE__ */ __name((msg) => json({ ok: false, error: msg }, 400), "bad");
async function handleAdmin() {
  const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Activity Waivers</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 30px;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover {
      color: #0070f3;
    }
    .tab.active {
      color: #0070f3;
      border-bottom-color: #0070f3;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .search-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
      font-size: 14px;
    }
    input, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #0070f3;
    }
    .button-group {
      grid-column: 1 / -1;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-search, .btn-primary {
      background: #0070f3;
      color: white;
    }
    .btn-search:hover, .btn-primary:hover {
      background: #0051cc;
    }
    .btn-clear {
      background: #eee;
      color: #333;
    }
    .btn-clear:hover {
      background: #ddd;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
      padding: 8px 15px;
      font-size: 13px;
      margin-left: 5px;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-warning {
      background: #ffc107;
      color: #000;
      padding: 8px 15px;
      font-size: 13px;
      margin-left: 5px;
    }
    .btn-warning:hover {
      background: #e0a800;
    }
    .results {
      margin-top: 20px;
    }
    .result-count {
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background: #f9f9f9;
    }
    th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #ddd;
      font-weight: 600;
      color: #555;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .activity-badge {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .activity-badge:hover {
      background: #1976d2;
      color: white;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      padding: 15px;
      background: #fee;
      color: #c33;
      border-radius: 4px;
      margin: 20px 0;
    }
    .message {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .section {
      margin-bottom: 40px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      color: #555;
    }
    .activities-list {
      margin-top: 20px;
    }
    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .activity-info {
      flex: 1;
    }
    .activity-slug {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }
    .activity-label {
      color: #666;
      margin: 5px 0;
    }
    .risk-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 5px;
    }
    .risk-low {
      background: #d4edda;
      color: #155724;
    }
    .risk-medium {
      background: #fff3cd;
      color: #856404;
    }
    .risk-high {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Activity Waivers Admin</h1>

    <div class="tabs">
      <button class="tab active" onclick="showTab('search')">Search Submissions</button>
      <button class="tab" onclick="showTab('activities')">Manage Activities</button>
      <button class="tab" onclick="showTab('properties')">Manage Properties</button>
      <button class="tab" onclick="showTab('releases')">Legal Releases</button>
      <button class="tab" onclick="showTab('debug')">Debug</button>
      <button class="tab" onclick="showTab('api')">API Documentation</button>
    </div>

    <!-- Search Tab -->
    <div id="searchTab" class="tab-content active">
      <form class="search-form" id="searchForm">
        <div class="form-group">
          <label for="name">Guest Name</label>
          <input type="text" id="name" name="name" placeholder="John Doe">
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" placeholder="guest@example.com">
        </div>

        <div class="form-group">
          <label for="prop">Property ID</label>
          <input type="text" id="prop" name="prop" placeholder="cabin-12">
        </div>

        <div class="form-group">
          <label for="date">Check-in Date</label>
          <input type="date" id="date" name="date">
        </div>

        <div class="form-group">
          <label for="activity">Activity</label>
          <input type="text" id="activity" name="activity" placeholder="archery">
        </div>

        <div class="button-group">
          <button type="submit" class="btn-search">Search</button>
          <button type="button" class="btn-clear" onclick="clearForm()">Clear</button>
        </div>
      </form>

      <div class="results" id="results"></div>
    </div>

    <!-- Activities Tab -->
    <div id="activitiesTab" class="tab-content">
      <div id="message"></div>

      <div class="section">
        <h2>Property</h2>
        <div class="form-group">
          <label for="propertySelect">Select Property</label>
          <select id="propertySelect" onchange="loadActivities()">
            <option value="">Loading...</option>
          </select>
        </div>
      </div>

      <div class="section">
        <h2>Add New Activity</h2>
        <form id="addForm">
          <div class="form-group">
            <label for="addSlug">Slug (e.g., rock-climbing)</label>
            <input type="text" id="addSlug" required placeholder="rock-climbing">
          </div>
          <div class="form-group">
            <label for="addLabel">Label (Display Name)</label>
            <input type="text" id="addLabel" required placeholder="Rock Climbing">
          </div>
          <div class="form-group">
            <label for="addRisk">Risk Level</label>
            <select id="addRisk" required>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <button type="submit" class="btn-primary">Add Activity</button>
        </form>
      </div>

      <div class="section">
        <h2>Current Activities</h2>
        <div id="activitiesList" class="activities-list">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Properties Tab -->
    <div id="propertiesTab" class="tab-content">
      <div id="propMessage"></div>

      <div class="section">
        <h2>Add New Property</h2>
        <form id="addPropertyForm">
          <div class="form-group">
            <label for="propId">Property ID (e.g., cabin-12)</label>
            <input type="text" id="propId" required placeholder="cabin-12">
          </div>
          <div class="form-group">
            <label for="propName">Property Name</label>
            <input type="text" id="propName" required placeholder="Cabin 12">
          </div>
          <div class="form-group">
            <label for="copyDefaultActivities" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="copyDefaultActivities" checked style="cursor: pointer;">
              <span>Copy default activities template</span>
            </label>
          </div>
          <button type="submit" class="btn-primary">Add Property</button>
        </form>
      </div>

      <div class="section">
        <h2>Current Properties</h2>
        <div id="propertiesList" class="activities-list">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Legal Releases Tab -->
    <div id="releasesTab" class="tab-content">
      <div id="releaseMessage"></div>

      <div class="section">
        <h2>Current Release</h2>
        <div id="currentRelease" class="current-release">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="section">
        <h2>Create New Release</h2>
        <form id="releaseForm">
          <div class="form-group">
            <label for="releaseVersion">Version</label>
            <input type="text" id="releaseVersion" placeholder="Leave blank to auto-increment" pattern="[0-9]+.[0-9]+.[0-9]+">
            <small style="color: #666; margin-top: 5px; display: block;">Format: X.Y.Z (e.g., 1.0.1) - Leave blank to auto-increment patch version</small>
          </div>
          <div class="form-group">
            <label for="waiverText">Legal Waiver Text</label>
            <textarea id="waiverText" required rows="12" style="font-family: system-ui, sans-serif; resize: vertical; min-height: 200px;"></textarea>
          </div>
          <button type="submit" class="btn-primary">Create Release</button>
        </form>
      </div>

      <div class="section">
        <h2>Release History</h2>
        <div id="releaseHistory" class="release-history">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Debug Tab -->
    <div id="debugTab" class="tab-content">
      <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>\u26A0\uFE0F Note:</strong> Debug data is cached and auto-updates every 7 days. Click "Refresh Data" to force an update.
      </div>

      <div style="margin-bottom: 20px;">
        <button class="btn-primary" onclick="loadDebugData(true)" style="padding: 10px 20px;">
          \u{1F504} Refresh Data
        </button>
        <span id="debugLastUpdate" style="margin-left: 15px; color: #666; font-size: 14px;"></span>
      </div>

      <div class="section">
        <h2>KV Store (PROPS_KV)</h2>
        <div id="kvData" style="background: #f9f9f9; padding: 15px; border-radius: 4px; overflow-x: auto;">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="section">
        <h2>D1 Database Tables</h2>
        <div id="d1Tables" style="margin-top: 15px;">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- API Documentation Tab -->
    <div id="apiTab" class="tab-content">
      <div style="max-width: 900px; margin: 0 auto;">
        <div style="background: white; padding: 30px; border-radius: 8px; line-height: 1.6;">
          <div id="apiDocs" style="font-family: system-ui, sans-serif;">
            <!-- API documentation will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentProperties = [];

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        if (tab.textContent.toLowerCase().includes(tabName === 'search' ? 'search' : tabName === 'activities' ? 'activities' : tabName === 'properties' ? 'properties' : tabName === 'releases' ? 'releases' : tabName === 'debug' ? 'debug' : 'api')) {
          tab.classList.add('active');
        }
      });
      document.getElementById(tabName + 'Tab').classList.add('active');

      if (tabName === 'activities') {
        loadPropertySelector();
        loadActivities();
      }
      if (tabName === 'properties') {
        loadProperties();
      }
      if (tabName === 'releases') {
        loadReleases();
      }
      if (tabName === 'debug') {
        loadDebugData();
      }
      if (tabName === 'api') {
        loadApiDocs();
      }
    }

    async function loadPropertySelector() {
      const selector = document.getElementById('propertySelect');
      try {
        const response = await fetch('/admin/properties');
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        currentProperties = data.properties;
        selector.innerHTML = currentProperties.map(p =>
          \`<option value="\${p.id}">\${p.name}</option>\`
        ).join('');

      } catch (error) {
        selector.innerHTML = '<option value="">Error loading properties</option>';
      }
    }

    // Search functionality
    const form = document.getElementById('searchForm');
    const resultsDiv = document.getElementById('results');

    window.addEventListener('load', () => search());

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      search();
    });

    async function search() {
      resultsDiv.innerHTML = '<div class="loading">Loading...</div>';

      const formData = new FormData(form);
      const params = new URLSearchParams();

      for (const [key, value] of formData) {
        if (value.trim()) {
          params.append(key, value.trim());
        }
      }

      try {
        const response = await fetch('/admin/search?' + params.toString());
        const data = await response.json();

        if (!data.rows.success) {
          throw new Error('Search failed');
        }

        displayResults(data.rows.results);
      } catch (error) {
        resultsDiv.innerHTML = '<div class="error">Error loading results: ' + error.message + '</div>';
      }
    }

    function displayResults(results) {
      if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="empty">No results found</div>';
        return;
      }

      const countHtml = '<div class="result-count">Found ' + results.length + ' submission' + (results.length !== 1 ? 's' : '') + '</div>';

      const tableHtml = \`
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Guest Name</th>
              <th>Email</th>
              <th>Property</th>
              <th>Check-in</th>
              <th>Activities</th>
              <th>Download</th>
            </tr>
          </thead>
          <tbody>
            \${results.map(row => {
              const createdDate = new Date(row.created_at).toLocaleString();
              const activities = JSON.parse(row.activities);

              return \`
                <tr>
                  <td>\${createdDate}</td>
                  <td>\${escapeHtml(row.guest_name)}</td>
                  <td>\${escapeHtml(row.guest_email)}</td>
                  <td>\${escapeHtml(row.property_id)}</td>
                  <td>\${row.checkin_date}</td>
                  <td>
                    \${activities.map(a =>
                      '<span class="activity-badge">' +
                      escapeHtml(a) + '</span>'
                    ).join('')}
                  </td>
                  <td>
                    <button class="btn-primary" onclick="downloadAllWaivers('\${escapeHtml(row.submission_id)}')" style="padding: 8px 12px; font-size: 13px;">Download All</button>
                  </td>
                </tr>
              \`;
            }).join('')}
          </tbody>
        </table>
      \`;

      resultsDiv.innerHTML = countHtml + tableHtml;
    }

    function clearForm() {
      form.reset();
      search();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Activities Management
    const messageDiv = document.getElementById('message');
    const activitiesList = document.getElementById('activitiesList');

    function showMessage(text, type = 'success') {
      messageDiv.innerHTML = \`<div class="message \${type}">\${text}</div>\`;
      setTimeout(() => messageDiv.innerHTML = '', 5000);
    }

    async function loadActivities() {
      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      if (!propertyId) return;

      try {
        const response = await fetch(\`/admin/activities?property=\${propertyId}\`);
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        displayActivities(data.activities);
      } catch (error) {
        activitiesList.innerHTML = \`<div class="error">Error loading activities: \${error.message}</div>\`;
      }
    }

    function displayActivities(activities) {
      if (activities.length === 0) {
        activitiesList.innerHTML = '<p>No activities found.</p>';
        return;
      }

      activitiesList.innerHTML = activities.map(activity => \`
        <div class="activity-item">
          <div class="activity-info">
            <div class="activity-slug">\${activity.slug}</div>
            <div class="activity-label">\${activity.label}</div>
            <span class="risk-badge risk-\${activity.risk}">\${activity.risk.toUpperCase()}</span>
          </div>
          <div class="activity-actions">
            <button class="btn-warning" onclick="editActivity('\${activity.slug}', '\${activity.label}', '\${activity.risk}')">Edit</button>
            <button class="btn-danger" onclick="removeActivity('\${activity.slug}')">Remove</button>
          </div>
        </div>
      \`).join('');
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      if (!propertyId) {
        showMessage('Please select a property first', 'error');
        return;
      }

      const slug = document.getElementById('addSlug').value.trim();
      const label = document.getElementById('addLabel').value.trim();
      const risk = document.getElementById('addRisk').value;

      try {
        const response = await fetch(\`/admin/activities/add?property=\${propertyId}\`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, label, risk })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showMessage(\`Activity "\${label}" added successfully!\`);
        document.getElementById('addForm').reset();
        loadActivities();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    });

    async function removeActivity(slug) {
      if (!confirm(\`Remove activity "\${slug}"?\`)) return;

      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      try {
        const response = await fetch(\`/admin/activities/remove?property=\${propertyId}\`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showMessage(\`Activity "\${slug}" removed successfully!\`);
        loadActivities();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    function editActivity(slug, currentLabel, currentRisk) {
      const newLabel = prompt('Enter new label:', currentLabel);
      if (newLabel === null) return;

      const newRisk = prompt('Enter risk level (low/medium/high):', currentRisk);
      if (newRisk === null) return;

      if (!['low', 'medium', 'high'].includes(newRisk.toLowerCase())) {
        showMessage('Invalid risk level. Must be low, medium, or high.', 'error');
        return;
      }

      updateActivity(slug, newLabel, newRisk.toLowerCase());
    }

    async function updateActivity(slug, label, risk) {
      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      try {
        const response = await fetch(\`/admin/activities/update?property=\${propertyId}\`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, label, risk })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showMessage(\`Activity "\${slug}" updated successfully!\`);
        loadActivities();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    // Properties Management
    const propMessageDiv = document.getElementById('propMessage');
    const propertiesList = document.getElementById('propertiesList');

    function showPropMessage(text, type = 'success') {
      propMessageDiv.innerHTML = \`<div class="message \${type}">\${text}</div>\`;
      setTimeout(() => propMessageDiv.innerHTML = '', 5000);
    }

    async function loadProperties() {
      try {
        const response = await fetch('/admin/properties');
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        displayProperties(data.properties);
      } catch (error) {
        propertiesList.innerHTML = \`<div class="error">Error loading properties: \${error.message}</div>\`;
      }
    }

    function displayProperties(properties) {
      if (properties.length === 0) {
        propertiesList.innerHTML = '<p>No properties found.</p>';
        return;
      }

      propertiesList.innerHTML = properties.map(property => \`
        <div class="activity-item">
          <div class="activity-info">
            <div class="activity-slug">\${property.id}</div>
            <div class="activity-label">\${property.name}</div>
          </div>
          <div class="activity-actions">
            <button class="btn-danger" onclick="removeProperty('\${property.id}')">Remove</button>
          </div>
        </div>
      \`).join('');
    }

    document.getElementById('addPropertyForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('propId').value.trim();
      const name = document.getElementById('propName').value.trim();
      const copyDefaults = document.getElementById('copyDefaultActivities').checked;

      try {
        const response = await fetch('/admin/properties/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, name, copyDefaultActivities: copyDefaults })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showPropMessage(\`Property "\${name}" added successfully!\`);
        document.getElementById('addPropertyForm').reset();
        document.getElementById('copyDefaultActivities').checked = true;
        loadProperties();
      } catch (error) {
        showPropMessage(error.message, 'error');
      }
    });

    async function removeProperty(id) {
      if (!confirm(\`Remove property "\${id}"?\`)) return;

      try {
        const response = await fetch('/admin/properties/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showPropMessage(\`Property "\${id}" removed successfully!\`);
        loadProperties();
      } catch (error) {
        showPropMessage(error.message, 'error');
      }
    }

    // Hash verification only
    async function verifyDocumentHash(submissionId, activity) {
      try {
        const docResponse = await fetch('/admin/document?submission=' + submissionId + '&activity=' + activity);
        const docData = await docResponse.json();

        if (!docData.ok) {
          alert('Error: ' + docData.error);
          return;
        }

        const verifyResponse = await fetch('/admin/verify?document=' + docData.document_id);
        const verifyData = await verifyResponse.json();

        if (!verifyData.ok) {
          alert('Error: ' + verifyData.error);
          return;
        }

        if (verifyData.verified) {
          alert('\u2713 Hash Verified Successfully\\n\\nDocument ID: ' + docData.document_id + '\\nStored Hash: ' + verifyData.stored_hash.substring(0, 16) + '...\\nComputed Hash: ' + verifyData.computed_hash.substring(0, 16) + '...');
        } else {
          alert('\u2717 Hash Verification Failed\\n\\nDocument may have been tampered with\\nDocument ID: ' + docData.document_id + '\\nStored Hash: ' + verifyData.stored_hash.substring(0, 16) + '...\\nComputed Hash: ' + verifyData.computed_hash.substring(0, 16) + '...');
        }
      } catch (error) {
        alert('Error verifying hash: ' + error.message);
      }
    }

    async function downloadAllWaivers(submissionId) {
      window.location.href = '/admin/download-all?submission=' + submissionId;
    }

    // Legal Releases functionality
    async function loadReleases() {
      const currentReleaseDiv = document.getElementById('currentRelease');
      const historyDiv = document.getElementById('releaseHistory');

      try {
        const response = await fetch('/admin/releases');
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        // Display current release
        if (data.current) {
          const rel = data.current;
          currentReleaseDiv.innerHTML = \`
            <div style="padding: 15px; background: #f0f9ff; border-left: 4px solid #0070f3; border-radius: 4px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="font-size: 18px;">Version \${rel.version}</strong>
                <span style="color: #666; font-size: 14px;">\${new Date(rel.release_date).toLocaleDateString()}</span>
              </div>
              <div style="white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #333; margin-top: 10px;">\${rel.waiver_text}</div>
            </div>
          \`;
        } else {
          currentReleaseDiv.innerHTML = '<div class="empty">No releases yet. Create the first release below.</div>';
        }

        // Display history
        if (data.releases && data.releases.length > 0) {
          historyDiv.innerHTML = data.releases.map(rel => \`
            <div style="padding: 12px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>Version \${rel.version}</strong>
                <span style="color: #666; font-size: 13px;">\${new Date(rel.release_date).toLocaleDateString()}</span>
              </div>
              <div style="white-space: pre-wrap; font-size: 13px; line-height: 1.5; color: #555; margin-top: 8px; max-height: 100px; overflow-y: auto;">\${rel.waiver_text}</div>
            </div>
          \`).join('');
        } else {
          historyDiv.innerHTML = '<div class="empty">No release history</div>';
        }

        // Populate form with current waiver text
        if (data.current) {
          document.getElementById('waiverText').value = data.current.waiver_text;
        }
      } catch (error) {
        currentReleaseDiv.innerHTML = '<div class="error">Error loading releases: ' + error.message + '</div>';
        historyDiv.innerHTML = '';
      }
    }

    document.getElementById('releaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const version = document.getElementById('releaseVersion').value.trim();
      const waiverText = document.getElementById('waiverText').value.trim();

      try {
        const response = await fetch('/admin/releases/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ version: version || null, waiver_text: waiverText })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showReleaseMessage(\`Release version \${data.version} created successfully!\`);
        document.getElementById('releaseVersion').value = '';
        loadReleases();
      } catch (error) {
        showReleaseMessage(error.message, 'error');
      }
    });

    function showReleaseMessage(msg, type = 'success') {
      const div = document.getElementById('releaseMessage');
      div.innerHTML = \`<div class="\${type === 'error' ? 'error' : 'success'}">\${msg}</div>\`;
      setTimeout(() => div.innerHTML = '', 5000);
    }

    // Debug functionality
    async function loadDebugData(forceRefresh = false) {
      const kvDataDiv = document.getElementById('kvData');
      const d1TablesDiv = document.getElementById('d1Tables');
      const lastUpdateSpan = document.getElementById('debugLastUpdate');

      try {
        kvDataDiv.innerHTML = '<div class="loading">Loading KV data...</div>';
        d1TablesDiv.innerHTML = '<div class="loading">Loading D1 tables...</div>';

        const response = await fetch('/admin/debug' + (forceRefresh ? '?refresh=true' : ''));
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        // Display last update time
        const lastUpdate = new Date(data.lastUpdate);
        lastUpdateSpan.textContent = 'Last updated: ' + lastUpdate.toLocaleString();

        // Display KV data
        let kvHtml = '<h3>All KV Keys</h3>';
        if (data.kv && Object.keys(data.kv).length > 0) {
          for (const [key, value] of Object.entries(data.kv)) {
            kvHtml += '<div style="margin-bottom: 20px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px;">';
            kvHtml += '<strong style="color: #0070f3; font-family: monospace;">' + escapeHtml(key) + '</strong>';
            kvHtml += '<pre style="margin: 10px 0 0 0; padding: 10px; background: #f5f5f5; border-radius: 4px; overflow-x: auto; font-size: 12px;">' + escapeHtml(JSON.stringify(value, null, 2)) + '</pre>';
            kvHtml += '</div>';
          }
        } else {
          kvHtml += '<p style="color: #666;">No KV data found</p>';
        }
        kvDataDiv.innerHTML = kvHtml;

        // Display D1 tables
        let d1Html = '';
        if (data.d1 && Object.keys(data.d1).length > 0) {
          for (const [tableName, tableData] of Object.entries(data.d1)) {
            d1Html += '<div style="margin-bottom: 30px;">';
            d1Html += '<h3 style="margin-bottom: 10px;">' + escapeHtml(tableName) + ' (' + tableData.count + ' rows)</h3>';

            if (tableData.rows && tableData.rows.length > 0) {
              d1Html += '<div style="overflow-x: auto;">';
              d1Html += '<table style="width: 100%; border-collapse: collapse; background: white;">';

              // Table headers
              d1Html += '<thead><tr>';
              const columns = Object.keys(tableData.rows[0]);
              columns.forEach(col => {
                d1Html += '<th style="padding: 10px; text-align: left; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600;">' + escapeHtml(col) + '</th>';
              });
              d1Html += '</tr></thead>';

              // Table rows (limit to first 50 rows)
              d1Html += '<tbody>';
              tableData.rows.slice(0, 50).forEach(row => {
                d1Html += '<tr>';
                columns.forEach(col => {
                  let value = row[col];
                  if (value === null) value = '<em style="color: #999;">null</em>';
                  else if (typeof value === 'object') value = JSON.stringify(value);
                  else value = escapeHtml(String(value));
                  d1Html += '<td style="padding: 10px; border: 1px solid #ddd; font-size: 13px;">' + value + '</td>';
                });
                d1Html += '</tr>';
              });
              d1Html += '</tbody>';
              d1Html += '</table>';
              d1Html += '</div>';

              if (tableData.count > 50) {
                d1Html += '<p style="margin-top: 10px; color: #666; font-size: 13px;"><em>Showing first 50 of ' + tableData.count + ' rows</em></p>';
              }
            } else {
              d1Html += '<p style="color: #666;">No data in this table</p>';
            }
            d1Html += '</div>';
          }
        } else {
          d1Html += '<p style="color: #666;">No D1 tables found</p>';
        }
        d1TablesDiv.innerHTML = d1Html;

      } catch (error) {
        kvDataDiv.innerHTML = '<div class="error">Error loading KV data: ' + escapeHtml(error.message) + '</div>';
        d1TablesDiv.innerHTML = '<div class="error">Error loading D1 data: ' + escapeHtml(error.message) + '</div>';
      }
    }

    // API Documentation functionality
    function loadApiDocs() {
      const apiDocsDiv = document.getElementById('apiDocs');
      apiDocsDiv.innerHTML = \`<div class="loading">Loading API documentation...</div>\`;

      fetch('/admin/api-docs')
        .then(response => response.text())
        .then(markdown => {
          apiDocsDiv.innerHTML = convertMarkdownToHTML(markdown);
        })
        .catch(error => {
          apiDocsDiv.innerHTML = '<div class="error">Error loading API documentation</div>';
        });
    }

    // Simple markdown to HTML converter
    function convertMarkdownToHTML(markdown) {
      let html = markdown
        // Escape HTML
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // Headers
        .replace(/^### (.+)$/gm, '<h3 style="margin-top: 30px; color: #333;">$1</h3>')
        .replace(/^## (.+)$/gm, '<h2 style="margin-top: 40px; color: #0070f3; border-bottom: 2px solid #0070f3; padding-bottom: 10px;">$1</h2>')
        .replace(/^# (.+)$/gm, '<h1 style="color: #0070f3;">$1</h1>')
        // Bold
        .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')
        // Code blocks
        .replace(/\`\`\`(\\w+)?\\n([\\s\\S]*?)\`\`\`/g, '<pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; border: 1px solid #ddd;"><code>$2</code></pre>')
        // Inline code
        .replace(/\`([^\`]+)\`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em;">$1</code>')
        // Horizontal rule
        .replace(/^---$/gm, '<hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">')
        // Lists
        .replace(/^- (.+)$/gm, '<li style="margin: 5px 0;">$1</li>')
        // Wrap consecutive list items
        .replace(/(<li[^>]*>.*<\\/li>\\n?)+/g, '<ul style="margin: 10px 0; padding-left: 30px;">$&</ul>')
        // Paragraphs
        .replace(/^(?!<[h|u|p|l|d|c])(\\S.*)$/gm, '<p style="margin: 10px 0;">$1</p>');

      return html;
    }
  <\/script>
</body>
</html>`;
  return new Response(html, {
    headers: { "Content-Type": "text/html; charset=utf-8" }
  });
}
__name(handleAdmin, "handleAdmin");

// src/services/validation.js
function validateSubmission(data) {
  const must = [
    "propertyId",
    "checkinDate",
    "guestName",
    "guestEmail",
    "activities",
    "initials",
    "signature",
    "accepted"
  ];
  for (const k of must) {
    if (data[k] === void 0 || data[k] === "" || Array.isArray(data[k]) && !data[k].length) {
      return `missing ${k}`;
    }
  }
  if (data.accepted !== true) {
    return "master acceptance not ticked";
  }
  return null;
}
__name(validateSubmission, "validateSubmission");

// src/services/storage.js
async function saveSubmission(env2, subId, data, createdAt) {
  await env2.waivers.prepare(
    "INSERT INTO submissions VALUES(?1,?2,?3,?4,?5,?6,?7)"
  ).bind(
    subId,
    createdAt,
    data.propertyId,
    data.checkinDate,
    data.guestName,
    data.guestEmail,
    JSON.stringify(data.activities)
  ).run();
}
__name(saveSubmission, "saveSubmission");
async function saveDocuments(env2, subId, pdfInfos) {
  const now = (/* @__PURE__ */ new Date()).toISOString();
  for (const p of pdfInfos) {
    await env2.waivers.prepare(
      "INSERT INTO documents VALUES(?1,?2,?3,?4,?5)"
    ).bind(p.id, subId, p.activity, p.r2Key, p.initials).run();
    const hashId = `hash_${p.id}`;
    await env2.waivers.prepare(
      "INSERT INTO hashes VALUES(?1,?2,?3,?4)"
    ).bind(hashId, p.id, p.hash, now).run();
  }
}
__name(saveDocuments, "saveDocuments");

// src/services/pdf.js
async function generateDocumentHash(data) {
  const hashInput = JSON.stringify({
    submission_id: data.submission_id,
    property_id: data.property_id,
    checkin_date: data.checkin_date,
    guest_name: data.guest_name,
    guest_email: data.guest_email,
    activity: data.activity,
    activity_label: data.activity_label,
    initials: data.initials,
    signature_key: data.signature_key,
    created_at: data.created_at,
    release_version: data.release_version,
    release_date: data.release_date
  });
  const encoder = new TextEncoder();
  const dataBuffer = encoder.encode(hashInput);
  const hashBuffer = await crypto.subtle.digest("SHA-256", dataBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
  return hashHex;
}
__name(generateDocumentHash, "generateDocumentHash");
function generateWaiverHTML(data, activityInfo, riskData, latestRelease, documentId, documentHash) {
  const riskLevel = activityInfo?.risk || "medium";
  return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @page {
      size: A4;
      margin: 1in;
    }

    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      font-size: 11pt;
      line-height: 1.6;
      color: #000;
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 20pt;
      font-weight: bold;
      margin-bottom: 30px;
      text-transform: uppercase;
    }

    .details {
      margin-bottom: 30px;
      line-height: 2;
    }

    .risk-section {
      margin: 30px 0;
    }

    .risk-level {
      font-weight: bold;
      font-size: 12pt;
      margin-bottom: 10px;
    }

    .risk-description {
      color: #4a4a4a;
      font-size: 10pt;
      margin-bottom: 20px;
    }

    .waiver-section {
      margin: 30px 0;
    }

    .waiver-title {
      font-weight: bold;
      font-size: 12pt;
      margin-bottom: 10px;
    }

    .waiver-text {
      font-size: 9pt;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .signature-section {
      margin-top: 40px;
      page-break-inside: avoid;
    }

    .signature-label {
      font-size: 12pt;
      margin-bottom: 10px;
    }

    .signature-image {
      max-width: 400px;
      max-height: 150px;
    }

    .footer {
      position: fixed;
      bottom: 0.5in;
      right: 1in;
      text-align: right;
      font-size: 7pt;
      color: #808080;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <h1>${data.activity.toUpperCase()} \u2014 Release of Liability</h1>

  <div class="details">
    Property  : ${data.propertyId}<br>
    Check-in  : ${data.checkinDate}<br>
    Guest     : ${data.guestName}<br>
    Initials  : ${data.initials[data.activity]}
  </div>

  <div class="risk-section">
    <div class="risk-level">Risk Level: ${riskLevel.toUpperCase()}</div>
    ${riskData?.description ? `<div class="risk-description">${riskData.description}</div>` : ""}
  </div>

  <div class="waiver-section">
    <div class="waiver-title">Waiver and Release:</div>
    <div class="waiver-text">${latestRelease.waiver_text}</div>
  </div>

  <div class="signature-section">
    <div class="signature-label">Signature:</div>
    ${data.signature ? `<img src="${data.signature}" class="signature-image" />` : '<p style="color: #808080;">No signature provided</p>'}
  </div>

  <div class="footer">
    Legal Version ${latestRelease.version} (${latestRelease.release_date}) \u2022 Document ID: ${documentId}<br>
    Verification Hash: ${documentHash.substring(0, 32)}...
  </div>
</body>
</html>`;
}
__name(generateWaiverHTML, "generateWaiverHTML");
async function makePDFs(data, subId, env2) {
  const now = /* @__PURE__ */ new Date();
  const createdAt = now.toISOString();
  const y = now.getUTCFullYear();
  const m = String(now.getUTCMonth() + 1).padStart(2, "0");
  const d = String(now.getUTCDate()).padStart(2, "0");
  const latestRelease = await env2.waivers.prepare(
    "SELECT version, release_date, waiver_text FROM releases ORDER BY release_date DESC, version DESC LIMIT 1"
  ).first();
  if (!latestRelease) {
    throw new Error("No legal release found. Please create a release in the admin panel first.");
  }
  const activitiesResult = await env2.waivers.prepare(
    "SELECT slug, label, risk FROM activities WHERE property_id = ?"
  ).bind(data.propertyId).all();
  const activities = activitiesResult.results || [];
  const risksResult = await env2.waivers.prepare(
    "SELECT level, description FROM risk_descriptions"
  ).all();
  const risks = {};
  for (const row of risksResult.results || []) {
    risks[row.level] = { description: row.description };
  }
  let signatureKey = null;
  if (data.signature) {
    try {
      const signatureData = data.signature.split(",")[1];
      const signatureBytes = Uint8Array.from(atob(signatureData), (c) => c.charCodeAt(0));
      const nameParts = data.guestName.trim().split(/\s+/);
      const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, "") || "unknown";
      const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, "") : "unknown";
      signatureKey = `waivers/${y}/${m}/${d}/${data.propertyId}/signatures/${lastName}-${firstName}-${subId}.png`;
      await env2.WAIVERS_R2.put(signatureKey, signatureBytes, {
        httpMetadata: { contentType: "image/png" }
      });
    } catch (err) {
      console.error("Error saving signature to R2:", err);
    }
  }
  const results = [];
  for (const act of data.activities) {
    const activityInfo = activities.find((a) => a.slug === act);
    const riskLevel = activityInfo?.risk || "medium";
    const riskData = risks[riskLevel];
    const nameParts = data.guestName.trim().split(/\s+/);
    const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, "") || "unknown";
    const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, "") : "unknown";
    const documentId = nanoid(12);
    const hashData = {
      submission_id: subId,
      property_id: data.propertyId,
      checkin_date: data.checkinDate,
      guest_name: data.guestName,
      guest_email: data.guestEmail,
      activity: act,
      activity_label: activityInfo?.label || act,
      initials: data.initials[act],
      signature_key: signatureKey,
      created_at: createdAt,
      release_version: latestRelease.version,
      release_date: latestRelease.release_date
    };
    const documentHash = await generateDocumentHash(hashData);
    const htmlContent = generateWaiverHTML(
      { ...data, activity: act },
      activityInfo,
      riskData,
      latestRelease,
      documentId,
      documentHash
    );
    let pdfBytes;
    try {
      const browser = await env2.BROWSER.launch();
      const page = await browser.newPage();
      await page.setContent(htmlContent, { waitUntil: "networkidle" });
      pdfBytes = await page.pdf({
        format: "A4",
        printBackground: true,
        margin: {
          top: "1in",
          right: "1in",
          bottom: "1in",
          left: "1in"
        }
      });
      await browser.close();
    } catch (err) {
      console.error("Error generating PDF with browser rendering:", err);
      throw new Error(`Failed to generate PDF for activity ${act}: ${err.message}`);
    }
    const filename = `${lastName}-${firstName}-${subId}.pdf`;
    const key = `waivers/${y}/${m}/${d}/${data.propertyId}/${act}/${lastName}-${firstName}-${subId}.pdf`;
    await env2.WAIVERS_R2.put(key, pdfBytes, {
      httpMetadata: { contentType: "application/pdf" }
    });
    results.push({
      id: documentId,
      activity: act,
      filename,
      r2Key: key,
      bytes: pdfBytes,
      hash: documentHash,
      initials: data.initials[act]
    });
  }
  return results;
}
__name(makePDFs, "makePDFs");

// node_modules/resend/dist/index.mjs
var __defProp2 = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = /* @__PURE__ */ __name((obj, key, value) => key in obj ? __defProp2(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value, "__defNormalProp");
var __spreadValues = /* @__PURE__ */ __name((a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
}, "__spreadValues");
var __spreadProps = /* @__PURE__ */ __name((a, b) => __defProps(a, __getOwnPropDescs(b)), "__spreadProps");
var __objRest = /* @__PURE__ */ __name((source, exclude) => {
  var target = {};
  for (var prop in source)
    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)
      target[prop] = source[prop];
  if (source != null && __getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(source)) {
      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))
        target[prop] = source[prop];
    }
  return target;
}, "__objRest");
var __async = /* @__PURE__ */ __name((__this, __arguments, generator) => {
  return new Promise((resolve, reject) => {
    var fulfilled = /* @__PURE__ */ __name((value) => {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }, "fulfilled");
    var rejected = /* @__PURE__ */ __name((value) => {
      try {
        step(generator.throw(value));
      } catch (e) {
        reject(e);
      }
    }, "rejected");
    var step = /* @__PURE__ */ __name((x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected), "step");
    step((generator = generator.apply(__this, __arguments)).next());
  });
}, "__async");
var version2 = "6.1.1";
function buildPaginationQuery(options) {
  const searchParams = new URLSearchParams();
  if (options.limit !== void 0) {
    searchParams.set("limit", options.limit.toString());
  }
  if ("after" in options && options.after !== void 0) {
    searchParams.set("after", options.after);
  }
  if ("before" in options && options.before !== void 0) {
    searchParams.set("before", options.before);
  }
  return searchParams.toString();
}
__name(buildPaginationQuery, "buildPaginationQuery");
var ApiKeys = class {
  static {
    __name(this, "ApiKeys");
  }
  constructor(resend) {
    this.resend = resend;
  }
  create(_0) {
    return __async(this, arguments, function* (payload, options = {}) {
      const data = yield this.resend.post(
        "/api-keys",
        payload,
        options
      );
      return data;
    });
  }
  list() {
    return __async(this, arguments, function* (options = {}) {
      const queryString = buildPaginationQuery(options);
      const url = queryString ? `/api-keys?${queryString}` : "/api-keys";
      const data = yield this.resend.get(url);
      return data;
    });
  }
  remove(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.delete(
        `/api-keys/${id}`
      );
      return data;
    });
  }
};
var Audiences = class {
  static {
    __name(this, "Audiences");
  }
  constructor(resend) {
    this.resend = resend;
  }
  create(_0) {
    return __async(this, arguments, function* (payload, options = {}) {
      const data = yield this.resend.post(
        "/audiences",
        payload,
        options
      );
      return data;
    });
  }
  list() {
    return __async(this, arguments, function* (options = {}) {
      const queryString = buildPaginationQuery(options);
      const url = queryString ? `/audiences?${queryString}` : "/audiences";
      const data = yield this.resend.get(url);
      return data;
    });
  }
  get(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.get(
        `/audiences/${id}`
      );
      return data;
    });
  }
  remove(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.delete(
        `/audiences/${id}`
      );
      return data;
    });
  }
};
function parseAttachments(attachments) {
  return attachments == null ? void 0 : attachments.map((attachment) => ({
    content: attachment.content,
    filename: attachment.filename,
    path: attachment.path,
    content_type: attachment.contentType,
    content_id: attachment.contentId
  }));
}
__name(parseAttachments, "parseAttachments");
function parseEmailToApiOptions(email) {
  return {
    attachments: parseAttachments(email.attachments),
    bcc: email.bcc,
    cc: email.cc,
    from: email.from,
    headers: email.headers,
    html: email.html,
    reply_to: email.replyTo,
    scheduled_at: email.scheduledAt,
    subject: email.subject,
    tags: email.tags,
    text: email.text,
    to: email.to
  };
}
__name(parseEmailToApiOptions, "parseEmailToApiOptions");
function render(node) {
  return new Promise((resolve, reject) => {
    import("@react-email/render").then(({ render: render2 }) => {
      resolve(render2(node));
    }).catch(() => {
      reject(
        Error(
          "Failed to render React component. Make sure to install `@react-email/render`"
        )
      );
    });
  });
}
__name(render, "render");
var Batch = class {
  static {
    __name(this, "Batch");
  }
  constructor(resend) {
    this.resend = resend;
  }
  send(payload, options) {
    return __async(this, null, function* () {
      return this.create(payload, options);
    });
  }
  create(payload, options) {
    return __async(this, null, function* () {
      var _a;
      const emails = [];
      for (const email of payload) {
        if (email.react) {
          email.html = yield render(email.react);
          email.react = void 0;
        }
        emails.push(parseEmailToApiOptions(email));
      }
      const data = yield this.resend.post(
        "/emails/batch",
        emails,
        __spreadProps(__spreadValues({}, options), {
          headers: __spreadValues({
            "x-batch-validation": (_a = options == null ? void 0 : options.batchValidation) != null ? _a : "strict"
          }, options == null ? void 0 : options.headers)
        })
      );
      return data;
    });
  }
};
var Broadcasts = class {
  static {
    __name(this, "Broadcasts");
  }
  constructor(resend) {
    this.resend = resend;
  }
  create(_0) {
    return __async(this, arguments, function* (payload, options = {}) {
      if (payload.react) {
        payload.html = yield render(payload.react);
      }
      const data = yield this.resend.post(
        "/broadcasts",
        {
          name: payload.name,
          audience_id: payload.audienceId,
          preview_text: payload.previewText,
          from: payload.from,
          html: payload.html,
          reply_to: payload.replyTo,
          subject: payload.subject,
          text: payload.text
        },
        options
      );
      return data;
    });
  }
  send(id, payload) {
    return __async(this, null, function* () {
      const data = yield this.resend.post(
        `/broadcasts/${id}/send`,
        { scheduled_at: payload == null ? void 0 : payload.scheduledAt }
      );
      return data;
    });
  }
  list() {
    return __async(this, arguments, function* (options = {}) {
      const queryString = buildPaginationQuery(options);
      const url = queryString ? `/broadcasts?${queryString}` : "/broadcasts";
      const data = yield this.resend.get(url);
      return data;
    });
  }
  get(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.get(
        `/broadcasts/${id}`
      );
      return data;
    });
  }
  remove(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.delete(
        `/broadcasts/${id}`
      );
      return data;
    });
  }
  update(id, payload) {
    return __async(this, null, function* () {
      if (payload.react) {
        payload.html = yield render(payload.react);
      }
      const data = yield this.resend.patch(
        `/broadcasts/${id}`,
        {
          name: payload.name,
          audience_id: payload.audienceId,
          from: payload.from,
          html: payload.html,
          text: payload.text,
          subject: payload.subject,
          reply_to: payload.replyTo,
          preview_text: payload.previewText
        }
      );
      return data;
    });
  }
};
var Contacts = class {
  static {
    __name(this, "Contacts");
  }
  constructor(resend) {
    this.resend = resend;
  }
  create(_0) {
    return __async(this, arguments, function* (payload, options = {}) {
      const data = yield this.resend.post(
        `/audiences/${payload.audienceId}/contacts`,
        {
          unsubscribed: payload.unsubscribed,
          email: payload.email,
          first_name: payload.firstName,
          last_name: payload.lastName
        },
        options
      );
      return data;
    });
  }
  list(options) {
    return __async(this, null, function* () {
      const _a = options, { audienceId } = _a, paginationOptions = __objRest(_a, ["audienceId"]);
      const queryString = buildPaginationQuery(paginationOptions);
      const url = queryString ? `/audiences/${audienceId}/contacts?${queryString}` : `/audiences/${audienceId}/contacts`;
      const data = yield this.resend.get(url);
      return data;
    });
  }
  get(options) {
    return __async(this, null, function* () {
      if (!options.id && !options.email) {
        return {
          data: null,
          error: {
            message: "Missing `id` or `email` field.",
            name: "missing_required_field"
          }
        };
      }
      const data = yield this.resend.get(
        `/audiences/${options.audienceId}/contacts/${(options == null ? void 0 : options.email) ? options == null ? void 0 : options.email : options == null ? void 0 : options.id}`
      );
      return data;
    });
  }
  update(options) {
    return __async(this, null, function* () {
      if (!options.id && !options.email) {
        return {
          data: null,
          error: {
            message: "Missing `id` or `email` field.",
            name: "missing_required_field"
          }
        };
      }
      const data = yield this.resend.patch(
        `/audiences/${options.audienceId}/contacts/${(options == null ? void 0 : options.email) ? options == null ? void 0 : options.email : options == null ? void 0 : options.id}`,
        {
          unsubscribed: options.unsubscribed,
          first_name: options.firstName,
          last_name: options.lastName
        }
      );
      return data;
    });
  }
  remove(payload) {
    return __async(this, null, function* () {
      if (!payload.id && !payload.email) {
        return {
          data: null,
          error: {
            message: "Missing `id` or `email` field.",
            name: "missing_required_field"
          }
        };
      }
      const data = yield this.resend.delete(
        `/audiences/${payload.audienceId}/contacts/${(payload == null ? void 0 : payload.email) ? payload == null ? void 0 : payload.email : payload == null ? void 0 : payload.id}`
      );
      return data;
    });
  }
};
function parseDomainToApiOptions(domain2) {
  return {
    name: domain2.name,
    region: domain2.region,
    custom_return_path: domain2.customReturnPath
  };
}
__name(parseDomainToApiOptions, "parseDomainToApiOptions");
var Domains = class {
  static {
    __name(this, "Domains");
  }
  constructor(resend) {
    this.resend = resend;
  }
  create(_0) {
    return __async(this, arguments, function* (payload, options = {}) {
      const data = yield this.resend.post(
        "/domains",
        parseDomainToApiOptions(payload),
        options
      );
      return data;
    });
  }
  list() {
    return __async(this, arguments, function* (options = {}) {
      const queryString = buildPaginationQuery(options);
      const url = queryString ? `/domains?${queryString}` : "/domains";
      const data = yield this.resend.get(url);
      return data;
    });
  }
  get(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.get(
        `/domains/${id}`
      );
      return data;
    });
  }
  update(payload) {
    return __async(this, null, function* () {
      const data = yield this.resend.patch(
        `/domains/${payload.id}`,
        {
          click_tracking: payload.clickTracking,
          open_tracking: payload.openTracking,
          tls: payload.tls
        }
      );
      return data;
    });
  }
  remove(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.delete(
        `/domains/${id}`
      );
      return data;
    });
  }
  verify(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.post(
        `/domains/${id}/verify`
      );
      return data;
    });
  }
};
var Emails = class {
  static {
    __name(this, "Emails");
  }
  constructor(resend) {
    this.resend = resend;
  }
  send(_0) {
    return __async(this, arguments, function* (payload, options = {}) {
      return this.create(payload, options);
    });
  }
  create(_0) {
    return __async(this, arguments, function* (payload, options = {}) {
      if (payload.react) {
        payload.html = yield render(payload.react);
      }
      const data = yield this.resend.post(
        "/emails",
        parseEmailToApiOptions(payload),
        options
      );
      return data;
    });
  }
  get(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.get(
        `/emails/${id}`
      );
      return data;
    });
  }
  list() {
    return __async(this, arguments, function* (options = {}) {
      const queryString = buildPaginationQuery(options);
      const url = queryString ? `/emails?${queryString}` : "/emails";
      const data = yield this.resend.get(url);
      return data;
    });
  }
  update(payload) {
    return __async(this, null, function* () {
      const data = yield this.resend.patch(
        `/emails/${payload.id}`,
        {
          scheduled_at: payload.scheduledAt
        }
      );
      return data;
    });
  }
  cancel(id) {
    return __async(this, null, function* () {
      const data = yield this.resend.post(
        `/emails/${id}/cancel`
      );
      return data;
    });
  }
};
var defaultBaseUrl = "https://api.resend.com";
var defaultUserAgent = `resend-node:${version2}`;
var baseUrl = typeof process !== "undefined" && process.env ? process.env.RESEND_BASE_URL || defaultBaseUrl : defaultBaseUrl;
var userAgent = typeof process !== "undefined" && process.env ? process.env.RESEND_USER_AGENT || defaultUserAgent : defaultUserAgent;
var Resend = class {
  static {
    __name(this, "Resend");
  }
  constructor(key) {
    this.key = key;
    this.apiKeys = new ApiKeys(this);
    this.audiences = new Audiences(this);
    this.batch = new Batch(this);
    this.broadcasts = new Broadcasts(this);
    this.contacts = new Contacts(this);
    this.domains = new Domains(this);
    this.emails = new Emails(this);
    if (!key) {
      if (typeof process !== "undefined" && process.env) {
        this.key = process.env.RESEND_API_KEY;
      }
      if (!this.key) {
        throw new Error(
          'Missing API key. Pass it to the constructor `new Resend("re_123")`'
        );
      }
    }
    this.headers = new Headers({
      Authorization: `Bearer ${this.key}`,
      "User-Agent": userAgent,
      "Content-Type": "application/json"
    });
  }
  fetchRequest(_0) {
    return __async(this, arguments, function* (path, options = {}) {
      try {
        const response = yield fetch(`${baseUrl}${path}`, options);
        if (!response.ok) {
          try {
            const rawError = yield response.text();
            return { data: null, error: JSON.parse(rawError) };
          } catch (err) {
            if (err instanceof SyntaxError) {
              return {
                data: null,
                error: {
                  name: "application_error",
                  message: "Internal server error. We are unable to process your request right now, please try again later."
                }
              };
            }
            const error3 = {
              message: response.statusText,
              name: "application_error"
            };
            if (err instanceof Error) {
              return { data: null, error: __spreadProps(__spreadValues({}, error3), { message: err.message }) };
            }
            return { data: null, error: error3 };
          }
        }
        const data = yield response.json();
        return { data, error: null };
      } catch (e) {
        return {
          data: null,
          error: {
            name: "application_error",
            message: "Unable to fetch data. The request could not be resolved."
          }
        };
      }
    });
  }
  post(_0, _1) {
    return __async(this, arguments, function* (path, entity, options = {}) {
      const headers = new Headers(this.headers);
      if (options.headers) {
        for (const [key, value] of new Headers(options.headers).entries()) {
          headers.set(key, value);
        }
      }
      if (options.idempotencyKey) {
        headers.set("Idempotency-Key", options.idempotencyKey);
      }
      const requestOptions = __spreadProps(__spreadValues({
        method: "POST",
        body: JSON.stringify(entity)
      }, options), {
        headers
      });
      return this.fetchRequest(path, requestOptions);
    });
  }
  get(_0) {
    return __async(this, arguments, function* (path, options = {}) {
      const headers = new Headers(this.headers);
      if (options.headers) {
        for (const [key, value] of new Headers(options.headers).entries()) {
          headers.set(key, value);
        }
      }
      const requestOptions = __spreadProps(__spreadValues({
        method: "GET"
      }, options), {
        headers
      });
      return this.fetchRequest(path, requestOptions);
    });
  }
  put(_0, _1) {
    return __async(this, arguments, function* (path, entity, options = {}) {
      const headers = new Headers(this.headers);
      if (options.headers) {
        for (const [key, value] of new Headers(options.headers).entries()) {
          headers.set(key, value);
        }
      }
      const requestOptions = __spreadProps(__spreadValues({
        method: "PUT",
        body: JSON.stringify(entity)
      }, options), {
        headers
      });
      return this.fetchRequest(path, requestOptions);
    });
  }
  patch(_0, _1) {
    return __async(this, arguments, function* (path, entity, options = {}) {
      const headers = new Headers(this.headers);
      if (options.headers) {
        for (const [key, value] of new Headers(options.headers).entries()) {
          headers.set(key, value);
        }
      }
      const requestOptions = __spreadProps(__spreadValues({
        method: "PATCH",
        body: JSON.stringify(entity)
      }, options), {
        headers
      });
      return this.fetchRequest(path, requestOptions);
    });
  }
  delete(path, query) {
    return __async(this, null, function* () {
      const requestOptions = {
        method: "DELETE",
        body: JSON.stringify(query),
        headers: this.headers
      };
      return this.fetchRequest(path, requestOptions);
    });
  }
};

// src/services/mail.js
async function sendVerificationEmail(email, name, verificationUrl, env2) {
  const resend = new Resend(env2.RESEND_API_KEY);
  const bodyText = `Hi ${name},

Thank you for starting your activity waiver submission!

Please click the link below to continue and complete your waiver:
${verificationUrl}

This link will expire in 24 hours.

If you didn't request this waiver, you can safely ignore this email.

Regards,
The Rentals Team`;
  const bodyHtml = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
      <h2 style="color: #3b82f6;">Complete Your Activity Waiver</h2>
      <p>Hi ${name},</p>
      <p>Thank you for starting your activity waiver submission!</p>
      <p>Please click the button below to continue and complete your waiver:</p>
      <div style="margin: 30px 0;">
        <a href="${verificationUrl}" style="background-color: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;">
          Complete Your Waiver
        </a>
      </div>
      <p style="color: #64748b; font-size: 14px;">This link will expire in 24 hours.</p>
      <p style="color: #64748b; font-size: 14px;">If you didn't request this waiver, you can safely ignore this email.</p>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 30px 0;">
      <p style="color: #94a3b8; font-size: 12px;">Regards,<br>The Rentals Team</p>
    </div>
  `;
  try {
    const { data: emailData, error: error3 } = await resend.emails.send({
      from: `Activity Waivers <${env2.EMAIL_FROM}>`,
      to: email,
      subject: "Complete Your Activity Waiver",
      text: bodyText,
      html: bodyHtml
    });
    if (error3) {
      console.error("Resend error:", error3);
      throw new Error(error3.message);
    }
    console.log("Verification email sent successfully:", emailData);
  } catch (error3) {
    console.error("Verification email send error:", error3);
    throw new Error("Failed to send verification email: " + error3.message);
  }
}
__name(sendVerificationEmail, "sendVerificationEmail");
async function sendWaiverEmail(data, pdfs, pin, env2) {
  const resend = new Resend(env2.RESEND_API_KEY);
  const bodyText = `Hi ${data.guestName},

Thank you for completing your waiver for ${data.propertyId}.
Attached: ${pdfs.map((p) => p.filename).join(", ")}

${pin ? "Your Archery PIN is " + pin + "\n\n" : ""}Regards,
The Rentals Team`;
  try {
    const { data: emailData, error: error3 } = await resend.emails.send({
      from: `Activity Waivers <${env2.EMAIL_FROM}>`,
      to: data.guestEmail,
      subject: "Your activity waiver(s)",
      text: bodyText,
      attachments: pdfs.map((p) => ({
        filename: p.filename,
        content: btoa(String.fromCharCode(...new Uint8Array(p.bytes)))
      }))
    });
    if (error3) {
      console.error("Resend error:", error3);
      throw new Error(error3.message);
    }
    console.log("Email sent successfully:", emailData);
  } catch (error3) {
    console.error("Email send error:", error3);
    throw new Error("Failed to send email: " + error3.message);
  }
}
__name(sendWaiverEmail, "sendWaiverEmail");
async function sendMail(data, pdfs, pin, env2) {
  const resend = new Resend(env2.RESEND_API_KEY);
  const bodyText = `Hi ${data.guestName},

Thank you for completing your waiver for ${data.propertyId}.
Attached: ${pdfs.map((p) => p.filename).join(", ")}

${pin ? "Your Archery PIN is " + pin + "\n\n" : ""}Regards,
The Rentals Team`;
  try {
    const { data: emailData, error: error3 } = await resend.emails.send({
      from: `Activity Waivers <${env2.EMAIL_FROM}>`,
      to: data.guestEmail,
      subject: "Your activity waiver(s)",
      text: bodyText,
      attachments: pdfs.map((p) => ({
        filename: p.filename,
        content: btoa(String.fromCharCode(...new Uint8Array(p.bytes)))
      }))
    });
    if (error3) {
      console.error("Resend error:", error3);
      throw new Error(error3.message);
    }
    console.log("Email sent successfully:", emailData);
  } catch (error3) {
    console.error("Email send error:", error3);
    throw new Error("Failed to send email: " + error3.message);
  }
}
__name(sendMail, "sendMail");

// src/routes/submit.js
async function handleSubmit(request, env2) {
  console.log("Submit endpoint called");
  const data = await request.json();
  console.log("Received data:", data);
  const validationError = validateSubmission(data);
  if (validationError) {
    return bad(validationError);
  }
  const subId = nanoid(10);
  const createdAt = (/* @__PURE__ */ new Date()).toISOString();
  try {
    await saveSubmission(env2, subId, data, createdAt);
    console.log("Submission saved to database");
  } catch (dbError) {
    console.error("Database error:", dbError);
    return json({ ok: false, error: "Database not initialized. Run migrations first." }, 500);
  }
  let pdfInfos;
  try {
    pdfInfos = await makePDFs(data, subId, env2);
    console.log("PDFs generated:", pdfInfos.length);
  } catch (pdfError) {
    console.error("PDF generation error:", pdfError);
    return json({ ok: false, error: "PDF generation failed: " + pdfError.message }, 500);
  }
  try {
    await saveDocuments(env2, subId, pdfInfos);
    console.log("Document records saved");
  } catch (docError) {
    console.error("Document save error:", docError);
  }
  const pin = data.activities.includes("archery") ? env2.ARCHERY_PIN : null;
  if (env2.DEV_MODE === "true") {
    const downloads = pdfInfos.map((p) => ({
      filename: p.filename,
      url: `/download/${p.r2Key}`
    }));
    return json({
      ok: true,
      devMode: true,
      downloads,
      pin
    });
  }
  try {
    await sendMail(data, pdfInfos, pin, env2);
    console.log("Email sent successfully");
  } catch (emailError) {
    console.error("Email sending failed:", emailError);
    return json({ ok: false, error: "Email sending failed: " + emailError.message }, 500);
  }
  return json({
    ok: true,
    emailed: pdfInfos.map((p) => p.filename),
    pin
  });
}
__name(handleSubmit, "handleSubmit");

// src/routes/submit-flow.js
async function handleInitialSubmit(request, env2) {
  try {
    const data = await request.json();
    if (!data.propertyId || !data.checkinDate || !data.guestName || !data.guestEmail) {
      return new Response(JSON.stringify({ ok: false, error: "Missing required fields" }), {
        status: 400,
        headers: { "content-type": "application/json" }
      });
    }
    const submissionId = nanoid(12);
    const verificationToken = nanoid(32);
    const createdAt = (/* @__PURE__ */ new Date()).toISOString();
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1e3).toISOString();
    await env2.waivers.prepare(
      `INSERT INTO submissions
       (submission_id, created_at, property_id, checkin_date, guest_name, guest_email, activities,
        status, verification_token, token_expires_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
    ).bind(
      submissionId,
      createdAt,
      data.propertyId,
      data.checkinDate,
      data.guestName,
      data.guestEmail,
      "[]",
      // Empty activities initially
      "pending",
      verificationToken,
      expiresAt
    ).run();
    const verificationUrl = `${new URL(request.url).origin}/?token=${verificationToken}`;
    if (env2.DEV_MODE === "true") {
      console.log("Dev Mode: Verification email would be sent to:", data.guestEmail);
      console.log("Dev Mode: Verification URL:", verificationUrl);
      return new Response(JSON.stringify({
        ok: true,
        devMode: true,
        submissionId,
        verificationUrl
      }), {
        headers: { "content-type": "application/json" }
      });
    } else {
      await sendVerificationEmail(data.guestEmail, data.guestName, verificationUrl, env2);
      return new Response(JSON.stringify({
        ok: true,
        submissionId
      }), {
        headers: { "content-type": "application/json" }
      });
    }
  } catch (error3) {
    console.error("Initial submission error:", error3);
    return new Response(JSON.stringify({ ok: false, error: error3.message }), {
      status: 500,
      headers: { "content-type": "application/json" }
    });
  }
}
__name(handleInitialSubmit, "handleInitialSubmit");
async function handleCompleteSubmit(request, env2) {
  try {
    const data = await request.json();
    if (!data.submissionId || !data.activities || !data.initials || !data.signature || !data.accepted) {
      return new Response(JSON.stringify({ ok: false, error: "Missing required fields" }), {
        status: 400,
        headers: { "content-type": "application/json" }
      });
    }
    const submission = await env2.waivers.prepare(
      "SELECT * FROM submissions WHERE submission_id = ? AND status = ?"
    ).bind(data.submissionId, "pending").first();
    if (!submission) {
      return new Response(JSON.stringify({ ok: false, error: "Invalid or expired submission" }), {
        status: 404,
        headers: { "content-type": "application/json" }
      });
    }
    const expires = new Date(submission.token_expires_at);
    if (expires < /* @__PURE__ */ new Date()) {
      return new Response(JSON.stringify({ ok: false, error: "Verification token expired" }), {
        status: 410,
        headers: { "content-type": "application/json" }
      });
    }
    const completedAt = (/* @__PURE__ */ new Date()).toISOString();
    await env2.waivers.prepare(
      "UPDATE submissions SET activities = ?, status = ?, completed_at = ? WHERE submission_id = ?"
    ).bind(
      JSON.stringify(data.activities),
      "completed",
      completedAt,
      data.submissionId
    ).run();
    const submissionData = {
      propertyId: submission.property_id,
      checkinDate: submission.checkin_date,
      guestName: submission.guest_name,
      guestEmail: submission.guest_email,
      activities: data.activities,
      initials: data.initials,
      signature: data.signature
    };
    const pdfs = await makePDFs(submissionData, data.submissionId, env2);
    let archeryPin = null;
    if (data.activities.includes("archery")) {
      archeryPin = env2.ARCHERY_PIN || "1234";
    }
    if (env2.DEV_MODE === "true") {
      const downloads = pdfs.map((p) => ({
        filename: p.filename,
        url: `/download/${p.id}`
      }));
      return new Response(JSON.stringify({
        ok: true,
        devMode: true,
        downloads,
        pin: archeryPin
      }), {
        headers: { "content-type": "application/json" }
      });
    } else {
      await sendWaiverEmail(submissionData, pdfs, archeryPin, env2);
      return new Response(JSON.stringify({
        ok: true,
        emailed: pdfs.map((p) => p.filename),
        pin: archeryPin
      }), {
        headers: { "content-type": "application/json" }
      });
    }
  } catch (error3) {
    console.error("Complete submission error:", error3);
    return new Response(JSON.stringify({ ok: false, error: error3.message }), {
      status: 500,
      headers: { "content-type": "application/json" }
    });
  }
}
__name(handleCompleteSubmit, "handleCompleteSubmit");

// src/routes/admin/search.js
async function handleAdminSearch(request, env2) {
  const url = new URL(request.url);
  const qName = url.searchParams.get("name") ?? "";
  const qEmail = url.searchParams.get("email") ?? "";
  const qProp = url.searchParams.get("prop") ?? "";
  const qDate = url.searchParams.get("date") ?? "";
  const qActivity = url.searchParams.get("activity") ?? "";
  const conditions = [];
  const params = [];
  if (qName) {
    conditions.push("guest_name LIKE ?");
    params.push(`%${qName}%`);
  }
  if (qEmail) {
    conditions.push("guest_email LIKE ?");
    params.push(`%${qEmail}%`);
  }
  if (qProp) {
    conditions.push("property_id LIKE ?");
    params.push(`%${qProp}%`);
  }
  if (qDate) {
    conditions.push("checkin_date LIKE ?");
    params.push(`%${qDate}%`);
  }
  if (qActivity) {
    conditions.push("activities LIKE ?");
    params.push(`%${qActivity}%`);
  }
  const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(" AND ")}` : "";
  const query = `SELECT * FROM submissions
                 ${whereClause}
                 ORDER BY created_at DESC
                 LIMIT 200`;
  const rows = await env2.waivers.prepare(query).bind(...params).all();
  return json({ rows });
}
__name(handleAdminSearch, "handleAdminSearch");

// src/routes/admin/activities.js
async function handleAdminActivities(request, env2) {
  const url = new URL(request.url);
  const { pathname } = url;
  const propertyId = url.searchParams.get("property") || "cabin-12";
  if (request.method === "GET") {
    return await getActivities(env2, propertyId);
  }
  if (request.method === "POST") {
    if (pathname === "/admin/activities/add") {
      return await addActivity(request, env2, propertyId);
    }
    if (pathname === "/admin/activities/remove") {
      return await removeActivity(request, env2, propertyId);
    }
    if (pathname === "/admin/activities/update") {
      return await updateActivity(request, env2, propertyId);
    }
    return await replaceAllActivities(request, env2, propertyId);
  }
  return new Response("Method not allowed", { status: 405 });
}
__name(handleAdminActivities, "handleAdminActivities");
async function getActivities(env2, propertyId) {
  const result = await env2.waivers.prepare(
    "SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label"
  ).bind(propertyId).all();
  return json({ ok: true, propertyId, activities: result.results || [] });
}
__name(getActivities, "getActivities");
async function addActivity(request, env2, propertyId) {
  const data = await request.json();
  if (!data.slug || !data.label || !data.risk) {
    return json({ ok: false, error: "Must provide slug, label, and risk" }, 400);
  }
  const existingCheck = await env2.waivers.prepare(
    "SELECT id FROM activities WHERE property_id = ? AND slug = ?"
  ).bind(propertyId, data.slug).first();
  if (existingCheck) {
    return json({ ok: false, error: "Activity with this slug already exists" }, 400);
  }
  await env2.waivers.prepare(
    "INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)"
  ).bind(propertyId, data.slug, data.label, data.risk, (/* @__PURE__ */ new Date()).toISOString()).run();
  const result = await env2.waivers.prepare(
    "SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label"
  ).bind(propertyId).all();
  return json({ ok: true, propertyId, activities: result.results || [], added: data.slug });
}
__name(addActivity, "addActivity");
async function removeActivity(request, env2, propertyId) {
  const data = await request.json();
  if (!data.slug) {
    return json({ ok: false, error: "Must provide slug" }, 400);
  }
  const existingCheck = await env2.waivers.prepare(
    "SELECT id FROM activities WHERE property_id = ? AND slug = ?"
  ).bind(propertyId, data.slug).first();
  if (!existingCheck) {
    return json({ ok: false, error: "Activity not found" }, 404);
  }
  await env2.waivers.prepare(
    "DELETE FROM activities WHERE property_id = ? AND slug = ?"
  ).bind(propertyId, data.slug).run();
  const result = await env2.waivers.prepare(
    "SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label"
  ).bind(propertyId).all();
  return json({ ok: true, propertyId, activities: result.results || [], removed: data.slug });
}
__name(removeActivity, "removeActivity");
async function updateActivity(request, env2, propertyId) {
  const data = await request.json();
  if (!data.slug) {
    return json({ ok: false, error: "Must provide slug" }, 400);
  }
  const existingCheck = await env2.waivers.prepare(
    "SELECT id FROM activities WHERE property_id = ? AND slug = ?"
  ).bind(propertyId, data.slug).first();
  if (!existingCheck) {
    return json({ ok: false, error: "Activity not found" }, 404);
  }
  const updates = [];
  const bindings = [];
  if (data.label) {
    updates.push("label = ?");
    bindings.push(data.label);
  }
  if (data.risk) {
    updates.push("risk = ?");
    bindings.push(data.risk);
  }
  if (updates.length > 0) {
    bindings.push(propertyId, data.slug);
    await env2.waivers.prepare(
      `UPDATE activities SET ${updates.join(", ")} WHERE property_id = ? AND slug = ?`
    ).bind(...bindings).run();
  }
  const result = await env2.waivers.prepare(
    "SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label"
  ).bind(propertyId).all();
  return json({ ok: true, propertyId, activities: result.results || [], updated: data.slug });
}
__name(updateActivity, "updateActivity");
async function replaceAllActivities(request, env2, propertyId) {
  const data = await request.json();
  if (!Array.isArray(data.activities)) {
    return json({ ok: false, error: "activities must be an array" }, 400);
  }
  for (const activity of data.activities) {
    if (!activity.slug || !activity.label || !activity.risk) {
      return json({ ok: false, error: "Each activity must have slug, label, and risk" }, 400);
    }
  }
  await env2.waivers.prepare(
    "DELETE FROM activities WHERE property_id = ?"
  ).bind(propertyId).run();
  const timestamp = (/* @__PURE__ */ new Date()).toISOString();
  for (const activity of data.activities) {
    await env2.waivers.prepare(
      "INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)"
    ).bind(propertyId, activity.slug, activity.label, activity.risk, timestamp).run();
  }
  const result = await env2.waivers.prepare(
    "SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label"
  ).bind(propertyId).all();
  return json({ ok: true, propertyId, activities: result.results || [] });
}
__name(replaceAllActivities, "replaceAllActivities");

// src/routes/admin/risks.js
async function handleAdminRisks(request, env2) {
  const url = new URL(request.url);
  const level = url.searchParams.get("level");
  if (request.method === "GET") {
    if (level) {
      return await getRisk(env2, level);
    }
    return await getAllRisks(env2);
  }
  if (request.method === "POST") {
    return await updateRisk(request, env2);
  }
  return new Response("Method not allowed", { status: 405 });
}
__name(handleAdminRisks, "handleAdminRisks");
async function getAllRisks(env2) {
  const result = await env2.waivers.prepare(
    "SELECT level, description FROM risk_descriptions"
  ).all();
  const risks = {};
  for (const row of result.results || []) {
    risks[row.level] = { level: row.level, description: row.description };
  }
  return json({ ok: true, risks });
}
__name(getAllRisks, "getAllRisks");
async function getRisk(env2, level) {
  const result = await env2.waivers.prepare(
    "SELECT level, description FROM risk_descriptions WHERE level = ?"
  ).bind(level).first();
  if (!result) {
    return json({ ok: false, error: "Risk level not found" }, 404);
  }
  return json({ ok: true, risk: { level: result.level, description: result.description } });
}
__name(getRisk, "getRisk");
async function updateRisk(request, env2) {
  const data = await request.json();
  if (!data.level || !data.description) {
    return json({ ok: false, error: "Must provide level and description" }, 400);
  }
  if (!["low", "medium", "high"].includes(data.level)) {
    return json({ ok: false, error: "level must be low, medium, or high" }, 400);
  }
  const existingCheck = await env2.waivers.prepare(
    "SELECT level FROM risk_descriptions WHERE level = ?"
  ).bind(data.level).first();
  if (existingCheck) {
    await env2.waivers.prepare(
      "UPDATE risk_descriptions SET description = ? WHERE level = ?"
    ).bind(data.description, data.level).run();
  } else {
    await env2.waivers.prepare(
      "INSERT INTO risk_descriptions (level, description, created_at) VALUES (?, ?, ?)"
    ).bind(data.level, data.description, (/* @__PURE__ */ new Date()).toISOString()).run();
  }
  const riskData = {
    level: data.level,
    description: data.description
  };
  return json({ ok: true, risk: riskData });
}
__name(updateRisk, "updateRisk");

// src/routes/admin/properties.js
async function handleAdminProperties(request, env2) {
  const url = new URL(request.url);
  const { pathname } = url;
  if (request.method === "GET") {
    return await getProperties(env2);
  }
  if (request.method === "POST") {
    if (pathname === "/admin/properties/add") {
      return await addProperty(request, env2);
    }
    if (pathname === "/admin/properties/remove") {
      return await removeProperty(request, env2);
    }
  }
  return new Response("Method not allowed", { status: 405 });
}
__name(handleAdminProperties, "handleAdminProperties");
async function getProperties(env2) {
  const result = await env2.waivers.prepare(
    "SELECT id, name FROM properties WHERE id != ? ORDER BY name"
  ).bind("default").all();
  return json({ ok: true, properties: result.results || [] });
}
__name(getProperties, "getProperties");
async function addProperty(request, env2) {
  const data = await request.json();
  if (!data.id || !data.name) {
    return json({ ok: false, error: "Must provide id and name" }, 400);
  }
  const existingCheck = await env2.waivers.prepare(
    "SELECT id FROM properties WHERE id = ?"
  ).bind(data.id).first();
  if (existingCheck) {
    return json({ ok: false, error: "Property with this ID already exists" }, 400);
  }
  await env2.waivers.prepare(
    "INSERT INTO properties (id, name, created_at) VALUES (?, ?, ?)"
  ).bind(data.id, data.name, (/* @__PURE__ */ new Date()).toISOString()).run();
  if (data.copyDefaultActivities) {
    const defaultActivities = await env2.waivers.prepare(
      "SELECT slug, label, risk FROM activities WHERE property_id = ?"
    ).bind("default").all();
    for (const activity of defaultActivities.results || []) {
      await env2.waivers.prepare(
        "INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)"
      ).bind(data.id, activity.slug, activity.label, activity.risk, (/* @__PURE__ */ new Date()).toISOString()).run();
    }
  }
  const result = await env2.waivers.prepare(
    "SELECT id, name FROM properties WHERE id != ? ORDER BY name"
  ).bind("default").all();
  return json({ ok: true, properties: result.results || [], added: data.id });
}
__name(addProperty, "addProperty");
async function removeProperty(request, env2) {
  const data = await request.json();
  if (!data.id) {
    return json({ ok: false, error: "Must provide id" }, 400);
  }
  const countResult = await env2.waivers.prepare(
    "SELECT COUNT(*) as count FROM properties WHERE id != ?"
  ).bind("default").first();
  if (countResult.count <= 1) {
    return json({ ok: false, error: "Cannot delete the last property" }, 400);
  }
  if (data.id === "default") {
    return json({ ok: false, error: "Cannot delete the default property template" }, 400);
  }
  const existingCheck = await env2.waivers.prepare(
    "SELECT id FROM properties WHERE id = ?"
  ).bind(data.id).first();
  if (!existingCheck) {
    return json({ ok: false, error: "Property not found" }, 404);
  }
  await env2.waivers.prepare(
    "DELETE FROM properties WHERE id = ?"
  ).bind(data.id).run();
  const result = await env2.waivers.prepare(
    "SELECT id, name FROM properties WHERE id != ? ORDER BY name"
  ).bind("default").all();
  return json({ ok: true, properties: result.results || [], removed: data.id });
}
__name(removeProperty, "removeProperty");

// src/routes/admin/document.js
async function handleAdminDocument(request, env2) {
  const url = new URL(request.url);
  const submissionId = url.searchParams.get("submission");
  const activity = url.searchParams.get("activity");
  if (!submissionId || !activity) {
    return json({ ok: false, error: "Missing submission or activity" }, 400);
  }
  try {
    const result = await env2.waivers.prepare(
      "SELECT document_id, r2_key FROM documents WHERE submission_id = ?1 AND activity = ?2"
    ).bind(submissionId, activity).first();
    if (!result) {
      return json({ ok: false, error: "Document not found" }, 404);
    }
    return json({
      ok: true,
      document_id: result.document_id,
      r2_key: result.r2_key
    });
  } catch (error3) {
    return json({ ok: false, error: error3.message }, 500);
  }
}
__name(handleAdminDocument, "handleAdminDocument");

// src/routes/admin/verify.js
async function generateDocumentHash2(data) {
  const hashInput = JSON.stringify({
    submission_id: data.submission_id,
    property_id: data.property_id,
    checkin_date: data.checkin_date,
    guest_name: data.guest_name,
    guest_email: data.guest_email,
    activity: data.activity,
    activity_label: data.activity_label,
    initials: data.initials,
    signature_key: data.signature_key,
    created_at: data.created_at,
    release_version: data.release_version,
    release_date: data.release_date
  });
  const encoder = new TextEncoder();
  const dataBuffer = encoder.encode(hashInput);
  const hashBuffer = await crypto.subtle.digest("SHA-256", dataBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
  return hashHex;
}
__name(generateDocumentHash2, "generateDocumentHash");
async function handleAdminVerify(request, env2) {
  const url = new URL(request.url);
  const documentId = url.searchParams.get("document");
  if (!documentId) {
    return json({ ok: false, error: "Missing document ID" }, 400);
  }
  try {
    const hashResult = await env2.waivers.prepare(
      "SELECT hash_value FROM hashes WHERE document_id = ?1"
    ).bind(documentId).first();
    if (!hashResult) {
      return json({ ok: false, error: "Hash not found" }, 404);
    }
    const docData = await env2.waivers.prepare(`
      SELECT
        d.activity,
        d.initials,
        s.submission_id,
        s.created_at,
        s.property_id,
        s.checkin_date,
        s.guest_name,
        s.guest_email
      FROM documents d
      JOIN submissions s ON d.submission_id = s.submission_id
      WHERE d.document_id = ?1
    `).bind(documentId).first();
    if (!docData) {
      return json({ ok: false, error: "Document not found" }, 404);
    }
    const activityResult = await env2.waivers.prepare(
      "SELECT label FROM activities WHERE property_id = ? AND slug = ?"
    ).bind(docData.property_id, docData.activity).first();
    const activityInfo = activityResult ? { label: activityResult.label } : null;
    const nameParts = docData.guest_name.trim().split(/\s+/);
    const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, "") || "unknown";
    const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, "") : "unknown";
    const createdDate = new Date(docData.created_at);
    const y = createdDate.getUTCFullYear();
    const m = String(createdDate.getUTCMonth() + 1).padStart(2, "0");
    const d = String(createdDate.getUTCDate()).padStart(2, "0");
    const signatureKey = `waivers/${y}/${m}/${d}/${docData.property_id}/signatures/${lastName}-${firstName}-${docData.submission_id}.png`;
    const release2 = await env2.waivers.prepare(
      "SELECT version, release_date FROM releases WHERE release_date <= ?1 ORDER BY release_date DESC, version DESC LIMIT 1"
    ).bind(docData.created_at.split("T")[0]).first();
    if (!release2) {
      return json({ ok: false, error: "No release found for document creation date" }, 404);
    }
    const hashData = {
      submission_id: docData.submission_id,
      property_id: docData.property_id,
      checkin_date: docData.checkin_date,
      guest_name: docData.guest_name,
      guest_email: docData.guest_email,
      activity: docData.activity,
      activity_label: activityInfo?.label || docData.activity,
      initials: docData.initials || "",
      signature_key: signatureKey,
      created_at: docData.created_at,
      release_version: release2.version,
      release_date: release2.release_date
    };
    const computedHash = await generateDocumentHash2(hashData);
    const verified = computedHash === hashResult.hash_value;
    return json({
      ok: true,
      verified,
      stored_hash: hashResult.hash_value,
      computed_hash: computedHash
    });
  } catch (error3) {
    return json({ ok: false, error: error3.message }, 500);
  }
}
__name(handleAdminVerify, "handleAdminVerify");

// src/routes/admin/releases.js
async function getLatestRelease(env2) {
  return await env2.waivers.prepare(
    "SELECT version, release_date, waiver_text, created_at FROM releases ORDER BY release_date DESC, version DESC LIMIT 1"
  ).first();
}
__name(getLatestRelease, "getLatestRelease");
async function getAllReleases(env2) {
  const result = await env2.waivers.prepare(
    "SELECT version, release_date, waiver_text, created_at FROM releases ORDER BY release_date DESC, version DESC"
  ).all();
  return result.results || [];
}
__name(getAllReleases, "getAllReleases");
function incrementVersion(version3) {
  if (!version3) return "1.0.0";
  const parts = version3.split(".");
  if (parts.length !== 3) return "1.0.0";
  const [major, minor, patch] = parts.map(Number);
  return `${major}.${minor}.${patch + 1}`;
}
__name(incrementVersion, "incrementVersion");
async function handleAdminReleases(request, env2) {
  const url = new URL(request.url);
  const pathname = url.pathname;
  if (request.method === "GET" && pathname === "/admin/releases") {
    try {
      const current = await getLatestRelease(env2);
      const releases = await getAllReleases(env2);
      return json({
        ok: true,
        current,
        releases
      });
    } catch (error3) {
      return json({ ok: false, error: error3.message }, 500);
    }
  }
  if (request.method === "POST" && pathname === "/admin/releases/create") {
    try {
      const data = await request.json();
      const { version: version3, waiver_text } = data;
      if (!waiver_text || !waiver_text.trim()) {
        return json({ ok: false, error: "Waiver text is required" }, 400);
      }
      let finalVersion = version3;
      if (!finalVersion) {
        const latest = await getLatestRelease(env2);
        finalVersion = incrementVersion(latest?.version);
      }
      if (!/^[0-9]+\.[0-9]+\.[0-9]+$/.test(finalVersion)) {
        return json({ ok: false, error: "Invalid version format. Must be X.Y.Z (e.g., 1.0.1)" }, 400);
      }
      const existing = await env2.waivers.prepare(
        "SELECT version FROM releases WHERE version = ?1"
      ).bind(finalVersion).first();
      if (existing) {
        return json({ ok: false, error: `Version ${finalVersion} already exists` }, 400);
      }
      const now = /* @__PURE__ */ new Date();
      const releaseDate = now.toISOString().split("T")[0];
      const createdAt = now.toISOString();
      await env2.waivers.prepare(
        "INSERT INTO releases (version, release_date, waiver_text, created_at) VALUES (?1, ?2, ?3, ?4)"
      ).bind(finalVersion, releaseDate, waiver_text.trim(), createdAt).run();
      return json({
        ok: true,
        version: finalVersion,
        release_date: releaseDate
      });
    } catch (error3) {
      return json({ ok: false, error: error3.message }, 500);
    }
  }
  return json({ ok: false, error: "Not found" }, 404);
}
__name(handleAdminReleases, "handleAdminReleases");

// src/routes/admin/download-all.js
async function handleAdminDownloadAll(request, env2) {
  const url = new URL(request.url);
  const submissionId = url.searchParams.get("submission");
  if (!submissionId) {
    return new Response("Missing submission ID", { status: 400 });
  }
  try {
    const documents = await env2.waivers.prepare(
      "SELECT document_id, activity, r2_key FROM documents WHERE submission_id = ?1"
    ).bind(submissionId).all();
    if (!documents.results || documents.results.length === 0) {
      return new Response("No documents found", { status: 404 });
    }
    const submission = await env2.waivers.prepare(
      "SELECT guest_name, checkin_date FROM submissions WHERE submission_id = ?1"
    ).bind(submissionId).first();
    const { zipSync, strToU8 } = await import("fflate");
    const files = {};
    for (const doc of documents.results) {
      const obj = await env2.WAIVERS_R2.get(doc.r2_key);
      if (obj) {
        const arrayBuffer = await obj.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);
        files[`${doc.activity}-waiver.pdf`] = uint8Array;
      }
    }
    const zipped = zipSync(files, { level: 6 });
    const guestName = submission.guest_name.replace(/[^a-zA-Z0-9]/g, "-");
    const filename = `${guestName}-${submission.checkin_date}-waivers.zip`;
    return new Response(zipped, {
      headers: {
        "Content-Type": "application/zip",
        "Content-Disposition": `attachment; filename="${filename}"`
      }
    });
  } catch (error3) {
    console.error("Error creating zip:", error3);
    return new Response("Error creating zip file: " + error3.message, { status: 500 });
  }
}
__name(handleAdminDownloadAll, "handleAdminDownloadAll");

// src/routes/admin/debug.js
var CACHE_DURATION = 7 * 24 * 60 * 60 * 1e3;
async function handleAdminDebug(request, env2) {
  const url = new URL(request.url);
  const forceRefresh = url.searchParams.get("refresh") === "true";
  try {
    const debugData = {
      timestamp: Date.now(),
      d1: {}
    };
    const tables = await env2.waivers.prepare(
      "SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE '_cf_%' ORDER BY name"
    ).all();
    for (const table3 of tables.results) {
      const tableName = table3.name;
      const countResult = await env2.waivers.prepare(
        `SELECT COUNT(*) as count FROM ${tableName}`
      ).first();
      const rowsResult = await env2.waivers.prepare(
        `SELECT * FROM ${tableName} LIMIT 50`
      ).all();
      debugData.d1[tableName] = {
        count: countResult.count,
        rows: rowsResult.results || []
      };
    }
    return json({
      ok: true,
      lastUpdate: new Date(debugData.timestamp).toISOString(),
      d1: debugData.d1
    });
  } catch (error3) {
    console.error("Debug data error:", error3);
    return json({ ok: false, error: error3.message }, 500);
  }
}
__name(handleAdminDebug, "handleAdminDebug");

// src/routes/admin/api-docs.js
import { join } from "path";
async function handleAdminApiDocs() {
  try {
    const apiDocs = `# API Documentation

This document describes the public API endpoints for the waiver management system.

## Endpoints

### GET /

**Description:** Returns the HTML waiver form for guests to fill out and submit.

**Response:** HTML page with embedded property, activity, and risk data.

**Example:**
\`\`\`bash
curl https://activities.rtxsecured.com/
\`\`\`

---

### POST /submit

**Description:** Submits a completed waiver form with guest information, selected activities, initials, and signature.

**Request Body:**
\`\`\`json
{
  "propertyId": "cabin-13",
  "checkinDate": "2025-10-15",
  "guestName": "John Doe",
  "guestEmail": "john@example.com",
  "activities": ["kayaking", "ziplining", "archery"],
  "initials": {
    "kayaking": "JD",
    "ziplining": "JD",
    "archery": "JD"
  },
  "signature": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "accepted": true
}
\`\`\`

**Response (Production Mode):**
\`\`\`json
{
  "ok": true,
  "devMode": false,
  "emailed": [
    "cabin-13_kayaking_20251015.pdf",
    "cabin-13_ziplining_20251015.pdf",
    "cabin-13_archery_20251015.pdf"
  ],
  "pin": "1234"
}
\`\`\`

**Response (Development Mode):**
\`\`\`json
{
  "ok": true,
  "devMode": true,
  "downloads": [
    {
      "filename": "cabin-13_kayaking_20251015.pdf",
      "url": "/download/abc123def456"
    },
    {
      "filename": "cabin-13_ziplining_20251015.pdf",
      "url": "/download/def456ghi789"
    }
  ],
  "pin": "1234"
}
\`\`\`

**Notes:**
- The \`pin\` field is only included if the "archery" activity is selected
- In development mode (\`DEV_MODE=true\`), PDFs are generated and stored but not emailed
- In production mode, PDFs are emailed to the guest's email address

---

### GET /admin/search

**Description:** Search for waiver submissions by guest name or email.

**Query Parameters:**
- \`q\` (required): Search query string

**Response:**
\`\`\`json
{
  "ok": true,
  "results": [...]
}
\`\`\`

---

### GET /status

**Description:** Check the status of a waiver submission by ID.

**Query Parameters:**
- \`id\` (required): Submission ID

**Response:**
\`\`\`json
{
  "ok": true,
  "submission": {...},
  "documents": [...]
}
\`\`\`

---

## Admin Endpoints

### Properties Management

#### GET /admin/properties

List all configured properties.

#### POST /admin/properties/add

Add a new property.

#### POST /admin/properties/remove

Remove a property.

---

### Activities Management

#### GET /admin/activities

Get all activities for a specific property.

**Query Parameters:**
- \`property\` (optional): Property ID

#### POST /admin/activities/add

Add a new activity to a property.

#### POST /admin/activities/update

Update an existing activity.

#### POST /admin/activities/remove

Remove an activity from a property.

---

### Risk Levels Management

#### GET /admin/risks

Get all risk level definitions.

#### POST /admin/risks

Update a risk level definition.

---

### Document Management

#### GET /admin/document

Get document metadata by submission ID and activity.

**Query Parameters:**
- \`submission\` (required): Submission ID
- \`activity\` (required): Activity slug

#### GET /admin/download-all

Download all waiver PDFs for a submission as a ZIP file.

**Query Parameters:**
- \`submission\` (required): Submission ID

---

### Release Management

#### GET /admin/releases

Get all waiver text releases (versioned legal text).

#### POST /admin/releases/create

Create a new waiver text release.

**Request Body:**
\`\`\`json
{
  "version": "1.0.3",
  "waiver_text": "Updated legal waiver text..."
}
\`\`\`

**Notes:**
- If \`version\` is omitted, it will auto-increment from the latest version
- Version must follow semantic versioning format: X.Y.Z
- Version must be unique

---

### Document Verification

#### GET /admin/verify

Verify document integrity by comparing stored hash with computed hash.

**Query Parameters:**
- \`document\` (required): Document ID

**Response:**
\`\`\`json
{
  "ok": true,
  "verified": true,
  "stored_hash": "abc123...",
  "computed_hash": "abc123..."
}
\`\`\`

**Notes:**
- Documents are hashed using SHA-256
- Hash includes: submission data, activity, initials, signature, and release version
- Used to verify documents haven't been tampered with

---

### Debug Panel

#### GET /admin/debug

View KV store and D1 database tables for debugging.

**Query Parameters:**
- \`refresh\` (optional): Set to "true" to force refresh cached data

**Notes:**
- Data is cached for 7 days
- Shows all PROPS_KV keys and values
- Shows all D1 tables with up to 50 rows each
`;
    return new Response(apiDocs, {
      headers: {
        "Content-Type": "text/plain; charset=utf-8"
      }
    });
  } catch (error3) {
    return new Response("Error loading API documentation", { status: 500 });
  }
}
__name(handleAdminApiDocs, "handleAdminApiDocs");

// src/routes/status.js
async function handleStatus(env2) {
  try {
    const dbOK = await env2.waivers.prepare("SELECT 1").first();
    return json({ ok: true, db: !!dbOK, ts: Date.now() });
  } catch (error3) {
    return json({ ok: false, error: error3.message, ts: Date.now() });
  }
}
__name(handleStatus, "handleStatus");

// src/routes/download.js
async function handleDownload(request, env2) {
  const { pathname } = new URL(request.url);
  const r2Key = pathname.replace("/download/", "");
  if (env2.DEV_MODE !== "true") {
    return new Response("Downloads only available in dev mode", { status: 403 });
  }
  const object = await env2.WAIVERS_R2.get(r2Key);
  if (!object) {
    return new Response("PDF not found", { status: 404 });
  }
  const filename = r2Key.split("/").pop();
  return new Response(object.body, {
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="${filename}"`,
      "Cache-Control": "private, max-age=300"
    }
  });
}
__name(handleDownload, "handleDownload");

// src/index.js
var src_default = {
  async fetch(request, env2, ctx) {
    const { pathname } = new URL(request.url);
    try {
      if (request.method === "GET" && pathname === "/") return await handleRoot(request, env2);
      if (request.method === "POST" && pathname === "/submit") return await handleSubmit(request, env2);
      if (request.method === "POST" && pathname === "/submit/initial") return await handleInitialSubmit(request, env2);
      if (request.method === "POST" && pathname === "/submit/complete") return await handleCompleteSubmit(request, env2);
      if (request.method === "GET" && pathname === "/admin/search") return await handleAdminSearch(request, env2);
      if (request.method === "GET" && pathname === "/status") return await handleStatus(env2);
      if (request.method === "GET" && pathname === "/admin") return await handleAdmin();
      if (request.method === "GET" && pathname === "/admin/document") return await handleAdminDocument(request, env2);
      if (request.method === "GET" && pathname === "/admin/verify") return await handleAdminVerify(request, env2);
      if (request.method === "GET" && pathname === "/admin/download-all") return await handleAdminDownloadAll(request, env2);
      if (request.method === "GET" && pathname === "/admin/debug") return await handleAdminDebug(request, env2);
      if (request.method === "GET" && pathname === "/admin/api-docs") return await handleAdminApiDocs();
      if ((request.method === "GET" || request.method === "POST") && pathname.startsWith("/admin/releases")) return await handleAdminReleases(request, env2);
      if ((request.method === "GET" || request.method === "POST") && pathname.startsWith("/admin/activities")) return await handleAdminActivities(request, env2);
      if ((request.method === "GET" || request.method === "POST") && pathname.startsWith("/admin/properties")) return await handleAdminProperties(request, env2);
      if ((request.method === "GET" || request.method === "POST") && pathname === "/admin/risks") return await handleAdminRisks(request, env2);
      if (request.method === "GET" && pathname.startsWith("/download/")) return await handleDownload(request, env2);
      return new Response("Not found", { status: 404 });
    } catch (err) {
      console.error(err);
      return new Response("Server error", { status: 500 });
    }
  }
};

// ../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts
var drainBody = /* @__PURE__ */ __name(async (request, env2, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env2);
  } finally {
    try {
      if (request.body !== null && !request.bodyUsed) {
        const reader = request.body.getReader();
        while (!(await reader.read()).done) {
        }
      }
    } catch (e) {
      console.error("Failed to drain the unused request body.", e);
    }
  }
}, "drainBody");
var middleware_ensure_req_body_drained_default = drainBody;

// ../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts
function reduceError(e) {
  return {
    name: e?.name,
    message: e?.message ?? String(e),
    stack: e?.stack,
    cause: e?.cause === void 0 ? void 0 : reduceError(e.cause)
  };
}
__name(reduceError, "reduceError");
var jsonError = /* @__PURE__ */ __name(async (request, env2, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env2);
  } catch (e) {
    const error3 = reduceError(e);
    return Response.json(error3, {
      status: 500,
      headers: { "MF-Experimental-Error-Stack": "true" }
    });
  }
}, "jsonError");
var middleware_miniflare3_json_error_default = jsonError;

// .wrangler/tmp/bundle-l3U5iW/middleware-insertion-facade.js
var __INTERNAL_WRANGLER_MIDDLEWARE__ = [
  middleware_ensure_req_body_drained_default,
  middleware_miniflare3_json_error_default
];
var middleware_insertion_facade_default = src_default;

// ../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts
var __facade_middleware__ = [];
function __facade_register__(...args) {
  __facade_middleware__.push(...args.flat());
}
__name(__facade_register__, "__facade_register__");
function __facade_invokeChain__(request, env2, ctx, dispatch, middlewareChain) {
  const [head, ...tail] = middlewareChain;
  const middlewareCtx = {
    dispatch,
    next(newRequest, newEnv) {
      return __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);
    }
  };
  return head(request, env2, ctx, middlewareCtx);
}
__name(__facade_invokeChain__, "__facade_invokeChain__");
function __facade_invoke__(request, env2, ctx, dispatch, finalMiddleware) {
  return __facade_invokeChain__(request, env2, ctx, dispatch, [
    ...__facade_middleware__,
    finalMiddleware
  ]);
}
__name(__facade_invoke__, "__facade_invoke__");

// .wrangler/tmp/bundle-l3U5iW/middleware-loader.entry.ts
var __Facade_ScheduledController__ = class ___Facade_ScheduledController__ {
  constructor(scheduledTime, cron, noRetry) {
    this.scheduledTime = scheduledTime;
    this.cron = cron;
    this.#noRetry = noRetry;
  }
  static {
    __name(this, "__Facade_ScheduledController__");
  }
  #noRetry;
  noRetry() {
    if (!(this instanceof ___Facade_ScheduledController__)) {
      throw new TypeError("Illegal invocation");
    }
    this.#noRetry();
  }
};
function wrapExportedHandler(worker) {
  if (__INTERNAL_WRANGLER_MIDDLEWARE__ === void 0 || __INTERNAL_WRANGLER_MIDDLEWARE__.length === 0) {
    return worker;
  }
  for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
    __facade_register__(middleware);
  }
  const fetchDispatcher = /* @__PURE__ */ __name(function(request, env2, ctx) {
    if (worker.fetch === void 0) {
      throw new Error("Handler does not export a fetch() function.");
    }
    return worker.fetch(request, env2, ctx);
  }, "fetchDispatcher");
  return {
    ...worker,
    fetch(request, env2, ctx) {
      const dispatcher = /* @__PURE__ */ __name(function(type, init) {
        if (type === "scheduled" && worker.scheduled !== void 0) {
          const controller = new __Facade_ScheduledController__(
            Date.now(),
            init.cron ?? "",
            () => {
            }
          );
          return worker.scheduled(controller, env2, ctx);
        }
      }, "dispatcher");
      return __facade_invoke__(request, env2, ctx, dispatcher, fetchDispatcher);
    }
  };
}
__name(wrapExportedHandler, "wrapExportedHandler");
function wrapWorkerEntrypoint(klass) {
  if (__INTERNAL_WRANGLER_MIDDLEWARE__ === void 0 || __INTERNAL_WRANGLER_MIDDLEWARE__.length === 0) {
    return klass;
  }
  for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
    __facade_register__(middleware);
  }
  return class extends klass {
    #fetchDispatcher = /* @__PURE__ */ __name((request, env2, ctx) => {
      this.env = env2;
      this.ctx = ctx;
      if (super.fetch === void 0) {
        throw new Error("Entrypoint class does not define a fetch() function.");
      }
      return super.fetch(request);
    }, "#fetchDispatcher");
    #dispatcher = /* @__PURE__ */ __name((type, init) => {
      if (type === "scheduled" && super.scheduled !== void 0) {
        const controller = new __Facade_ScheduledController__(
          Date.now(),
          init.cron ?? "",
          () => {
          }
        );
        return super.scheduled(controller);
      }
    }, "#dispatcher");
    fetch(request) {
      return __facade_invoke__(
        request,
        this.env,
        this.ctx,
        this.#dispatcher,
        this.#fetchDispatcher
      );
    }
  };
}
__name(wrapWorkerEntrypoint, "wrapWorkerEntrypoint");
var WRAPPED_ENTRY;
if (typeof middleware_insertion_facade_default === "object") {
  WRAPPED_ENTRY = wrapExportedHandler(middleware_insertion_facade_default);
} else if (typeof middleware_insertion_facade_default === "function") {
  WRAPPED_ENTRY = wrapWorkerEntrypoint(middleware_insertion_facade_default);
}
var middleware_loader_entry_default = WRAPPED_ENTRY;
export {
  __INTERNAL_WRANGLER_MIDDLEWARE__,
  middleware_loader_entry_default as default
};
//# sourceMappingURL=index.js.map
</file>

<file path=".wrangler/tmp/dev-0uWY0W/index.js.map">
{
  "version": 3,
  "sources": ["../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/_internal/utils.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/perf_hooks/performance.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/@cloudflare/unenv-preset/dist/runtime/polyfill/performance.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/console.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/mock/noop.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/@cloudflare/unenv-preset/dist/runtime/node/console.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/_virtual_unenv_global_polyfill-@cloudflare-unenv-preset-node-console", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/process/hrtime.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/process/process.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/tty/read-stream.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/tty/write-stream.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/unenv/dist/runtime/node/internal/process/node-version.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/@cloudflare/unenv-preset/dist/runtime/node/process.mjs", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/_virtual_unenv_global_polyfill-@cloudflare-unenv-preset-node-process", "../../../src/utils/spa.js", "../../../src/routes/root.js", "../../../src/utils/nanoid.js", "../../../src/utils/admin.js", "../../../src/services/validation.js", "../../../src/services/storage.js", "../../../src/services/pdf.js", "../../../node_modules/resend/dist/index.mjs", "../../../src/services/mail.js", "../../../src/routes/submit.js", "../../../src/routes/submit-flow.js", "../../../src/routes/admin/search.js", "../../../src/routes/admin/activities.js", "../../../src/routes/admin/risks.js", "../../../src/routes/admin/properties.js", "../../../src/routes/admin/document.js", "../../../src/routes/admin/verify.js", "../../../src/routes/admin/releases.js", "../../../src/routes/admin/download-all.js", "../../../src/routes/admin/debug.js", "../../../src/routes/admin/api-docs.js", "../../../src/routes/status.js", "../../../src/routes/download.js", "../../../src/index.js", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-l3U5iW/middleware-insertion-facade.js", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts", "../bundle-l3U5iW/middleware-loader.entry.ts"],
  "sourceRoot": "C:\\Users\\scrap\\dev\\vitaliyah\\cf\\.wrangler\\tmp\\dev-0uWY0W",
  "sourcesContent": ["/* @__NO_SIDE_EFFECTS__ */\nexport function rawHeaders(headers) {\n\tconst rawHeaders = [];\n\tfor (const key in headers) {\n\t\tif (Array.isArray(headers[key])) {\n\t\t\tfor (const h of headers[key]) {\n\t\t\t\trawHeaders.push(key, h);\n\t\t\t}\n\t\t} else {\n\t\t\trawHeaders.push(key, headers[key]);\n\t\t}\n\t}\n\treturn rawHeaders;\n}\n/* @__NO_SIDE_EFFECTS__ */\nexport function mergeFns(...functions) {\n\treturn function(...args) {\n\t\tfor (const fn of functions) {\n\t\t\tfn(...args);\n\t\t}\n\t};\n}\n/* @__NO_SIDE_EFFECTS__ */\nexport function createNotImplementedError(name) {\n\treturn new Error(`[unenv] ${name} is not implemented yet!`);\n}\n/* @__NO_SIDE_EFFECTS__ */\nexport function notImplemented(name) {\n\tconst fn = () => {\n\t\tthrow createNotImplementedError(name);\n\t};\n\treturn Object.assign(fn, { __unenv__: true });\n}\n/* @__NO_SIDE_EFFECTS__ */\nexport function notImplementedAsync(name) {\n\tconst fn = notImplemented(name);\n\tfn.__promisify__ = () => notImplemented(name + \".__promisify__\");\n\tfn.native = fn;\n\treturn fn;\n}\n/* @__NO_SIDE_EFFECTS__ */\nexport function notImplementedClass(name) {\n\treturn class {\n\t\t__unenv__ = true;\n\t\tconstructor() {\n\t\t\tthrow new Error(`[unenv] ${name} is not implemented yet!`);\n\t\t}\n\t};\n}\n", "import { createNotImplementedError } from \"../../../_internal/utils.mjs\";\nconst _timeOrigin = globalThis.performance?.timeOrigin ?? Date.now();\nconst _performanceNow = globalThis.performance?.now ? globalThis.performance.now.bind(globalThis.performance) : () => Date.now() - _timeOrigin;\nconst nodeTiming = {\n\tname: \"node\",\n\tentryType: \"node\",\n\tstartTime: 0,\n\tduration: 0,\n\tnodeStart: 0,\n\tv8Start: 0,\n\tbootstrapComplete: 0,\n\tenvironment: 0,\n\tloopStart: 0,\n\tloopExit: 0,\n\tidleTime: 0,\n\tuvMetricsInfo: {\n\t\tloopCount: 0,\n\t\tevents: 0,\n\t\teventsWaiting: 0\n\t},\n\tdetail: undefined,\n\ttoJSON() {\n\t\treturn this;\n\t}\n};\n// PerformanceEntry\nexport class PerformanceEntry {\n\t__unenv__ = true;\n\tdetail;\n\tentryType = \"event\";\n\tname;\n\tstartTime;\n\tconstructor(name, options) {\n\t\tthis.name = name;\n\t\tthis.startTime = options?.startTime || _performanceNow();\n\t\tthis.detail = options?.detail;\n\t}\n\tget duration() {\n\t\treturn _performanceNow() - this.startTime;\n\t}\n\ttoJSON() {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tentryType: this.entryType,\n\t\t\tstartTime: this.startTime,\n\t\t\tduration: this.duration,\n\t\t\tdetail: this.detail\n\t\t};\n\t}\n}\n// PerformanceMark\nexport const PerformanceMark = class PerformanceMark extends PerformanceEntry {\n\tentryType = \"mark\";\n\tconstructor() {\n\t\t// @ts-ignore\n\t\tsuper(...arguments);\n\t}\n\tget duration() {\n\t\treturn 0;\n\t}\n};\n// PerformanceMark\nexport class PerformanceMeasure extends PerformanceEntry {\n\tentryType = \"measure\";\n}\n// PerformanceResourceTiming\nexport class PerformanceResourceTiming extends PerformanceEntry {\n\tentryType = \"resource\";\n\tserverTiming = [];\n\tconnectEnd = 0;\n\tconnectStart = 0;\n\tdecodedBodySize = 0;\n\tdomainLookupEnd = 0;\n\tdomainLookupStart = 0;\n\tencodedBodySize = 0;\n\tfetchStart = 0;\n\tinitiatorType = \"\";\n\tname = \"\";\n\tnextHopProtocol = \"\";\n\tredirectEnd = 0;\n\tredirectStart = 0;\n\trequestStart = 0;\n\tresponseEnd = 0;\n\tresponseStart = 0;\n\tsecureConnectionStart = 0;\n\tstartTime = 0;\n\ttransferSize = 0;\n\tworkerStart = 0;\n\tresponseStatus = 0;\n}\n// PerformanceObserverEntryList\nexport class PerformanceObserverEntryList {\n\t__unenv__ = true;\n\tgetEntries() {\n\t\treturn [];\n\t}\n\tgetEntriesByName(_name, _type) {\n\t\treturn [];\n\t}\n\tgetEntriesByType(type) {\n\t\treturn [];\n\t}\n}\n// Performance\nexport class Performance {\n\t__unenv__ = true;\n\ttimeOrigin = _timeOrigin;\n\teventCounts = new Map();\n\t_entries = [];\n\t_resourceTimingBufferSize = 0;\n\tnavigation = undefined;\n\ttiming = undefined;\n\ttimerify(_fn, _options) {\n\t\tthrow createNotImplementedError(\"Performance.timerify\");\n\t}\n\tget nodeTiming() {\n\t\treturn nodeTiming;\n\t}\n\teventLoopUtilization() {\n\t\treturn {};\n\t}\n\tmarkResourceTiming() {\n\t\t// TODO: create a new PerformanceResourceTiming entry\n\t\t// so that performance.getEntries, getEntriesByName, and getEntriesByType return it\n\t\t// see: https://nodejs.org/api/perf_hooks.html#performancemarkresourcetimingtiminginfo-requestedurl-initiatortype-global-cachemode-bodyinfo-responsestatus-deliverytype\n\t\treturn new PerformanceResourceTiming(\"\");\n\t}\n\tonresourcetimingbufferfull = null;\n\tnow() {\n\t\t// https://developer.mozilla.org/en-US/docs/Web/API/Performance/now\n\t\tif (this.timeOrigin === _timeOrigin) {\n\t\t\treturn _performanceNow();\n\t\t}\n\t\treturn Date.now() - this.timeOrigin;\n\t}\n\tclearMarks(markName) {\n\t\tthis._entries = markName ? this._entries.filter((e) => e.name !== markName) : this._entries.filter((e) => e.entryType !== \"mark\");\n\t}\n\tclearMeasures(measureName) {\n\t\tthis._entries = measureName ? this._entries.filter((e) => e.name !== measureName) : this._entries.filter((e) => e.entryType !== \"measure\");\n\t}\n\tclearResourceTimings() {\n\t\tthis._entries = this._entries.filter((e) => e.entryType !== \"resource\" || e.entryType !== \"navigation\");\n\t}\n\tgetEntries() {\n\t\treturn this._entries;\n\t}\n\tgetEntriesByName(name, type) {\n\t\treturn this._entries.filter((e) => e.name === name && (!type || e.entryType === type));\n\t}\n\tgetEntriesByType(type) {\n\t\treturn this._entries.filter((e) => e.entryType === type);\n\t}\n\tmark(name, options) {\n\t\t// @ts-expect-error constructor is not protected\n\t\tconst entry = new PerformanceMark(name, options);\n\t\tthis._entries.push(entry);\n\t\treturn entry;\n\t}\n\tmeasure(measureName, startOrMeasureOptions, endMark) {\n\t\tlet start;\n\t\tlet end;\n\t\tif (typeof startOrMeasureOptions === \"string\") {\n\t\t\tstart = this.getEntriesByName(startOrMeasureOptions, \"mark\")[0]?.startTime;\n\t\t\tend = this.getEntriesByName(endMark, \"mark\")[0]?.startTime;\n\t\t} else {\n\t\t\tstart = Number.parseFloat(startOrMeasureOptions?.start) || this.now();\n\t\t\tend = Number.parseFloat(startOrMeasureOptions?.end) || this.now();\n\t\t}\n\t\tconst entry = new PerformanceMeasure(measureName, {\n\t\t\tstartTime: start,\n\t\t\tdetail: {\n\t\t\t\tstart,\n\t\t\t\tend\n\t\t\t}\n\t\t});\n\t\tthis._entries.push(entry);\n\t\treturn entry;\n\t}\n\tsetResourceTimingBufferSize(maxSize) {\n\t\tthis._resourceTimingBufferSize = maxSize;\n\t}\n\taddEventListener(type, listener, options) {\n\t\tthrow createNotImplementedError(\"Performance.addEventListener\");\n\t}\n\tremoveEventListener(type, listener, options) {\n\t\tthrow createNotImplementedError(\"Performance.removeEventListener\");\n\t}\n\tdispatchEvent(event) {\n\t\tthrow createNotImplementedError(\"Performance.dispatchEvent\");\n\t}\n\ttoJSON() {\n\t\treturn this;\n\t}\n}\n// PerformanceObserver\nexport class PerformanceObserver {\n\t__unenv__ = true;\n\tstatic supportedEntryTypes = [];\n\t_callback = null;\n\tconstructor(callback) {\n\t\tthis._callback = callback;\n\t}\n\ttakeRecords() {\n\t\treturn [];\n\t}\n\tdisconnect() {\n\t\tthrow createNotImplementedError(\"PerformanceObserver.disconnect\");\n\t}\n\tobserve(options) {\n\t\tthrow createNotImplementedError(\"PerformanceObserver.observe\");\n\t}\n\tbind(fn) {\n\t\treturn fn;\n\t}\n\trunInAsyncScope(fn, thisArg, ...args) {\n\t\treturn fn.call(thisArg, ...args);\n\t}\n\tasyncId() {\n\t\treturn 0;\n\t}\n\ttriggerAsyncId() {\n\t\treturn 0;\n\t}\n\temitDestroy() {\n\t\treturn this;\n\t}\n}\n// workerd implements a subset of globalThis.performance (as of last check, only timeOrigin set to 0 + now() implemented)\n// We already use performance.now() from globalThis.performance, if provided (see top of this file)\n// If we detect this condition, we can just use polyfill instead.\nexport const performance = globalThis.performance && \"addEventListener\" in globalThis.performance ? globalThis.performance : new Performance();\n", "import {\n  performance,\n  Performance,\n  PerformanceEntry,\n  PerformanceMark,\n  PerformanceMeasure,\n  PerformanceObserver,\n  PerformanceObserverEntryList,\n  PerformanceResourceTiming\n} from \"node:perf_hooks\";\nglobalThis.performance = performance;\nglobalThis.Performance = Performance;\nglobalThis.PerformanceEntry = PerformanceEntry;\nglobalThis.PerformanceMark = PerformanceMark;\nglobalThis.PerformanceMeasure = PerformanceMeasure;\nglobalThis.PerformanceObserver = PerformanceObserver;\nglobalThis.PerformanceObserverEntryList = PerformanceObserverEntryList;\nglobalThis.PerformanceResourceTiming = PerformanceResourceTiming;\n", "import { Writable } from \"node:stream\";\nimport noop from \"../mock/noop.mjs\";\nimport { notImplemented, notImplementedClass } from \"../_internal/utils.mjs\";\nconst _console = globalThis.console;\n// undocumented public APIs\nexport const _ignoreErrors = true;\nexport const _stderr = new Writable();\nexport const _stdout = new Writable();\nexport const log = _console?.log ?? noop;\nexport const info = _console?.info ?? log;\nexport const trace = _console?.trace ?? info;\nexport const debug = _console?.debug ?? log;\nexport const table = _console?.table ?? log;\nexport const error = _console?.error ?? log;\nexport const warn = _console?.warn ?? error;\n// https://developer.chrome.com/docs/devtools/console/api#createtask\nexport const createTask = _console?.createTask ?? /* @__PURE__ */ notImplemented(\"console.createTask\");\nexport const assert = /* @__PURE__ */ notImplemented(\"console.assert\");\n// noop\nexport const clear = _console?.clear ?? noop;\nexport const count = _console?.count ?? noop;\nexport const countReset = _console?.countReset ?? noop;\nexport const dir = _console?.dir ?? noop;\nexport const dirxml = _console?.dirxml ?? noop;\nexport const group = _console?.group ?? noop;\nexport const groupEnd = _console?.groupEnd ?? noop;\nexport const groupCollapsed = _console?.groupCollapsed ?? noop;\nexport const profile = _console?.profile ?? noop;\nexport const profileEnd = _console?.profileEnd ?? noop;\nexport const time = _console?.time ?? noop;\nexport const timeEnd = _console?.timeEnd ?? noop;\nexport const timeLog = _console?.timeLog ?? noop;\nexport const timeStamp = _console?.timeStamp ?? noop;\nexport const Console = _console?.Console ?? /* @__PURE__ */ notImplementedClass(\"console.Console\");\nexport const _times = /* @__PURE__ */ new Map();\nexport function context() {\n\t// TODO: Should be Console with all the methods\n\treturn _console;\n}\nexport const _stdoutErrorHandler = noop;\nexport const _stderrErrorHandler = noop;\nexport default {\n\t_times,\n\t_ignoreErrors,\n\t_stdoutErrorHandler,\n\t_stderrErrorHandler,\n\t_stdout,\n\t_stderr,\n\tassert,\n\tclear,\n\tConsole,\n\tcount,\n\tcountReset,\n\tdebug,\n\tdir,\n\tdirxml,\n\terror,\n\tcontext,\n\tcreateTask,\n\tgroup,\n\tgroupEnd,\n\tgroupCollapsed,\n\tinfo,\n\tlog,\n\tprofile,\n\tprofileEnd,\n\ttable,\n\ttime,\n\ttimeEnd,\n\ttimeLog,\n\ttimeStamp,\n\ttrace,\n\twarn\n};\n", "export default Object.assign(() => {}, { __unenv__: true });\n", "import {\n  _ignoreErrors,\n  _stderr,\n  _stderrErrorHandler,\n  _stdout,\n  _stdoutErrorHandler,\n  _times,\n  Console\n} from \"unenv/node/console\";\nexport {\n  Console,\n  _ignoreErrors,\n  _stderr,\n  _stderrErrorHandler,\n  _stdout,\n  _stdoutErrorHandler,\n  _times\n} from \"unenv/node/console\";\nconst workerdConsole = globalThis[\"console\"];\nexport const {\n  assert,\n  clear,\n  // @ts-expect-error undocumented public API\n  context,\n  count,\n  countReset,\n  // @ts-expect-error undocumented public API\n  createTask,\n  debug,\n  dir,\n  dirxml,\n  error,\n  group,\n  groupCollapsed,\n  groupEnd,\n  info,\n  log,\n  profile,\n  profileEnd,\n  table,\n  time,\n  timeEnd,\n  timeLog,\n  timeStamp,\n  trace,\n  warn\n} = workerdConsole;\nObject.assign(workerdConsole, {\n  Console,\n  _ignoreErrors,\n  _stderr,\n  _stderrErrorHandler,\n  _stdout,\n  _stdoutErrorHandler,\n  _times\n});\nexport default workerdConsole;\n", "import { default as defaultExport } from \"@cloudflare/unenv-preset/node/console\";\nglobalThis.console = defaultExport;", "// https://nodejs.org/api/process.html#processhrtime\nexport const hrtime = /* @__PURE__ */ Object.assign(function hrtime(startTime) {\n\tconst now = Date.now();\n\t// millis to seconds\n\tconst seconds = Math.trunc(now / 1e3);\n\t// convert millis to nanos\n\tconst nanos = now % 1e3 * 1e6;\n\tif (startTime) {\n\t\tlet diffSeconds = seconds - startTime[0];\n\t\tlet diffNanos = nanos - startTime[0];\n\t\tif (diffNanos < 0) {\n\t\t\tdiffSeconds = diffSeconds - 1;\n\t\t\tdiffNanos = 1e9 + diffNanos;\n\t\t}\n\t\treturn [diffSeconds, diffNanos];\n\t}\n\treturn [seconds, nanos];\n}, { bigint: function bigint() {\n\t// Convert milliseconds to nanoseconds\n\treturn BigInt(Date.now() * 1e6);\n} });\n", "import { EventEmitter } from \"node:events\";\nimport { ReadStream, WriteStream } from \"node:tty\";\nimport { notImplemented, createNotImplementedError } from \"../../../_internal/utils.mjs\";\n// node-version.ts is generated at build time\nimport { NODE_VERSION } from \"./node-version.mjs\";\nexport class Process extends EventEmitter {\n\tenv;\n\thrtime;\n\tnextTick;\n\tconstructor(impl) {\n\t\tsuper();\n\t\tthis.env = impl.env;\n\t\tthis.hrtime = impl.hrtime;\n\t\tthis.nextTick = impl.nextTick;\n\t\tfor (const prop of [...Object.getOwnPropertyNames(Process.prototype), ...Object.getOwnPropertyNames(EventEmitter.prototype)]) {\n\t\t\tconst value = this[prop];\n\t\t\tif (typeof value === \"function\") {\n\t\t\t\tthis[prop] = value.bind(this);\n\t\t\t}\n\t\t}\n\t}\n\t// --- event emitter ---\n\temitWarning(warning, type, code) {\n\t\tconsole.warn(`${code ? `[${code}] ` : \"\"}${type ? `${type}: ` : \"\"}${warning}`);\n\t}\n\temit(...args) {\n\t\t// @ts-ignore\n\t\treturn super.emit(...args);\n\t}\n\tlisteners(eventName) {\n\t\treturn super.listeners(eventName);\n\t}\n\t// --- stdio (lazy initializers) ---\n\t#stdin;\n\t#stdout;\n\t#stderr;\n\tget stdin() {\n\t\treturn this.#stdin ??= new ReadStream(0);\n\t}\n\tget stdout() {\n\t\treturn this.#stdout ??= new WriteStream(1);\n\t}\n\tget stderr() {\n\t\treturn this.#stderr ??= new WriteStream(2);\n\t}\n\t// --- cwd ---\n\t#cwd = \"/\";\n\tchdir(cwd) {\n\t\tthis.#cwd = cwd;\n\t}\n\tcwd() {\n\t\treturn this.#cwd;\n\t}\n\t// --- dummy props and getters ---\n\tarch = \"\";\n\tplatform = \"\";\n\targv = [];\n\targv0 = \"\";\n\texecArgv = [];\n\texecPath = \"\";\n\ttitle = \"\";\n\tpid = 200;\n\tppid = 100;\n\tget version() {\n\t\treturn `v${NODE_VERSION}`;\n\t}\n\tget versions() {\n\t\treturn { node: NODE_VERSION };\n\t}\n\tget allowedNodeEnvironmentFlags() {\n\t\treturn new Set();\n\t}\n\tget sourceMapsEnabled() {\n\t\treturn false;\n\t}\n\tget debugPort() {\n\t\treturn 0;\n\t}\n\tget throwDeprecation() {\n\t\treturn false;\n\t}\n\tget traceDeprecation() {\n\t\treturn false;\n\t}\n\tget features() {\n\t\treturn {};\n\t}\n\tget release() {\n\t\treturn {};\n\t}\n\tget connected() {\n\t\treturn false;\n\t}\n\tget config() {\n\t\treturn {};\n\t}\n\tget moduleLoadList() {\n\t\treturn [];\n\t}\n\tconstrainedMemory() {\n\t\treturn 0;\n\t}\n\tavailableMemory() {\n\t\treturn 0;\n\t}\n\tuptime() {\n\t\treturn 0;\n\t}\n\tresourceUsage() {\n\t\treturn {};\n\t}\n\t// --- noop methods ---\n\tref() {\n\t\t// noop\n\t}\n\tunref() {\n\t\t// noop\n\t}\n\t// --- unimplemented methods ---\n\tumask() {\n\t\tthrow createNotImplementedError(\"process.umask\");\n\t}\n\tgetBuiltinModule() {\n\t\treturn undefined;\n\t}\n\tgetActiveResourcesInfo() {\n\t\tthrow createNotImplementedError(\"process.getActiveResourcesInfo\");\n\t}\n\texit() {\n\t\tthrow createNotImplementedError(\"process.exit\");\n\t}\n\treallyExit() {\n\t\tthrow createNotImplementedError(\"process.reallyExit\");\n\t}\n\tkill() {\n\t\tthrow createNotImplementedError(\"process.kill\");\n\t}\n\tabort() {\n\t\tthrow createNotImplementedError(\"process.abort\");\n\t}\n\tdlopen() {\n\t\tthrow createNotImplementedError(\"process.dlopen\");\n\t}\n\tsetSourceMapsEnabled() {\n\t\tthrow createNotImplementedError(\"process.setSourceMapsEnabled\");\n\t}\n\tloadEnvFile() {\n\t\tthrow createNotImplementedError(\"process.loadEnvFile\");\n\t}\n\tdisconnect() {\n\t\tthrow createNotImplementedError(\"process.disconnect\");\n\t}\n\tcpuUsage() {\n\t\tthrow createNotImplementedError(\"process.cpuUsage\");\n\t}\n\tsetUncaughtExceptionCaptureCallback() {\n\t\tthrow createNotImplementedError(\"process.setUncaughtExceptionCaptureCallback\");\n\t}\n\thasUncaughtExceptionCaptureCallback() {\n\t\tthrow createNotImplementedError(\"process.hasUncaughtExceptionCaptureCallback\");\n\t}\n\tinitgroups() {\n\t\tthrow createNotImplementedError(\"process.initgroups\");\n\t}\n\topenStdin() {\n\t\tthrow createNotImplementedError(\"process.openStdin\");\n\t}\n\tassert() {\n\t\tthrow createNotImplementedError(\"process.assert\");\n\t}\n\tbinding() {\n\t\tthrow createNotImplementedError(\"process.binding\");\n\t}\n\t// --- attached interfaces ---\n\tpermission = { has: /* @__PURE__ */ notImplemented(\"process.permission.has\") };\n\treport = {\n\t\tdirectory: \"\",\n\t\tfilename: \"\",\n\t\tsignal: \"SIGUSR2\",\n\t\tcompact: false,\n\t\treportOnFatalError: false,\n\t\treportOnSignal: false,\n\t\treportOnUncaughtException: false,\n\t\tgetReport: /* @__PURE__ */ notImplemented(\"process.report.getReport\"),\n\t\twriteReport: /* @__PURE__ */ notImplemented(\"process.report.writeReport\")\n\t};\n\tfinalization = {\n\t\tregister: /* @__PURE__ */ notImplemented(\"process.finalization.register\"),\n\t\tunregister: /* @__PURE__ */ notImplemented(\"process.finalization.unregister\"),\n\t\tregisterBeforeExit: /* @__PURE__ */ notImplemented(\"process.finalization.registerBeforeExit\")\n\t};\n\tmemoryUsage = Object.assign(() => ({\n\t\tarrayBuffers: 0,\n\t\trss: 0,\n\t\texternal: 0,\n\t\theapTotal: 0,\n\t\theapUsed: 0\n\t}), { rss: () => 0 });\n\t// --- undefined props ---\n\tmainModule = undefined;\n\tdomain = undefined;\n\t// optional\n\tsend = undefined;\n\texitCode = undefined;\n\tchannel = undefined;\n\tgetegid = undefined;\n\tgeteuid = undefined;\n\tgetgid = undefined;\n\tgetgroups = undefined;\n\tgetuid = undefined;\n\tsetegid = undefined;\n\tseteuid = undefined;\n\tsetgid = undefined;\n\tsetgroups = undefined;\n\tsetuid = undefined;\n\t// internals\n\t_events = undefined;\n\t_eventsCount = undefined;\n\t_exiting = undefined;\n\t_maxListeners = undefined;\n\t_debugEnd = undefined;\n\t_debugProcess = undefined;\n\t_fatalException = undefined;\n\t_getActiveHandles = undefined;\n\t_getActiveRequests = undefined;\n\t_kill = undefined;\n\t_preload_modules = undefined;\n\t_rawDebug = undefined;\n\t_startProfilerIdleNotifier = undefined;\n\t_stopProfilerIdleNotifier = undefined;\n\t_tickCallback = undefined;\n\t_disconnect = undefined;\n\t_handleQueue = undefined;\n\t_pendingMessage = undefined;\n\t_channel = undefined;\n\t_send = undefined;\n\t_linkedBinding = undefined;\n}\n", "export class ReadStream {\n\tfd;\n\tisRaw = false;\n\tisTTY = false;\n\tconstructor(fd) {\n\t\tthis.fd = fd;\n\t}\n\tsetRawMode(mode) {\n\t\tthis.isRaw = mode;\n\t\treturn this;\n\t}\n}\n", "export class WriteStream {\n\tfd;\n\tcolumns = 80;\n\trows = 24;\n\tisTTY = false;\n\tconstructor(fd) {\n\t\tthis.fd = fd;\n\t}\n\tclearLine(dir, callback) {\n\t\tcallback && callback();\n\t\treturn false;\n\t}\n\tclearScreenDown(callback) {\n\t\tcallback && callback();\n\t\treturn false;\n\t}\n\tcursorTo(x, y, callback) {\n\t\tcallback && typeof callback === \"function\" && callback();\n\t\treturn false;\n\t}\n\tmoveCursor(dx, dy, callback) {\n\t\tcallback && callback();\n\t\treturn false;\n\t}\n\tgetColorDepth(env) {\n\t\treturn 1;\n\t}\n\thasColors(count, env) {\n\t\treturn false;\n\t}\n\tgetWindowSize() {\n\t\treturn [this.columns, this.rows];\n\t}\n\twrite(str, encoding, cb) {\n\t\tif (str instanceof Uint8Array) {\n\t\t\tstr = new TextDecoder().decode(str);\n\t\t}\n\t\ttry {\n\t\t\tconsole.log(str);\n\t\t} catch {}\n\t\tcb && typeof cb === \"function\" && cb();\n\t\treturn false;\n\t}\n}\n", "// Extracted from .nvmrc\nexport const NODE_VERSION = \"22.14.0\";\n", "import { hrtime as UnenvHrTime } from \"unenv/node/internal/process/hrtime\";\nimport { Process as UnenvProcess } from \"unenv/node/internal/process/process\";\nconst globalProcess = globalThis[\"process\"];\nexport const getBuiltinModule = globalProcess.getBuiltinModule;\nconst workerdProcess = getBuiltinModule(\"node:process\");\nconst isWorkerdProcessV2 = globalThis.Cloudflare.compatibilityFlags.enable_nodejs_process_v2;\nconst unenvProcess = new UnenvProcess({\n  env: globalProcess.env,\n  // `hrtime` is only available from workerd process v2\n  hrtime: isWorkerdProcessV2 ? workerdProcess.hrtime : UnenvHrTime,\n  // `nextTick` is available from workerd process v1\n  nextTick: workerdProcess.nextTick\n});\nexport const { exit, features, platform } = workerdProcess;\nexport const {\n  // Always implemented by workerd\n  env,\n  // Only implemented in workerd v2\n  hrtime,\n  // Always implemented by workerd\n  nextTick\n} = unenvProcess;\nexport const {\n  _channel,\n  _disconnect,\n  _events,\n  _eventsCount,\n  _handleQueue,\n  _maxListeners,\n  _pendingMessage,\n  _send,\n  assert,\n  disconnect,\n  mainModule\n} = unenvProcess;\nexport const {\n  // @ts-expect-error `_debugEnd` is missing typings\n  _debugEnd,\n  // @ts-expect-error `_debugProcess` is missing typings\n  _debugProcess,\n  // @ts-expect-error `_exiting` is missing typings\n  _exiting,\n  // @ts-expect-error `_fatalException` is missing typings\n  _fatalException,\n  // @ts-expect-error `_getActiveHandles` is missing typings\n  _getActiveHandles,\n  // @ts-expect-error `_getActiveRequests` is missing typings\n  _getActiveRequests,\n  // @ts-expect-error `_kill` is missing typings\n  _kill,\n  // @ts-expect-error `_linkedBinding` is missing typings\n  _linkedBinding,\n  // @ts-expect-error `_preload_modules` is missing typings\n  _preload_modules,\n  // @ts-expect-error `_rawDebug` is missing typings\n  _rawDebug,\n  // @ts-expect-error `_startProfilerIdleNotifier` is missing typings\n  _startProfilerIdleNotifier,\n  // @ts-expect-error `_stopProfilerIdleNotifier` is missing typings\n  _stopProfilerIdleNotifier,\n  // @ts-expect-error `_tickCallback` is missing typings\n  _tickCallback,\n  abort,\n  addListener,\n  allowedNodeEnvironmentFlags,\n  arch,\n  argv,\n  argv0,\n  availableMemory,\n  // @ts-expect-error `binding` is missing typings\n  binding,\n  channel,\n  chdir,\n  config,\n  connected,\n  constrainedMemory,\n  cpuUsage,\n  cwd,\n  debugPort,\n  dlopen,\n  // @ts-expect-error `domain` is missing typings\n  domain,\n  emit,\n  emitWarning,\n  eventNames,\n  execArgv,\n  execPath,\n  exitCode,\n  finalization,\n  getActiveResourcesInfo,\n  getegid,\n  geteuid,\n  getgid,\n  getgroups,\n  getMaxListeners,\n  getuid,\n  hasUncaughtExceptionCaptureCallback,\n  // @ts-expect-error `initgroups` is missing typings\n  initgroups,\n  kill,\n  listenerCount,\n  listeners,\n  loadEnvFile,\n  memoryUsage,\n  // @ts-expect-error `moduleLoadList` is missing typings\n  moduleLoadList,\n  off,\n  on,\n  once,\n  // @ts-expect-error `openStdin` is missing typings\n  openStdin,\n  permission,\n  pid,\n  ppid,\n  prependListener,\n  prependOnceListener,\n  rawListeners,\n  // @ts-expect-error `reallyExit` is missing typings\n  reallyExit,\n  ref,\n  release,\n  removeAllListeners,\n  removeListener,\n  report,\n  resourceUsage,\n  send,\n  setegid,\n  seteuid,\n  setgid,\n  setgroups,\n  setMaxListeners,\n  setSourceMapsEnabled,\n  setuid,\n  setUncaughtExceptionCaptureCallback,\n  sourceMapsEnabled,\n  stderr,\n  stdin,\n  stdout,\n  throwDeprecation,\n  title,\n  traceDeprecation,\n  umask,\n  unref,\n  uptime,\n  version,\n  versions\n} = isWorkerdProcessV2 ? workerdProcess : unenvProcess;\nconst _process = {\n  abort,\n  addListener,\n  allowedNodeEnvironmentFlags,\n  hasUncaughtExceptionCaptureCallback,\n  setUncaughtExceptionCaptureCallback,\n  loadEnvFile,\n  sourceMapsEnabled,\n  arch,\n  argv,\n  argv0,\n  chdir,\n  config,\n  connected,\n  constrainedMemory,\n  availableMemory,\n  cpuUsage,\n  cwd,\n  debugPort,\n  dlopen,\n  disconnect,\n  emit,\n  emitWarning,\n  env,\n  eventNames,\n  execArgv,\n  execPath,\n  exit,\n  finalization,\n  features,\n  getBuiltinModule,\n  getActiveResourcesInfo,\n  getMaxListeners,\n  hrtime,\n  kill,\n  listeners,\n  listenerCount,\n  memoryUsage,\n  nextTick,\n  on,\n  off,\n  once,\n  pid,\n  platform,\n  ppid,\n  prependListener,\n  prependOnceListener,\n  rawListeners,\n  release,\n  removeAllListeners,\n  removeListener,\n  report,\n  resourceUsage,\n  setMaxListeners,\n  setSourceMapsEnabled,\n  stderr,\n  stdin,\n  stdout,\n  title,\n  throwDeprecation,\n  traceDeprecation,\n  umask,\n  uptime,\n  version,\n  versions,\n  // @ts-expect-error old API\n  domain,\n  initgroups,\n  moduleLoadList,\n  reallyExit,\n  openStdin,\n  assert,\n  binding,\n  send,\n  exitCode,\n  channel,\n  getegid,\n  geteuid,\n  getgid,\n  getgroups,\n  getuid,\n  setegid,\n  seteuid,\n  setgid,\n  setgroups,\n  setuid,\n  permission,\n  mainModule,\n  _events,\n  _eventsCount,\n  _exiting,\n  _maxListeners,\n  _debugEnd,\n  _debugProcess,\n  _fatalException,\n  _getActiveHandles,\n  _getActiveRequests,\n  _kill,\n  _preload_modules,\n  _rawDebug,\n  _startProfilerIdleNotifier,\n  _stopProfilerIdleNotifier,\n  _tickCallback,\n  _disconnect,\n  _handleQueue,\n  _pendingMessage,\n  _channel,\n  _send,\n  _linkedBinding\n};\nexport default _process;\n", "import { default as defaultExport } from \"@cloudflare/unenv-preset/node/process\";\nglobalThis.process = defaultExport;", "export async function htmlPage(env, submissionToken = null) {\r\n  let submissionData = null;\r\n\r\n  // If token provided, fetch submission details\r\n  if (submissionToken) {\r\n    const result = await env.waivers.prepare(\r\n      'SELECT submission_id, property_id, checkin_date, guest_name, guest_email, status, token_expires_at FROM submissions WHERE verification_token = ?'\r\n    ).bind(submissionToken).first();\r\n\r\n    if (result && result.status === 'pending') {\r\n      const expires = new Date(result.token_expires_at);\r\n      if (expires > new Date()) {\r\n        submissionData = result;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Fetch all properties from database (excluding default template)\r\n  const propertiesResult = await env.waivers.prepare(\r\n    'SELECT id, name FROM properties WHERE id != ? ORDER BY name'\r\n  ).bind('default').all();\r\n  const properties = propertiesResult.results || [];\r\n\r\n  // Fetch activities for each property\r\n  const propsData = [];\r\n  for (const property of properties) {\r\n    const activitiesResult = await env.waivers.prepare(\r\n      'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'\r\n    ).bind(property.id).all();\r\n\r\n    propsData.push({\r\n      id: property.id,\r\n      name: property.name,\r\n      activities: activitiesResult.results || []\r\n    });\r\n  }\r\n\r\n  // Fetch risk descriptions from database\r\n  const risksResult = await env.waivers.prepare(\r\n    'SELECT level, description FROM risk_descriptions'\r\n  ).all();\r\n\r\n  const risks = {};\r\n  for (const row of (risksResult.results || [])) {\r\n    risks[row.level] = { description: row.description };\r\n  }\r\n\r\n  const propsJSON = JSON.stringify(propsData);\r\n  const props64 = btoa(unescape(encodeURIComponent(propsJSON)));\r\n\r\n  const risksJSON = JSON.stringify(risks);\r\n  const risks64 = btoa(unescape(encodeURIComponent(risksJSON)));\r\n\r\n  const submissionJSON = submissionData ? JSON.stringify(submissionData) : 'null';\r\n  const submission64 = btoa(unescape(encodeURIComponent(submissionJSON)));\r\n\r\n  return new Response(`\r\n<!doctype html>\r\n<html lang=\"en\"><meta charset=\"utf-8\">\r\n<title>Activity Waiver</title>\r\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\r\n<style>\r\n  *{box-sizing:border-box}\r\n  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;padding:2rem 1rem;background:#f8fafc;color:#1e293b;line-height:1.6}\r\n  .container{max-width:1200px;margin:0 auto;background:white;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);overflow:hidden}\r\n  .header{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);padding:2.5rem 2rem;color:white;text-align:center}\r\n  .header h1{margin:0 0 0.5rem 0;font-size:2rem;font-weight:700}\r\n  .header p{margin:0;opacity:0.9;font-size:1rem}\r\n  .content{padding:2rem}\r\n  .form-group{margin-bottom:1.5rem}\r\n  .form-group label{display:block;margin-bottom:0.5rem;font-weight:600;font-size:0.875rem;color:#475569}\r\n  .form-group input,.form-group select{width:100%;padding:0.75rem 1rem;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;transition:all 0.2s;max-width:400px}\r\n  .form-group input:focus,.form-group select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}\r\n  .section-title{font-size:1.25rem;font-weight:700;color:#0f172a;margin:2rem 0 1rem 0;padding-bottom:0.5rem;border-bottom:2px solid #e2e8f0}\r\n  .activities-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;column-gap:24px;padding:0;overflow:hidden}\r\n  .activity-row{display:flex;gap:8px;align-items:center}\r\n  .activity-item{display:flex;align-items:center;padding:12px;background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0;cursor:pointer;transition:all 0.2s;flex:1;position:relative;min-height:68px;overflow:hidden}\r\n  .activity-item:hover{background:#f1f5f9;border-color:#3b82f6}\r\n  .activity-item.checked{background:#eff6ff;border-color:#3b82f6}\r\n  .activity-item input[type=\"checkbox\"]{margin-right:10px;cursor:pointer;width:20px;height:20px;flex-shrink:0;accent-color:#3b82f6}\r\n  .activity-item label{margin:0;cursor:pointer;flex:1;display:flex;align-items:center;gap:8px;position:relative;z-index:1;justify-content:space-between}\r\n  .activity-label-text{white-space:nowrap;flex-shrink:0;min-width:120px;font-weight:600;color:#1e293b}\r\n  .risk-chip-wrapper{display:flex;align-items:center;justify-content:flex-end;min-width:360px;width:360px;transition:all 0.3s ease;position:relative;overflow:visible;z-index:10}\r\n  .risk-chip{padding:6px 14px;border-radius:12px;color:white;font-size:11px;font-weight:600;white-space:nowrap;display:inline-block;width:100px;text-align:center;box-sizing:border-box;flex-shrink:0;position:absolute;right:0;z-index:2}\r\n  .risk-low{background:#10b981}\r\n  .risk-medium{background:#f59e0b}\r\n  .risk-high{background:#ef4444}\r\n  .risk-details{position:absolute;right:110px;width:250px;opacity:0;font-size:9px;line-height:1.3;color:#334155;transition:opacity 0.3s ease;padding:4px 8px;display:block;box-sizing:border-box;max-height:56px;overflow-y:auto;background:white;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);white-space:normal}\r\n  .risk-chip-wrapper:hover .risk-details{opacity:1}\r\n  .activity-initial{width:70px;height:50px;text-align:center;padding:0;border:2px solid #cbd5e1;border-radius:8px;visibility:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;background:white;transition:all 0.2s}\r\n  .activity-initial.visible{visibility:visible;border-color:#3b82f6}\r\n  .activity-initial:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}\r\n  .acceptance-box{background:#fef3c7;border:2px solid #fbbf24;border-radius:10px;padding:1rem;margin:1.5rem 0;display:flex;align-items:center;gap:0.75rem;position:relative}\r\n  .acceptance-box input[type=\"checkbox\"]{width:20px;height:20px;accent-color:#f59e0b;cursor:pointer}\r\n  .acceptance-box label{margin:0;font-weight:600;color:#78350f;cursor:pointer}\r\n  .acceptance-box input[type=\"checkbox\"]:disabled{cursor:not-allowed;opacity:0.5}\r\n  .acceptance-box .tooltip{display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#1e293b;color:white;padding:0.5rem 1rem;border-radius:6px;font-size:0.875rem;white-space:nowrap;margin-bottom:0.5rem;font-weight:400}\r\n  .acceptance-box .tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e293b}\r\n  .acceptance-box:has(input[type=\"checkbox\"]:disabled):hover .tooltip{display:block}\r\n  .signature-container{display:flex;flex-direction:column;align-items:center;gap:12px;padding:1.5rem;background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0}\r\n  canvas{border:2px dashed #cbd5e1;border-radius:8px;width:90%;max-width:600px;touch-action:none;display:block;background:white}\r\n  button{font-weight:600;border:none;cursor:pointer;transition:all 0.2s;font-size:1rem;border-radius:8px;font-family:inherit}\r\n  #clearSig{padding:0.625rem 1.5rem;background:#64748b;color:white}\r\n  #clearSig:hover{background:#475569}\r\n  #submit{width:100%;padding:1rem;background:#3b82f6;color:white;font-size:1.125rem;margin-top:1.5rem;max-width:400px}\r\n  #submit:hover:not(:disabled){background:#2563eb}\r\n  #submit:disabled{opacity:0.5;cursor:not-allowed}\r\n  .thanks{padding:2rem;text-align:center}\r\n  .thanks h2{color:#3b82f6;font-size:1.75rem;margin-bottom:1rem}\r\n  .info-box{background:#eff6ff;border:2px solid #3b82f6;border-radius:10px;padding:1rem;margin-bottom:1.5rem}\r\n  .info-box p{margin:0.25rem 0;color:#1e40af}\r\n  @media (max-width:768px){\r\n    .content{padding:1.5rem}\r\n    .activities-grid{grid-template-columns:1fr}\r\n    .form-group input,.form-group select{width:100%;max-width:100%}\r\n    canvas{width:100%}\r\n  }\r\n</style>\r\n\r\n<body>\r\n  <div class=\"container\">\r\n    <div class=\"header\">\r\n      <h1>Activity Waiver</h1>\r\n      <p id=\"headerSubtitle\">Complete your waiver to get started</p>\r\n    </div>\r\n\r\n    <div class=\"content\">\r\n      <!-- Initial Info Form -->\r\n      <form id=\"initialForm\">\r\n        <div class=\"form-group\">\r\n          <label>Property</label>\r\n          <select id=\"prop\" required></select>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label>Check-in Date</label>\r\n          <input type=\"date\" id=\"date\" required>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label>Full Name</label>\r\n          <input id=\"name\" required>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label>Email Address</label>\r\n          <input id=\"email\" type=\"email\" required>\r\n        </div>\r\n\r\n        <button id=\"initialSubmit\">Continue to Activities</button>\r\n      </form>\r\n\r\n      <!-- Activity Selection Form (hidden initially) -->\r\n      <form id=\"activityForm\" hidden>\r\n        <div class=\"info-box\" id=\"guestInfo\"></div>\r\n\r\n        <h3 class=\"section-title\">Select Activities</h3>\r\n        <div id=\"activities\" class=\"activities-grid\"></div>\r\n\r\n        <div class=\"acceptance-box\">\r\n          <input id=\"master\" type=\"checkbox\" required>\r\n          <label for=\"master\">I have read and accept all risks</label>\r\n          <span class=\"tooltip\" id=\"masterTooltip\">Please initial all selected activities first</span>\r\n        </div>\r\n\r\n        <h3 class=\"section-title\">Signature</h3>\r\n        <div class=\"signature-container\">\r\n          <canvas id=\"sign\" width=\"600\" height=\"200\"></canvas>\r\n          <button id=\"clearSig\" type=\"button\">Clear</button>\r\n        </div>\r\n\r\n        <button id=\"submit\">Submit Waiver</button>\r\n      </form>\r\n\r\n      <div id=\"thanks\" class=\"thanks\" hidden></div>\r\n    </div>\r\n  </div>\r\n\r\n<script type=\"module\">\r\n  /* ---------- bootstrap data -------------------- */\r\n  let props = JSON.parse(atob('${props64}'));\r\n  const risks = JSON.parse(atob('${risks64}'));\r\n  const submission = JSON.parse(atob('${submission64}'));\r\n\r\n  console.log(\"Props:\", props);\r\n  console.log(\"Risks:\", risks);\r\n  console.log(\"Submission:\", submission);\r\n\r\n  if (!Array.isArray(props)) {\r\n    props = [props];\r\n  }\r\n\r\n  const propSel = document.getElementById('prop');\r\n  if (!props || props.length === 0) {\r\n    propSel.add(new Option('No properties available', ''));\r\n    propSel.disabled = true;\r\n  } else {\r\n    props.forEach(p => propSel.add(new Option(p.name, p.id)));\r\n  }\r\n\r\n  /* ---------- Determine which form to show -------------------- */\r\n  const initialForm = document.getElementById('initialForm');\r\n  const activityForm = document.getElementById('activityForm');\r\n  const headerSubtitle = document.getElementById('headerSubtitle');\r\n\r\n  if (submission) {\r\n    // Show activity form with pre-filled info\r\n    initialForm.hidden = true;\r\n    activityForm.hidden = false;\r\n    headerSubtitle.textContent = 'Select your activities and sign';\r\n\r\n    // Pre-fill property selection\r\n    propSel.value = submission.property_id;\r\n    propSel.disabled = true;\r\n\r\n    // Show guest info\r\n    document.getElementById('guestInfo').innerHTML =\r\n      '<p><strong>Property:</strong> ' + props.find(p => p.id === submission.property_id)?.name + '</p>' +\r\n      '<p><strong>Check-in:</strong> ' + submission.checkin_date + '</p>' +\r\n      '<p><strong>Name:</strong> ' + submission.guest_name + '</p>' +\r\n      '<p><strong>Email:</strong> ' + submission.guest_email + '</p>';\r\n  } else {\r\n    // Show initial form\r\n    initialForm.hidden = false;\r\n    activityForm.hidden = true;\r\n  }\r\n\r\n  /* ---------- Initial form submission -------------------- */\r\n  document.getElementById('initialForm').onsubmit = async e => {\r\n    e.preventDefault();\r\n\r\n    const data = {\r\n      propertyId: propSel.value,\r\n      checkinDate: document.getElementById('date').value,\r\n      guestName: document.getElementById('name').value,\r\n      guestEmail: document.getElementById('email').value\r\n    };\r\n\r\n    console.log(\"Submitting initial form:\", data);\r\n\r\n    try {\r\n      const res = await fetch('/submit/initial', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(data)\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errorText = await res.text();\r\n        console.error(\"Server error:\", errorText);\r\n        alert(\"Error: \" + errorText);\r\n        return;\r\n      }\r\n\r\n      const json = await res.json();\r\n      console.log(\"Response:\", json);\r\n\r\n      // Show confirmation message\r\n      initialForm.hidden = true;\r\n      document.getElementById('thanks').hidden = false;\r\n      document.getElementById('thanks').innerHTML =\r\n        '<h2>\u2713 Check Your Email</h2>' +\r\n        '<p style=\"color:#64748b;margin-bottom:1.5rem\">We\\\\'ve sent a verification link to <strong>' + data.guestEmail + '</strong></p>' +\r\n        '<p style=\"color:#94a3b8;font-size:0.875rem\">Click the link in the email to continue with your waiver.</p>';\r\n    } catch (error) {\r\n      console.error(\"Form submission error:\", error);\r\n      alert(\"Error: \" + error.message);\r\n    }\r\n  };\r\n\r\n  /* ---------- activity checkboxes ------------------------- */\r\n  const actsDiv = document.getElementById('activities');\r\n  const masterCheck = document.getElementById('master');\r\n  let chosen = new Map();\r\n\r\n  function loadActivities() {\r\n    const selectedProp = props.find(p => p.id === (submission ? submission.property_id : propSel.value));\r\n    const activities = selectedProp?.activities ?? [];\r\n\r\n    actsDiv.innerHTML = '';\r\n    chosen.clear();\r\n    masterCheck.disabled = true;\r\n    masterCheck.checked = false;\r\n\r\n    activities.forEach(a => {\r\n      const rowDiv = document.createElement('div');\r\n      rowDiv.className = 'activity-row';\r\n\r\n      const itemDiv = document.createElement('div');\r\n      itemDiv.className = 'activity-item';\r\n\r\n      const checkbox = document.createElement('input');\r\n      checkbox.type = 'checkbox';\r\n      checkbox.id = 'activity-' + a.slug;\r\n      checkbox.value = a.slug;\r\n\r\n      const label = document.createElement('label');\r\n      label.htmlFor = 'activity-' + a.slug;\r\n\r\n      const labelText = document.createElement('span');\r\n      labelText.className = 'activity-label-text';\r\n      labelText.textContent = a.label;\r\n      label.appendChild(labelText);\r\n\r\n      if (a.risk) {\r\n        const chipWrapper = document.createElement('div');\r\n        chipWrapper.className = 'risk-chip-wrapper';\r\n\r\n        const riskChip = document.createElement('span');\r\n        riskChip.className = 'risk-chip risk-' + a.risk;\r\n        riskChip.textContent = a.risk.charAt(0).toUpperCase() + a.risk.slice(1) + ' Risk';\r\n\r\n        const riskDetails = document.createElement('span');\r\n        riskDetails.className = 'risk-details';\r\n\r\n        const riskData = risks[a.risk];\r\n        if (riskData) {\r\n          riskDetails.textContent = riskData.description || 'Activity-specific risks apply';\r\n        } else {\r\n          riskDetails.textContent = 'Activity-specific risks apply';\r\n        }\r\n\r\n        chipWrapper.appendChild(riskChip);\r\n        chipWrapper.appendChild(riskDetails);\r\n        label.appendChild(chipWrapper);\r\n      }\r\n\r\n      const initialInput = document.createElement('input');\r\n      initialInput.type = 'text';\r\n      initialInput.maxLength = 4;\r\n      initialInput.placeholder = 'Initials';\r\n      initialInput.className = 'activity-initial';\r\n      initialInput.dataset.slug = a.slug;\r\n      initialInput.oninput = validateMasterCheckbox;\r\n\r\n      checkbox.onchange = () => {\r\n        if (checkbox.checked) {\r\n          chosen.set(a.slug, {itemDiv, initialInput});\r\n          initialInput.classList.add('visible');\r\n          itemDiv.classList.add('checked');\r\n        } else {\r\n          chosen.delete(a.slug);\r\n          initialInput.classList.remove('visible');\r\n          initialInput.value = '';\r\n          itemDiv.classList.remove('checked');\r\n        }\r\n        validateMasterCheckbox();\r\n      };\r\n\r\n      itemDiv.appendChild(checkbox);\r\n      itemDiv.appendChild(label);\r\n\r\n      itemDiv.onclick = () => {\r\n        checkbox.checked = !checkbox.checked;\r\n        checkbox.onchange();\r\n      };\r\n\r\n      rowDiv.appendChild(itemDiv);\r\n      rowDiv.appendChild(initialInput);\r\n      actsDiv.appendChild(rowDiv);\r\n    });\r\n  }\r\n\r\n  function validateMasterCheckbox() {\r\n    let allFilled = true;\r\n    for (const [slug, {initialInput}] of chosen) {\r\n      if (!initialInput.value.trim()) {\r\n        allFilled = false;\r\n        break;\r\n      }\r\n    }\r\n    masterCheck.disabled = !allFilled || chosen.size === 0;\r\n    if (masterCheck.disabled) {\r\n      masterCheck.checked = false;\r\n    }\r\n  }\r\n\r\n  if (submission) {\r\n    loadActivities();\r\n    validateMasterCheckbox();\r\n  }\r\n\r\n  /* ---------- signature pad -------------------------------- */\r\n  const canvas = document.getElementById('sign');\r\n  const ctx = canvas.getContext('2d', { willReadFrequently: true });\r\n  let drawing = false;\r\n\r\n  canvas.addEventListener('pointerdown', e => {\r\n    drawing = true;\r\n    ctx.moveTo(e.offsetX, e.offsetY);\r\n  });\r\n  canvas.addEventListener('pointermove', e => {\r\n    if (!drawing) return;\r\n    ctx.lineTo(e.offsetX, e.offsetY);\r\n    ctx.stroke();\r\n  });\r\n  canvas.addEventListener('pointerup', () => drawing = false);\r\n  document.getElementById('clearSig').onclick =\r\n    () => ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n  /* ---------- activity form submit --------------------------------------- */\r\n  document.getElementById('activityForm').onsubmit = async e => {\r\n    e.preventDefault();\r\n\r\n    if (!submission) {\r\n      alert('Invalid submission. Please start over.');\r\n      return;\r\n    }\r\n\r\n    const data = {\r\n      submissionId: submission.submission_id,\r\n      activities: [...chosen.keys()],\r\n      initials: Object.fromEntries(\r\n        [...chosen.entries()].map(([slug, {initialInput}]) =>\r\n          [slug, initialInput.value])),\r\n      signature: canvas.toDataURL(),\r\n      accepted: document.getElementById('master').checked\r\n    };\r\n\r\n    console.log(\"Submitting activity form:\", data);\r\n\r\n    try {\r\n      const res = await fetch('/submit/complete', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(data)\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errorText = await res.text();\r\n        console.error(\"Server error:\", errorText);\r\n        alert(\"Error submitting form: \" + errorText);\r\n        return;\r\n      }\r\n\r\n      const json = await res.json();\r\n      console.log(\"Response data:\", json);\r\n\r\n      document.getElementById('activityForm').hidden = true;\r\n      document.getElementById('thanks').hidden = false;\r\n\r\n      if (json.devMode) {\r\n        let html = '<h2>\u2713 Waivers Generated</h2>';\r\n        html += '<p style=\"color:#64748b;margin-bottom:1.5rem\">Your waivers are ready to download</p>';\r\n        html += '<div style=\"display:flex;flex-direction:column;gap:12px\">';\r\n\r\n        json.downloads.forEach(pdf => {\r\n          html += '<button onclick=\"window.open(&quot;' + pdf.url + '&quot;, &quot;_blank&quot;)\" ';\r\n          html += 'style=\"padding:12px 24px;background:#3b82f6;color:white;border:none;';\r\n          html += 'border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;';\r\n          html += 'transition:background 0.2s\"';\r\n          html += ' onmouseover=\"this.style.background=&quot;#2563eb&quot;\"';\r\n          html += ' onmouseout=\"this.style.background=&quot;#3b82f6&quot;\">';\r\n          html += '\uD83D\uDCC4 Download ' + pdf.filename + '</button>';\r\n        });\r\n\r\n        html += '</div>';\r\n\r\n        if (json.downloads.length > 1) {\r\n          html += '<button onclick=\"';\r\n          json.downloads.forEach(pdf => {\r\n            html += 'window.open(&quot;' + pdf.url + '&quot;, &quot;_blank&quot;);';\r\n          });\r\n          html += '\" style=\"padding:14px 28px;background:#10b981;color:white;border:none;';\r\n          html += 'border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;margin-top:12px;';\r\n          html += 'transition:background 0.2s\"';\r\n          html += ' onmouseover=\"this.style.background=&quot;#059669&quot;\"';\r\n          html += ' onmouseout=\"this.style.background=&quot;#10b981&quot;\">';\r\n          html += '\uD83D\uDCE6 Download All (' + json.downloads.length + ' PDFs)</button>';\r\n        }\r\n\r\n        if (json.pin) {\r\n          html += '<div style=\"margin-top:1.5rem;padding:1rem;background:#fef3c7;border:2px solid #fbbf24;border-radius:8px\">';\r\n          html += '<p style=\"margin:0;color:#78350f;font-weight:600\">Archery PIN: <strong>' + json.pin + '</strong></p></div>';\r\n        }\r\n\r\n        html += '<p style=\"margin-top:1.5rem;color:#94a3b8;font-size:0.875rem\">';\r\n        html += '\u26A0\uFE0F Development Mode - PDFs stored locally, not emailed</p>';\r\n\r\n        document.getElementById('thanks').innerHTML = html;\r\n      } else {\r\n        let html = '<h2>\u2713 Success</h2>';\r\n        html += '<p style=\"color:#64748b;margin-bottom:1.5rem\">Your waivers have been sent to your email</p>';\r\n        if (json.pin) {\r\n          html += '<div style=\"margin-top:1.5rem;padding:1rem;background:#fef3c7;border:2px solid #fbbf24;border-radius:8px\">';\r\n          html += '<p style=\"margin:0;color:#78350f;font-weight:600\">Archery PIN: <strong>' + json.pin + '</strong></p></div>';\r\n        }\r\n        document.getElementById('thanks').innerHTML = html;\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Form submission error:\", error);\r\n      alert(\"Error submitting form: \" + error.message);\r\n    }\r\n  };\r\n</script>\r\n</body>\r\n</html>`, {\r\n    headers: { 'content-type': 'text/html; charset=utf-8' }\r\n  });\r\n}\r\n", "import { htmlPage } from '../utils/spa.js';\n\nexport async function handleRoot(request, env) {\n  const url = new URL(request.url);\n  const token = url.searchParams.get('token');\n\n  return await htmlPage(env, token);\n}\n", "// In-house nanoid implementation\n// Generates cryptographically secure random IDs\n\nconst urlAlphabet = 'useandom26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict';\n\nexport function nanoid(size = 21) {\n  let id = '';\n  const bytes = crypto.getRandomValues(new Uint8Array(size));\n\n  while (size--) {\n    id += urlAlphabet[bytes[size] & 63];\n  }\n\n  return id;\n}\n\nexport function customAlphabet(alphabet, defaultSize = 21) {\n  return (size = defaultSize) => {\n    let id = '';\n    const mask = (2 << Math.log2(alphabet.length - 1)) - 1;\n    const step = -~((1.6 * mask * size) / alphabet.length);\n\n    while (true) {\n      const bytes = crypto.getRandomValues(new Uint8Array(step));\n      let i = step;\n\n      while (i--) {\n        id += alphabet[bytes[i] & mask] || '';\n        if (id.length >= size) return id;\n      }\n    }\n  };\n}\n", "export const json = (obj, status = 200) =>\r\n  new Response(JSON.stringify(obj), {\r\n    status,\r\n    headers: { 'content-type': 'application/json' }\r\n  });\r\n\r\nexport const bad = msg => json({ ok: false, error: msg }, 400);\r\n\r\nexport async function handleAdmin() {\r\n  const html = `<!doctype html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\r\n  <title>Admin - Activity Waivers</title>\r\n  <style>\r\n    body {\r\n      font-family: system-ui, -apple-system, sans-serif;\r\n      margin: 0;\r\n      padding: 20px;\r\n      background: #f5f5f5;\r\n    }\r\n    .container {\r\n      max-width: 1400px;\r\n      margin: 0 auto;\r\n      background: white;\r\n      padding: 30px;\r\n      border-radius: 8px;\r\n      box-shadow: 0 2px 8px rgba(0,0,0,0.1);\r\n    }\r\n    h1 {\r\n      margin-top: 0;\r\n      color: #333;\r\n    }\r\n    .tabs {\r\n      display: flex;\r\n      border-bottom: 2px solid #ddd;\r\n      margin-bottom: 30px;\r\n    }\r\n    .tab {\r\n      padding: 12px 24px;\r\n      cursor: pointer;\r\n      border: none;\r\n      background: none;\r\n      font-size: 16px;\r\n      font-weight: 600;\r\n      color: #666;\r\n      border-bottom: 3px solid transparent;\r\n      transition: all 0.2s;\r\n    }\r\n    .tab:hover {\r\n      color: #0070f3;\r\n    }\r\n    .tab.active {\r\n      color: #0070f3;\r\n      border-bottom-color: #0070f3;\r\n    }\r\n    .tab-content {\r\n      display: none;\r\n    }\r\n    .tab-content.active {\r\n      display: block;\r\n    }\r\n    .search-form {\r\n      display: grid;\r\n      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\r\n      gap: 15px;\r\n      margin-bottom: 30px;\r\n      padding: 20px;\r\n      background: #f9f9f9;\r\n      border-radius: 8px;\r\n    }\r\n    .form-group {\r\n      display: flex;\r\n      flex-direction: column;\r\n    }\r\n    label {\r\n      font-weight: 600;\r\n      margin-bottom: 5px;\r\n      color: #555;\r\n      font-size: 14px;\r\n    }\r\n    input, select {\r\n      padding: 10px;\r\n      border: 1px solid #ddd;\r\n      border-radius: 4px;\r\n      font-size: 14px;\r\n      width: 100%;\r\n      max-width: 400px;\r\n      box-sizing: border-box;\r\n    }\r\n    input:focus, select:focus {\r\n      outline: none;\r\n      border-color: #0070f3;\r\n    }\r\n    .button-group {\r\n      grid-column: 1 / -1;\r\n      display: flex;\r\n      gap: 10px;\r\n    }\r\n    button {\r\n      padding: 12px 24px;\r\n      border: none;\r\n      border-radius: 4px;\r\n      font-size: 14px;\r\n      font-weight: 600;\r\n      cursor: pointer;\r\n      transition: all 0.2s;\r\n    }\r\n    .btn-search, .btn-primary {\r\n      background: #0070f3;\r\n      color: white;\r\n    }\r\n    .btn-search:hover, .btn-primary:hover {\r\n      background: #0051cc;\r\n    }\r\n    .btn-clear {\r\n      background: #eee;\r\n      color: #333;\r\n    }\r\n    .btn-clear:hover {\r\n      background: #ddd;\r\n    }\r\n    .btn-danger {\r\n      background: #dc3545;\r\n      color: white;\r\n      padding: 8px 15px;\r\n      font-size: 13px;\r\n      margin-left: 5px;\r\n    }\r\n    .btn-danger:hover {\r\n      background: #c82333;\r\n    }\r\n    .btn-warning {\r\n      background: #ffc107;\r\n      color: #000;\r\n      padding: 8px 15px;\r\n      font-size: 13px;\r\n      margin-left: 5px;\r\n    }\r\n    .btn-warning:hover {\r\n      background: #e0a800;\r\n    }\r\n    .results {\r\n      margin-top: 20px;\r\n    }\r\n    .result-count {\r\n      margin-bottom: 15px;\r\n      color: #666;\r\n      font-size: 14px;\r\n    }\r\n    table {\r\n      width: 100%;\r\n      border-collapse: collapse;\r\n      font-size: 14px;\r\n    }\r\n    thead {\r\n      background: #f9f9f9;\r\n    }\r\n    th {\r\n      text-align: left;\r\n      padding: 12px;\r\n      border-bottom: 2px solid #ddd;\r\n      font-weight: 600;\r\n      color: #555;\r\n    }\r\n    td {\r\n      padding: 12px;\r\n      border-bottom: 1px solid #eee;\r\n    }\r\n    tr:hover {\r\n      background: #f9f9f9;\r\n    }\r\n    .activity-badge {\r\n      display: inline-block;\r\n      padding: 4px 8px;\r\n      margin: 2px;\r\n      background: #e3f2fd;\r\n      color: #1976d2;\r\n      border-radius: 4px;\r\n      font-size: 12px;\r\n      cursor: pointer;\r\n      transition: all 0.2s;\r\n    }\r\n    .activity-badge:hover {\r\n      background: #1976d2;\r\n      color: white;\r\n    }\r\n    .loading {\r\n      text-align: center;\r\n      padding: 40px;\r\n      color: #666;\r\n    }\r\n    .error {\r\n      padding: 15px;\r\n      background: #fee;\r\n      color: #c33;\r\n      border-radius: 4px;\r\n      margin: 20px 0;\r\n    }\r\n    .message {\r\n      padding: 15px;\r\n      border-radius: 4px;\r\n      margin-bottom: 20px;\r\n    }\r\n    .success {\r\n      background: #d4edda;\r\n      color: #155724;\r\n      border: 1px solid #c3e6cb;\r\n    }\r\n    .empty {\r\n      text-align: center;\r\n      padding: 40px;\r\n      color: #999;\r\n    }\r\n    .section {\r\n      margin-bottom: 40px;\r\n      padding: 20px;\r\n      background: #f9f9f9;\r\n      border-radius: 8px;\r\n    }\r\n    h2 {\r\n      margin-top: 0;\r\n      font-size: 20px;\r\n      color: #555;\r\n    }\r\n    .activities-list {\r\n      margin-top: 20px;\r\n    }\r\n    .activity-item {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 15px;\r\n      background: white;\r\n      border: 1px solid #ddd;\r\n      border-radius: 4px;\r\n      margin-bottom: 10px;\r\n    }\r\n    .activity-info {\r\n      flex: 1;\r\n    }\r\n    .activity-slug {\r\n      font-weight: 600;\r\n      color: #333;\r\n      font-size: 16px;\r\n    }\r\n    .activity-label {\r\n      color: #666;\r\n      margin: 5px 0;\r\n    }\r\n    .risk-badge {\r\n      display: inline-block;\r\n      padding: 4px 12px;\r\n      border-radius: 4px;\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      margin-top: 5px;\r\n    }\r\n    .risk-low {\r\n      background: #d4edda;\r\n      color: #155724;\r\n    }\r\n    .risk-medium {\r\n      background: #fff3cd;\r\n      color: #856404;\r\n    }\r\n    .risk-high {\r\n      background: #f8d7da;\r\n      color: #721c24;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <h1>Activity Waivers Admin</h1>\r\n\r\n    <div class=\"tabs\">\r\n      <button class=\"tab active\" onclick=\"showTab('search')\">Search Submissions</button>\r\n      <button class=\"tab\" onclick=\"showTab('activities')\">Manage Activities</button>\r\n      <button class=\"tab\" onclick=\"showTab('properties')\">Manage Properties</button>\r\n      <button class=\"tab\" onclick=\"showTab('releases')\">Legal Releases</button>\r\n      <button class=\"tab\" onclick=\"showTab('debug')\">Debug</button>\r\n      <button class=\"tab\" onclick=\"showTab('api')\">API Documentation</button>\r\n    </div>\r\n\r\n    <!-- Search Tab -->\r\n    <div id=\"searchTab\" class=\"tab-content active\">\r\n      <form class=\"search-form\" id=\"searchForm\">\r\n        <div class=\"form-group\">\r\n          <label for=\"name\">Guest Name</label>\r\n          <input type=\"text\" id=\"name\" name=\"name\" placeholder=\"John Doe\">\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"email\">Email</label>\r\n          <input type=\"email\" id=\"email\" name=\"email\" placeholder=\"guest@example.com\">\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"prop\">Property ID</label>\r\n          <input type=\"text\" id=\"prop\" name=\"prop\" placeholder=\"cabin-12\">\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"date\">Check-in Date</label>\r\n          <input type=\"date\" id=\"date\" name=\"date\">\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"activity\">Activity</label>\r\n          <input type=\"text\" id=\"activity\" name=\"activity\" placeholder=\"archery\">\r\n        </div>\r\n\r\n        <div class=\"button-group\">\r\n          <button type=\"submit\" class=\"btn-search\">Search</button>\r\n          <button type=\"button\" class=\"btn-clear\" onclick=\"clearForm()\">Clear</button>\r\n        </div>\r\n      </form>\r\n\r\n      <div class=\"results\" id=\"results\"></div>\r\n    </div>\r\n\r\n    <!-- Activities Tab -->\r\n    <div id=\"activitiesTab\" class=\"tab-content\">\r\n      <div id=\"message\"></div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Property</h2>\r\n        <div class=\"form-group\">\r\n          <label for=\"propertySelect\">Select Property</label>\r\n          <select id=\"propertySelect\" onchange=\"loadActivities()\">\r\n            <option value=\"\">Loading...</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Add New Activity</h2>\r\n        <form id=\"addForm\">\r\n          <div class=\"form-group\">\r\n            <label for=\"addSlug\">Slug (e.g., rock-climbing)</label>\r\n            <input type=\"text\" id=\"addSlug\" required placeholder=\"rock-climbing\">\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label for=\"addLabel\">Label (Display Name)</label>\r\n            <input type=\"text\" id=\"addLabel\" required placeholder=\"Rock Climbing\">\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label for=\"addRisk\">Risk Level</label>\r\n            <select id=\"addRisk\" required>\r\n              <option value=\"low\">Low</option>\r\n              <option value=\"medium\">Medium</option>\r\n              <option value=\"high\">High</option>\r\n            </select>\r\n          </div>\r\n          <button type=\"submit\" class=\"btn-primary\">Add Activity</button>\r\n        </form>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Current Activities</h2>\r\n        <div id=\"activitiesList\" class=\"activities-list\">\r\n          <div class=\"loading\">Loading...</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- Properties Tab -->\r\n    <div id=\"propertiesTab\" class=\"tab-content\">\r\n      <div id=\"propMessage\"></div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Add New Property</h2>\r\n        <form id=\"addPropertyForm\">\r\n          <div class=\"form-group\">\r\n            <label for=\"propId\">Property ID (e.g., cabin-12)</label>\r\n            <input type=\"text\" id=\"propId\" required placeholder=\"cabin-12\">\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label for=\"propName\">Property Name</label>\r\n            <input type=\"text\" id=\"propName\" required placeholder=\"Cabin 12\">\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label for=\"copyDefaultActivities\" style=\"display: flex; align-items: center; gap: 8px; cursor: pointer;\">\r\n              <input type=\"checkbox\" id=\"copyDefaultActivities\" checked style=\"cursor: pointer;\">\r\n              <span>Copy default activities template</span>\r\n            </label>\r\n          </div>\r\n          <button type=\"submit\" class=\"btn-primary\">Add Property</button>\r\n        </form>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Current Properties</h2>\r\n        <div id=\"propertiesList\" class=\"activities-list\">\r\n          <div class=\"loading\">Loading...</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- Legal Releases Tab -->\r\n    <div id=\"releasesTab\" class=\"tab-content\">\r\n      <div id=\"releaseMessage\"></div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Current Release</h2>\r\n        <div id=\"currentRelease\" class=\"current-release\">\r\n          <div class=\"loading\">Loading...</div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Create New Release</h2>\r\n        <form id=\"releaseForm\">\r\n          <div class=\"form-group\">\r\n            <label for=\"releaseVersion\">Version</label>\r\n            <input type=\"text\" id=\"releaseVersion\" placeholder=\"Leave blank to auto-increment\" pattern=\"[0-9]+\\.[0-9]+\\.[0-9]+\">\r\n            <small style=\"color: #666; margin-top: 5px; display: block;\">Format: X.Y.Z (e.g., 1.0.1) - Leave blank to auto-increment patch version</small>\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label for=\"waiverText\">Legal Waiver Text</label>\r\n            <textarea id=\"waiverText\" required rows=\"12\" style=\"font-family: system-ui, sans-serif; resize: vertical; min-height: 200px;\"></textarea>\r\n          </div>\r\n          <button type=\"submit\" class=\"btn-primary\">Create Release</button>\r\n        </form>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <h2>Release History</h2>\r\n        <div id=\"releaseHistory\" class=\"release-history\">\r\n          <div class=\"loading\">Loading...</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- Debug Tab -->\r\n    <div id=\"debugTab\" class=\"tab-content\">\r\n      <div style=\"background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;\">\r\n        <strong>\u26A0\uFE0F Note:</strong> Debug data is cached and auto-updates every 7 days. Click \"Refresh Data\" to force an update.\r\n      </div>\r\n\r\n      <div style=\"margin-bottom: 20px;\">\r\n        <button class=\"btn-primary\" onclick=\"loadDebugData(true)\" style=\"padding: 10px 20px;\">\r\n          \uD83D\uDD04 Refresh Data\r\n        </button>\r\n        <span id=\"debugLastUpdate\" style=\"margin-left: 15px; color: #666; font-size: 14px;\"></span>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <h2>KV Store (PROPS_KV)</h2>\r\n        <div id=\"kvData\" style=\"background: #f9f9f9; padding: 15px; border-radius: 4px; overflow-x: auto;\">\r\n          <div class=\"loading\">Loading...</div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <h2>D1 Database Tables</h2>\r\n        <div id=\"d1Tables\" style=\"margin-top: 15px;\">\r\n          <div class=\"loading\">Loading...</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- API Documentation Tab -->\r\n    <div id=\"apiTab\" class=\"tab-content\">\r\n      <div style=\"max-width: 900px; margin: 0 auto;\">\r\n        <div style=\"background: white; padding: 30px; border-radius: 8px; line-height: 1.6;\">\r\n          <div id=\"apiDocs\" style=\"font-family: system-ui, sans-serif;\">\r\n            <!-- API documentation will be rendered here -->\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <script>\r\n    let currentProperties = [];\r\n\r\n    // Tab switching\r\n    function showTab(tabName) {\r\n      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));\r\n      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));\r\n\r\n      const tabs = document.querySelectorAll('.tab');\r\n      tabs.forEach(tab => {\r\n        if (tab.textContent.toLowerCase().includes(tabName === 'search' ? 'search' : tabName === 'activities' ? 'activities' : tabName === 'properties' ? 'properties' : tabName === 'releases' ? 'releases' : tabName === 'debug' ? 'debug' : 'api')) {\r\n          tab.classList.add('active');\r\n        }\r\n      });\r\n      document.getElementById(tabName + 'Tab').classList.add('active');\r\n\r\n      if (tabName === 'activities') {\r\n        loadPropertySelector();\r\n        loadActivities();\r\n      }\r\n      if (tabName === 'properties') {\r\n        loadProperties();\r\n      }\r\n      if (tabName === 'releases') {\r\n        loadReleases();\r\n      }\r\n      if (tabName === 'debug') {\r\n        loadDebugData();\r\n      }\r\n      if (tabName === 'api') {\r\n        loadApiDocs();\r\n      }\r\n    }\r\n\r\n    async function loadPropertySelector() {\r\n      const selector = document.getElementById('propertySelect');\r\n      try {\r\n        const response = await fetch('/admin/properties');\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        currentProperties = data.properties;\r\n        selector.innerHTML = currentProperties.map(p =>\r\n          \\`<option value=\"\\${p.id}\">\\${p.name}</option>\\`\r\n        ).join('');\r\n\r\n      } catch (error) {\r\n        selector.innerHTML = '<option value=\"\">Error loading properties</option>';\r\n      }\r\n    }\r\n\r\n    // Search functionality\r\n    const form = document.getElementById('searchForm');\r\n    const resultsDiv = document.getElementById('results');\r\n\r\n    window.addEventListener('load', () => search());\r\n\r\n    form.addEventListener('submit', (e) => {\r\n      e.preventDefault();\r\n      search();\r\n    });\r\n\r\n    async function search() {\r\n      resultsDiv.innerHTML = '<div class=\"loading\">Loading...</div>';\r\n\r\n      const formData = new FormData(form);\r\n      const params = new URLSearchParams();\r\n\r\n      for (const [key, value] of formData) {\r\n        if (value.trim()) {\r\n          params.append(key, value.trim());\r\n        }\r\n      }\r\n\r\n      try {\r\n        const response = await fetch('/admin/search?' + params.toString());\r\n        const data = await response.json();\r\n\r\n        if (!data.rows.success) {\r\n          throw new Error('Search failed');\r\n        }\r\n\r\n        displayResults(data.rows.results);\r\n      } catch (error) {\r\n        resultsDiv.innerHTML = '<div class=\"error\">Error loading results: ' + error.message + '</div>';\r\n      }\r\n    }\r\n\r\n    function displayResults(results) {\r\n      if (results.length === 0) {\r\n        resultsDiv.innerHTML = '<div class=\"empty\">No results found</div>';\r\n        return;\r\n      }\r\n\r\n      const countHtml = '<div class=\"result-count\">Found ' + results.length + ' submission' + (results.length !== 1 ? 's' : '') + '</div>';\r\n\r\n      const tableHtml = \\`\r\n        <table>\r\n          <thead>\r\n            <tr>\r\n              <th>Date</th>\r\n              <th>Guest Name</th>\r\n              <th>Email</th>\r\n              <th>Property</th>\r\n              <th>Check-in</th>\r\n              <th>Activities</th>\r\n              <th>Download</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            \\${results.map(row => {\r\n              const createdDate = new Date(row.created_at).toLocaleString();\r\n              const activities = JSON.parse(row.activities);\r\n\r\n              return \\`\r\n                <tr>\r\n                  <td>\\${createdDate}</td>\r\n                  <td>\\${escapeHtml(row.guest_name)}</td>\r\n                  <td>\\${escapeHtml(row.guest_email)}</td>\r\n                  <td>\\${escapeHtml(row.property_id)}</td>\r\n                  <td>\\${row.checkin_date}</td>\r\n                  <td>\r\n                    \\${activities.map(a =>\r\n                      '<span class=\"activity-badge\">' +\r\n                      escapeHtml(a) + '</span>'\r\n                    ).join('')}\r\n                  </td>\r\n                  <td>\r\n                    <button class=\"btn-primary\" onclick=\"downloadAllWaivers('\\${escapeHtml(row.submission_id)}')\" style=\"padding: 8px 12px; font-size: 13px;\">Download All</button>\r\n                  </td>\r\n                </tr>\r\n              \\`;\r\n            }).join('')}\r\n          </tbody>\r\n        </table>\r\n      \\`;\r\n\r\n      resultsDiv.innerHTML = countHtml + tableHtml;\r\n    }\r\n\r\n    function clearForm() {\r\n      form.reset();\r\n      search();\r\n    }\r\n\r\n    function escapeHtml(text) {\r\n      const div = document.createElement('div');\r\n      div.textContent = text;\r\n      return div.innerHTML;\r\n    }\r\n\r\n    // Activities Management\r\n    const messageDiv = document.getElementById('message');\r\n    const activitiesList = document.getElementById('activitiesList');\r\n\r\n    function showMessage(text, type = 'success') {\r\n      messageDiv.innerHTML = \\`<div class=\"message \\${type}\">\\${text}</div>\\`;\r\n      setTimeout(() => messageDiv.innerHTML = '', 5000);\r\n    }\r\n\r\n    async function loadActivities() {\r\n      const selector = document.getElementById('propertySelect');\r\n      const propertyId = selector.value;\r\n\r\n      if (!propertyId) return;\r\n\r\n      try {\r\n        const response = await fetch(\\`/admin/activities?property=\\${propertyId}\\`);\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        displayActivities(data.activities);\r\n      } catch (error) {\r\n        activitiesList.innerHTML = \\`<div class=\"error\">Error loading activities: \\${error.message}</div>\\`;\r\n      }\r\n    }\r\n\r\n    function displayActivities(activities) {\r\n      if (activities.length === 0) {\r\n        activitiesList.innerHTML = '<p>No activities found.</p>';\r\n        return;\r\n      }\r\n\r\n      activitiesList.innerHTML = activities.map(activity => \\`\r\n        <div class=\"activity-item\">\r\n          <div class=\"activity-info\">\r\n            <div class=\"activity-slug\">\\${activity.slug}</div>\r\n            <div class=\"activity-label\">\\${activity.label}</div>\r\n            <span class=\"risk-badge risk-\\${activity.risk}\">\\${activity.risk.toUpperCase()}</span>\r\n          </div>\r\n          <div class=\"activity-actions\">\r\n            <button class=\"btn-warning\" onclick=\"editActivity('\\${activity.slug}', '\\${activity.label}', '\\${activity.risk}')\">Edit</button>\r\n            <button class=\"btn-danger\" onclick=\"removeActivity('\\${activity.slug}')\">Remove</button>\r\n          </div>\r\n        </div>\r\n      \\`).join('');\r\n    }\r\n\r\n    document.getElementById('addForm').addEventListener('submit', async (e) => {\r\n      e.preventDefault();\r\n\r\n      const selector = document.getElementById('propertySelect');\r\n      const propertyId = selector.value;\r\n\r\n      if (!propertyId) {\r\n        showMessage('Please select a property first', 'error');\r\n        return;\r\n      }\r\n\r\n      const slug = document.getElementById('addSlug').value.trim();\r\n      const label = document.getElementById('addLabel').value.trim();\r\n      const risk = document.getElementById('addRisk').value;\r\n\r\n      try {\r\n        const response = await fetch(\\`/admin/activities/add?property=\\${propertyId}\\`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ slug, label, risk })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        showMessage(\\`Activity \"\\${label}\" added successfully!\\`);\r\n        document.getElementById('addForm').reset();\r\n        loadActivities();\r\n      } catch (error) {\r\n        showMessage(error.message, 'error');\r\n      }\r\n    });\r\n\r\n    async function removeActivity(slug) {\r\n      if (!confirm(\\`Remove activity \"\\${slug}\"?\\`)) return;\r\n\r\n      const selector = document.getElementById('propertySelect');\r\n      const propertyId = selector.value;\r\n\r\n      try {\r\n        const response = await fetch(\\`/admin/activities/remove?property=\\${propertyId}\\`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ slug })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        showMessage(\\`Activity \"\\${slug}\" removed successfully!\\`);\r\n        loadActivities();\r\n      } catch (error) {\r\n        showMessage(error.message, 'error');\r\n      }\r\n    }\r\n\r\n    function editActivity(slug, currentLabel, currentRisk) {\r\n      const newLabel = prompt('Enter new label:', currentLabel);\r\n      if (newLabel === null) return;\r\n\r\n      const newRisk = prompt('Enter risk level (low/medium/high):', currentRisk);\r\n      if (newRisk === null) return;\r\n\r\n      if (!['low', 'medium', 'high'].includes(newRisk.toLowerCase())) {\r\n        showMessage('Invalid risk level. Must be low, medium, or high.', 'error');\r\n        return;\r\n      }\r\n\r\n      updateActivity(slug, newLabel, newRisk.toLowerCase());\r\n    }\r\n\r\n    async function updateActivity(slug, label, risk) {\r\n      const selector = document.getElementById('propertySelect');\r\n      const propertyId = selector.value;\r\n\r\n      try {\r\n        const response = await fetch(\\`/admin/activities/update?property=\\${propertyId}\\`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ slug, label, risk })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        showMessage(\\`Activity \"\\${slug}\" updated successfully!\\`);\r\n        loadActivities();\r\n      } catch (error) {\r\n        showMessage(error.message, 'error');\r\n      }\r\n    }\r\n\r\n    // Properties Management\r\n    const propMessageDiv = document.getElementById('propMessage');\r\n    const propertiesList = document.getElementById('propertiesList');\r\n\r\n    function showPropMessage(text, type = 'success') {\r\n      propMessageDiv.innerHTML = \\`<div class=\"message \\${type}\">\\${text}</div>\\`;\r\n      setTimeout(() => propMessageDiv.innerHTML = '', 5000);\r\n    }\r\n\r\n    async function loadProperties() {\r\n      try {\r\n        const response = await fetch('/admin/properties');\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        displayProperties(data.properties);\r\n      } catch (error) {\r\n        propertiesList.innerHTML = \\`<div class=\"error\">Error loading properties: \\${error.message}</div>\\`;\r\n      }\r\n    }\r\n\r\n    function displayProperties(properties) {\r\n      if (properties.length === 0) {\r\n        propertiesList.innerHTML = '<p>No properties found.</p>';\r\n        return;\r\n      }\r\n\r\n      propertiesList.innerHTML = properties.map(property => \\`\r\n        <div class=\"activity-item\">\r\n          <div class=\"activity-info\">\r\n            <div class=\"activity-slug\">\\${property.id}</div>\r\n            <div class=\"activity-label\">\\${property.name}</div>\r\n          </div>\r\n          <div class=\"activity-actions\">\r\n            <button class=\"btn-danger\" onclick=\"removeProperty('\\${property.id}')\">Remove</button>\r\n          </div>\r\n        </div>\r\n      \\`).join('');\r\n    }\r\n\r\n    document.getElementById('addPropertyForm').addEventListener('submit', async (e) => {\r\n      e.preventDefault();\r\n\r\n      const id = document.getElementById('propId').value.trim();\r\n      const name = document.getElementById('propName').value.trim();\r\n      const copyDefaults = document.getElementById('copyDefaultActivities').checked;\r\n\r\n      try {\r\n        const response = await fetch('/admin/properties/add', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ id, name, copyDefaultActivities: copyDefaults })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        showPropMessage(\\`Property \"\\${name}\" added successfully!\\`);\r\n        document.getElementById('addPropertyForm').reset();\r\n        document.getElementById('copyDefaultActivities').checked = true;\r\n        loadProperties();\r\n      } catch (error) {\r\n        showPropMessage(error.message, 'error');\r\n      }\r\n    });\r\n\r\n    async function removeProperty(id) {\r\n      if (!confirm(\\`Remove property \"\\${id}\"?\\`)) return;\r\n\r\n      try {\r\n        const response = await fetch('/admin/properties/remove', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ id })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        showPropMessage(\\`Property \"\\${id}\" removed successfully!\\`);\r\n        loadProperties();\r\n      } catch (error) {\r\n        showPropMessage(error.message, 'error');\r\n      }\r\n    }\r\n\r\n    // Hash verification only\r\n    async function verifyDocumentHash(submissionId, activity) {\r\n      try {\r\n        const docResponse = await fetch('/admin/document?submission=' + submissionId + '&activity=' + activity);\r\n        const docData = await docResponse.json();\r\n\r\n        if (!docData.ok) {\r\n          alert('Error: ' + docData.error);\r\n          return;\r\n        }\r\n\r\n        const verifyResponse = await fetch('/admin/verify?document=' + docData.document_id);\r\n        const verifyData = await verifyResponse.json();\r\n\r\n        if (!verifyData.ok) {\r\n          alert('Error: ' + verifyData.error);\r\n          return;\r\n        }\r\n\r\n        if (verifyData.verified) {\r\n          alert('\u2713 Hash Verified Successfully\\\\n\\\\nDocument ID: ' + docData.document_id + '\\\\nStored Hash: ' + verifyData.stored_hash.substring(0, 16) + '...\\\\nComputed Hash: ' + verifyData.computed_hash.substring(0, 16) + '...');\r\n        } else {\r\n          alert('\u2717 Hash Verification Failed\\\\n\\\\nDocument may have been tampered with\\\\nDocument ID: ' + docData.document_id + '\\\\nStored Hash: ' + verifyData.stored_hash.substring(0, 16) + '...\\\\nComputed Hash: ' + verifyData.computed_hash.substring(0, 16) + '...');\r\n        }\r\n      } catch (error) {\r\n        alert('Error verifying hash: ' + error.message);\r\n      }\r\n    }\r\n\r\n    async function downloadAllWaivers(submissionId) {\r\n      window.location.href = '/admin/download-all?submission=' + submissionId;\r\n    }\r\n\r\n    // Legal Releases functionality\r\n    async function loadReleases() {\r\n      const currentReleaseDiv = document.getElementById('currentRelease');\r\n      const historyDiv = document.getElementById('releaseHistory');\r\n\r\n      try {\r\n        const response = await fetch('/admin/releases');\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        // Display current release\r\n        if (data.current) {\r\n          const rel = data.current;\r\n          currentReleaseDiv.innerHTML = \\`\r\n            <div style=\"padding: 15px; background: #f0f9ff; border-left: 4px solid #0070f3; border-radius: 4px;\">\r\n              <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\r\n                <strong style=\"font-size: 18px;\">Version \\${rel.version}</strong>\r\n                <span style=\"color: #666; font-size: 14px;\">\\${new Date(rel.release_date).toLocaleDateString()}</span>\r\n              </div>\r\n              <div style=\"white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #333; margin-top: 10px;\">\\${rel.waiver_text}</div>\r\n            </div>\r\n          \\`;\r\n        } else {\r\n          currentReleaseDiv.innerHTML = '<div class=\"empty\">No releases yet. Create the first release below.</div>';\r\n        }\r\n\r\n        // Display history\r\n        if (data.releases && data.releases.length > 0) {\r\n          historyDiv.innerHTML = data.releases.map(rel => \\`\r\n            <div style=\"padding: 12px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 10px;\">\r\n              <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n                <strong>Version \\${rel.version}</strong>\r\n                <span style=\"color: #666; font-size: 13px;\">\\${new Date(rel.release_date).toLocaleDateString()}</span>\r\n              </div>\r\n              <div style=\"white-space: pre-wrap; font-size: 13px; line-height: 1.5; color: #555; margin-top: 8px; max-height: 100px; overflow-y: auto;\">\\${rel.waiver_text}</div>\r\n            </div>\r\n          \\`).join('');\r\n        } else {\r\n          historyDiv.innerHTML = '<div class=\"empty\">No release history</div>';\r\n        }\r\n\r\n        // Populate form with current waiver text\r\n        if (data.current) {\r\n          document.getElementById('waiverText').value = data.current.waiver_text;\r\n        }\r\n      } catch (error) {\r\n        currentReleaseDiv.innerHTML = '<div class=\"error\">Error loading releases: ' + error.message + '</div>';\r\n        historyDiv.innerHTML = '';\r\n      }\r\n    }\r\n\r\n    document.getElementById('releaseForm').addEventListener('submit', async (e) => {\r\n      e.preventDefault();\r\n\r\n      const version = document.getElementById('releaseVersion').value.trim();\r\n      const waiverText = document.getElementById('waiverText').value.trim();\r\n\r\n      try {\r\n        const response = await fetch('/admin/releases/create', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ version: version || null, waiver_text: waiverText })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        showReleaseMessage(\\`Release version \\${data.version} created successfully!\\`);\r\n        document.getElementById('releaseVersion').value = '';\r\n        loadReleases();\r\n      } catch (error) {\r\n        showReleaseMessage(error.message, 'error');\r\n      }\r\n    });\r\n\r\n    function showReleaseMessage(msg, type = 'success') {\r\n      const div = document.getElementById('releaseMessage');\r\n      div.innerHTML = \\`<div class=\"\\${type === 'error' ? 'error' : 'success'}\">\\${msg}</div>\\`;\r\n      setTimeout(() => div.innerHTML = '', 5000);\r\n    }\r\n\r\n    // Debug functionality\r\n    async function loadDebugData(forceRefresh = false) {\r\n      const kvDataDiv = document.getElementById('kvData');\r\n      const d1TablesDiv = document.getElementById('d1Tables');\r\n      const lastUpdateSpan = document.getElementById('debugLastUpdate');\r\n\r\n      try {\r\n        kvDataDiv.innerHTML = '<div class=\"loading\">Loading KV data...</div>';\r\n        d1TablesDiv.innerHTML = '<div class=\"loading\">Loading D1 tables...</div>';\r\n\r\n        const response = await fetch('/admin/debug' + (forceRefresh ? '?refresh=true' : ''));\r\n        const data = await response.json();\r\n\r\n        if (!data.ok) {\r\n          throw new Error(data.error);\r\n        }\r\n\r\n        // Display last update time\r\n        const lastUpdate = new Date(data.lastUpdate);\r\n        lastUpdateSpan.textContent = 'Last updated: ' + lastUpdate.toLocaleString();\r\n\r\n        // Display KV data\r\n        let kvHtml = '<h3>All KV Keys</h3>';\r\n        if (data.kv && Object.keys(data.kv).length > 0) {\r\n          for (const [key, value] of Object.entries(data.kv)) {\r\n            kvHtml += '<div style=\"margin-bottom: 20px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px;\">';\r\n            kvHtml += '<strong style=\"color: #0070f3; font-family: monospace;\">' + escapeHtml(key) + '</strong>';\r\n            kvHtml += '<pre style=\"margin: 10px 0 0 0; padding: 10px; background: #f5f5f5; border-radius: 4px; overflow-x: auto; font-size: 12px;\">' + escapeHtml(JSON.stringify(value, null, 2)) + '</pre>';\r\n            kvHtml += '</div>';\r\n          }\r\n        } else {\r\n          kvHtml += '<p style=\"color: #666;\">No KV data found</p>';\r\n        }\r\n        kvDataDiv.innerHTML = kvHtml;\r\n\r\n        // Display D1 tables\r\n        let d1Html = '';\r\n        if (data.d1 && Object.keys(data.d1).length > 0) {\r\n          for (const [tableName, tableData] of Object.entries(data.d1)) {\r\n            d1Html += '<div style=\"margin-bottom: 30px;\">';\r\n            d1Html += '<h3 style=\"margin-bottom: 10px;\">' + escapeHtml(tableName) + ' (' + tableData.count + ' rows)</h3>';\r\n\r\n            if (tableData.rows && tableData.rows.length > 0) {\r\n              d1Html += '<div style=\"overflow-x: auto;\">';\r\n              d1Html += '<table style=\"width: 100%; border-collapse: collapse; background: white;\">';\r\n\r\n              // Table headers\r\n              d1Html += '<thead><tr>';\r\n              const columns = Object.keys(tableData.rows[0]);\r\n              columns.forEach(col => {\r\n                d1Html += '<th style=\"padding: 10px; text-align: left; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600;\">' + escapeHtml(col) + '</th>';\r\n              });\r\n              d1Html += '</tr></thead>';\r\n\r\n              // Table rows (limit to first 50 rows)\r\n              d1Html += '<tbody>';\r\n              tableData.rows.slice(0, 50).forEach(row => {\r\n                d1Html += '<tr>';\r\n                columns.forEach(col => {\r\n                  let value = row[col];\r\n                  if (value === null) value = '<em style=\"color: #999;\">null</em>';\r\n                  else if (typeof value === 'object') value = JSON.stringify(value);\r\n                  else value = escapeHtml(String(value));\r\n                  d1Html += '<td style=\"padding: 10px; border: 1px solid #ddd; font-size: 13px;\">' + value + '</td>';\r\n                });\r\n                d1Html += '</tr>';\r\n              });\r\n              d1Html += '</tbody>';\r\n              d1Html += '</table>';\r\n              d1Html += '</div>';\r\n\r\n              if (tableData.count > 50) {\r\n                d1Html += '<p style=\"margin-top: 10px; color: #666; font-size: 13px;\"><em>Showing first 50 of ' + tableData.count + ' rows</em></p>';\r\n              }\r\n            } else {\r\n              d1Html += '<p style=\"color: #666;\">No data in this table</p>';\r\n            }\r\n            d1Html += '</div>';\r\n          }\r\n        } else {\r\n          d1Html += '<p style=\"color: #666;\">No D1 tables found</p>';\r\n        }\r\n        d1TablesDiv.innerHTML = d1Html;\r\n\r\n      } catch (error) {\r\n        kvDataDiv.innerHTML = '<div class=\"error\">Error loading KV data: ' + escapeHtml(error.message) + '</div>';\r\n        d1TablesDiv.innerHTML = '<div class=\"error\">Error loading D1 data: ' + escapeHtml(error.message) + '</div>';\r\n      }\r\n    }\r\n\r\n    // API Documentation functionality\r\n    function loadApiDocs() {\r\n      const apiDocsDiv = document.getElementById('apiDocs');\r\n      apiDocsDiv.innerHTML = \\`<div class=\"loading\">Loading API documentation...</div>\\`;\r\n\r\n      fetch('/admin/api-docs')\r\n        .then(response => response.text())\r\n        .then(markdown => {\r\n          apiDocsDiv.innerHTML = convertMarkdownToHTML(markdown);\r\n        })\r\n        .catch(error => {\r\n          apiDocsDiv.innerHTML = '<div class=\"error\">Error loading API documentation</div>';\r\n        });\r\n    }\r\n\r\n    // Simple markdown to HTML converter\r\n    function convertMarkdownToHTML(markdown) {\r\n      let html = markdown\r\n        // Escape HTML\r\n        .replace(/&/g, '&amp;')\r\n        .replace(/</g, '&lt;')\r\n        .replace(/>/g, '&gt;')\r\n        // Headers\r\n        .replace(/^### (.+)$/gm, '<h3 style=\"margin-top: 30px; color: #333;\">$1</h3>')\r\n        .replace(/^## (.+)$/gm, '<h2 style=\"margin-top: 40px; color: #0070f3; border-bottom: 2px solid #0070f3; padding-bottom: 10px;\">$1</h2>')\r\n        .replace(/^# (.+)$/gm, '<h1 style=\"color: #0070f3;\">$1</h1>')\r\n        // Bold\r\n        .replace(/\\\\*\\\\*(.+?)\\\\*\\\\*/g, '<strong>$1</strong>')\r\n        // Code blocks\r\n        .replace(/\\`\\`\\`(\\\\w+)?\\\\n([\\\\s\\\\S]*?)\\`\\`\\`/g, '<pre style=\"background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; border: 1px solid #ddd;\"><code>$2</code></pre>')\r\n        // Inline code\r\n        .replace(/\\`([^\\`]+)\\`/g, '<code style=\"background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em;\">$1</code>')\r\n        // Horizontal rule\r\n        .replace(/^---$/gm, '<hr style=\"margin: 30px 0; border: none; border-top: 1px solid #ddd;\">')\r\n        // Lists\r\n        .replace(/^- (.+)$/gm, '<li style=\"margin: 5px 0;\">$1</li>')\r\n        // Wrap consecutive list items\r\n        .replace(/(<li[^>]*>.*<\\\\/li>\\\\n?)+/g, '<ul style=\"margin: 10px 0; padding-left: 30px;\">$&</ul>')\r\n        // Paragraphs\r\n        .replace(/^(?!<[h|u|p|l|d|c])(\\\\S.*)$/gm, '<p style=\"margin: 10px 0;\">$1</p>');\r\n\r\n      return html;\r\n    }\r\n  </script>\r\n</body>\r\n</html>`;\r\n\r\n  return new Response(html, {\r\n    headers: { 'Content-Type': 'text/html; charset=utf-8' }\r\n  });\r\n}\r\n", "export function validateSubmission(data) {\n  const must = ['propertyId','checkinDate','guestName','guestEmail',\n                'activities','initials','signature','accepted'];\n\n  for (const k of must) {\n    if (data[k] === undefined || data[k] === '' ||\n        (Array.isArray(data[k]) && !data[k].length)) {\n      return `missing ${k}`;\n    }\n  }\n\n  if (data.accepted !== true) {\n    return 'master acceptance not ticked';\n  }\n\n  return null;\n}\n", "export async function saveSubmission(env, subId, data, createdAt) {\n  await env.waivers.prepare(\n      'INSERT INTO submissions VALUES(?1,?2,?3,?4,?5,?6,?7)'\n    ).bind(\n      subId, createdAt, data.propertyId, data.checkinDate,\n      data.guestName, data.guestEmail, JSON.stringify(data.activities)\n    ).run();\n}\n\nexport async function saveDocuments(env, subId, pdfInfos) {\n  const now = new Date().toISOString();\n\n  for (const p of pdfInfos) {\n    // Insert document\n    await env.waivers.prepare(\n        'INSERT INTO documents VALUES(?1,?2,?3,?4,?5)'\n      ).bind(p.id, subId, p.activity, p.r2Key, p.initials).run();\n\n    // Insert hash\n    const hashId = `hash_${p.id}`;\n    await env.waivers.prepare(\n        'INSERT INTO hashes VALUES(?1,?2,?3,?4)'\n      ).bind(hashId, p.id, p.hash, now).run();\n  }\n}\n", "import { nanoid } from '../utils/nanoid.js';\n\nasync function generateDocumentHash(data) {\n  const hashInput = JSON.stringify({\n    submission_id: data.submission_id,\n    property_id: data.property_id,\n    checkin_date: data.checkin_date,\n    guest_name: data.guest_name,\n    guest_email: data.guest_email,\n    activity: data.activity,\n    activity_label: data.activity_label,\n    initials: data.initials,\n    signature_key: data.signature_key,\n    created_at: data.created_at,\n    release_version: data.release_version,\n    release_date: data.release_date\n  });\n\n  const encoder = new TextEncoder();\n  const dataBuffer = encoder.encode(hashInput);\n  const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\n\n  return hashHex;\n}\n\nfunction generateWaiverHTML(data, activityInfo, riskData, latestRelease, documentId, documentHash) {\n  const riskLevel = activityInfo?.risk || 'medium';\n\n  return `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    @page {\n      size: A4;\n      margin: 1in;\n    }\n\n    body {\n      font-family: 'Helvetica', 'Arial', sans-serif;\n      font-size: 11pt;\n      line-height: 1.6;\n      color: #000;\n      margin: 0;\n      padding: 20px;\n    }\n\n    h1 {\n      font-size: 20pt;\n      font-weight: bold;\n      margin-bottom: 30px;\n      text-transform: uppercase;\n    }\n\n    .details {\n      margin-bottom: 30px;\n      line-height: 2;\n    }\n\n    .risk-section {\n      margin: 30px 0;\n    }\n\n    .risk-level {\n      font-weight: bold;\n      font-size: 12pt;\n      margin-bottom: 10px;\n    }\n\n    .risk-description {\n      color: #4a4a4a;\n      font-size: 10pt;\n      margin-bottom: 20px;\n    }\n\n    .waiver-section {\n      margin: 30px 0;\n    }\n\n    .waiver-title {\n      font-weight: bold;\n      font-size: 12pt;\n      margin-bottom: 10px;\n    }\n\n    .waiver-text {\n      font-size: 9pt;\n      line-height: 1.5;\n      white-space: pre-wrap;\n    }\n\n    .signature-section {\n      margin-top: 40px;\n      page-break-inside: avoid;\n    }\n\n    .signature-label {\n      font-size: 12pt;\n      margin-bottom: 10px;\n    }\n\n    .signature-image {\n      max-width: 400px;\n      max-height: 150px;\n    }\n\n    .footer {\n      position: fixed;\n      bottom: 0.5in;\n      right: 1in;\n      text-align: right;\n      font-size: 7pt;\n      color: #808080;\n      line-height: 1.4;\n    }\n  </style>\n</head>\n<body>\n  <h1>${data.activity.toUpperCase()} \u2014 Release of Liability</h1>\n\n  <div class=\"details\">\n    Property  : ${data.propertyId}<br>\n    Check-in  : ${data.checkinDate}<br>\n    Guest     : ${data.guestName}<br>\n    Initials  : ${data.initials[data.activity]}\n  </div>\n\n  <div class=\"risk-section\">\n    <div class=\"risk-level\">Risk Level: ${riskLevel.toUpperCase()}</div>\n    ${riskData?.description ? `<div class=\"risk-description\">${riskData.description}</div>` : ''}\n  </div>\n\n  <div class=\"waiver-section\">\n    <div class=\"waiver-title\">Waiver and Release:</div>\n    <div class=\"waiver-text\">${latestRelease.waiver_text}</div>\n  </div>\n\n  <div class=\"signature-section\">\n    <div class=\"signature-label\">Signature:</div>\n    ${data.signature ? `<img src=\"${data.signature}\" class=\"signature-image\" />` : '<p style=\"color: #808080;\">No signature provided</p>'}\n  </div>\n\n  <div class=\"footer\">\n    Legal Version ${latestRelease.version} (${latestRelease.release_date}) \u2022 Document ID: ${documentId}<br>\n    Verification Hash: ${documentHash.substring(0, 32)}...\n  </div>\n</body>\n</html>`;\n}\n\nexport async function makePDFs(data, subId, env) {\n  const now = new Date();\n  const createdAt = now.toISOString();\n  const y = now.getUTCFullYear();\n  const m = String(now.getUTCMonth() + 1).padStart(2, '0');\n  const d = String(now.getUTCDate()).padStart(2, '0');\n\n  // Fetch latest legal release\n  const latestRelease = await env.waivers.prepare(\n    'SELECT version, release_date, waiver_text FROM releases ORDER BY release_date DESC, version DESC LIMIT 1'\n  ).first();\n\n  if (!latestRelease) {\n    throw new Error('No legal release found. Please create a release in the admin panel first.');\n  }\n\n  // Fetch activity info from database\n  const activitiesResult = await env.waivers.prepare(\n    'SELECT slug, label, risk FROM activities WHERE property_id = ?'\n  ).bind(data.propertyId).all();\n  const activities = activitiesResult.results || [];\n\n  // Fetch risk descriptions from database\n  const risksResult = await env.waivers.prepare(\n    'SELECT level, description FROM risk_descriptions'\n  ).all();\n  const risks = {};\n  for (const row of (risksResult.results || [])) {\n    risks[row.level] = { description: row.description };\n  }\n\n  // Save signature to R2 (once per submission, not per activity)\n  let signatureKey = null;\n  if (data.signature) {\n    try {\n      const signatureData = data.signature.split(',')[1];\n      const signatureBytes = Uint8Array.from(atob(signatureData), c => c.charCodeAt(0));\n\n      const nameParts = data.guestName.trim().split(/\\s+/);\n      const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, '') || 'unknown';\n      const lastName = nameParts.length > 1\n        ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, '')\n        : 'unknown';\n\n      signatureKey = `waivers/${y}/${m}/${d}/${data.propertyId}/signatures/${lastName}-${firstName}-${subId}.png`;\n\n      await env.WAIVERS_R2.put(signatureKey, signatureBytes, {\n        httpMetadata: { contentType: 'image/png' }\n      });\n    } catch (err) {\n      console.error('Error saving signature to R2:', err);\n    }\n  }\n\n  const results = [];\n\n  for (const act of data.activities) {\n    const activityInfo = activities.find(a => a.slug === act);\n    const riskLevel = activityInfo?.risk || 'medium';\n    const riskData = risks[riskLevel];\n\n    const nameParts = data.guestName.trim().split(/\\s+/);\n    const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, '') || 'unknown';\n    const lastName = nameParts.length > 1\n      ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, '')\n      : 'unknown';\n\n    const documentId = nanoid(12);\n\n    const hashData = {\n      submission_id: subId,\n      property_id: data.propertyId,\n      checkin_date: data.checkinDate,\n      guest_name: data.guestName,\n      guest_email: data.guestEmail,\n      activity: act,\n      activity_label: activityInfo?.label || act,\n      initials: data.initials[act],\n      signature_key: signatureKey,\n      created_at: createdAt,\n      release_version: latestRelease.version,\n      release_date: latestRelease.release_date\n    };\n\n    const documentHash = await generateDocumentHash(hashData);\n\n    // Generate HTML for this activity\n    const htmlContent = generateWaiverHTML(\n      { ...data, activity: act },\n      activityInfo,\n      riskData,\n      latestRelease,\n      documentId,\n      documentHash\n    );\n\n    // Use Cloudflare Browser Rendering to generate PDF\n    let pdfBytes;\n    try {\n      const browser = await env.BROWSER.launch();\n      const page = await browser.newPage();\n      await page.setContent(htmlContent, { waitUntil: 'networkidle' });\n\n      pdfBytes = await page.pdf({\n        format: 'A4',\n        printBackground: true,\n        margin: {\n          top: '1in',\n          right: '1in',\n          bottom: '1in',\n          left: '1in'\n        }\n      });\n\n      await browser.close();\n    } catch (err) {\n      console.error('Error generating PDF with browser rendering:', err);\n      throw new Error(`Failed to generate PDF for activity ${act}: ${err.message}`);\n    }\n\n    // Save to R2\n    const filename = `${lastName}-${firstName}-${subId}.pdf`;\n    const key = `waivers/${y}/${m}/${d}/${data.propertyId}/${act}/${lastName}-${firstName}-${subId}.pdf`;\n\n    await env.WAIVERS_R2.put(key, pdfBytes, {\n      httpMetadata: { contentType: 'application/pdf' }\n    });\n\n    results.push({\n      id: documentId,\n      activity: act,\n      filename,\n      r2Key: key,\n      bytes: pdfBytes,\n      hash: documentHash,\n      initials: data.initials[act]\n    });\n  }\n\n  return results;\n}\n", "var __defProp = Object.defineProperty;\nvar __defProps = Object.defineProperties;\nvar __getOwnPropDescs = Object.getOwnPropertyDescriptors;\nvar __getOwnPropSymbols = Object.getOwnPropertySymbols;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __propIsEnum = Object.prototype.propertyIsEnumerable;\nvar __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;\nvar __spreadValues = (a, b) => {\n  for (var prop in b || (b = {}))\n    if (__hasOwnProp.call(b, prop))\n      __defNormalProp(a, prop, b[prop]);\n  if (__getOwnPropSymbols)\n    for (var prop of __getOwnPropSymbols(b)) {\n      if (__propIsEnum.call(b, prop))\n        __defNormalProp(a, prop, b[prop]);\n    }\n  return a;\n};\nvar __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));\nvar __objRest = (source, exclude) => {\n  var target = {};\n  for (var prop in source)\n    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)\n      target[prop] = source[prop];\n  if (source != null && __getOwnPropSymbols)\n    for (var prop of __getOwnPropSymbols(source)) {\n      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))\n        target[prop] = source[prop];\n    }\n  return target;\n};\nvar __async = (__this, __arguments, generator) => {\n  return new Promise((resolve, reject) => {\n    var fulfilled = (value) => {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    };\n    var rejected = (value) => {\n      try {\n        step(generator.throw(value));\n      } catch (e) {\n        reject(e);\n      }\n    };\n    var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);\n    step((generator = generator.apply(__this, __arguments)).next());\n  });\n};\n\n// package.json\nvar version = \"6.1.1\";\n\n// src/common/utils/build-pagination-query.ts\nfunction buildPaginationQuery(options) {\n  const searchParams = new URLSearchParams();\n  if (options.limit !== void 0) {\n    searchParams.set(\"limit\", options.limit.toString());\n  }\n  if (\"after\" in options && options.after !== void 0) {\n    searchParams.set(\"after\", options.after);\n  }\n  if (\"before\" in options && options.before !== void 0) {\n    searchParams.set(\"before\", options.before);\n  }\n  return searchParams.toString();\n}\n\n// src/api-keys/api-keys.ts\nvar ApiKeys = class {\n  constructor(resend) {\n    this.resend = resend;\n  }\n  create(_0) {\n    return __async(this, arguments, function* (payload, options = {}) {\n      const data = yield this.resend.post(\n        \"/api-keys\",\n        payload,\n        options\n      );\n      return data;\n    });\n  }\n  list() {\n    return __async(this, arguments, function* (options = {}) {\n      const queryString = buildPaginationQuery(options);\n      const url = queryString ? `/api-keys?${queryString}` : \"/api-keys\";\n      const data = yield this.resend.get(url);\n      return data;\n    });\n  }\n  remove(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.delete(\n        `/api-keys/${id}`\n      );\n      return data;\n    });\n  }\n};\n\n// src/audiences/audiences.ts\nvar Audiences = class {\n  constructor(resend) {\n    this.resend = resend;\n  }\n  create(_0) {\n    return __async(this, arguments, function* (payload, options = {}) {\n      const data = yield this.resend.post(\n        \"/audiences\",\n        payload,\n        options\n      );\n      return data;\n    });\n  }\n  list() {\n    return __async(this, arguments, function* (options = {}) {\n      const queryString = buildPaginationQuery(options);\n      const url = queryString ? `/audiences?${queryString}` : \"/audiences\";\n      const data = yield this.resend.get(url);\n      return data;\n    });\n  }\n  get(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.get(\n        `/audiences/${id}`\n      );\n      return data;\n    });\n  }\n  remove(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.delete(\n        `/audiences/${id}`\n      );\n      return data;\n    });\n  }\n};\n\n// src/common/utils/parse-email-to-api-options.ts\nfunction parseAttachments(attachments) {\n  return attachments == null ? void 0 : attachments.map((attachment) => ({\n    content: attachment.content,\n    filename: attachment.filename,\n    path: attachment.path,\n    content_type: attachment.contentType,\n    content_id: attachment.contentId\n  }));\n}\nfunction parseEmailToApiOptions(email) {\n  return {\n    attachments: parseAttachments(email.attachments),\n    bcc: email.bcc,\n    cc: email.cc,\n    from: email.from,\n    headers: email.headers,\n    html: email.html,\n    reply_to: email.replyTo,\n    scheduled_at: email.scheduledAt,\n    subject: email.subject,\n    tags: email.tags,\n    text: email.text,\n    to: email.to\n  };\n}\n\n// src/render.ts\nfunction render(node) {\n  return new Promise((resolve, reject) => {\n    import(\"@react-email/render\").then(({ render: render2 }) => {\n      resolve(render2(node));\n    }).catch(() => {\n      reject(\n        Error(\n          \"Failed to render React component. Make sure to install `@react-email/render`\"\n        )\n      );\n    });\n  });\n}\n\n// src/batch/batch.ts\nvar Batch = class {\n  constructor(resend) {\n    this.resend = resend;\n  }\n  send(payload, options) {\n    return __async(this, null, function* () {\n      return this.create(payload, options);\n    });\n  }\n  create(payload, options) {\n    return __async(this, null, function* () {\n      var _a;\n      const emails = [];\n      for (const email of payload) {\n        if (email.react) {\n          email.html = yield render(email.react);\n          email.react = void 0;\n        }\n        emails.push(parseEmailToApiOptions(email));\n      }\n      const data = yield this.resend.post(\n        \"/emails/batch\",\n        emails,\n        __spreadProps(__spreadValues({}, options), {\n          headers: __spreadValues({\n            \"x-batch-validation\": (_a = options == null ? void 0 : options.batchValidation) != null ? _a : \"strict\"\n          }, options == null ? void 0 : options.headers)\n        })\n      );\n      return data;\n    });\n  }\n};\n\n// src/broadcasts/broadcasts.ts\nvar Broadcasts = class {\n  constructor(resend) {\n    this.resend = resend;\n  }\n  create(_0) {\n    return __async(this, arguments, function* (payload, options = {}) {\n      if (payload.react) {\n        payload.html = yield render(payload.react);\n      }\n      const data = yield this.resend.post(\n        \"/broadcasts\",\n        {\n          name: payload.name,\n          audience_id: payload.audienceId,\n          preview_text: payload.previewText,\n          from: payload.from,\n          html: payload.html,\n          reply_to: payload.replyTo,\n          subject: payload.subject,\n          text: payload.text\n        },\n        options\n      );\n      return data;\n    });\n  }\n  send(id, payload) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.post(\n        `/broadcasts/${id}/send`,\n        { scheduled_at: payload == null ? void 0 : payload.scheduledAt }\n      );\n      return data;\n    });\n  }\n  list() {\n    return __async(this, arguments, function* (options = {}) {\n      const queryString = buildPaginationQuery(options);\n      const url = queryString ? `/broadcasts?${queryString}` : \"/broadcasts\";\n      const data = yield this.resend.get(url);\n      return data;\n    });\n  }\n  get(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.get(\n        `/broadcasts/${id}`\n      );\n      return data;\n    });\n  }\n  remove(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.delete(\n        `/broadcasts/${id}`\n      );\n      return data;\n    });\n  }\n  update(id, payload) {\n    return __async(this, null, function* () {\n      if (payload.react) {\n        payload.html = yield render(payload.react);\n      }\n      const data = yield this.resend.patch(\n        `/broadcasts/${id}`,\n        {\n          name: payload.name,\n          audience_id: payload.audienceId,\n          from: payload.from,\n          html: payload.html,\n          text: payload.text,\n          subject: payload.subject,\n          reply_to: payload.replyTo,\n          preview_text: payload.previewText\n        }\n      );\n      return data;\n    });\n  }\n};\n\n// src/contacts/contacts.ts\nvar Contacts = class {\n  constructor(resend) {\n    this.resend = resend;\n  }\n  create(_0) {\n    return __async(this, arguments, function* (payload, options = {}) {\n      const data = yield this.resend.post(\n        `/audiences/${payload.audienceId}/contacts`,\n        {\n          unsubscribed: payload.unsubscribed,\n          email: payload.email,\n          first_name: payload.firstName,\n          last_name: payload.lastName\n        },\n        options\n      );\n      return data;\n    });\n  }\n  list(options) {\n    return __async(this, null, function* () {\n      const _a = options, { audienceId } = _a, paginationOptions = __objRest(_a, [\"audienceId\"]);\n      const queryString = buildPaginationQuery(paginationOptions);\n      const url = queryString ? `/audiences/${audienceId}/contacts?${queryString}` : `/audiences/${audienceId}/contacts`;\n      const data = yield this.resend.get(url);\n      return data;\n    });\n  }\n  get(options) {\n    return __async(this, null, function* () {\n      if (!options.id && !options.email) {\n        return {\n          data: null,\n          error: {\n            message: \"Missing `id` or `email` field.\",\n            name: \"missing_required_field\"\n          }\n        };\n      }\n      const data = yield this.resend.get(\n        `/audiences/${options.audienceId}/contacts/${(options == null ? void 0 : options.email) ? options == null ? void 0 : options.email : options == null ? void 0 : options.id}`\n      );\n      return data;\n    });\n  }\n  update(options) {\n    return __async(this, null, function* () {\n      if (!options.id && !options.email) {\n        return {\n          data: null,\n          error: {\n            message: \"Missing `id` or `email` field.\",\n            name: \"missing_required_field\"\n          }\n        };\n      }\n      const data = yield this.resend.patch(\n        `/audiences/${options.audienceId}/contacts/${(options == null ? void 0 : options.email) ? options == null ? void 0 : options.email : options == null ? void 0 : options.id}`,\n        {\n          unsubscribed: options.unsubscribed,\n          first_name: options.firstName,\n          last_name: options.lastName\n        }\n      );\n      return data;\n    });\n  }\n  remove(payload) {\n    return __async(this, null, function* () {\n      if (!payload.id && !payload.email) {\n        return {\n          data: null,\n          error: {\n            message: \"Missing `id` or `email` field.\",\n            name: \"missing_required_field\"\n          }\n        };\n      }\n      const data = yield this.resend.delete(\n        `/audiences/${payload.audienceId}/contacts/${(payload == null ? void 0 : payload.email) ? payload == null ? void 0 : payload.email : payload == null ? void 0 : payload.id}`\n      );\n      return data;\n    });\n  }\n};\n\n// src/common/utils/parse-domain-to-api-options.ts\nfunction parseDomainToApiOptions(domain) {\n  return {\n    name: domain.name,\n    region: domain.region,\n    custom_return_path: domain.customReturnPath\n  };\n}\n\n// src/domains/domains.ts\nvar Domains = class {\n  constructor(resend) {\n    this.resend = resend;\n  }\n  create(_0) {\n    return __async(this, arguments, function* (payload, options = {}) {\n      const data = yield this.resend.post(\n        \"/domains\",\n        parseDomainToApiOptions(payload),\n        options\n      );\n      return data;\n    });\n  }\n  list() {\n    return __async(this, arguments, function* (options = {}) {\n      const queryString = buildPaginationQuery(options);\n      const url = queryString ? `/domains?${queryString}` : \"/domains\";\n      const data = yield this.resend.get(url);\n      return data;\n    });\n  }\n  get(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.get(\n        `/domains/${id}`\n      );\n      return data;\n    });\n  }\n  update(payload) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.patch(\n        `/domains/${payload.id}`,\n        {\n          click_tracking: payload.clickTracking,\n          open_tracking: payload.openTracking,\n          tls: payload.tls\n        }\n      );\n      return data;\n    });\n  }\n  remove(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.delete(\n        `/domains/${id}`\n      );\n      return data;\n    });\n  }\n  verify(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.post(\n        `/domains/${id}/verify`\n      );\n      return data;\n    });\n  }\n};\n\n// src/emails/emails.ts\nvar Emails = class {\n  constructor(resend) {\n    this.resend = resend;\n  }\n  send(_0) {\n    return __async(this, arguments, function* (payload, options = {}) {\n      return this.create(payload, options);\n    });\n  }\n  create(_0) {\n    return __async(this, arguments, function* (payload, options = {}) {\n      if (payload.react) {\n        payload.html = yield render(payload.react);\n      }\n      const data = yield this.resend.post(\n        \"/emails\",\n        parseEmailToApiOptions(payload),\n        options\n      );\n      return data;\n    });\n  }\n  get(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.get(\n        `/emails/${id}`\n      );\n      return data;\n    });\n  }\n  list() {\n    return __async(this, arguments, function* (options = {}) {\n      const queryString = buildPaginationQuery(options);\n      const url = queryString ? `/emails?${queryString}` : \"/emails\";\n      const data = yield this.resend.get(url);\n      return data;\n    });\n  }\n  update(payload) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.patch(\n        `/emails/${payload.id}`,\n        {\n          scheduled_at: payload.scheduledAt\n        }\n      );\n      return data;\n    });\n  }\n  cancel(id) {\n    return __async(this, null, function* () {\n      const data = yield this.resend.post(\n        `/emails/${id}/cancel`\n      );\n      return data;\n    });\n  }\n};\n\n// src/resend.ts\nvar defaultBaseUrl = \"https://api.resend.com\";\nvar defaultUserAgent = `resend-node:${version}`;\nvar baseUrl = typeof process !== \"undefined\" && process.env ? process.env.RESEND_BASE_URL || defaultBaseUrl : defaultBaseUrl;\nvar userAgent = typeof process !== \"undefined\" && process.env ? process.env.RESEND_USER_AGENT || defaultUserAgent : defaultUserAgent;\nvar Resend = class {\n  constructor(key) {\n    this.key = key;\n    this.apiKeys = new ApiKeys(this);\n    this.audiences = new Audiences(this);\n    this.batch = new Batch(this);\n    this.broadcasts = new Broadcasts(this);\n    this.contacts = new Contacts(this);\n    this.domains = new Domains(this);\n    this.emails = new Emails(this);\n    if (!key) {\n      if (typeof process !== \"undefined\" && process.env) {\n        this.key = process.env.RESEND_API_KEY;\n      }\n      if (!this.key) {\n        throw new Error(\n          'Missing API key. Pass it to the constructor `new Resend(\"re_123\")`'\n        );\n      }\n    }\n    this.headers = new Headers({\n      Authorization: `Bearer ${this.key}`,\n      \"User-Agent\": userAgent,\n      \"Content-Type\": \"application/json\"\n    });\n  }\n  fetchRequest(_0) {\n    return __async(this, arguments, function* (path, options = {}) {\n      try {\n        const response = yield fetch(`${baseUrl}${path}`, options);\n        if (!response.ok) {\n          try {\n            const rawError = yield response.text();\n            return { data: null, error: JSON.parse(rawError) };\n          } catch (err) {\n            if (err instanceof SyntaxError) {\n              return {\n                data: null,\n                error: {\n                  name: \"application_error\",\n                  message: \"Internal server error. We are unable to process your request right now, please try again later.\"\n                }\n              };\n            }\n            const error = {\n              message: response.statusText,\n              name: \"application_error\"\n            };\n            if (err instanceof Error) {\n              return { data: null, error: __spreadProps(__spreadValues({}, error), { message: err.message }) };\n            }\n            return { data: null, error };\n          }\n        }\n        const data = yield response.json();\n        return { data, error: null };\n      } catch (e) {\n        return {\n          data: null,\n          error: {\n            name: \"application_error\",\n            message: \"Unable to fetch data. The request could not be resolved.\"\n          }\n        };\n      }\n    });\n  }\n  post(_0, _1) {\n    return __async(this, arguments, function* (path, entity, options = {}) {\n      const headers = new Headers(this.headers);\n      if (options.headers) {\n        for (const [key, value] of new Headers(options.headers).entries()) {\n          headers.set(key, value);\n        }\n      }\n      if (options.idempotencyKey) {\n        headers.set(\"Idempotency-Key\", options.idempotencyKey);\n      }\n      const requestOptions = __spreadProps(__spreadValues({\n        method: \"POST\",\n        body: JSON.stringify(entity)\n      }, options), {\n        headers\n      });\n      return this.fetchRequest(path, requestOptions);\n    });\n  }\n  get(_0) {\n    return __async(this, arguments, function* (path, options = {}) {\n      const headers = new Headers(this.headers);\n      if (options.headers) {\n        for (const [key, value] of new Headers(options.headers).entries()) {\n          headers.set(key, value);\n        }\n      }\n      const requestOptions = __spreadProps(__spreadValues({\n        method: \"GET\"\n      }, options), {\n        headers\n      });\n      return this.fetchRequest(path, requestOptions);\n    });\n  }\n  put(_0, _1) {\n    return __async(this, arguments, function* (path, entity, options = {}) {\n      const headers = new Headers(this.headers);\n      if (options.headers) {\n        for (const [key, value] of new Headers(options.headers).entries()) {\n          headers.set(key, value);\n        }\n      }\n      const requestOptions = __spreadProps(__spreadValues({\n        method: \"PUT\",\n        body: JSON.stringify(entity)\n      }, options), {\n        headers\n      });\n      return this.fetchRequest(path, requestOptions);\n    });\n  }\n  patch(_0, _1) {\n    return __async(this, arguments, function* (path, entity, options = {}) {\n      const headers = new Headers(this.headers);\n      if (options.headers) {\n        for (const [key, value] of new Headers(options.headers).entries()) {\n          headers.set(key, value);\n        }\n      }\n      const requestOptions = __spreadProps(__spreadValues({\n        method: \"PATCH\",\n        body: JSON.stringify(entity)\n      }, options), {\n        headers\n      });\n      return this.fetchRequest(path, requestOptions);\n    });\n  }\n  delete(path, query) {\n    return __async(this, null, function* () {\n      const requestOptions = {\n        method: \"DELETE\",\n        body: JSON.stringify(query),\n        headers: this.headers\n      };\n      return this.fetchRequest(path, requestOptions);\n    });\n  }\n};\nexport {\n  Resend\n};\n", "import { Resend } from 'resend';\n\nexport async function sendVerificationEmail(email, name, verificationUrl, env) {\n  const resend = new Resend(env.RESEND_API_KEY);\n\n  const bodyText = `Hi ${name},\n\nThank you for starting your activity waiver submission!\n\nPlease click the link below to continue and complete your waiver:\n${verificationUrl}\n\nThis link will expire in 24 hours.\n\nIf you didn't request this waiver, you can safely ignore this email.\n\nRegards,\nThe Rentals Team`;\n\n  const bodyHtml = `\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n      <h2 style=\"color: #3b82f6;\">Complete Your Activity Waiver</h2>\n      <p>Hi ${name},</p>\n      <p>Thank you for starting your activity waiver submission!</p>\n      <p>Please click the button below to continue and complete your waiver:</p>\n      <div style=\"margin: 30px 0;\">\n        <a href=\"${verificationUrl}\" style=\"background-color: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;\">\n          Complete Your Waiver\n        </a>\n      </div>\n      <p style=\"color: #64748b; font-size: 14px;\">This link will expire in 24 hours.</p>\n      <p style=\"color: #64748b; font-size: 14px;\">If you didn't request this waiver, you can safely ignore this email.</p>\n      <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 30px 0;\">\n      <p style=\"color: #94a3b8; font-size: 12px;\">Regards,<br>The Rentals Team</p>\n    </div>\n  `;\n\n  try {\n    const { data: emailData, error } = await resend.emails.send({\n      from: `Activity Waivers <${env.EMAIL_FROM}>`,\n      to: email,\n      subject: 'Complete Your Activity Waiver',\n      text: bodyText,\n      html: bodyHtml\n    });\n\n    if (error) {\n      console.error('Resend error:', error);\n      throw new Error(error.message);\n    }\n\n    console.log('Verification email sent successfully:', emailData);\n  } catch (error) {\n    console.error('Verification email send error:', error);\n    throw new Error('Failed to send verification email: ' + error.message);\n  }\n}\n\nexport async function sendWaiverEmail(data, pdfs, pin, env) {\n  const resend = new Resend(env.RESEND_API_KEY);\n\n  const bodyText = `Hi ${data.guestName},\n\nThank you for completing your waiver for ${data.propertyId}.\nAttached: ${pdfs.map(p => p.filename).join(', ')}\n\n${pin ? 'Your Archery PIN is ' + pin + '\\n\\n' : ''}Regards,\nThe Rentals Team`;\n\n  try {\n    const { data: emailData, error } = await resend.emails.send({\n      from: `Activity Waivers <${env.EMAIL_FROM}>`,\n      to: data.guestEmail,\n      subject: 'Your activity waiver(s)',\n      text: bodyText,\n      attachments: pdfs.map(p => ({\n        filename: p.filename,\n        content: btoa(String.fromCharCode(...new Uint8Array(p.bytes)))\n      }))\n    });\n\n    if (error) {\n      console.error('Resend error:', error);\n      throw new Error(error.message);\n    }\n\n    console.log('Email sent successfully:', emailData);\n  } catch (error) {\n    console.error('Email send error:', error);\n    throw new Error('Failed to send email: ' + error.message);\n  }\n}\n\nexport async function sendMail (data, pdfs, pin, env) {\n  const resend = new Resend(env.RESEND_API_KEY);\n\n  const bodyText = `Hi ${data.guestName},\n\nThank you for completing your waiver for ${data.propertyId}.\nAttached: ${pdfs.map(p => p.filename).join(', ')}\n\n${pin ? 'Your Archery PIN is ' + pin + '\\n\\n' : ''}Regards,\nThe Rentals Team`;\n\n  try {\n    const { data: emailData, error } = await resend.emails.send({\n      from: `Activity Waivers <${env.EMAIL_FROM}>`,\n      to: data.guestEmail,\n      subject: 'Your activity waiver(s)',\n      text: bodyText,\n      attachments: pdfs.map(p => ({\n        filename: p.filename,\n        content: btoa(String.fromCharCode(...new Uint8Array(p.bytes)))\n      }))\n    });\n\n    if (error) {\n      console.error('Resend error:', error);\n      throw new Error(error.message);\n    }\n\n    console.log('Email sent successfully:', emailData);\n  } catch (error) {\n    console.error('Email send error:', error);\n    throw new Error('Failed to send email: ' + error.message);\n  }\n}\n", "import { nanoid } from '../utils/nanoid.js';\nimport { json, bad } from '../utils/admin.js';\nimport { validateSubmission } from '../services/validation.js';\nimport { saveSubmission, saveDocuments } from '../services/storage.js';\nimport { makePDFs } from '../services/pdf.js';\nimport { sendMail } from '../services/mail.js';\n\nexport async function handleSubmit(request, env) {\n  console.log('Submit endpoint called');\n  const data = await request.json();\n  console.log('Received data:', data);\n\n  /* ---- validation ----------------------------------------------------- */\n  const validationError = validateSubmission(data);\n  if (validationError) {\n    return bad(validationError);\n  }\n\n  /* ---- write submission ----------------------------------------------- */\n  const subId = nanoid(10);\n  const createdAt = new Date().toISOString();\n\n  try {\n    await saveSubmission(env, subId, data, createdAt);\n    console.log('Submission saved to database');\n  } catch (dbError) {\n    console.error('Database error:', dbError);\n    return json({ ok: false, error: 'Database not initialized. Run migrations first.' }, 500);\n  }\n\n  /* ---- generate PDFs -------------------------------------------------- */\n  let pdfInfos;\n  try {\n    pdfInfos = await makePDFs(data, subId, env);\n    console.log('PDFs generated:', pdfInfos.length);\n  } catch (pdfError) {\n    console.error('PDF generation error:', pdfError);\n    return json({ ok: false, error: 'PDF generation failed: ' + pdfError.message }, 500);\n  }\n\n  /* ---- save document records ------------------------------------------ */\n  try {\n    await saveDocuments(env, subId, pdfInfos);\n    console.log('Document records saved');\n  } catch (docError) {\n    console.error('Document save error:', docError);\n  }\n\n  const pin = data.activities.includes('archery') ? env.ARCHERY_PIN : null;\n\n  /* ---- dev mode: return download URLs --------------------------------- */\n  if (env.DEV_MODE === 'true') {\n    const downloads = pdfInfos.map(p => ({\n      filename: p.filename,\n      url: `/download/${p.r2Key}`\n    }));\n\n    return json({\n      ok: true,\n      devMode: true,\n      downloads,\n      pin\n    });\n  }\n\n  /* ---- production: send email ----------------------------------------- */\n  try {\n    await sendMail(data, pdfInfos, pin, env);\n    console.log('Email sent successfully');\n  } catch (emailError) {\n    console.error('Email sending failed:', emailError);\n    return json({ ok: false, error: 'Email sending failed: ' + emailError.message }, 500);\n  }\n\n  return json({ ok: true,\n                emailed: pdfInfos.map(p => p.filename),\n                pin });\n}\n", "import { nanoid } from '../utils/nanoid.js';\nimport { makePDFs } from '../services/pdf.js';\nimport { sendVerificationEmail, sendWaiverEmail } from '../services/mail.js';\n\nexport async function handleInitialSubmit(request, env) {\n  try {\n    const data = await request.json();\n\n    // Validate required fields\n    if (!data.propertyId || !data.checkinDate || !data.guestName || !data.guestEmail) {\n      return new Response(JSON.stringify({ ok: false, error: 'Missing required fields' }), {\n        status: 400,\n        headers: { 'content-type': 'application/json' }\n      });\n    }\n\n    // Generate submission ID and verification token\n    const submissionId = nanoid(12);\n    const verificationToken = nanoid(32);\n    const createdAt = new Date().toISOString();\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24 hours\n\n    // Create pending submission record\n    await env.waivers.prepare(\n      `INSERT INTO submissions\n       (submission_id, created_at, property_id, checkin_date, guest_name, guest_email, activities,\n        status, verification_token, token_expires_at)\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n    ).bind(\n      submissionId,\n      createdAt,\n      data.propertyId,\n      data.checkinDate,\n      data.guestName,\n      data.guestEmail,\n      '[]', // Empty activities initially\n      'pending',\n      verificationToken,\n      expiresAt\n    ).run();\n\n    // Send verification email\n    const verificationUrl = `${new URL(request.url).origin}/?token=${verificationToken}`;\n\n    if (env.DEV_MODE === 'true') {\n      console.log('Dev Mode: Verification email would be sent to:', data.guestEmail);\n      console.log('Dev Mode: Verification URL:', verificationUrl);\n\n      return new Response(JSON.stringify({\n        ok: true,\n        devMode: true,\n        submissionId,\n        verificationUrl\n      }), {\n        headers: { 'content-type': 'application/json' }\n      });\n    } else {\n      await sendVerificationEmail(data.guestEmail, data.guestName, verificationUrl, env);\n\n      return new Response(JSON.stringify({\n        ok: true,\n        submissionId\n      }), {\n        headers: { 'content-type': 'application/json' }\n      });\n    }\n  } catch (error) {\n    console.error('Initial submission error:', error);\n    return new Response(JSON.stringify({ ok: false, error: error.message }), {\n      status: 500,\n      headers: { 'content-type': 'application/json' }\n    });\n  }\n}\n\nexport async function handleCompleteSubmit(request, env) {\n  try {\n    const data = await request.json();\n\n    // Validate required fields\n    if (!data.submissionId || !data.activities || !data.initials || !data.signature || !data.accepted) {\n      return new Response(JSON.stringify({ ok: false, error: 'Missing required fields' }), {\n        status: 400,\n        headers: { 'content-type': 'application/json' }\n      });\n    }\n\n    // Retrieve submission\n    const submission = await env.waivers.prepare(\n      'SELECT * FROM submissions WHERE submission_id = ? AND status = ?'\n    ).bind(data.submissionId, 'pending').first();\n\n    if (!submission) {\n      return new Response(JSON.stringify({ ok: false, error: 'Invalid or expired submission' }), {\n        status: 404,\n        headers: { 'content-type': 'application/json' }\n      });\n    }\n\n    // Check if token expired\n    const expires = new Date(submission.token_expires_at);\n    if (expires < new Date()) {\n      return new Response(JSON.stringify({ ok: false, error: 'Verification token expired' }), {\n        status: 410,\n        headers: { 'content-type': 'application/json' }\n      });\n    }\n\n    // Update submission with activities\n    const completedAt = new Date().toISOString();\n    await env.waivers.prepare(\n      'UPDATE submissions SET activities = ?, status = ?, completed_at = ? WHERE submission_id = ?'\n    ).bind(\n      JSON.stringify(data.activities),\n      'completed',\n      completedAt,\n      data.submissionId\n    ).run();\n\n    // Generate PDFs\n    const submissionData = {\n      propertyId: submission.property_id,\n      checkinDate: submission.checkin_date,\n      guestName: submission.guest_name,\n      guestEmail: submission.guest_email,\n      activities: data.activities,\n      initials: data.initials,\n      signature: data.signature\n    };\n\n    const pdfs = await makePDFs(submissionData, data.submissionId, env);\n\n    // Generate archery PIN if needed\n    let archeryPin = null;\n    if (data.activities.includes('archery')) {\n      archeryPin = env.ARCHERY_PIN || '1234';\n    }\n\n    // Development mode or production mode\n    if (env.DEV_MODE === 'true') {\n      const downloads = pdfs.map(p => ({\n        filename: p.filename,\n        url: `/download/${p.id}`\n      }));\n\n      return new Response(JSON.stringify({\n        ok: true,\n        devMode: true,\n        downloads,\n        pin: archeryPin\n      }), {\n        headers: { 'content-type': 'application/json' }\n      });\n    } else {\n      // Send email with waivers\n      await sendWaiverEmail(submissionData, pdfs, archeryPin, env);\n\n      return new Response(JSON.stringify({\n        ok: true,\n        emailed: pdfs.map(p => p.filename),\n        pin: archeryPin\n      }), {\n        headers: { 'content-type': 'application/json' }\n      });\n    }\n  } catch (error) {\n    console.error('Complete submission error:', error);\n    return new Response(JSON.stringify({ ok: false, error: error.message }), {\n      status: 500,\n      headers: { 'content-type': 'application/json' }\n    });\n  }\n}\n", "import { json } from '../../utils/admin.js';\n\nexport async function handleAdminSearch(request, env) {\n  const url = new URL(request.url);\n  const qName     = url.searchParams.get('name')     ?? '';\n  const qEmail    = url.searchParams.get('email')    ?? '';\n  const qProp     = url.searchParams.get('prop')     ?? '';\n  const qDate     = url.searchParams.get('date')     ?? '';\n  const qActivity = url.searchParams.get('activity') ?? '';\n\n  const conditions = [];\n  const params = [];\n\n  if (qName) {\n    conditions.push('guest_name LIKE ?');\n    params.push(`%${qName}%`);\n  }\n\n  if (qEmail) {\n    conditions.push('guest_email LIKE ?');\n    params.push(`%${qEmail}%`);\n  }\n\n  if (qProp) {\n    conditions.push('property_id LIKE ?');\n    params.push(`%${qProp}%`);\n  }\n\n  if (qDate) {\n    conditions.push('checkin_date LIKE ?');\n    params.push(`%${qDate}%`);\n  }\n\n  if (qActivity) {\n    conditions.push('activities LIKE ?');\n    params.push(`%${qActivity}%`);\n  }\n\n  const whereClause = conditions.length > 0\n    ? `WHERE ${conditions.join(' AND ')}`\n    : '';\n\n  const query = `SELECT * FROM submissions\n                 ${whereClause}\n                 ORDER BY created_at DESC\n                 LIMIT 200`;\n\n  const rows = await env.waivers.prepare(query).bind(...params).all();\n\n  return json({ rows });\n}\n", "import { json } from '../../utils/admin.js';\n\nexport async function handleAdminActivities(request, env) {\n  const url = new URL(request.url);\n  const { pathname } = url;\n  const propertyId = url.searchParams.get('property') || 'cabin-12';\n\n  if (request.method === 'GET') {\n    return await getActivities(env, propertyId);\n  }\n\n  if (request.method === 'POST') {\n    if (pathname === '/admin/activities/add') {\n      return await addActivity(request, env, propertyId);\n    }\n    if (pathname === '/admin/activities/remove') {\n      return await removeActivity(request, env, propertyId);\n    }\n    if (pathname === '/admin/activities/update') {\n      return await updateActivity(request, env, propertyId);\n    }\n    return await replaceAllActivities(request, env, propertyId);\n  }\n\n  return new Response('Method not allowed', { status: 405 });\n}\n\nasync function getActivities(env, propertyId) {\n  const result = await env.waivers.prepare(\n    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'\n  ).bind(propertyId).all();\n\n  return json({ ok: true, propertyId, activities: result.results || [] });\n}\n\nasync function addActivity(request, env, propertyId) {\n  const data = await request.json();\n\n  if (!data.slug || !data.label || !data.risk) {\n    return json({ ok: false, error: 'Must provide slug, label, and risk' }, 400);\n  }\n\n  const existingCheck = await env.waivers.prepare(\n    'SELECT id FROM activities WHERE property_id = ? AND slug = ?'\n  ).bind(propertyId, data.slug).first();\n\n  if (existingCheck) {\n    return json({ ok: false, error: 'Activity with this slug already exists' }, 400);\n  }\n\n  await env.waivers.prepare(\n    'INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)'\n  ).bind(propertyId, data.slug, data.label, data.risk, new Date().toISOString()).run();\n\n  const result = await env.waivers.prepare(\n    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'\n  ).bind(propertyId).all();\n\n  return json({ ok: true, propertyId, activities: result.results || [], added: data.slug });\n}\n\nasync function removeActivity(request, env, propertyId) {\n  const data = await request.json();\n\n  if (!data.slug) {\n    return json({ ok: false, error: 'Must provide slug' }, 400);\n  }\n\n  const existingCheck = await env.waivers.prepare(\n    'SELECT id FROM activities WHERE property_id = ? AND slug = ?'\n  ).bind(propertyId, data.slug).first();\n\n  if (!existingCheck) {\n    return json({ ok: false, error: 'Activity not found' }, 404);\n  }\n\n  await env.waivers.prepare(\n    'DELETE FROM activities WHERE property_id = ? AND slug = ?'\n  ).bind(propertyId, data.slug).run();\n\n  const result = await env.waivers.prepare(\n    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'\n  ).bind(propertyId).all();\n\n  return json({ ok: true, propertyId, activities: result.results || [], removed: data.slug });\n}\n\nasync function updateActivity(request, env, propertyId) {\n  const data = await request.json();\n\n  if (!data.slug) {\n    return json({ ok: false, error: 'Must provide slug' }, 400);\n  }\n\n  const existingCheck = await env.waivers.prepare(\n    'SELECT id FROM activities WHERE property_id = ? AND slug = ?'\n  ).bind(propertyId, data.slug).first();\n\n  if (!existingCheck) {\n    return json({ ok: false, error: 'Activity not found' }, 404);\n  }\n\n  const updates = [];\n  const bindings = [];\n\n  if (data.label) {\n    updates.push('label = ?');\n    bindings.push(data.label);\n  }\n  if (data.risk) {\n    updates.push('risk = ?');\n    bindings.push(data.risk);\n  }\n\n  if (updates.length > 0) {\n    bindings.push(propertyId, data.slug);\n    await env.waivers.prepare(\n      `UPDATE activities SET ${updates.join(', ')} WHERE property_id = ? AND slug = ?`\n    ).bind(...bindings).run();\n  }\n\n  const result = await env.waivers.prepare(\n    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'\n  ).bind(propertyId).all();\n\n  return json({ ok: true, propertyId, activities: result.results || [], updated: data.slug });\n}\n\nasync function replaceAllActivities(request, env, propertyId) {\n  const data = await request.json();\n\n  if (!Array.isArray(data.activities)) {\n    return json({ ok: false, error: 'activities must be an array' }, 400);\n  }\n\n  for (const activity of data.activities) {\n    if (!activity.slug || !activity.label || !activity.risk) {\n      return json({ ok: false, error: 'Each activity must have slug, label, and risk' }, 400);\n    }\n  }\n\n  await env.waivers.prepare(\n    'DELETE FROM activities WHERE property_id = ?'\n  ).bind(propertyId).run();\n\n  const timestamp = new Date().toISOString();\n  for (const activity of data.activities) {\n    await env.waivers.prepare(\n      'INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)'\n    ).bind(propertyId, activity.slug, activity.label, activity.risk, timestamp).run();\n  }\n\n  const result = await env.waivers.prepare(\n    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'\n  ).bind(propertyId).all();\n\n  return json({ ok: true, propertyId, activities: result.results || [] });\n}\n", "import { json } from '../../utils/admin.js';\n\nexport async function handleAdminRisks(request, env) {\n  const url = new URL(request.url);\n  const level = url.searchParams.get('level');\n\n  if (request.method === 'GET') {\n    if (level) {\n      return await getRisk(env, level);\n    }\n    return await getAllRisks(env);\n  }\n\n  if (request.method === 'POST') {\n    return await updateRisk(request, env);\n  }\n\n  return new Response('Method not allowed', { status: 405 });\n}\n\nasync function getAllRisks(env) {\n  const result = await env.waivers.prepare(\n    'SELECT level, description FROM risk_descriptions'\n  ).all();\n\n  const risks = {};\n  for (const row of (result.results || [])) {\n    risks[row.level] = { level: row.level, description: row.description };\n  }\n\n  return json({ ok: true, risks });\n}\n\nasync function getRisk(env, level) {\n  const result = await env.waivers.prepare(\n    'SELECT level, description FROM risk_descriptions WHERE level = ?'\n  ).bind(level).first();\n\n  if (!result) {\n    return json({ ok: false, error: 'Risk level not found' }, 404);\n  }\n\n  return json({ ok: true, risk: { level: result.level, description: result.description } });\n}\n\nasync function updateRisk(request, env) {\n  const data = await request.json();\n\n  if (!data.level || !data.description) {\n    return json({ ok: false, error: 'Must provide level and description' }, 400);\n  }\n\n  if (!['low', 'medium', 'high'].includes(data.level)) {\n    return json({ ok: false, error: 'level must be low, medium, or high' }, 400);\n  }\n\n  const existingCheck = await env.waivers.prepare(\n    'SELECT level FROM risk_descriptions WHERE level = ?'\n  ).bind(data.level).first();\n\n  if (existingCheck) {\n    await env.waivers.prepare(\n      'UPDATE risk_descriptions SET description = ? WHERE level = ?'\n    ).bind(data.description, data.level).run();\n  } else {\n    await env.waivers.prepare(\n      'INSERT INTO risk_descriptions (level, description, created_at) VALUES (?, ?, ?)'\n    ).bind(data.level, data.description, new Date().toISOString()).run();\n  }\n\n  const riskData = {\n    level: data.level,\n    description: data.description\n  };\n\n  return json({ ok: true, risk: riskData });\n}\n", "import { json } from '../../utils/admin.js';\n\nexport async function handleAdminProperties(request, env) {\n  const url = new URL(request.url);\n  const { pathname } = url;\n\n  if (request.method === 'GET') {\n    return await getProperties(env);\n  }\n\n  if (request.method === 'POST') {\n    if (pathname === '/admin/properties/add') {\n      return await addProperty(request, env);\n    }\n    if (pathname === '/admin/properties/remove') {\n      return await removeProperty(request, env);\n    }\n  }\n\n  return new Response('Method not allowed', { status: 405 });\n}\n\nasync function getProperties(env) {\n  const result = await env.waivers.prepare(\n    'SELECT id, name FROM properties WHERE id != ? ORDER BY name'\n  ).bind('default').all();\n\n  return json({ ok: true, properties: result.results || [] });\n}\n\nasync function addProperty(request, env) {\n  const data = await request.json();\n\n  if (!data.id || !data.name) {\n    return json({ ok: false, error: 'Must provide id and name' }, 400);\n  }\n\n  const existingCheck = await env.waivers.prepare(\n    'SELECT id FROM properties WHERE id = ?'\n  ).bind(data.id).first();\n\n  if (existingCheck) {\n    return json({ ok: false, error: 'Property with this ID already exists' }, 400);\n  }\n\n  await env.waivers.prepare(\n    'INSERT INTO properties (id, name, created_at) VALUES (?, ?, ?)'\n  ).bind(data.id, data.name, new Date().toISOString()).run();\n\n  if (data.copyDefaultActivities) {\n    const defaultActivities = await env.waivers.prepare(\n      'SELECT slug, label, risk FROM activities WHERE property_id = ?'\n    ).bind('default').all();\n\n    for (const activity of (defaultActivities.results || [])) {\n      await env.waivers.prepare(\n        'INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)'\n      ).bind(data.id, activity.slug, activity.label, activity.risk, new Date().toISOString()).run();\n    }\n  }\n\n  const result = await env.waivers.prepare(\n    'SELECT id, name FROM properties WHERE id != ? ORDER BY name'\n  ).bind('default').all();\n\n  return json({ ok: true, properties: result.results || [], added: data.id });\n}\n\nasync function removeProperty(request, env) {\n  const data = await request.json();\n\n  if (!data.id) {\n    return json({ ok: false, error: 'Must provide id' }, 400);\n  }\n\n  const countResult = await env.waivers.prepare(\n    'SELECT COUNT(*) as count FROM properties WHERE id != ?'\n  ).bind('default').first();\n\n  if (countResult.count <= 1) {\n    return json({ ok: false, error: 'Cannot delete the last property' }, 400);\n  }\n\n  if (data.id === 'default') {\n    return json({ ok: false, error: 'Cannot delete the default property template' }, 400);\n  }\n\n  const existingCheck = await env.waivers.prepare(\n    'SELECT id FROM properties WHERE id = ?'\n  ).bind(data.id).first();\n\n  if (!existingCheck) {\n    return json({ ok: false, error: 'Property not found' }, 404);\n  }\n\n  await env.waivers.prepare(\n    'DELETE FROM properties WHERE id = ?'\n  ).bind(data.id).run();\n\n  const result = await env.waivers.prepare(\n    'SELECT id, name FROM properties WHERE id != ? ORDER BY name'\n  ).bind('default').all();\n\n  return json({ ok: true, properties: result.results || [], removed: data.id });\n}\n", "import { json } from '../../utils/admin.js';\n\nexport async function handleAdminDocument(request, env) {\n  const url = new URL(request.url);\n  const submissionId = url.searchParams.get('submission');\n  const activity = url.searchParams.get('activity');\n\n  if (!submissionId || !activity) {\n    return json({ ok: false, error: 'Missing submission or activity' }, 400);\n  }\n\n  try {\n    const result = await env.waivers.prepare(\n      'SELECT document_id, r2_key FROM documents WHERE submission_id = ?1 AND activity = ?2'\n    ).bind(submissionId, activity).first();\n\n    if (!result) {\n      return json({ ok: false, error: 'Document not found' }, 404);\n    }\n\n    return json({\n      ok: true,\n      document_id: result.document_id,\n      r2_key: result.r2_key\n    });\n  } catch (error) {\n    return json({ ok: false, error: error.message }, 500);\n  }\n}\n", "import { json } from '../../utils/admin.js';\n\nasync function generateDocumentHash(data) {\n  const hashInput = JSON.stringify({\n    submission_id: data.submission_id,\n    property_id: data.property_id,\n    checkin_date: data.checkin_date,\n    guest_name: data.guest_name,\n    guest_email: data.guest_email,\n    activity: data.activity,\n    activity_label: data.activity_label,\n    initials: data.initials,\n    signature_key: data.signature_key,\n    created_at: data.created_at,\n    release_version: data.release_version,\n    release_date: data.release_date\n  });\n\n  const encoder = new TextEncoder();\n  const dataBuffer = encoder.encode(hashInput);\n  const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\n\n  return hashHex;\n}\n\nexport async function handleAdminVerify(request, env) {\n  const url = new URL(request.url);\n  const documentId = url.searchParams.get('document');\n\n  if (!documentId) {\n    return json({ ok: false, error: 'Missing document ID' }, 400);\n  }\n\n  try {\n    // Get stored hash\n    const hashResult = await env.waivers.prepare(\n      'SELECT hash_value FROM hashes WHERE document_id = ?1'\n    ).bind(documentId).first();\n\n    if (!hashResult) {\n      return json({ ok: false, error: 'Hash not found' }, 404);\n    }\n\n    // Get document and submission data\n    const docData = await env.waivers.prepare(`\n      SELECT\n        d.activity,\n        d.initials,\n        s.submission_id,\n        s.created_at,\n        s.property_id,\n        s.checkin_date,\n        s.guest_name,\n        s.guest_email\n      FROM documents d\n      JOIN submissions s ON d.submission_id = s.submission_id\n      WHERE d.document_id = ?1\n    `).bind(documentId).first();\n\n    if (!docData) {\n      return json({ ok: false, error: 'Document not found' }, 404);\n    }\n\n    // Get activity info for label\n    const activityResult = await env.waivers.prepare(\n      'SELECT label FROM activities WHERE property_id = ? AND slug = ?'\n    ).bind(docData.property_id, docData.activity).first();\n    const activityInfo = activityResult ? { label: activityResult.label } : null;\n\n    // Construct signature key (deterministic from submission data)\n    const nameParts = docData.guest_name.trim().split(/\\s+/);\n    const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, '') || 'unknown';\n    const lastName = nameParts.length > 1\n      ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, '')\n      : 'unknown';\n\n    const createdDate = new Date(docData.created_at);\n    const y = createdDate.getUTCFullYear();\n    const m = String(createdDate.getUTCMonth() + 1).padStart(2, '0');\n    const d = String(createdDate.getUTCDate()).padStart(2, '0');\n\n    const signatureKey = `waivers/${y}/${m}/${d}/${docData.property_id}/signatures/${lastName}-${firstName}-${docData.submission_id}.png`;\n\n    // Get latest release at time of document creation\n    const release = await env.waivers.prepare(\n      'SELECT version, release_date FROM releases WHERE release_date <= ?1 ORDER BY release_date DESC, version DESC LIMIT 1'\n    ).bind(docData.created_at.split('T')[0]).first();\n\n    if (!release) {\n      return json({ ok: false, error: 'No release found for document creation date' }, 404);\n    }\n\n    const hashData = {\n      submission_id: docData.submission_id,\n      property_id: docData.property_id,\n      checkin_date: docData.checkin_date,\n      guest_name: docData.guest_name,\n      guest_email: docData.guest_email,\n      activity: docData.activity,\n      activity_label: activityInfo?.label || docData.activity,\n      initials: docData.initials || '',\n      signature_key: signatureKey,\n      created_at: docData.created_at,\n      release_version: release.version,\n      release_date: release.release_date\n    };\n\n    const computedHash = await generateDocumentHash(hashData);\n    const verified = computedHash === hashResult.hash_value;\n\n    return json({\n      ok: true,\n      verified,\n      stored_hash: hashResult.hash_value,\n      computed_hash: computedHash\n    });\n  } catch (error) {\n    return json({ ok: false, error: error.message }, 500);\n  }\n}\n", "import { json } from '../../utils/admin.js';\n\nasync function getLatestRelease(env) {\n  return await env.waivers.prepare(\n    'SELECT version, release_date, waiver_text, created_at FROM releases ORDER BY release_date DESC, version DESC LIMIT 1'\n  ).first();\n}\n\nasync function getAllReleases(env) {\n  const result = await env.waivers.prepare(\n    'SELECT version, release_date, waiver_text, created_at FROM releases ORDER BY release_date DESC, version DESC'\n  ).all();\n  return result.results || [];\n}\n\nfunction incrementVersion(version) {\n  if (!version) return '1.0.0';\n\n  const parts = version.split('.');\n  if (parts.length !== 3) return '1.0.0';\n\n  const [major, minor, patch] = parts.map(Number);\n  return `${major}.${minor}.${patch + 1}`;\n}\n\nexport async function handleAdminReleases(request, env) {\n  const url = new URL(request.url);\n  const pathname = url.pathname;\n\n  // GET /admin/releases - Get all releases\n  if (request.method === 'GET' && pathname === '/admin/releases') {\n    try {\n      const current = await getLatestRelease(env);\n      const releases = await getAllReleases(env);\n\n      return json({\n        ok: true,\n        current,\n        releases\n      });\n    } catch (error) {\n      return json({ ok: false, error: error.message }, 500);\n    }\n  }\n\n  // POST /admin/releases/create - Create new release\n  if (request.method === 'POST' && pathname === '/admin/releases/create') {\n    try {\n      const data = await request.json();\n      const { version, waiver_text } = data;\n\n      if (!waiver_text || !waiver_text.trim()) {\n        return json({ ok: false, error: 'Waiver text is required' }, 400);\n      }\n\n      let finalVersion = version;\n\n      // Auto-increment if no version specified\n      if (!finalVersion) {\n        const latest = await getLatestRelease(env);\n        finalVersion = incrementVersion(latest?.version);\n      }\n\n      // Validate version format\n      if (!/^[0-9]+\\.[0-9]+\\.[0-9]+$/.test(finalVersion)) {\n        return json({ ok: false, error: 'Invalid version format. Must be X.Y.Z (e.g., 1.0.1)' }, 400);\n      }\n\n      // Check if version already exists\n      const existing = await env.waivers.prepare(\n        'SELECT version FROM releases WHERE version = ?1'\n      ).bind(finalVersion).first();\n\n      if (existing) {\n        return json({ ok: false, error: `Version ${finalVersion} already exists` }, 400);\n      }\n\n      // Insert new release\n      const now = new Date();\n      const releaseDate = now.toISOString().split('T')[0]; // YYYY-MM-DD\n      const createdAt = now.toISOString();\n\n      await env.waivers.prepare(\n        'INSERT INTO releases (version, release_date, waiver_text, created_at) VALUES (?1, ?2, ?3, ?4)'\n      ).bind(finalVersion, releaseDate, waiver_text.trim(), createdAt).run();\n\n      return json({\n        ok: true,\n        version: finalVersion,\n        release_date: releaseDate\n      });\n    } catch (error) {\n      return json({ ok: false, error: error.message }, 500);\n    }\n  }\n\n  return json({ ok: false, error: 'Not found' }, 404);\n}\n", "export async function handleAdminDownloadAll(request, env) {\n  const url = new URL(request.url);\n  const submissionId = url.searchParams.get('submission');\n\n  if (!submissionId) {\n    return new Response('Missing submission ID', { status: 400 });\n  }\n\n  try {\n    // Get all documents for this submission\n    const documents = await env.waivers.prepare(\n      'SELECT document_id, activity, r2_key FROM documents WHERE submission_id = ?1'\n    ).bind(submissionId).all();\n\n    if (!documents.results || documents.results.length === 0) {\n      return new Response('No documents found', { status: 404 });\n    }\n\n    // Get submission info for filename\n    const submission = await env.waivers.prepare(\n      'SELECT guest_name, checkin_date FROM submissions WHERE submission_id = ?1'\n    ).bind(submissionId).first();\n\n    // For now, we'll use fflate to create a zip file\n    // Import at the top of the file when we add it\n    const { zipSync, strToU8 } = await import('fflate');\n\n    const files = {};\n\n    // Fetch all PDFs from R2\n    for (const doc of documents.results) {\n      const obj = await env.WAIVERS_R2.get(doc.r2_key);\n      if (obj) {\n        const arrayBuffer = await obj.arrayBuffer();\n        const uint8Array = new Uint8Array(arrayBuffer);\n        files[`${doc.activity}-waiver.pdf`] = uint8Array;\n      }\n    }\n\n    // Create zip file\n    const zipped = zipSync(files, { level: 6 });\n\n    // Create filename from guest name and date\n    const guestName = submission.guest_name.replace(/[^a-zA-Z0-9]/g, '-');\n    const filename = `${guestName}-${submission.checkin_date}-waivers.zip`;\n\n    return new Response(zipped, {\n      headers: {\n        'Content-Type': 'application/zip',\n        'Content-Disposition': `attachment; filename=\"${filename}\"`\n      }\n    });\n  } catch (error) {\n    console.error('Error creating zip:', error);\n    return new Response('Error creating zip file: ' + error.message, { status: 500 });\n  }\n}\n", "import { json } from '../../utils/admin.js';\n\nconst CACHE_KEY = 'admin_debug_cache';\nconst CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds\n\nexport async function handleAdminDebug(request, env) {\n  const url = new URL(request.url);\n  const forceRefresh = url.searchParams.get('refresh') === 'true';\n\n  try {\n    // Fetch fresh data from database\n    const debugData = {\n      timestamp: Date.now(),\n      d1: {}\n    };\n\n    // Get all D1 tables\n    const tables = await env.waivers.prepare(\n      \"SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE '_cf_%' ORDER BY name\"\n    ).all();\n\n    for (const table of tables.results) {\n      const tableName = table.name;\n\n      // Get count\n      const countResult = await env.waivers.prepare(\n        `SELECT COUNT(*) as count FROM ${tableName}`\n      ).first();\n\n      // Get rows\n      const rowsResult = await env.waivers.prepare(\n        `SELECT * FROM ${tableName} LIMIT 50`\n      ).all();\n\n      debugData.d1[tableName] = {\n        count: countResult.count,\n        rows: rowsResult.results || []\n      };\n    }\n\n    return json({\n      ok: true,\n      lastUpdate: new Date(debugData.timestamp).toISOString(),\n      d1: debugData.d1\n    });\n\n  } catch (error) {\n    console.error('Debug data error:', error);\n    return json({ ok: false, error: error.message }, 500);\n  }\n}\n", "import { readFileSync } from 'fs';\nimport { join } from 'path';\n\nexport async function handleAdminApiDocs() {\n  try {\n    // In Cloudflare Workers, we need to embed the content at build time\n    // For now, we'll just return the markdown content directly\n    const apiDocs = `# API Documentation\n\nThis document describes the public API endpoints for the waiver management system.\n\n## Endpoints\n\n### GET /\n\n**Description:** Returns the HTML waiver form for guests to fill out and submit.\n\n**Response:** HTML page with embedded property, activity, and risk data.\n\n**Example:**\n\\`\\`\\`bash\ncurl https://activities.rtxsecured.com/\n\\`\\`\\`\n\n---\n\n### POST /submit\n\n**Description:** Submits a completed waiver form with guest information, selected activities, initials, and signature.\n\n**Request Body:**\n\\`\\`\\`json\n{\n  \"propertyId\": \"cabin-13\",\n  \"checkinDate\": \"2025-10-15\",\n  \"guestName\": \"John Doe\",\n  \"guestEmail\": \"john@example.com\",\n  \"activities\": [\"kayaking\", \"ziplining\", \"archery\"],\n  \"initials\": {\n    \"kayaking\": \"JD\",\n    \"ziplining\": \"JD\",\n    \"archery\": \"JD\"\n  },\n  \"signature\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...\",\n  \"accepted\": true\n}\n\\`\\`\\`\n\n**Response (Production Mode):**\n\\`\\`\\`json\n{\n  \"ok\": true,\n  \"devMode\": false,\n  \"emailed\": [\n    \"cabin-13_kayaking_20251015.pdf\",\n    \"cabin-13_ziplining_20251015.pdf\",\n    \"cabin-13_archery_20251015.pdf\"\n  ],\n  \"pin\": \"1234\"\n}\n\\`\\`\\`\n\n**Response (Development Mode):**\n\\`\\`\\`json\n{\n  \"ok\": true,\n  \"devMode\": true,\n  \"downloads\": [\n    {\n      \"filename\": \"cabin-13_kayaking_20251015.pdf\",\n      \"url\": \"/download/abc123def456\"\n    },\n    {\n      \"filename\": \"cabin-13_ziplining_20251015.pdf\",\n      \"url\": \"/download/def456ghi789\"\n    }\n  ],\n  \"pin\": \"1234\"\n}\n\\`\\`\\`\n\n**Notes:**\n- The \\`pin\\` field is only included if the \"archery\" activity is selected\n- In development mode (\\`DEV_MODE=true\\`), PDFs are generated and stored but not emailed\n- In production mode, PDFs are emailed to the guest's email address\n\n---\n\n### GET /admin/search\n\n**Description:** Search for waiver submissions by guest name or email.\n\n**Query Parameters:**\n- \\`q\\` (required): Search query string\n\n**Response:**\n\\`\\`\\`json\n{\n  \"ok\": true,\n  \"results\": [...]\n}\n\\`\\`\\`\n\n---\n\n### GET /status\n\n**Description:** Check the status of a waiver submission by ID.\n\n**Query Parameters:**\n- \\`id\\` (required): Submission ID\n\n**Response:**\n\\`\\`\\`json\n{\n  \"ok\": true,\n  \"submission\": {...},\n  \"documents\": [...]\n}\n\\`\\`\\`\n\n---\n\n## Admin Endpoints\n\n### Properties Management\n\n#### GET /admin/properties\n\nList all configured properties.\n\n#### POST /admin/properties/add\n\nAdd a new property.\n\n#### POST /admin/properties/remove\n\nRemove a property.\n\n---\n\n### Activities Management\n\n#### GET /admin/activities\n\nGet all activities for a specific property.\n\n**Query Parameters:**\n- \\`property\\` (optional): Property ID\n\n#### POST /admin/activities/add\n\nAdd a new activity to a property.\n\n#### POST /admin/activities/update\n\nUpdate an existing activity.\n\n#### POST /admin/activities/remove\n\nRemove an activity from a property.\n\n---\n\n### Risk Levels Management\n\n#### GET /admin/risks\n\nGet all risk level definitions.\n\n#### POST /admin/risks\n\nUpdate a risk level definition.\n\n---\n\n### Document Management\n\n#### GET /admin/document\n\nGet document metadata by submission ID and activity.\n\n**Query Parameters:**\n- \\`submission\\` (required): Submission ID\n- \\`activity\\` (required): Activity slug\n\n#### GET /admin/download-all\n\nDownload all waiver PDFs for a submission as a ZIP file.\n\n**Query Parameters:**\n- \\`submission\\` (required): Submission ID\n\n---\n\n### Release Management\n\n#### GET /admin/releases\n\nGet all waiver text releases (versioned legal text).\n\n#### POST /admin/releases/create\n\nCreate a new waiver text release.\n\n**Request Body:**\n\\`\\`\\`json\n{\n  \"version\": \"1.0.3\",\n  \"waiver_text\": \"Updated legal waiver text...\"\n}\n\\`\\`\\`\n\n**Notes:**\n- If \\`version\\` is omitted, it will auto-increment from the latest version\n- Version must follow semantic versioning format: X.Y.Z\n- Version must be unique\n\n---\n\n### Document Verification\n\n#### GET /admin/verify\n\nVerify document integrity by comparing stored hash with computed hash.\n\n**Query Parameters:**\n- \\`document\\` (required): Document ID\n\n**Response:**\n\\`\\`\\`json\n{\n  \"ok\": true,\n  \"verified\": true,\n  \"stored_hash\": \"abc123...\",\n  \"computed_hash\": \"abc123...\"\n}\n\\`\\`\\`\n\n**Notes:**\n- Documents are hashed using SHA-256\n- Hash includes: submission data, activity, initials, signature, and release version\n- Used to verify documents haven't been tampered with\n\n---\n\n### Debug Panel\n\n#### GET /admin/debug\n\nView KV store and D1 database tables for debugging.\n\n**Query Parameters:**\n- \\`refresh\\` (optional): Set to \"true\" to force refresh cached data\n\n**Notes:**\n- Data is cached for 7 days\n- Shows all PROPS_KV keys and values\n- Shows all D1 tables with up to 50 rows each\n`;\n\n    return new Response(apiDocs, {\n      headers: {\n        'Content-Type': 'text/plain; charset=utf-8'\n      }\n    });\n  } catch (error) {\n    return new Response('Error loading API documentation', { status: 500 });\n  }\n}\n", "import { json } from '../utils/admin.js';\n\nexport async function handleStatus(env) {\n  try {\n    const dbOK = await env.waivers.prepare('SELECT 1').first();\n    return json({ ok: true, db: !!dbOK, ts: Date.now() });\n  } catch (error) {\n    return json({ ok: false, error: error.message, ts: Date.now() });\n  }\n}\n", "export async function handleDownload(request, env) {\n  const { pathname } = new URL(request.url);\n  const r2Key = pathname.replace('/download/', '');\n\n  if (env.DEV_MODE !== 'true') {\n    return new Response('Downloads only available in dev mode', { status: 403 });\n  }\n\n  const object = await env.WAIVERS_R2.get(r2Key);\n\n  if (!object) {\n    return new Response('PDF not found', { status: 404 });\n  }\n\n  const filename = r2Key.split('/').pop();\n\n  return new Response(object.body, {\n    headers: {\n      'Content-Type': 'application/pdf',\n      'Content-Disposition': `attachment; filename=\"${filename}\"`,\n      'Cache-Control': 'private, max-age=300'\n    }\n  });\n}\n", "import { handleRoot } from './routes/root.js';\nimport { handleSubmit } from './routes/submit.js';\nimport { handleInitialSubmit, handleCompleteSubmit } from './routes/submit-flow.js';\nimport { handleAdminSearch } from './routes/admin/search.js';\nimport { handleAdminActivities } from './routes/admin/activities.js';\nimport { handleAdminRisks } from './routes/admin/risks.js';\nimport { handleAdminProperties } from './routes/admin/properties.js';\nimport { handleAdminDocument } from './routes/admin/document.js';\nimport { handleAdminVerify } from './routes/admin/verify.js';\nimport { handleAdminReleases } from './routes/admin/releases.js';\nimport { handleAdminDownloadAll } from './routes/admin/download-all.js';\nimport { handleAdminDebug } from './routes/admin/debug.js';\nimport { handleAdminApiDocs } from './routes/admin/api-docs.js';\nimport { handleStatus } from './routes/status.js';\nimport { handleDownload } from './routes/download.js';\nimport { handleAdmin } from './utils/admin.js';\n\nexport default {\n  async fetch(request, env, ctx) {\n    const { pathname } = new URL(request.url);\n\n    try {\n      if (request.method === 'GET'  && pathname === '/')                      return await handleRoot(request, env);\n      if (request.method === 'POST' && pathname === '/submit')                return await handleSubmit(request, env);\n      if (request.method === 'POST' && pathname === '/submit/initial')        return await handleInitialSubmit(request, env);\n      if (request.method === 'POST' && pathname === '/submit/complete')       return await handleCompleteSubmit(request, env);\n      if (request.method === 'GET'  && pathname === '/admin/search')          return await handleAdminSearch(request, env);\n      if (request.method === 'GET'  && pathname === '/status')                return await handleStatus(env);\n      \n      if (request.method === 'GET'  && pathname === '/admin')                 return await handleAdmin();\n\t  if (request.method === 'GET'  && pathname === '/admin/document')        return await handleAdminDocument(request, env);\n      if (request.method === 'GET'  && pathname === '/admin/verify')          return await handleAdminVerify(request, env);\n      if (request.method === 'GET'  && pathname === '/admin/download-all')    return await handleAdminDownloadAll(request, env);\n      if (request.method === 'GET'  && pathname === '/admin/debug')           return await handleAdminDebug(request, env);\n      if (request.method === 'GET'  && pathname === '/admin/api-docs')        return await handleAdminApiDocs();\n      if ((request.method === 'GET' || request.method === 'POST') && pathname.startsWith('/admin/releases'))\treturn await handleAdminReleases(request, env);\n      if ((request.method === 'GET' || request.method === 'POST') && pathname.startsWith('/admin/activities')) \treturn await handleAdminActivities(request, env);\n      if ((request.method === 'GET' || request.method === 'POST') && pathname.startsWith('/admin/properties'))\treturn await handleAdminProperties(request, env);\n      if ((request.method === 'GET' || request.method === 'POST') && pathname === '/admin/risks')\t\t\t\treturn await handleAdminRisks(request, env);\n      if (request.method === 'GET'  && pathname.startsWith('/download/'))     return await handleDownload(request, env);\n\n      return new Response('Not found', { status: 404 });\n    } catch (err) {\n      console.error(err);\n      return new Response('Server error', { status: 500 });\n    }\n  }\n};\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\scrap\\\\dev\\\\vitaliyah\\\\cf\\\\src\\\\index.js\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\scrap\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\scrap\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\scrap\\\\dev\\\\vitaliyah\\\\cf\\\\src\\\\index.js\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\scrap\\\\dev\\\\vitaliyah\\\\cf\\\\.wrangler\\\\tmp\\\\bundle-l3U5iW\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\scrap\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\scrap\\\\dev\\\\vitaliyah\\\\cf\\\\.wrangler\\\\tmp\\\\bundle-l3U5iW\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\scrap\\\\dev\\\\vitaliyah\\\\cf\\\\.wrangler\\\\tmp\\\\bundle-l3U5iW\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCA4HW,OAAO;AAAA,mCACL,OAAO;AAAA,wCACF,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;A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AAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAomCb,SAAO,IAAI,SAAS,MAAM;AAAA,IACxB,SAAS,EAAE,gBAAgB,2BAA2B;AAAA,EACxD,CAAC;AACH;AAxmCsB;;;ACRf,SAAS,mBAAmB,MAAM;AACvC,QAAM,OAAO;AAAA,IAAC;AAAA,IAAa;AAAA,IAAc;AAAA,IAAY;AAAA,IACvC;AAAA,IAAa;AAAA,IAAW;AAAA,IAAY;AAAA,EAAU;AAE5D,aAAW,KAAK,MAAM;AACpB,QAAI,KAAK,CAAC,MAAM,UAAa,KAAK,CAAC,MAAM,MACpC,MAAM,QAAQ,KAAK,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE,QAAS;AAC/C,aAAO,WAAW,CAAC;AAAA,IACrB;AAAA,EACF;AAEA,MAAI,KAAK,aAAa,MAAM;AAC1B,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAhBgB;;;ACAhB,eAAsB,eAAeC,MAAK,OAAO,MAAM,WAAW;AAChE,QAAMA,KAAI,QAAQ;AAAA,IACd;AAAA,EACF,EAAE;AAAA,IACA;AAAA,IAAO;AAAA,IAAW,KAAK;AAAA,IAAY,KAAK;AAAA,IACxC,KAAK;AAAA,IAAW,KAAK;AAAA,IAAY,KAAK,UAAU,KAAK,UAAU;AAAA,EACjE,EAAE,IAAI;AACV;AAPsB;AAStB,eAAsB,cAAcA,MAAK,OAAO,UAAU;AACxD,QAAM,OAAM,oBAAI,KAAK,GAAE,YAAY;AAEnC,aAAW,KAAK,UAAU;AAExB,UAAMA,KAAI,QAAQ;AAAA,MACd;AAAA,IACF,EAAE,KAAK,EAAE,IAAI,OAAO,EAAE,UAAU,EAAE,OAAO,EAAE,QAAQ,EAAE,IAAI;AAG3D,UAAM,SAAS,QAAQ,EAAE,EAAE;AAC3B,UAAMA,KAAI,QAAQ;AAAA,MACd;AAAA,IACF,EAAE,KAAK,QAAQ,EAAE,IAAI,EAAE,MAAM,GAAG,EAAE,IAAI;AAAA,EAC1C;AACF;AAfsB;;;ACPtB,eAAe,qBAAqB,MAAM;AACxC,QAAM,YAAY,KAAK,UAAU;AAAA,IAC/B,eAAe,KAAK;AAAA,IACpB,aAAa,KAAK;AAAA,IAClB,cAAc,KAAK;AAAA,IACnB,YAAY,KAAK;AAAA,IACjB,aAAa,KAAK;AAAA,IAClB,UAAU,KAAK;AAAA,IACf,gBAAgB,KAAK;AAAA,IACrB,UAAU,KAAK;AAAA,IACf,eAAe,KAAK;AAAA,IACpB,YAAY,KAAK;AAAA,IACjB,iBAAiB,KAAK;AAAA,IACtB,cAAc,KAAK;AAAA,EACrB,CAAC;AAED,QAAM,UAAU,IAAI,YAAY;AAChC,QAAM,aAAa,QAAQ,OAAO,SAAS;AAC3C,QAAM,aAAa,MAAM,OAAO,OAAO,OAAO,WAAW,UAAU;AACnE,QAAM,YAAY,MAAM,KAAK,IAAI,WAAW,UAAU,CAAC;AACvD,QAAM,UAAU,UAAU,IAAI,OAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AAE3E,SAAO;AACT;AAvBe;AAyBf,SAAS,mBAAmB,MAAM,cAAc,UAAU,eAAe,YAAY,cAAc;AACjG,QAAM,YAAY,cAAc,QAAQ;AAExC,SAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QA0FD,KAAK,SAAS,YAAY,CAAC;AAAA;AAAA;AAAA,kBAGjB,KAAK,UAAU;AAAA,kBACf,KAAK,WAAW;AAAA,kBAChB,KAAK,SAAS;AAAA,kBACd,KAAK,SAAS,KAAK,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA,0CAIJ,UAAU,YAAY,CAAC;AAAA,MAC3D,UAAU,cAAc,iCAAiC,SAAS,WAAW,WAAW,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA,+BAKjE,cAAc,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,MAKlD,KAAK,YAAY,aAAa,KAAK,SAAS,iCAAiC,sDAAsD;AAAA;AAAA;AAAA;AAAA,oBAIrH,cAAc,OAAO,KAAK,cAAc,YAAY,yBAAoB,UAAU;AAAA,yBAC7E,aAAa,UAAU,GAAG,EAAE,CAAC;AAAA;AAAA;AAAA;AAItD;AA3HS;AA6HT,eAAsB,SAAS,MAAM,OAAOC,MAAK;AAC/C,QAAM,MAAM,oBAAI,KAAK;AACrB,QAAM,YAAY,IAAI,YAAY;AAClC,QAAM,IAAI,IAAI,eAAe;AAC7B,QAAM,IAAI,OAAO,IAAI,YAAY,IAAI,CAAC,EAAE,SAAS,GAAG,GAAG;AACvD,QAAM,IAAI,OAAO,IAAI,WAAW,CAAC,EAAE,SAAS,GAAG,GAAG;AAGlD,QAAM,gBAAgB,MAAMA,KAAI,QAAQ;AAAA,IACtC;AAAA,EACF,EAAE,MAAM;AAER,MAAI,CAAC,eAAe;AAClB,UAAM,IAAI,MAAM,2EAA2E;AAAA,EAC7F;AAGA,QAAM,mBAAmB,MAAMA,KAAI,QAAQ;AAAA,IACzC;AAAA,EACF,EAAE,KAAK,KAAK,UAAU,EAAE,IAAI;AAC5B,QAAM,aAAa,iBAAiB,WAAW,CAAC;AAGhD,QAAM,cAAc,MAAMA,KAAI,QAAQ;AAAA,IACpC;AAAA,EACF,EAAE,IAAI;AACN,QAAM,QAAQ,CAAC;AACf,aAAW,OAAQ,YAAY,WAAW,CAAC,GAAI;AAC7C,UAAM,IAAI,KAAK,IAAI,EAAE,aAAa,IAAI,YAAY;AAAA,EACpD;AAGA,MAAI,eAAe;AACnB,MAAI,KAAK,WAAW;AAClB,QAAI;AACF,YAAM,gBAAgB,KAAK,UAAU,MAAM,GAAG,EAAE,CAAC;AACjD,YAAM,iBAAiB,WAAW,KAAK,KAAK,aAAa,GAAG,OAAK,EAAE,WAAW,CAAC,CAAC;AAEhF,YAAM,YAAY,KAAK,UAAU,KAAK,EAAE,MAAM,KAAK;AACnD,YAAM,YAAY,UAAU,CAAC,GAAG,YAAY,EAAE,QAAQ,WAAW,EAAE,KAAK;AACxE,YAAM,WAAW,UAAU,SAAS,IAChC,UAAU,UAAU,SAAS,CAAC,EAAE,YAAY,EAAE,QAAQ,WAAW,EAAE,IACnE;AAEJ,qBAAe,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,KAAK,UAAU,eAAe,QAAQ,IAAI,SAAS,IAAI,KAAK;AAErG,YAAMA,KAAI,WAAW,IAAI,cAAc,gBAAgB;AAAA,QACrD,cAAc,EAAE,aAAa,YAAY;AAAA,MAC3C,CAAC;AAAA,IACH,SAAS,KAAK;AACZ,cAAQ,MAAM,iCAAiC,GAAG;AAAA,IACpD;AAAA,EACF;AAEA,QAAM,UAAU,CAAC;AAEjB,aAAW,OAAO,KAAK,YAAY;AACjC,UAAM,eAAe,WAAW,KAAK,OAAK,EAAE,SAAS,GAAG;AACxD,UAAM,YAAY,cAAc,QAAQ;AACxC,UAAM,WAAW,MAAM,SAAS;AAEhC,UAAM,YAAY,KAAK,UAAU,KAAK,EAAE,MAAM,KAAK;AACnD,UAAM,YAAY,UAAU,CAAC,GAAG,YAAY,EAAE,QAAQ,WAAW,EAAE,KAAK;AACxE,UAAM,WAAW,UAAU,SAAS,IAChC,UAAU,UAAU,SAAS,CAAC,EAAE,YAAY,EAAE,QAAQ,WAAW,EAAE,IACnE;AAEJ,UAAM,aAAa,OAAO,EAAE;AAE5B,UAAM,WAAW;AAAA,MACf,eAAe;AAAA,MACf,aAAa,KAAK;AAAA,MAClB,cAAc,KAAK;AAAA,MACnB,YAAY,KAAK;AAAA,MACjB,aAAa,KAAK;AAAA,MAClB,UAAU;AAAA,MACV,gBAAgB,cAAc,SAAS;AAAA,MACvC,UAAU,KAAK,SAAS,GAAG;AAAA,MAC3B,eAAe;AAAA,MACf,YAAY;AAAA,MACZ,iBAAiB,cAAc;AAAA,MAC/B,cAAc,cAAc;AAAA,IAC9B;AAEA,UAAM,eAAe,MAAM,qBAAqB,QAAQ;AAGxD,UAAM,cAAc;AAAA,MAClB,EAAE,GAAG,MAAM,UAAU,IAAI;AAAA,MACzB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAGA,QAAI;AACJ,QAAI;AACF,YAAM,UAAU,MAAMA,KAAI,QAAQ,OAAO;AACzC,YAAM,OAAO,MAAM,QAAQ,QAAQ;AACnC,YAAM,KAAK,WAAW,aAAa,EAAE,WAAW,cAAc,CAAC;AAE/D,iBAAW,MAAM,KAAK,IAAI;AAAA,QACxB,QAAQ;AAAA,QACR,iBAAiB;AAAA,QACjB,QAAQ;AAAA,UACN,KAAK;AAAA,UACL,OAAO;AAAA,UACP,QAAQ;AAAA,UACR,MAAM;AAAA,QACR;AAAA,MACF,CAAC;AAED,YAAM,QAAQ,MAAM;AAAA,IACtB,SAAS,KAAK;AACZ,cAAQ,MAAM,gDAAgD,GAAG;AACjE,YAAM,IAAI,MAAM,uCAAuC,GAAG,KAAK,IAAI,OAAO,EAAE;AAAA,IAC9E;AAGA,UAAM,WAAW,GAAG,QAAQ,IAAI,SAAS,IAAI,KAAK;AAClD,UAAM,MAAM,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,KAAK,UAAU,IAAI,GAAG,IAAI,QAAQ,IAAI,SAAS,IAAI,KAAK;AAE9F,UAAMA,KAAI,WAAW,IAAI,KAAK,UAAU;AAAA,MACtC,cAAc,EAAE,aAAa,kBAAkB;AAAA,IACjD,CAAC;AAED,YAAQ,KAAK;AAAA,MACX,IAAI;AAAA,MACJ,UAAU;AAAA,MACV;AAAA,MACA,OAAO;AAAA,MACP,OAAO;AAAA,MACP,MAAM;AAAA,MACN,UAAU,KAAK,SAAS,GAAG;AAAA,IAC7B,CAAC;AAAA,EACH;AAEA,SAAO;AACT;AA5IsB;;;ACxJtB,IAAIC,aAAY,OAAO;AACvB,IAAI,aAAa,OAAO;AACxB,IAAI,oBAAoB,OAAO;AAC/B,IAAI,sBAAsB,OAAO;AACjC,IAAI,eAAe,OAAO,UAAU;AACpC,IAAI,eAAe,OAAO,UAAU;AACpC,IAAI,kBAAkB,wBAAC,KAAK,KAAK,UAAU,OAAO,MAAMA,WAAU,KAAK,KAAK,EAAE,YAAY,MAAM,cAAc,MAAM,UAAU,MAAM,MAAM,CAAC,IAAI,IAAI,GAAG,IAAI,OAApI;AACtB,IAAI,iBAAiB,wBAAC,GAAG,MAAM;AAC7B,WAAS,QAAQ,MAAM,IAAI,CAAC;AAC1B,QAAI,aAAa,KAAK,GAAG,IAAI;AAC3B,sBAAgB,GAAG,MAAM,EAAE,IAAI,CAAC;AACpC,MAAI;AACF,aAAS,QAAQ,oBAAoB,CAAC,GAAG;AACvC,UAAI,aAAa,KAAK,GAAG,IAAI;AAC3B,wBAAgB,GAAG,MAAM,EAAE,IAAI,CAAC;AAAA,IACpC;AACF,SAAO;AACT,GAVqB;AAWrB,IAAI,gBAAgB,wBAAC,GAAG,MAAM,WAAW,GAAG,kBAAkB,CAAC,CAAC,GAA5C;AACpB,IAAI,YAAY,wBAAC,QAAQ,YAAY;AACnC,MAAI,SAAS,CAAC;AACd,WAAS,QAAQ;AACf,QAAI,aAAa,KAAK,QAAQ,IAAI,KAAK,QAAQ,QAAQ,IAAI,IAAI;AAC7D,aAAO,IAAI,IAAI,OAAO,IAAI;AAC9B,MAAI,UAAU,QAAQ;AACpB,aAAS,QAAQ,oBAAoB,MAAM,GAAG;AAC5C,UAAI,QAAQ,QAAQ,IAAI,IAAI,KAAK,aAAa,KAAK,QAAQ,IAAI;AAC7D,eAAO,IAAI,IAAI,OAAO,IAAI;AAAA,IAC9B;AACF,SAAO;AACT,GAXgB;AAYhB,IAAI,UAAU,wBAAC,QAAQ,aAAa,cAAc;AAChD,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,QAAI,YAAY,wBAAC,UAAU;AACzB,UAAI;AACF,aAAK,UAAU,KAAK,KAAK,CAAC;AAAA,MAC5B,SAAS,GAAG;AACV,eAAO,CAAC;AAAA,MACV;AAAA,IACF,GANgB;AAOhB,QAAI,WAAW,wBAAC,UAAU;AACxB,UAAI;AACF,aAAK,UAAU,MAAM,KAAK,CAAC;AAAA,MAC7B,SAAS,GAAG;AACV,eAAO,CAAC;AAAA,MACV;AAAA,IACF,GANe;AAOf,QAAI,OAAO,wBAAC,MAAM,EAAE,OAAO,QAAQ,EAAE,KAAK,IAAI,QAAQ,QAAQ,EAAE,KAAK,EAAE,KAAK,WAAW,QAAQ,GAApF;AACX,UAAM,YAAY,UAAU,MAAM,QAAQ,WAAW,GAAG,KAAK,CAAC;AAAA,EAChE,CAAC;AACH,GAnBc;AAsBd,IAAIC,WAAU;AAGd,SAAS,qBAAqB,SAAS;AACrC,QAAM,eAAe,IAAI,gBAAgB;AACzC,MAAI,QAAQ,UAAU,QAAQ;AAC5B,iBAAa,IAAI,SAAS,QAAQ,MAAM,SAAS,CAAC;AAAA,EACpD;AACA,MAAI,WAAW,WAAW,QAAQ,UAAU,QAAQ;AAClD,iBAAa,IAAI,SAAS,QAAQ,KAAK;AAAA,EACzC;AACA,MAAI,YAAY,WAAW,QAAQ,WAAW,QAAQ;AACpD,iBAAa,IAAI,UAAU,QAAQ,MAAM;AAAA,EAC3C;AACA,SAAO,aAAa,SAAS;AAC/B;AAZS;AAeT,IAAI,UAAU,MAAM;AAAA,EAvEpB,OAuEoB;AAAA;AAAA;AAAA,EAClB,YAAY,QAAQ;AAClB,SAAK,SAAS;AAAA,EAChB;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,WAAW,WAAW,SAAS,UAAU,CAAC,GAAG;AAChE,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B;AAAA,QACA;AAAA,QACA;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO;AACL,WAAO,QAAQ,MAAM,WAAW,WAAW,UAAU,CAAC,GAAG;AACvD,YAAM,cAAc,qBAAqB,OAAO;AAChD,YAAM,MAAM,cAAc,aAAa,WAAW,KAAK;AACvD,YAAM,OAAO,MAAM,KAAK,OAAO,IAAI,GAAG;AACtC,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,aAAa,EAAE;AAAA,MACjB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AACF;AAGA,IAAI,YAAY,MAAM;AAAA,EAxGtB,OAwGsB;AAAA;AAAA;AAAA,EACpB,YAAY,QAAQ;AAClB,SAAK,SAAS;AAAA,EAChB;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,WAAW,WAAW,SAAS,UAAU,CAAC,GAAG;AAChE,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B;AAAA,QACA;AAAA,QACA;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO;AACL,WAAO,QAAQ,MAAM,WAAW,WAAW,UAAU,CAAC,GAAG;AACvD,YAAM,cAAc,qBAAqB,OAAO;AAChD,YAAM,MAAM,cAAc,cAAc,WAAW,KAAK;AACxD,YAAM,OAAO,MAAM,KAAK,OAAO,IAAI,GAAG;AACtC,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,IAAI,IAAI;AACN,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,cAAc,EAAE;AAAA,MAClB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,cAAc,EAAE;AAAA,MAClB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AACF;AAGA,SAAS,iBAAiB,aAAa;AACrC,SAAO,eAAe,OAAO,SAAS,YAAY,IAAI,CAAC,gBAAgB;AAAA,IACrE,SAAS,WAAW;AAAA,IACpB,UAAU,WAAW;AAAA,IACrB,MAAM,WAAW;AAAA,IACjB,cAAc,WAAW;AAAA,IACzB,YAAY,WAAW;AAAA,EACzB,EAAE;AACJ;AARS;AAST,SAAS,uBAAuB,OAAO;AACrC,SAAO;AAAA,IACL,aAAa,iBAAiB,MAAM,WAAW;AAAA,IAC/C,KAAK,MAAM;AAAA,IACX,IAAI,MAAM;AAAA,IACV,MAAM,MAAM;AAAA,IACZ,SAAS,MAAM;AAAA,IACf,MAAM,MAAM;AAAA,IACZ,UAAU,MAAM;AAAA,IAChB,cAAc,MAAM;AAAA,IACpB,SAAS,MAAM;AAAA,IACf,MAAM,MAAM;AAAA,IACZ,MAAM,MAAM;AAAA,IACZ,IAAI,MAAM;AAAA,EACZ;AACF;AAfS;AAkBT,SAAS,OAAO,MAAM;AACpB,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,WAAO,qBAAqB,EAAE,KAAK,CAAC,EAAE,QAAQ,QAAQ,MAAM;AAC1D,cAAQ,QAAQ,IAAI,CAAC;AAAA,IACvB,CAAC,EAAE,MAAM,MAAM;AACb;AAAA,QACE;AAAA,UACE;AAAA,QACF;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH,CAAC;AACH;AAZS;AAeT,IAAI,QAAQ,MAAM;AAAA,EA3LlB,OA2LkB;AAAA;AAAA;AAAA,EAChB,YAAY,QAAQ;AAClB,SAAK,SAAS;AAAA,EAChB;AAAA,EACA,KAAK,SAAS,SAAS;AACrB,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,aAAO,KAAK,OAAO,SAAS,OAAO;AAAA,IACrC,CAAC;AAAA,EACH;AAAA,EACA,OAAO,SAAS,SAAS;AACvB,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,UAAI;AACJ,YAAM,SAAS,CAAC;AAChB,iBAAW,SAAS,SAAS;AAC3B,YAAI,MAAM,OAAO;AACf,gBAAM,OAAO,MAAM,OAAO,MAAM,KAAK;AACrC,gBAAM,QAAQ;AAAA,QAChB;AACA,eAAO,KAAK,uBAAuB,KAAK,CAAC;AAAA,MAC3C;AACA,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B;AAAA,QACA;AAAA,QACA,cAAc,eAAe,CAAC,GAAG,OAAO,GAAG;AAAA,UACzC,SAAS,eAAe;AAAA,YACtB,uBAAuB,KAAK,WAAW,OAAO,SAAS,QAAQ,oBAAoB,OAAO,KAAK;AAAA,UACjG,GAAG,WAAW,OAAO,SAAS,QAAQ,OAAO;AAAA,QAC/C,CAAC;AAAA,MACH;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AACF;AAGA,IAAI,aAAa,MAAM;AAAA,EA9NvB,OA8NuB;AAAA;AAAA;AAAA,EACrB,YAAY,QAAQ;AAClB,SAAK,SAAS;AAAA,EAChB;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,WAAW,WAAW,SAAS,UAAU,CAAC,GAAG;AAChE,UAAI,QAAQ,OAAO;AACjB,gBAAQ,OAAO,MAAM,OAAO,QAAQ,KAAK;AAAA,MAC3C;AACA,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B;AAAA,QACA;AAAA,UACE,MAAM,QAAQ;AAAA,UACd,aAAa,QAAQ;AAAA,UACrB,cAAc,QAAQ;AAAA,UACtB,MAAM,QAAQ;AAAA,UACd,MAAM,QAAQ;AAAA,UACd,UAAU,QAAQ;AAAA,UAClB,SAAS,QAAQ;AAAA,UACjB,MAAM,QAAQ;AAAA,QAChB;AAAA,QACA;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,KAAK,IAAI,SAAS;AAChB,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,eAAe,EAAE;AAAA,QACjB,EAAE,cAAc,WAAW,OAAO,SAAS,QAAQ,YAAY;AAAA,MACjE;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO;AACL,WAAO,QAAQ,MAAM,WAAW,WAAW,UAAU,CAAC,GAAG;AACvD,YAAM,cAAc,qBAAqB,OAAO;AAChD,YAAM,MAAM,cAAc,eAAe,WAAW,KAAK;AACzD,YAAM,OAAO,MAAM,KAAK,OAAO,IAAI,GAAG;AACtC,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,IAAI,IAAI;AACN,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,eAAe,EAAE;AAAA,MACnB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,eAAe,EAAE;AAAA,MACnB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI,SAAS;AAClB,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,UAAI,QAAQ,OAAO;AACjB,gBAAQ,OAAO,MAAM,OAAO,QAAQ,KAAK;AAAA,MAC3C;AACA,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,eAAe,EAAE;AAAA,QACjB;AAAA,UACE,MAAM,QAAQ;AAAA,UACd,aAAa,QAAQ;AAAA,UACrB,MAAM,QAAQ;AAAA,UACd,MAAM,QAAQ;AAAA,UACd,MAAM,QAAQ;AAAA,UACd,SAAS,QAAQ;AAAA,UACjB,UAAU,QAAQ;AAAA,UAClB,cAAc,QAAQ;AAAA,QACxB;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AACF;AAGA,IAAI,WAAW,MAAM;AAAA,EAjTrB,OAiTqB;AAAA;AAAA;AAAA,EACnB,YAAY,QAAQ;AAClB,SAAK,SAAS;AAAA,EAChB;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,WAAW,WAAW,SAAS,UAAU,CAAC,GAAG;AAChE,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,cAAc,QAAQ,UAAU;AAAA,QAChC;AAAA,UACE,cAAc,QAAQ;AAAA,UACtB,OAAO,QAAQ;AAAA,UACf,YAAY,QAAQ;AAAA,UACpB,WAAW,QAAQ;AAAA,QACrB;AAAA,QACA;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,KAAK,SAAS;AACZ,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,KAAK,SAAS,EAAE,WAAW,IAAI,IAAI,oBAAoB,UAAU,IAAI,CAAC,YAAY,CAAC;AACzF,YAAM,cAAc,qBAAqB,iBAAiB;AAC1D,YAAM,MAAM,cAAc,cAAc,UAAU,aAAa,WAAW,KAAK,cAAc,UAAU;AACvG,YAAM,OAAO,MAAM,KAAK,OAAO,IAAI,GAAG;AACtC,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,IAAI,SAAS;AACX,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,UAAI,CAAC,QAAQ,MAAM,CAAC,QAAQ,OAAO;AACjC,eAAO;AAAA,UACL,MAAM;AAAA,UACN,OAAO;AAAA,YACL,SAAS;AAAA,YACT,MAAM;AAAA,UACR;AAAA,QACF;AAAA,MACF;AACA,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,cAAc,QAAQ,UAAU,cAAc,WAAW,OAAO,SAAS,QAAQ,SAAS,WAAW,OAAO,SAAS,QAAQ,QAAQ,WAAW,OAAO,SAAS,QAAQ,EAAE;AAAA,MAC5K;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,SAAS;AACd,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,UAAI,CAAC,QAAQ,MAAM,CAAC,QAAQ,OAAO;AACjC,eAAO;AAAA,UACL,MAAM;AAAA,UACN,OAAO;AAAA,YACL,SAAS;AAAA,YACT,MAAM;AAAA,UACR;AAAA,QACF;AAAA,MACF;AACA,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,cAAc,QAAQ,UAAU,cAAc,WAAW,OAAO,SAAS,QAAQ,SAAS,WAAW,OAAO,SAAS,QAAQ,QAAQ,WAAW,OAAO,SAAS,QAAQ,EAAE;AAAA,QAC1K;AAAA,UACE,cAAc,QAAQ;AAAA,UACtB,YAAY,QAAQ;AAAA,UACpB,WAAW,QAAQ;AAAA,QACrB;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,SAAS;AACd,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,UAAI,CAAC,QAAQ,MAAM,CAAC,QAAQ,OAAO;AACjC,eAAO;AAAA,UACL,MAAM;AAAA,UACN,OAAO;AAAA,YACL,SAAS;AAAA,YACT,MAAM;AAAA,UACR;AAAA,QACF;AAAA,MACF;AACA,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,cAAc,QAAQ,UAAU,cAAc,WAAW,OAAO,SAAS,QAAQ,SAAS,WAAW,OAAO,SAAS,QAAQ,QAAQ,WAAW,OAAO,SAAS,QAAQ,EAAE;AAAA,MAC5K;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AACF;AAGA,SAAS,wBAAwBC,SAAQ;AACvC,SAAO;AAAA,IACL,MAAMA,QAAO;AAAA,IACb,QAAQA,QAAO;AAAA,IACf,oBAAoBA,QAAO;AAAA,EAC7B;AACF;AANS;AAST,IAAI,UAAU,MAAM;AAAA,EAjZpB,OAiZoB;AAAA;AAAA;AAAA,EAClB,YAAY,QAAQ;AAClB,SAAK,SAAS;AAAA,EAChB;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,WAAW,WAAW,SAAS,UAAU,CAAC,GAAG;AAChE,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B;AAAA,QACA,wBAAwB,OAAO;AAAA,QAC/B;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO;AACL,WAAO,QAAQ,MAAM,WAAW,WAAW,UAAU,CAAC,GAAG;AACvD,YAAM,cAAc,qBAAqB,OAAO;AAChD,YAAM,MAAM,cAAc,YAAY,WAAW,KAAK;AACtD,YAAM,OAAO,MAAM,KAAK,OAAO,IAAI,GAAG;AACtC,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,IAAI,IAAI;AACN,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,YAAY,EAAE;AAAA,MAChB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,SAAS;AACd,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,YAAY,QAAQ,EAAE;AAAA,QACtB;AAAA,UACE,gBAAgB,QAAQ;AAAA,UACxB,eAAe,QAAQ;AAAA,UACvB,KAAK,QAAQ;AAAA,QACf;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,YAAY,EAAE;AAAA,MAChB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,YAAY,EAAE;AAAA,MAChB;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AACF;AAGA,IAAI,SAAS,MAAM;AAAA,EA/cnB,OA+cmB;AAAA;AAAA;AAAA,EACjB,YAAY,QAAQ;AAClB,SAAK,SAAS;AAAA,EAChB;AAAA,EACA,KAAK,IAAI;AACP,WAAO,QAAQ,MAAM,WAAW,WAAW,SAAS,UAAU,CAAC,GAAG;AAChE,aAAO,KAAK,OAAO,SAAS,OAAO;AAAA,IACrC,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,WAAW,WAAW,SAAS,UAAU,CAAC,GAAG;AAChE,UAAI,QAAQ,OAAO;AACjB,gBAAQ,OAAO,MAAM,OAAO,QAAQ,KAAK;AAAA,MAC3C;AACA,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B;AAAA,QACA,uBAAuB,OAAO;AAAA,QAC9B;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,IAAI,IAAI;AACN,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,WAAW,EAAE;AAAA,MACf;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO;AACL,WAAO,QAAQ,MAAM,WAAW,WAAW,UAAU,CAAC,GAAG;AACvD,YAAM,cAAc,qBAAqB,OAAO;AAChD,YAAM,MAAM,cAAc,WAAW,WAAW,KAAK;AACrD,YAAM,OAAO,MAAM,KAAK,OAAO,IAAI,GAAG;AACtC,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,SAAS;AACd,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,WAAW,QAAQ,EAAE;AAAA,QACrB;AAAA,UACE,cAAc,QAAQ;AAAA,QACxB;AAAA,MACF;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,OAAO,IAAI;AACT,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,OAAO,MAAM,KAAK,OAAO;AAAA,QAC7B,WAAW,EAAE;AAAA,MACf;AACA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AACF;AAGA,IAAI,iBAAiB;AACrB,IAAI,mBAAmB,eAAeD,QAAO;AAC7C,IAAI,UAAU,OAAO,YAAY,eAAe,QAAQ,MAAM,QAAQ,IAAI,mBAAmB,iBAAiB;AAC9G,IAAI,YAAY,OAAO,YAAY,eAAe,QAAQ,MAAM,QAAQ,IAAI,qBAAqB,mBAAmB;AACpH,IAAI,SAAS,MAAM;AAAA,EA/gBnB,OA+gBmB;AAAA;AAAA;AAAA,EACjB,YAAY,KAAK;AACf,SAAK,MAAM;AACX,SAAK,UAAU,IAAI,QAAQ,IAAI;AAC/B,SAAK,YAAY,IAAI,UAAU,IAAI;AACnC,SAAK,QAAQ,IAAI,MAAM,IAAI;AAC3B,SAAK,aAAa,IAAI,WAAW,IAAI;AACrC,SAAK,WAAW,IAAI,SAAS,IAAI;AACjC,SAAK,UAAU,IAAI,QAAQ,IAAI;AAC/B,SAAK,SAAS,IAAI,OAAO,IAAI;AAC7B,QAAI,CAAC,KAAK;AACR,UAAI,OAAO,YAAY,eAAe,QAAQ,KAAK;AACjD,aAAK,MAAM,QAAQ,IAAI;AAAA,MACzB;AACA,UAAI,CAAC,KAAK,KAAK;AACb,cAAM,IAAI;AAAA,UACR;AAAA,QACF;AAAA,MACF;AAAA,IACF;AACA,SAAK,UAAU,IAAI,QAAQ;AAAA,MACzB,eAAe,UAAU,KAAK,GAAG;AAAA,MACjC,cAAc;AAAA,MACd,gBAAgB;AAAA,IAClB,CAAC;AAAA,EACH;AAAA,EACA,aAAa,IAAI;AACf,WAAO,QAAQ,MAAM,WAAW,WAAW,MAAM,UAAU,CAAC,GAAG;AAC7D,UAAI;AACF,cAAM,WAAW,MAAM,MAAM,GAAG,OAAO,GAAG,IAAI,IAAI,OAAO;AACzD,YAAI,CAAC,SAAS,IAAI;AAChB,cAAI;AACF,kBAAM,WAAW,MAAM,SAAS,KAAK;AACrC,mBAAO,EAAE,MAAM,MAAM,OAAO,KAAK,MAAM,QAAQ,EAAE;AAAA,UACnD,SAAS,KAAK;AACZ,gBAAI,eAAe,aAAa;AAC9B,qBAAO;AAAA,gBACL,MAAM;AAAA,gBACN,OAAO;AAAA,kBACL,MAAM;AAAA,kBACN,SAAS;AAAA,gBACX;AAAA,cACF;AAAA,YACF;AACA,kBAAME,SAAQ;AAAA,cACZ,SAAS,SAAS;AAAA,cAClB,MAAM;AAAA,YACR;AACA,gBAAI,eAAe,OAAO;AACxB,qBAAO,EAAE,MAAM,MAAM,OAAO,cAAc,eAAe,CAAC,GAAGA,MAAK,GAAG,EAAE,SAAS,IAAI,QAAQ,CAAC,EAAE;AAAA,YACjG;AACA,mBAAO,EAAE,MAAM,MAAM,OAAAA,OAAM;AAAA,UAC7B;AAAA,QACF;AACA,cAAM,OAAO,MAAM,SAAS,KAAK;AACjC,eAAO,EAAE,MAAM,OAAO,KAAK;AAAA,MAC7B,SAAS,GAAG;AACV,eAAO;AAAA,UACL,MAAM;AAAA,UACN,OAAO;AAAA,YACL,MAAM;AAAA,YACN,SAAS;AAAA,UACX;AAAA,QACF;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EACA,KAAK,IAAI,IAAI;AACX,WAAO,QAAQ,MAAM,WAAW,WAAW,MAAM,QAAQ,UAAU,CAAC,GAAG;AACrE,YAAM,UAAU,IAAI,QAAQ,KAAK,OAAO;AACxC,UAAI,QAAQ,SAAS;AACnB,mBAAW,CAAC,KAAK,KAAK,KAAK,IAAI,QAAQ,QAAQ,OAAO,EAAE,QAAQ,GAAG;AACjE,kBAAQ,IAAI,KAAK,KAAK;AAAA,QACxB;AAAA,MACF;AACA,UAAI,QAAQ,gBAAgB;AAC1B,gBAAQ,IAAI,mBAAmB,QAAQ,cAAc;AAAA,MACvD;AACA,YAAM,iBAAiB,cAAc,eAAe;AAAA,QAClD,QAAQ;AAAA,QACR,MAAM,KAAK,UAAU,MAAM;AAAA,MAC7B,GAAG,OAAO,GAAG;AAAA,QACX;AAAA,MACF,CAAC;AACD,aAAO,KAAK,aAAa,MAAM,cAAc;AAAA,IAC/C,CAAC;AAAA,EACH;AAAA,EACA,IAAI,IAAI;AACN,WAAO,QAAQ,MAAM,WAAW,WAAW,MAAM,UAAU,CAAC,GAAG;AAC7D,YAAM,UAAU,IAAI,QAAQ,KAAK,OAAO;AACxC,UAAI,QAAQ,SAAS;AACnB,mBAAW,CAAC,KAAK,KAAK,KAAK,IAAI,QAAQ,QAAQ,OAAO,EAAE,QAAQ,GAAG;AACjE,kBAAQ,IAAI,KAAK,KAAK;AAAA,QACxB;AAAA,MACF;AACA,YAAM,iBAAiB,cAAc,eAAe;AAAA,QAClD,QAAQ;AAAA,MACV,GAAG,OAAO,GAAG;AAAA,QACX;AAAA,MACF,CAAC;AACD,aAAO,KAAK,aAAa,MAAM,cAAc;AAAA,IAC/C,CAAC;AAAA,EACH;AAAA,EACA,IAAI,IAAI,IAAI;AACV,WAAO,QAAQ,MAAM,WAAW,WAAW,MAAM,QAAQ,UAAU,CAAC,GAAG;AACrE,YAAM,UAAU,IAAI,QAAQ,KAAK,OAAO;AACxC,UAAI,QAAQ,SAAS;AACnB,mBAAW,CAAC,KAAK,KAAK,KAAK,IAAI,QAAQ,QAAQ,OAAO,EAAE,QAAQ,GAAG;AACjE,kBAAQ,IAAI,KAAK,KAAK;AAAA,QACxB;AAAA,MACF;AACA,YAAM,iBAAiB,cAAc,eAAe;AAAA,QAClD,QAAQ;AAAA,QACR,MAAM,KAAK,UAAU,MAAM;AAAA,MAC7B,GAAG,OAAO,GAAG;AAAA,QACX;AAAA,MACF,CAAC;AACD,aAAO,KAAK,aAAa,MAAM,cAAc;AAAA,IAC/C,CAAC;AAAA,EACH;AAAA,EACA,MAAM,IAAI,IAAI;AACZ,WAAO,QAAQ,MAAM,WAAW,WAAW,MAAM,QAAQ,UAAU,CAAC,GAAG;AACrE,YAAM,UAAU,IAAI,QAAQ,KAAK,OAAO;AACxC,UAAI,QAAQ,SAAS;AACnB,mBAAW,CAAC,KAAK,KAAK,KAAK,IAAI,QAAQ,QAAQ,OAAO,EAAE,QAAQ,GAAG;AACjE,kBAAQ,IAAI,KAAK,KAAK;AAAA,QACxB;AAAA,MACF;AACA,YAAM,iBAAiB,cAAc,eAAe;AAAA,QAClD,QAAQ;AAAA,QACR,MAAM,KAAK,UAAU,MAAM;AAAA,MAC7B,GAAG,OAAO,GAAG;AAAA,QACX;AAAA,MACF,CAAC;AACD,aAAO,KAAK,aAAa,MAAM,cAAc;AAAA,IAC/C,CAAC;AAAA,EACH;AAAA,EACA,OAAO,MAAM,OAAO;AAClB,WAAO,QAAQ,MAAM,MAAM,aAAa;AACtC,YAAM,iBAAiB;AAAA,QACrB,QAAQ;AAAA,QACR,MAAM,KAAK,UAAU,KAAK;AAAA,QAC1B,SAAS,KAAK;AAAA,MAChB;AACA,aAAO,KAAK,aAAa,MAAM,cAAc;AAAA,IAC/C,CAAC;AAAA,EACH;AACF;;;AChqBA,eAAsB,sBAAsB,OAAO,MAAM,iBAAiBC,MAAK;AAC7E,QAAM,SAAS,IAAI,OAAOA,KAAI,cAAc;AAE5C,QAAM,WAAW,MAAM,IAAI;AAAA;AAAA;AAAA;AAAA;AAAA,EAK3B,eAAe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AASf,QAAM,WAAW;AAAA;AAAA;AAAA,cAGL,IAAI;AAAA;AAAA;AAAA;AAAA,mBAIC,eAAe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWhC,MAAI;AACF,UAAM,EAAE,MAAM,WAAW,OAAAC,OAAM,IAAI,MAAM,OAAO,OAAO,KAAK;AAAA,MAC1D,MAAM,qBAAqBD,KAAI,UAAU;AAAA,MACzC,IAAI;AAAA,MACJ,SAAS;AAAA,MACT,MAAM;AAAA,MACN,MAAM;AAAA,IACR,CAAC;AAED,QAAIC,QAAO;AACT,cAAQ,MAAM,iBAAiBA,MAAK;AACpC,YAAM,IAAI,MAAMA,OAAM,OAAO;AAAA,IAC/B;AAEA,YAAQ,IAAI,yCAAyC,SAAS;AAAA,EAChE,SAASA,QAAO;AACd,YAAQ,MAAM,kCAAkCA,MAAK;AACrD,UAAM,IAAI,MAAM,wCAAwCA,OAAM,OAAO;AAAA,EACvE;AACF;AAtDsB;AAwDtB,eAAsB,gBAAgB,MAAM,MAAM,KAAKD,MAAK;AAC1D,QAAM,SAAS,IAAI,OAAOA,KAAI,cAAc;AAE5C,QAAM,WAAW,MAAM,KAAK,SAAS;AAAA;AAAA,2CAEI,KAAK,UAAU;AAAA,YAC9C,KAAK,IAAI,OAAK,EAAE,QAAQ,EAAE,KAAK,IAAI,CAAC;AAAA;AAAA,EAE9C,MAAM,yBAAyB,MAAM,SAAS,EAAE;AAAA;AAGhD,MAAI;AACF,UAAM,EAAE,MAAM,WAAW,OAAAC,OAAM,IAAI,MAAM,OAAO,OAAO,KAAK;AAAA,MAC1D,MAAM,qBAAqBD,KAAI,UAAU;AAAA,MACzC,IAAI,KAAK;AAAA,MACT,SAAS;AAAA,MACT,MAAM;AAAA,MACN,aAAa,KAAK,IAAI,QAAM;AAAA,QAC1B,UAAU,EAAE;AAAA,QACZ,SAAS,KAAK,OAAO,aAAa,GAAG,IAAI,WAAW,EAAE,KAAK,CAAC,CAAC;AAAA,MAC/D,EAAE;AAAA,IACJ,CAAC;AAED,QAAIC,QAAO;AACT,cAAQ,MAAM,iBAAiBA,MAAK;AACpC,YAAM,IAAI,MAAMA,OAAM,OAAO;AAAA,IAC/B;AAEA,YAAQ,IAAI,4BAA4B,SAAS;AAAA,EACnD,SAASA,QAAO;AACd,YAAQ,MAAM,qBAAqBA,MAAK;AACxC,UAAM,IAAI,MAAM,2BAA2BA,OAAM,OAAO;AAAA,EAC1D;AACF;AAjCsB;AAmCtB,eAAsB,SAAU,MAAM,MAAM,KAAKD,MAAK;AACpD,QAAM,SAAS,IAAI,OAAOA,KAAI,cAAc;AAE5C,QAAM,WAAW,MAAM,KAAK,SAAS;AAAA;AAAA,2CAEI,KAAK,UAAU;AAAA,YAC9C,KAAK,IAAI,OAAK,EAAE,QAAQ,EAAE,KAAK,IAAI,CAAC;AAAA;AAAA,EAE9C,MAAM,yBAAyB,MAAM,SAAS,EAAE;AAAA;AAGhD,MAAI;AACF,UAAM,EAAE,MAAM,WAAW,OAAAC,OAAM,IAAI,MAAM,OAAO,OAAO,KAAK;AAAA,MAC1D,MAAM,qBAAqBD,KAAI,UAAU;AAAA,MACzC,IAAI,KAAK;AAAA,MACT,SAAS;AAAA,MACT,MAAM;AAAA,MACN,aAAa,KAAK,IAAI,QAAM;AAAA,QAC1B,UAAU,EAAE;AAAA,QACZ,SAAS,KAAK,OAAO,aAAa,GAAG,IAAI,WAAW,EAAE,KAAK,CAAC,CAAC;AAAA,MAC/D,EAAE;AAAA,IACJ,CAAC;AAED,QAAIC,QAAO;AACT,cAAQ,MAAM,iBAAiBA,MAAK;AACpC,YAAM,IAAI,MAAMA,OAAM,OAAO;AAAA,IAC/B;AAEA,YAAQ,IAAI,4BAA4B,SAAS;AAAA,EACnD,SAASA,QAAO;AACd,YAAQ,MAAM,qBAAqBA,MAAK;AACxC,UAAM,IAAI,MAAM,2BAA2BA,OAAM,OAAO;AAAA,EAC1D;AACF;AAjCsB;;;ACtFtB,eAAsB,aAAa,SAASC,MAAK;AAC/C,UAAQ,IAAI,wBAAwB;AACpC,QAAM,OAAO,MAAM,QAAQ,KAAK;AAChC,UAAQ,IAAI,kBAAkB,IAAI;AAGlC,QAAM,kBAAkB,mBAAmB,IAAI;AAC/C,MAAI,iBAAiB;AACnB,WAAO,IAAI,eAAe;AAAA,EAC5B;AAGA,QAAM,QAAQ,OAAO,EAAE;AACvB,QAAM,aAAY,oBAAI,KAAK,GAAE,YAAY;AAEzC,MAAI;AACF,UAAM,eAAeA,MAAK,OAAO,MAAM,SAAS;AAChD,YAAQ,IAAI,8BAA8B;AAAA,EAC5C,SAAS,SAAS;AAChB,YAAQ,MAAM,mBAAmB,OAAO;AACxC,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,kDAAkD,GAAG,GAAG;AAAA,EAC1F;AAGA,MAAI;AACJ,MAAI;AACF,eAAW,MAAM,SAAS,MAAM,OAAOA,IAAG;AAC1C,YAAQ,IAAI,mBAAmB,SAAS,MAAM;AAAA,EAChD,SAAS,UAAU;AACjB,YAAQ,MAAM,yBAAyB,QAAQ;AAC/C,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,4BAA4B,SAAS,QAAQ,GAAG,GAAG;AAAA,EACrF;AAGA,MAAI;AACF,UAAM,cAAcA,MAAK,OAAO,QAAQ;AACxC,YAAQ,IAAI,wBAAwB;AAAA,EACtC,SAAS,UAAU;AACjB,YAAQ,MAAM,wBAAwB,QAAQ;AAAA,EAChD;AAEA,QAAM,MAAM,KAAK,WAAW,SAAS,SAAS,IAAIA,KAAI,cAAc;AAGpE,MAAIA,KAAI,aAAa,QAAQ;AAC3B,UAAM,YAAY,SAAS,IAAI,QAAM;AAAA,MACnC,UAAU,EAAE;AAAA,MACZ,KAAK,aAAa,EAAE,KAAK;AAAA,IAC3B,EAAE;AAEF,WAAO,KAAK;AAAA,MACV,IAAI;AAAA,MACJ,SAAS;AAAA,MACT;AAAA,MACA;AAAA,IACF,CAAC;AAAA,EACH;AAGA,MAAI;AACF,UAAM,SAAS,MAAM,UAAU,KAAKA,IAAG;AACvC,YAAQ,IAAI,yBAAyB;AAAA,EACvC,SAAS,YAAY;AACnB,YAAQ,MAAM,yBAAyB,UAAU;AACjD,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,2BAA2B,WAAW,QAAQ,GAAG,GAAG;AAAA,EACtF;AAEA,SAAO,KAAK;AAAA,IAAE,IAAI;AAAA,IACJ,SAAS,SAAS,IAAI,OAAK,EAAE,QAAQ;AAAA,IACrC;AAAA,EAAI,CAAC;AACrB;AAtEsB;;;ACHtB,eAAsB,oBAAoB,SAASC,MAAK;AACtD,MAAI;AACF,UAAM,OAAO,MAAM,QAAQ,KAAK;AAGhC,QAAI,CAAC,KAAK,cAAc,CAAC,KAAK,eAAe,CAAC,KAAK,aAAa,CAAC,KAAK,YAAY;AAChF,aAAO,IAAI,SAAS,KAAK,UAAU,EAAE,IAAI,OAAO,OAAO,0BAA0B,CAAC,GAAG;AAAA,QACnF,QAAQ;AAAA,QACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH;AAGA,UAAM,eAAe,OAAO,EAAE;AAC9B,UAAM,oBAAoB,OAAO,EAAE;AACnC,UAAM,aAAY,oBAAI,KAAK,GAAE,YAAY;AACzC,UAAM,YAAY,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,KAAK,GAAI,EAAE,YAAY;AAGzE,UAAMA,KAAI,QAAQ;AAAA,MAChB;AAAA;AAAA;AAAA;AAAA,IAIF,EAAE;AAAA,MACA;AAAA,MACA;AAAA,MACA,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AAAA,MACL;AAAA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,EAAE,IAAI;AAGN,UAAM,kBAAkB,GAAG,IAAI,IAAI,QAAQ,GAAG,EAAE,MAAM,WAAW,iBAAiB;AAElF,QAAIA,KAAI,aAAa,QAAQ;AAC3B,cAAQ,IAAI,kDAAkD,KAAK,UAAU;AAC7E,cAAQ,IAAI,+BAA+B,eAAe;AAE1D,aAAO,IAAI,SAAS,KAAK,UAAU;AAAA,QACjC,IAAI;AAAA,QACJ,SAAS;AAAA,QACT;AAAA,QACA;AAAA,MACF,CAAC,GAAG;AAAA,QACF,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH,OAAO;AACL,YAAM,sBAAsB,KAAK,YAAY,KAAK,WAAW,iBAAiBA,IAAG;AAEjF,aAAO,IAAI,SAAS,KAAK,UAAU;AAAA,QACjC,IAAI;AAAA,QACJ;AAAA,MACF,CAAC,GAAG;AAAA,QACF,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH;AAAA,EACF,SAASC,QAAO;AACd,YAAQ,MAAM,6BAA6BA,MAAK;AAChD,WAAO,IAAI,SAAS,KAAK,UAAU,EAAE,IAAI,OAAO,OAAOA,OAAM,QAAQ,CAAC,GAAG;AAAA,MACvE,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,IAChD,CAAC;AAAA,EACH;AACF;AArEsB;AAuEtB,eAAsB,qBAAqB,SAASD,MAAK;AACvD,MAAI;AACF,UAAM,OAAO,MAAM,QAAQ,KAAK;AAGhC,QAAI,CAAC,KAAK,gBAAgB,CAAC,KAAK,cAAc,CAAC,KAAK,YAAY,CAAC,KAAK,aAAa,CAAC,KAAK,UAAU;AACjG,aAAO,IAAI,SAAS,KAAK,UAAU,EAAE,IAAI,OAAO,OAAO,0BAA0B,CAAC,GAAG;AAAA,QACnF,QAAQ;AAAA,QACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH;AAGA,UAAM,aAAa,MAAMA,KAAI,QAAQ;AAAA,MACnC;AAAA,IACF,EAAE,KAAK,KAAK,cAAc,SAAS,EAAE,MAAM;AAE3C,QAAI,CAAC,YAAY;AACf,aAAO,IAAI,SAAS,KAAK,UAAU,EAAE,IAAI,OAAO,OAAO,gCAAgC,CAAC,GAAG;AAAA,QACzF,QAAQ;AAAA,QACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH;AAGA,UAAM,UAAU,IAAI,KAAK,WAAW,gBAAgB;AACpD,QAAI,UAAU,oBAAI,KAAK,GAAG;AACxB,aAAO,IAAI,SAAS,KAAK,UAAU,EAAE,IAAI,OAAO,OAAO,6BAA6B,CAAC,GAAG;AAAA,QACtF,QAAQ;AAAA,QACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH;AAGA,UAAM,eAAc,oBAAI,KAAK,GAAE,YAAY;AAC3C,UAAMA,KAAI,QAAQ;AAAA,MAChB;AAAA,IACF,EAAE;AAAA,MACA,KAAK,UAAU,KAAK,UAAU;AAAA,MAC9B;AAAA,MACA;AAAA,MACA,KAAK;AAAA,IACP,EAAE,IAAI;AAGN,UAAM,iBAAiB;AAAA,MACrB,YAAY,WAAW;AAAA,MACvB,aAAa,WAAW;AAAA,MACxB,WAAW,WAAW;AAAA,MACtB,YAAY,WAAW;AAAA,MACvB,YAAY,KAAK;AAAA,MACjB,UAAU,KAAK;AAAA,MACf,WAAW,KAAK;AAAA,IAClB;AAEA,UAAM,OAAO,MAAM,SAAS,gBAAgB,KAAK,cAAcA,IAAG;AAGlE,QAAI,aAAa;AACjB,QAAI,KAAK,WAAW,SAAS,SAAS,GAAG;AACvC,mBAAaA,KAAI,eAAe;AAAA,IAClC;AAGA,QAAIA,KAAI,aAAa,QAAQ;AAC3B,YAAM,YAAY,KAAK,IAAI,QAAM;AAAA,QAC/B,UAAU,EAAE;AAAA,QACZ,KAAK,aAAa,EAAE,EAAE;AAAA,MACxB,EAAE;AAEF,aAAO,IAAI,SAAS,KAAK,UAAU;AAAA,QACjC,IAAI;AAAA,QACJ,SAAS;AAAA,QACT;AAAA,QACA,KAAK;AAAA,MACP,CAAC,GAAG;AAAA,QACF,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH,OAAO;AAEL,YAAM,gBAAgB,gBAAgB,MAAM,YAAYA,IAAG;AAE3D,aAAO,IAAI,SAAS,KAAK,UAAU;AAAA,QACjC,IAAI;AAAA,QACJ,SAAS,KAAK,IAAI,OAAK,EAAE,QAAQ;AAAA,QACjC,KAAK;AAAA,MACP,CAAC,GAAG;AAAA,QACF,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH;AAAA,EACF,SAASC,QAAO;AACd,YAAQ,MAAM,8BAA8BA,MAAK;AACjD,WAAO,IAAI,SAAS,KAAK,UAAU,EAAE,IAAI,OAAO,OAAOA,OAAM,QAAQ,CAAC,GAAG;AAAA,MACvE,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,IAChD,CAAC;AAAA,EACH;AACF;AAjGsB;;;ACzEtB,eAAsB,kBAAkB,SAASC,MAAK;AACpD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,QAAY,IAAI,aAAa,IAAI,MAAM,KAAS;AACtD,QAAM,SAAY,IAAI,aAAa,IAAI,OAAO,KAAQ;AACtD,QAAM,QAAY,IAAI,aAAa,IAAI,MAAM,KAAS;AACtD,QAAM,QAAY,IAAI,aAAa,IAAI,MAAM,KAAS;AACtD,QAAM,YAAY,IAAI,aAAa,IAAI,UAAU,KAAK;AAEtD,QAAM,aAAa,CAAC;AACpB,QAAM,SAAS,CAAC;AAEhB,MAAI,OAAO;AACT,eAAW,KAAK,mBAAmB;AACnC,WAAO,KAAK,IAAI,KAAK,GAAG;AAAA,EAC1B;AAEA,MAAI,QAAQ;AACV,eAAW,KAAK,oBAAoB;AACpC,WAAO,KAAK,IAAI,MAAM,GAAG;AAAA,EAC3B;AAEA,MAAI,OAAO;AACT,eAAW,KAAK,oBAAoB;AACpC,WAAO,KAAK,IAAI,KAAK,GAAG;AAAA,EAC1B;AAEA,MAAI,OAAO;AACT,eAAW,KAAK,qBAAqB;AACrC,WAAO,KAAK,IAAI,KAAK,GAAG;AAAA,EAC1B;AAEA,MAAI,WAAW;AACb,eAAW,KAAK,mBAAmB;AACnC,WAAO,KAAK,IAAI,SAAS,GAAG;AAAA,EAC9B;AAEA,QAAM,cAAc,WAAW,SAAS,IACpC,SAAS,WAAW,KAAK,OAAO,CAAC,KACjC;AAEJ,QAAM,QAAQ;AAAA,mBACG,WAAW;AAAA;AAAA;AAI5B,QAAM,OAAO,MAAMA,KAAI,QAAQ,QAAQ,KAAK,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAElE,SAAO,KAAK,EAAE,KAAK,CAAC;AACtB;AAhDsB;;;ACAtB,eAAsB,sBAAsB,SAASC,MAAK;AACxD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,EAAE,SAAS,IAAI;AACrB,QAAM,aAAa,IAAI,aAAa,IAAI,UAAU,KAAK;AAEvD,MAAI,QAAQ,WAAW,OAAO;AAC5B,WAAO,MAAM,cAAcA,MAAK,UAAU;AAAA,EAC5C;AAEA,MAAI,QAAQ,WAAW,QAAQ;AAC7B,QAAI,aAAa,yBAAyB;AACxC,aAAO,MAAM,YAAY,SAASA,MAAK,UAAU;AAAA,IACnD;AACA,QAAI,aAAa,4BAA4B;AAC3C,aAAO,MAAM,eAAe,SAASA,MAAK,UAAU;AAAA,IACtD;AACA,QAAI,aAAa,4BAA4B;AAC3C,aAAO,MAAM,eAAe,SAASA,MAAK,UAAU;AAAA,IACtD;AACA,WAAO,MAAM,qBAAqB,SAASA,MAAK,UAAU;AAAA,EAC5D;AAEA,SAAO,IAAI,SAAS,sBAAsB,EAAE,QAAQ,IAAI,CAAC;AAC3D;AAvBsB;AAyBtB,eAAe,cAAcA,MAAK,YAAY;AAC5C,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,UAAU,EAAE,IAAI;AAEvB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,YAAY,OAAO,WAAW,CAAC,EAAE,CAAC;AACxE;AANe;AAQf,eAAe,YAAY,SAASA,MAAK,YAAY;AACnD,QAAM,OAAO,MAAM,QAAQ,KAAK;AAEhC,MAAI,CAAC,KAAK,QAAQ,CAAC,KAAK,SAAS,CAAC,KAAK,MAAM;AAC3C,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qCAAqC,GAAG,GAAG;AAAA,EAC7E;AAEA,QAAM,gBAAgB,MAAMA,KAAI,QAAQ;AAAA,IACtC;AAAA,EACF,EAAE,KAAK,YAAY,KAAK,IAAI,EAAE,MAAM;AAEpC,MAAI,eAAe;AACjB,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,yCAAyC,GAAG,GAAG;AAAA,EACjF;AAEA,QAAMA,KAAI,QAAQ;AAAA,IAChB;AAAA,EACF,EAAE,KAAK,YAAY,KAAK,MAAM,KAAK,OAAO,KAAK,OAAM,oBAAI,KAAK,GAAE,YAAY,CAAC,EAAE,IAAI;AAEnF,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,UAAU,EAAE,IAAI;AAEvB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,YAAY,OAAO,WAAW,CAAC,GAAG,OAAO,KAAK,KAAK,CAAC;AAC1F;AAxBe;AA0Bf,eAAe,eAAe,SAASA,MAAK,YAAY;AACtD,QAAM,OAAO,MAAM,QAAQ,KAAK;AAEhC,MAAI,CAAC,KAAK,MAAM;AACd,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,oBAAoB,GAAG,GAAG;AAAA,EAC5D;AAEA,QAAM,gBAAgB,MAAMA,KAAI,QAAQ;AAAA,IACtC;AAAA,EACF,EAAE,KAAK,YAAY,KAAK,IAAI,EAAE,MAAM;AAEpC,MAAI,CAAC,eAAe;AAClB,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qBAAqB,GAAG,GAAG;AAAA,EAC7D;AAEA,QAAMA,KAAI,QAAQ;AAAA,IAChB;AAAA,EACF,EAAE,KAAK,YAAY,KAAK,IAAI,EAAE,IAAI;AAElC,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,UAAU,EAAE,IAAI;AAEvB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,YAAY,OAAO,WAAW,CAAC,GAAG,SAAS,KAAK,KAAK,CAAC;AAC5F;AAxBe;AA0Bf,eAAe,eAAe,SAASA,MAAK,YAAY;AACtD,QAAM,OAAO,MAAM,QAAQ,KAAK;AAEhC,MAAI,CAAC,KAAK,MAAM;AACd,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,oBAAoB,GAAG,GAAG;AAAA,EAC5D;AAEA,QAAM,gBAAgB,MAAMA,KAAI,QAAQ;AAAA,IACtC;AAAA,EACF,EAAE,KAAK,YAAY,KAAK,IAAI,EAAE,MAAM;AAEpC,MAAI,CAAC,eAAe;AAClB,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qBAAqB,GAAG,GAAG;AAAA,EAC7D;AAEA,QAAM,UAAU,CAAC;AACjB,QAAM,WAAW,CAAC;AAElB,MAAI,KAAK,OAAO;AACd,YAAQ,KAAK,WAAW;AACxB,aAAS,KAAK,KAAK,KAAK;AAAA,EAC1B;AACA,MAAI,KAAK,MAAM;AACb,YAAQ,KAAK,UAAU;AACvB,aAAS,KAAK,KAAK,IAAI;AAAA,EACzB;AAEA,MAAI,QAAQ,SAAS,GAAG;AACtB,aAAS,KAAK,YAAY,KAAK,IAAI;AACnC,UAAMA,KAAI,QAAQ;AAAA,MAChB,yBAAyB,QAAQ,KAAK,IAAI,CAAC;AAAA,IAC7C,EAAE,KAAK,GAAG,QAAQ,EAAE,IAAI;AAAA,EAC1B;AAEA,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,UAAU,EAAE,IAAI;AAEvB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,YAAY,OAAO,WAAW,CAAC,GAAG,SAAS,KAAK,KAAK,CAAC;AAC5F;AAvCe;AAyCf,eAAe,qBAAqB,SAASA,MAAK,YAAY;AAC5D,QAAM,OAAO,MAAM,QAAQ,KAAK;AAEhC,MAAI,CAAC,MAAM,QAAQ,KAAK,UAAU,GAAG;AACnC,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,8BAA8B,GAAG,GAAG;AAAA,EACtE;AAEA,aAAW,YAAY,KAAK,YAAY;AACtC,QAAI,CAAC,SAAS,QAAQ,CAAC,SAAS,SAAS,CAAC,SAAS,MAAM;AACvD,aAAO,KAAK,EAAE,IAAI,OAAO,OAAO,gDAAgD,GAAG,GAAG;AAAA,IACxF;AAAA,EACF;AAEA,QAAMA,KAAI,QAAQ;AAAA,IAChB;AAAA,EACF,EAAE,KAAK,UAAU,EAAE,IAAI;AAEvB,QAAM,aAAY,oBAAI,KAAK,GAAE,YAAY;AACzC,aAAW,YAAY,KAAK,YAAY;AACtC,UAAMA,KAAI,QAAQ;AAAA,MAChB;AAAA,IACF,EAAE,KAAK,YAAY,SAAS,MAAM,SAAS,OAAO,SAAS,MAAM,SAAS,EAAE,IAAI;AAAA,EAClF;AAEA,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,UAAU,EAAE,IAAI;AAEvB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,YAAY,OAAO,WAAW,CAAC,EAAE,CAAC;AACxE;AA7Be;;;AC9Hf,eAAsB,iBAAiB,SAASC,MAAK;AACnD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,QAAQ,IAAI,aAAa,IAAI,OAAO;AAE1C,MAAI,QAAQ,WAAW,OAAO;AAC5B,QAAI,OAAO;AACT,aAAO,MAAM,QAAQA,MAAK,KAAK;AAAA,IACjC;AACA,WAAO,MAAM,YAAYA,IAAG;AAAA,EAC9B;AAEA,MAAI,QAAQ,WAAW,QAAQ;AAC7B,WAAO,MAAM,WAAW,SAASA,IAAG;AAAA,EACtC;AAEA,SAAO,IAAI,SAAS,sBAAsB,EAAE,QAAQ,IAAI,CAAC;AAC3D;AAhBsB;AAkBtB,eAAe,YAAYA,MAAK;AAC9B,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,IAAI;AAEN,QAAM,QAAQ,CAAC;AACf,aAAW,OAAQ,OAAO,WAAW,CAAC,GAAI;AACxC,UAAM,IAAI,KAAK,IAAI,EAAE,OAAO,IAAI,OAAO,aAAa,IAAI,YAAY;AAAA,EACtE;AAEA,SAAO,KAAK,EAAE,IAAI,MAAM,MAAM,CAAC;AACjC;AAXe;AAaf,eAAe,QAAQA,MAAK,OAAO;AACjC,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,KAAK,EAAE,MAAM;AAEpB,MAAI,CAAC,QAAQ;AACX,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,uBAAuB,GAAG,GAAG;AAAA,EAC/D;AAEA,SAAO,KAAK,EAAE,IAAI,MAAM,MAAM,EAAE,OAAO,OAAO,OAAO,aAAa,OAAO,YAAY,EAAE,CAAC;AAC1F;AAVe;AAYf,eAAe,WAAW,SAASA,MAAK;AACtC,QAAM,OAAO,MAAM,QAAQ,KAAK;AAEhC,MAAI,CAAC,KAAK,SAAS,CAAC,KAAK,aAAa;AACpC,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qCAAqC,GAAG,GAAG;AAAA,EAC7E;AAEA,MAAI,CAAC,CAAC,OAAO,UAAU,MAAM,EAAE,SAAS,KAAK,KAAK,GAAG;AACnD,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qCAAqC,GAAG,GAAG;AAAA,EAC7E;AAEA,QAAM,gBAAgB,MAAMA,KAAI,QAAQ;AAAA,IACtC;AAAA,EACF,EAAE,KAAK,KAAK,KAAK,EAAE,MAAM;AAEzB,MAAI,eAAe;AACjB,UAAMA,KAAI,QAAQ;AAAA,MAChB;AAAA,IACF,EAAE,KAAK,KAAK,aAAa,KAAK,KAAK,EAAE,IAAI;AAAA,EAC3C,OAAO;AACL,UAAMA,KAAI,QAAQ;AAAA,MAChB;AAAA,IACF,EAAE,KAAK,KAAK,OAAO,KAAK,cAAa,oBAAI,KAAK,GAAE,YAAY,CAAC,EAAE,IAAI;AAAA,EACrE;AAEA,QAAM,WAAW;AAAA,IACf,OAAO,KAAK;AAAA,IACZ,aAAa,KAAK;AAAA,EACpB;AAEA,SAAO,KAAK,EAAE,IAAI,MAAM,MAAM,SAAS,CAAC;AAC1C;AA/Be;;;AC3Cf,eAAsB,sBAAsB,SAASC,MAAK;AACxD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,EAAE,SAAS,IAAI;AAErB,MAAI,QAAQ,WAAW,OAAO;AAC5B,WAAO,MAAM,cAAcA,IAAG;AAAA,EAChC;AAEA,MAAI,QAAQ,WAAW,QAAQ;AAC7B,QAAI,aAAa,yBAAyB;AACxC,aAAO,MAAM,YAAY,SAASA,IAAG;AAAA,IACvC;AACA,QAAI,aAAa,4BAA4B;AAC3C,aAAO,MAAM,eAAe,SAASA,IAAG;AAAA,IAC1C;AAAA,EACF;AAEA,SAAO,IAAI,SAAS,sBAAsB,EAAE,QAAQ,IAAI,CAAC;AAC3D;AAlBsB;AAoBtB,eAAe,cAAcA,MAAK;AAChC,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,SAAS,EAAE,IAAI;AAEtB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,OAAO,WAAW,CAAC,EAAE,CAAC;AAC5D;AANe;AAQf,eAAe,YAAY,SAASA,MAAK;AACvC,QAAM,OAAO,MAAM,QAAQ,KAAK;AAEhC,MAAI,CAAC,KAAK,MAAM,CAAC,KAAK,MAAM;AAC1B,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,2BAA2B,GAAG,GAAG;AAAA,EACnE;AAEA,QAAM,gBAAgB,MAAMA,KAAI,QAAQ;AAAA,IACtC;AAAA,EACF,EAAE,KAAK,KAAK,EAAE,EAAE,MAAM;AAEtB,MAAI,eAAe;AACjB,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,uCAAuC,GAAG,GAAG;AAAA,EAC/E;AAEA,QAAMA,KAAI,QAAQ;AAAA,IAChB;AAAA,EACF,EAAE,KAAK,KAAK,IAAI,KAAK,OAAM,oBAAI,KAAK,GAAE,YAAY,CAAC,EAAE,IAAI;AAEzD,MAAI,KAAK,uBAAuB;AAC9B,UAAM,oBAAoB,MAAMA,KAAI,QAAQ;AAAA,MAC1C;AAAA,IACF,EAAE,KAAK,SAAS,EAAE,IAAI;AAEtB,eAAW,YAAa,kBAAkB,WAAW,CAAC,GAAI;AACxD,YAAMA,KAAI,QAAQ;AAAA,QAChB;AAAA,MACF,EAAE,KAAK,KAAK,IAAI,SAAS,MAAM,SAAS,OAAO,SAAS,OAAM,oBAAI,KAAK,GAAE,YAAY,CAAC,EAAE,IAAI;AAAA,IAC9F;AAAA,EACF;AAEA,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,SAAS,EAAE,IAAI;AAEtB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,OAAO,WAAW,CAAC,GAAG,OAAO,KAAK,GAAG,CAAC;AAC5E;AApCe;AAsCf,eAAe,eAAe,SAASA,MAAK;AAC1C,QAAM,OAAO,MAAM,QAAQ,KAAK;AAEhC,MAAI,CAAC,KAAK,IAAI;AACZ,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,kBAAkB,GAAG,GAAG;AAAA,EAC1D;AAEA,QAAM,cAAc,MAAMA,KAAI,QAAQ;AAAA,IACpC;AAAA,EACF,EAAE,KAAK,SAAS,EAAE,MAAM;AAExB,MAAI,YAAY,SAAS,GAAG;AAC1B,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,kCAAkC,GAAG,GAAG;AAAA,EAC1E;AAEA,MAAI,KAAK,OAAO,WAAW;AACzB,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,8CAA8C,GAAG,GAAG;AAAA,EACtF;AAEA,QAAM,gBAAgB,MAAMA,KAAI,QAAQ;AAAA,IACtC;AAAA,EACF,EAAE,KAAK,KAAK,EAAE,EAAE,MAAM;AAEtB,MAAI,CAAC,eAAe;AAClB,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qBAAqB,GAAG,GAAG;AAAA,EAC7D;AAEA,QAAMA,KAAI,QAAQ;AAAA,IAChB;AAAA,EACF,EAAE,KAAK,KAAK,EAAE,EAAE,IAAI;AAEpB,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,KAAK,SAAS,EAAE,IAAI;AAEtB,SAAO,KAAK,EAAE,IAAI,MAAM,YAAY,OAAO,WAAW,CAAC,GAAG,SAAS,KAAK,GAAG,CAAC;AAC9E;AApCe;;;AClEf,eAAsB,oBAAoB,SAASC,MAAK;AACtD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,eAAe,IAAI,aAAa,IAAI,YAAY;AACtD,QAAM,WAAW,IAAI,aAAa,IAAI,UAAU;AAEhD,MAAI,CAAC,gBAAgB,CAAC,UAAU;AAC9B,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,iCAAiC,GAAG,GAAG;AAAA,EACzE;AAEA,MAAI;AACF,UAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,MAC/B;AAAA,IACF,EAAE,KAAK,cAAc,QAAQ,EAAE,MAAM;AAErC,QAAI,CAAC,QAAQ;AACX,aAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qBAAqB,GAAG,GAAG;AAAA,IAC7D;AAEA,WAAO,KAAK;AAAA,MACV,IAAI;AAAA,MACJ,aAAa,OAAO;AAAA,MACpB,QAAQ,OAAO;AAAA,IACjB,CAAC;AAAA,EACH,SAASC,QAAO;AACd,WAAO,KAAK,EAAE,IAAI,OAAO,OAAOA,OAAM,QAAQ,GAAG,GAAG;AAAA,EACtD;AACF;AA1BsB;;;ACAtB,eAAeC,sBAAqB,MAAM;AACxC,QAAM,YAAY,KAAK,UAAU;AAAA,IAC/B,eAAe,KAAK;AAAA,IACpB,aAAa,KAAK;AAAA,IAClB,cAAc,KAAK;AAAA,IACnB,YAAY,KAAK;AAAA,IACjB,aAAa,KAAK;AAAA,IAClB,UAAU,KAAK;AAAA,IACf,gBAAgB,KAAK;AAAA,IACrB,UAAU,KAAK;AAAA,IACf,eAAe,KAAK;AAAA,IACpB,YAAY,KAAK;AAAA,IACjB,iBAAiB,KAAK;AAAA,IACtB,cAAc,KAAK;AAAA,EACrB,CAAC;AAED,QAAM,UAAU,IAAI,YAAY;AAChC,QAAM,aAAa,QAAQ,OAAO,SAAS;AAC3C,QAAM,aAAa,MAAM,OAAO,OAAO,OAAO,WAAW,UAAU;AACnE,QAAM,YAAY,MAAM,KAAK,IAAI,WAAW,UAAU,CAAC;AACvD,QAAM,UAAU,UAAU,IAAI,OAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AAE3E,SAAO;AACT;AAvBe,OAAAA,uBAAA;AAyBf,eAAsB,kBAAkB,SAASC,MAAK;AACpD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,aAAa,IAAI,aAAa,IAAI,UAAU;AAElD,MAAI,CAAC,YAAY;AACf,WAAO,KAAK,EAAE,IAAI,OAAO,OAAO,sBAAsB,GAAG,GAAG;AAAA,EAC9D;AAEA,MAAI;AAEF,UAAM,aAAa,MAAMA,KAAI,QAAQ;AAAA,MACnC;AAAA,IACF,EAAE,KAAK,UAAU,EAAE,MAAM;AAEzB,QAAI,CAAC,YAAY;AACf,aAAO,KAAK,EAAE,IAAI,OAAO,OAAO,iBAAiB,GAAG,GAAG;AAAA,IACzD;AAGA,UAAM,UAAU,MAAMA,KAAI,QAAQ,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAazC,EAAE,KAAK,UAAU,EAAE,MAAM;AAE1B,QAAI,CAAC,SAAS;AACZ,aAAO,KAAK,EAAE,IAAI,OAAO,OAAO,qBAAqB,GAAG,GAAG;AAAA,IAC7D;AAGA,UAAM,iBAAiB,MAAMA,KAAI,QAAQ;AAAA,MACvC;AAAA,IACF,EAAE,KAAK,QAAQ,aAAa,QAAQ,QAAQ,EAAE,MAAM;AACpD,UAAM,eAAe,iBAAiB,EAAE,OAAO,eAAe,MAAM,IAAI;AAGxE,UAAM,YAAY,QAAQ,WAAW,KAAK,EAAE,MAAM,KAAK;AACvD,UAAM,YAAY,UAAU,CAAC,GAAG,YAAY,EAAE,QAAQ,WAAW,EAAE,KAAK;AACxE,UAAM,WAAW,UAAU,SAAS,IAChC,UAAU,UAAU,SAAS,CAAC,EAAE,YAAY,EAAE,QAAQ,WAAW,EAAE,IACnE;AAEJ,UAAM,cAAc,IAAI,KAAK,QAAQ,UAAU;AAC/C,UAAM,IAAI,YAAY,eAAe;AACrC,UAAM,IAAI,OAAO,YAAY,YAAY,IAAI,CAAC,EAAE,SAAS,GAAG,GAAG;AAC/D,UAAM,IAAI,OAAO,YAAY,WAAW,CAAC,EAAE,SAAS,GAAG,GAAG;AAE1D,UAAM,eAAe,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,QAAQ,WAAW,eAAe,QAAQ,IAAI,SAAS,IAAI,QAAQ,aAAa;AAG/H,UAAMC,WAAU,MAAMD,KAAI,QAAQ;AAAA,MAChC;AAAA,IACF,EAAE,KAAK,QAAQ,WAAW,MAAM,GAAG,EAAE,CAAC,CAAC,EAAE,MAAM;AAE/C,QAAI,CAACC,UAAS;AACZ,aAAO,KAAK,EAAE,IAAI,OAAO,OAAO,8CAA8C,GAAG,GAAG;AAAA,IACtF;AAEA,UAAM,WAAW;AAAA,MACf,eAAe,QAAQ;AAAA,MACvB,aAAa,QAAQ;AAAA,MACrB,cAAc,QAAQ;AAAA,MACtB,YAAY,QAAQ;AAAA,MACpB,aAAa,QAAQ;AAAA,MACrB,UAAU,QAAQ;AAAA,MAClB,gBAAgB,cAAc,SAAS,QAAQ;AAAA,MAC/C,UAAU,QAAQ,YAAY;AAAA,MAC9B,eAAe;AAAA,MACf,YAAY,QAAQ;AAAA,MACpB,iBAAiBA,SAAQ;AAAA,MACzB,cAAcA,SAAQ;AAAA,IACxB;AAEA,UAAM,eAAe,MAAMF,sBAAqB,QAAQ;AACxD,UAAM,WAAW,iBAAiB,WAAW;AAE7C,WAAO,KAAK;AAAA,MACV,IAAI;AAAA,MACJ;AAAA,MACA,aAAa,WAAW;AAAA,MACxB,eAAe;AAAA,IACjB,CAAC;AAAA,EACH,SAASG,QAAO;AACd,WAAO,KAAK,EAAE,IAAI,OAAO,OAAOA,OAAM,QAAQ,GAAG,GAAG;AAAA,EACtD;AACF;AA9FsB;;;ACzBtB,eAAe,iBAAiBC,MAAK;AACnC,SAAO,MAAMA,KAAI,QAAQ;AAAA,IACvB;AAAA,EACF,EAAE,MAAM;AACV;AAJe;AAMf,eAAe,eAAeA,MAAK;AACjC,QAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,IAC/B;AAAA,EACF,EAAE,IAAI;AACN,SAAO,OAAO,WAAW,CAAC;AAC5B;AALe;AAOf,SAAS,iBAAiBC,UAAS;AACjC,MAAI,CAACA,SAAS,QAAO;AAErB,QAAM,QAAQA,SAAQ,MAAM,GAAG;AAC/B,MAAI,MAAM,WAAW,EAAG,QAAO;AAE/B,QAAM,CAAC,OAAO,OAAO,KAAK,IAAI,MAAM,IAAI,MAAM;AAC9C,SAAO,GAAG,KAAK,IAAI,KAAK,IAAI,QAAQ,CAAC;AACvC;AARS;AAUT,eAAsB,oBAAoB,SAASD,MAAK;AACtD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,WAAW,IAAI;AAGrB,MAAI,QAAQ,WAAW,SAAS,aAAa,mBAAmB;AAC9D,QAAI;AACF,YAAM,UAAU,MAAM,iBAAiBA,IAAG;AAC1C,YAAM,WAAW,MAAM,eAAeA,IAAG;AAEzC,aAAO,KAAK;AAAA,QACV,IAAI;AAAA,QACJ;AAAA,QACA;AAAA,MACF,CAAC;AAAA,IACH,SAASE,QAAO;AACd,aAAO,KAAK,EAAE,IAAI,OAAO,OAAOA,OAAM,QAAQ,GAAG,GAAG;AAAA,IACtD;AAAA,EACF;AAGA,MAAI,QAAQ,WAAW,UAAU,aAAa,0BAA0B;AACtE,QAAI;AACF,YAAM,OAAO,MAAM,QAAQ,KAAK;AAChC,YAAM,EAAE,SAAAD,UAAS,YAAY,IAAI;AAEjC,UAAI,CAAC,eAAe,CAAC,YAAY,KAAK,GAAG;AACvC,eAAO,KAAK,EAAE,IAAI,OAAO,OAAO,0BAA0B,GAAG,GAAG;AAAA,MAClE;AAEA,UAAI,eAAeA;AAGnB,UAAI,CAAC,cAAc;AACjB,cAAM,SAAS,MAAM,iBAAiBD,IAAG;AACzC,uBAAe,iBAAiB,QAAQ,OAAO;AAAA,MACjD;AAGA,UAAI,CAAC,2BAA2B,KAAK,YAAY,GAAG;AAClD,eAAO,KAAK,EAAE,IAAI,OAAO,OAAO,sDAAsD,GAAG,GAAG;AAAA,MAC9F;AAGA,YAAM,WAAW,MAAMA,KAAI,QAAQ;AAAA,QACjC;AAAA,MACF,EAAE,KAAK,YAAY,EAAE,MAAM;AAE3B,UAAI,UAAU;AACZ,eAAO,KAAK,EAAE,IAAI,OAAO,OAAO,WAAW,YAAY,kBAAkB,GAAG,GAAG;AAAA,MACjF;AAGA,YAAM,MAAM,oBAAI,KAAK;AACrB,YAAM,cAAc,IAAI,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAClD,YAAM,YAAY,IAAI,YAAY;AAElC,YAAMA,KAAI,QAAQ;AAAA,QAChB;AAAA,MACF,EAAE,KAAK,cAAc,aAAa,YAAY,KAAK,GAAG,SAAS,EAAE,IAAI;AAErE,aAAO,KAAK;AAAA,QACV,IAAI;AAAA,QACJ,SAAS;AAAA,QACT,cAAc;AAAA,MAChB,CAAC;AAAA,IACH,SAASE,QAAO;AACd,aAAO,KAAK,EAAE,IAAI,OAAO,OAAOA,OAAM,QAAQ,GAAG,GAAG;AAAA,IACtD;AAAA,EACF;AAEA,SAAO,KAAK,EAAE,IAAI,OAAO,OAAO,YAAY,GAAG,GAAG;AACpD;AAxEsB;;;ACzBtB,eAAsB,uBAAuB,SAASC,MAAK;AACzD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,eAAe,IAAI,aAAa,IAAI,YAAY;AAEtD,MAAI,CAAC,cAAc;AACjB,WAAO,IAAI,SAAS,yBAAyB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9D;AAEA,MAAI;AAEF,UAAM,YAAY,MAAMA,KAAI,QAAQ;AAAA,MAClC;AAAA,IACF,EAAE,KAAK,YAAY,EAAE,IAAI;AAEzB,QAAI,CAAC,UAAU,WAAW,UAAU,QAAQ,WAAW,GAAG;AACxD,aAAO,IAAI,SAAS,sBAAsB,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC3D;AAGA,UAAM,aAAa,MAAMA,KAAI,QAAQ;AAAA,MACnC;AAAA,IACF,EAAE,KAAK,YAAY,EAAE,MAAM;AAI3B,UAAM,EAAE,SAAS,QAAQ,IAAI,MAAM,OAAO,QAAQ;AAElD,UAAM,QAAQ,CAAC;AAGf,eAAW,OAAO,UAAU,SAAS;AACnC,YAAM,MAAM,MAAMA,KAAI,WAAW,IAAI,IAAI,MAAM;AAC/C,UAAI,KAAK;AACP,cAAM,cAAc,MAAM,IAAI,YAAY;AAC1C,cAAM,aAAa,IAAI,WAAW,WAAW;AAC7C,cAAM,GAAG,IAAI,QAAQ,aAAa,IAAI;AAAA,MACxC;AAAA,IACF;AAGA,UAAM,SAAS,QAAQ,OAAO,EAAE,OAAO,EAAE,CAAC;AAG1C,UAAM,YAAY,WAAW,WAAW,QAAQ,iBAAiB,GAAG;AACpE,UAAM,WAAW,GAAG,SAAS,IAAI,WAAW,YAAY;AAExD,WAAO,IAAI,SAAS,QAAQ;AAAA,MAC1B,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,uBAAuB,yBAAyB,QAAQ;AAAA,MAC1D;AAAA,IACF,CAAC;AAAA,EACH,SAASC,QAAO;AACd,YAAQ,MAAM,uBAAuBA,MAAK;AAC1C,WAAO,IAAI,SAAS,8BAA8BA,OAAM,SAAS,EAAE,QAAQ,IAAI,CAAC;AAAA,EAClF;AACF;AAxDsB;;;ACGtB,IAAM,iBAAiB,IAAI,KAAK,KAAK,KAAK;AAE1C,eAAsB,iBAAiB,SAASC,MAAK;AACnD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,eAAe,IAAI,aAAa,IAAI,SAAS,MAAM;AAEzD,MAAI;AAEF,UAAM,YAAY;AAAA,MAChB,WAAW,KAAK,IAAI;AAAA,MACpB,IAAI,CAAC;AAAA,IACP;AAGA,UAAM,SAAS,MAAMA,KAAI,QAAQ;AAAA,MAC/B;AAAA,IACF,EAAE,IAAI;AAEN,eAAWC,UAAS,OAAO,SAAS;AAClC,YAAM,YAAYA,OAAM;AAGxB,YAAM,cAAc,MAAMD,KAAI,QAAQ;AAAA,QACpC,iCAAiC,SAAS;AAAA,MAC5C,EAAE,MAAM;AAGR,YAAM,aAAa,MAAMA,KAAI,QAAQ;AAAA,QACnC,iBAAiB,SAAS;AAAA,MAC5B,EAAE,IAAI;AAEN,gBAAU,GAAG,SAAS,IAAI;AAAA,QACxB,OAAO,YAAY;AAAA,QACnB,MAAM,WAAW,WAAW,CAAC;AAAA,MAC/B;AAAA,IACF;AAEA,WAAO,KAAK;AAAA,MACV,IAAI;AAAA,MACJ,YAAY,IAAI,KAAK,UAAU,SAAS,EAAE,YAAY;AAAA,MACtD,IAAI,UAAU;AAAA,IAChB,CAAC;AAAA,EAEH,SAASE,QAAO;AACd,YAAQ,MAAM,qBAAqBA,MAAK;AACxC,WAAO,KAAK,EAAE,IAAI,OAAO,OAAOA,OAAM,QAAQ,GAAG,GAAG;AAAA,EACtD;AACF;AA7CsB;;;ACJtB,SAAS,YAAY;AAErB,eAAsB,qBAAqB;AACzC,MAAI;AAGF,UAAM,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA8PhB,WAAO,IAAI,SAAS,SAAS;AAAA,MAC3B,SAAS;AAAA,QACP,gBAAgB;AAAA,MAClB;AAAA,IACF,CAAC;AAAA,EACH,SAASC,QAAO;AACd,WAAO,IAAI,SAAS,mCAAmC,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxE;AACF;AA1QsB;;;ACDtB,eAAsB,aAAaC,MAAK;AACtC,MAAI;AACF,UAAM,OAAO,MAAMA,KAAI,QAAQ,QAAQ,UAAU,EAAE,MAAM;AACzD,WAAO,KAAK,EAAE,IAAI,MAAM,IAAI,CAAC,CAAC,MAAM,IAAI,KAAK,IAAI,EAAE,CAAC;AAAA,EACtD,SAASC,QAAO;AACd,WAAO,KAAK,EAAE,IAAI,OAAO,OAAOA,OAAM,SAAS,IAAI,KAAK,IAAI,EAAE,CAAC;AAAA,EACjE;AACF;AAPsB;;;ACFtB,eAAsB,eAAe,SAASC,MAAK;AACjD,QAAM,EAAE,SAAS,IAAI,IAAI,IAAI,QAAQ,GAAG;AACxC,QAAM,QAAQ,SAAS,QAAQ,cAAc,EAAE;AAE/C,MAAIA,KAAI,aAAa,QAAQ;AAC3B,WAAO,IAAI,SAAS,wCAAwC,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC7E;AAEA,QAAM,SAAS,MAAMA,KAAI,WAAW,IAAI,KAAK;AAE7C,MAAI,CAAC,QAAQ;AACX,WAAO,IAAI,SAAS,iBAAiB,EAAE,QAAQ,IAAI,CAAC;AAAA,EACtD;AAEA,QAAM,WAAW,MAAM,MAAM,GAAG,EAAE,IAAI;AAEtC,SAAO,IAAI,SAAS,OAAO,MAAM;AAAA,IAC/B,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,uBAAuB,yBAAyB,QAAQ;AAAA,MACxD,iBAAiB;AAAA,IACnB;AAAA,EACF,CAAC;AACH;AAvBsB;;;ACiBtB,IAAO,cAAQ;AAAA,EACb,MAAM,MAAM,SAASC,MAAK,KAAK;AAC7B,UAAM,EAAE,SAAS,IAAI,IAAI,IAAI,QAAQ,GAAG;AAExC,QAAI;AACF,UAAI,QAAQ,WAAW,SAAU,aAAa,IAA0B,QAAO,MAAM,WAAW,SAASA,IAAG;AAC5G,UAAI,QAAQ,WAAW,UAAU,aAAa,UAA0B,QAAO,MAAM,aAAa,SAASA,IAAG;AAC9G,UAAI,QAAQ,WAAW,UAAU,aAAa,kBAA0B,QAAO,MAAM,oBAAoB,SAASA,IAAG;AACrH,UAAI,QAAQ,WAAW,UAAU,aAAa,mBAA0B,QAAO,MAAM,qBAAqB,SAASA,IAAG;AACtH,UAAI,QAAQ,WAAW,SAAU,aAAa,gBAA0B,QAAO,MAAM,kBAAkB,SAASA,IAAG;AACnH,UAAI,QAAQ,WAAW,SAAU,aAAa,UAA0B,QAAO,MAAM,aAAaA,IAAG;AAErG,UAAI,QAAQ,WAAW,SAAU,aAAa,SAA0B,QAAO,MAAM,YAAY;AACpG,UAAI,QAAQ,WAAW,SAAU,aAAa,kBAA0B,QAAO,MAAM,oBAAoB,SAASA,IAAG;AAClH,UAAI,QAAQ,WAAW,SAAU,aAAa,gBAA0B,QAAO,MAAM,kBAAkB,SAASA,IAAG;AACnH,UAAI,QAAQ,WAAW,SAAU,aAAa,sBAA0B,QAAO,MAAM,uBAAuB,SAASA,IAAG;AACxH,UAAI,QAAQ,WAAW,SAAU,aAAa,eAA0B,QAAO,MAAM,iBAAiB,SAASA,IAAG;AAClH,UAAI,QAAQ,WAAW,SAAU,aAAa,kBAA0B,QAAO,MAAM,mBAAmB;AACxG,WAAK,QAAQ,WAAW,SAAS,QAAQ,WAAW,WAAW,SAAS,WAAW,iBAAiB,EAAG,QAAO,MAAM,oBAAoB,SAASA,IAAG;AACpJ,WAAK,QAAQ,WAAW,SAAS,QAAQ,WAAW,WAAW,SAAS,WAAW,mBAAmB,EAAI,QAAO,MAAM,sBAAsB,SAASA,IAAG;AACzJ,WAAK,QAAQ,WAAW,SAAS,QAAQ,WAAW,WAAW,SAAS,WAAW,mBAAmB,EAAG,QAAO,MAAM,sBAAsB,SAASA,IAAG;AACxJ,WAAK,QAAQ,WAAW,SAAS,QAAQ,WAAW,WAAW,aAAa,eAAmB,QAAO,MAAM,iBAAiB,SAASA,IAAG;AACzI,UAAI,QAAQ,WAAW,SAAU,SAAS,WAAW,YAAY,EAAO,QAAO,MAAM,eAAe,SAASA,IAAG;AAEhH,aAAO,IAAI,SAAS,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,IAClD,SAAS,KAAK;AACZ,cAAQ,MAAM,GAAG;AACjB,aAAO,IAAI,SAAS,gBAAgB,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AAAA,EACF;AACF;;;AC7CA,IAAM,YAAwB,8BAAO,SAASC,MAAK,MAAM,kBAAkB;AAC1E,MAAI;AACH,WAAO,MAAM,cAAc,KAAK,SAASA,IAAG;AAAA,EAC7C,UAAE;AACD,QAAI;AACH,UAAI,QAAQ,SAAS,QAAQ,CAAC,QAAQ,UAAU;AAC/C,cAAM,SAAS,QAAQ,KAAK,UAAU;AACtC,eAAO,EAAE,MAAM,OAAO,KAAK,GAAG,MAAM;AAAA,QAAC;AAAA,MACtC;AAAA,IACD,SAAS,GAAG;AACX,cAAQ,MAAM,4CAA4C,CAAC;AAAA,IAC5D;AAAA,EACD;AACD,GAb8B;AAe9B,IAAO,6CAAQ;;;ACRf,SAAS,YAAY,GAAmB;AACvC,SAAO;AAAA,IACN,MAAM,GAAG;AAAA,IACT,SAAS,GAAG,WAAW,OAAO,CAAC;AAAA,IAC/B,OAAO,GAAG;AAAA,IACV,OAAO,GAAG,UAAU,SAAY,SAAY,YAAY,EAAE,KAAK;AAAA,EAChE;AACD;AAPS;AAUT,IAAM,YAAwB,8BAAO,SAASC,MAAK,MAAM,kBAAkB;AAC1E,MAAI;AACH,WAAO,MAAM,cAAc,KAAK,SAASA,IAAG;AAAA,EAC7C,SAAS,GAAQ;AAChB,UAAMC,SAAQ,YAAY,CAAC;AAC3B,WAAO,SAAS,KAAKA,QAAO;AAAA,MAC3B,QAAQ;AAAA,MACR,SAAS,EAAE,+BAA+B,OAAO;AAAA,IAClD,CAAC;AAAA,EACF;AACD,GAV8B;AAY9B,IAAO,2CAAQ;;;ACzBJ,IAAM,mCAAmC;AAAA,EAE9B;AAAA,EAAyB;AAC3C;AACA,IAAO,sCAAQ;;;ACcnB,IAAM,wBAAsC,CAAC;AAKtC,SAAS,uBAAuB,MAAqC;AAC3E,wBAAsB,KAAK,GAAG,KAAK,KAAK,CAAC;AAC1C;AAFgB;AAShB,SAAS,uBACR,SACAC,MACA,KACA,UACA,iBACsB;AACtB,QAAM,CAAC,MAAM,GAAG,IAAI,IAAI;AACxB,QAAM,gBAAmC;AAAA,IACxC;AAAA,IACA,KAAK,YAAY,QAAQ;AACxB,aAAO,uBAAuB,YAAY,QAAQ,KAAK,UAAU,IAAI;AAAA,IACtE;AAAA,EACD;AACA,SAAO,KAAK,SAASA,MAAK,KAAK,aAAa;AAC7C;AAfS;AAiBF,SAAS,kBACf,SACAA,MACA,KACA,UACA,iBACsB;AACtB,SAAO,uBAAuB,SAASA,MAAK,KAAK,UAAU;AAAA,IAC1D,GAAG;AAAA,IACH;AAAA,EACD,CAAC;AACF;AAXgB;;;AC3ChB,IAAM,iCAAN,MAAM,gCAA8D;AAAA,EAGnE,YACU,eACA,MACT,SACC;AAHQ;AACA;AAGT,SAAK,WAAW;AAAA,EACjB;AAAA,EArBD,OAYoE;AAAA;AAAA;AAAA,EAC1D;AAAA,EAUT,UAAU;AACT,QAAI,EAAE,gBAAgB,kCAAiC;AACtD,YAAM,IAAI,UAAU,oBAAoB;AAAA,IACzC;AAEA,SAAK,SAAS;AAAA,EACf;AACD;AAEA,SAAS,oBAAoB,QAA0C;AAEtE,MACC,qCAAqC,UACrC,iCAAiC,WAAW,GAC3C;AACD,WAAO;AAAA,EACR;AAEA,aAAW,cAAc,kCAAkC;AAC1D,wBAAoB,UAAU;AAAA,EAC/B;AAEA,QAAM,kBAA+C,gCACpD,SACAC,MACA,KACC;AACD,QAAI,OAAO,UAAU,QAAW;AAC/B,YAAM,IAAI,MAAM,6CAA6C;AAAA,IAC9D;AACA,WAAO,OAAO,MAAM,SAASA,MAAK,GAAG;AAAA,EACtC,GATqD;AAWrD,SAAO;AAAA,IACN,GAAG;AAAA,IACH,MAAM,SAASA,MAAK,KAAK;AACxB,YAAM,aAAyB,gCAAU,MAAM,MAAM;AACpD,YAAI,SAAS,eAAe,OAAO,cAAc,QAAW;AAC3D,gBAAM,aAAa,IAAI;AAAA,YACtB,KAAK,IAAI;AAAA,YACT,KAAK,QAAQ;AAAA,YACb,MAAM;AAAA,YAAC;AAAA,UACR;AACA,iBAAO,OAAO,UAAU,YAAYA,MAAK,GAAG;AAAA,QAC7C;AAAA,MACD,GAT+B;AAU/B,aAAO,kBAAkB,SAASA,MAAK,KAAK,YAAY,eAAe;AAAA,IACxE;AAAA,EACD;AACD;AAxCS;AA0CT,SAAS,qBACR,OAC8B;AAE9B,MACC,qCAAqC,UACrC,iCAAiC,WAAW,GAC3C;AACD,WAAO;AAAA,EACR;AAEA,aAAW,cAAc,kCAAkC;AAC1D,wBAAoB,UAAU;AAAA,EAC/B;AAGA,SAAO,cAAc,MAAM;AAAA,IAC1B,mBAAyE,wBACxE,SACAA,MACA,QACI;AACJ,WAAK,MAAMA;AACX,WAAK,MAAM;AACX,UAAI,MAAM,UAAU,QAAW;AAC9B,cAAM,IAAI,MAAM,sDAAsD;AAAA,MACvE;AACA,aAAO,MAAM,MAAM,OAAO;AAAA,IAC3B,GAXyE;AAAA,IAazE,cAA0B,wBAAC,MAAM,SAAS;AACzC,UAAI,SAAS,eAAe,MAAM,cAAc,QAAW;AAC1D,cAAM,aAAa,IAAI;AAAA,UACtB,KAAK,IAAI;AAAA,UACT,KAAK,QAAQ;AAAA,UACb,MAAM;AAAA,UAAC;AAAA,QACR;AACA,eAAO,MAAM,UAAU,UAAU;AAAA,MAClC;AAAA,IACD,GAT0B;AAAA,IAW1B,MAAM,SAAwD;AAC7D,aAAO;AAAA,QACN;AAAA,QACA,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,MACN;AAAA,IACD;AAAA,EACD;AACD;AAnDS;AAqDT,IAAI;AACJ,IAAI,OAAO,wCAAU,UAAU;AAC9B,kBAAgB,oBAAoB,mCAAK;AAC1C,WAAW,OAAO,wCAAU,YAAY;AACvC,kBAAgB,qBAAqB,mCAAK;AAC3C;AACA,IAAO,kCAAQ;",
  "names": ["PerformanceMark", "clear", "count", "countReset", "createTask", "debug", "dir", "dirxml", "error", "group", "groupCollapsed", "groupEnd", "info", "log", "profile", "profileEnd", "table", "time", "timeEnd", "timeLog", "timeStamp", "trace", "warn", "hrtime", "dir", "env", "count", "cwd", "hrtime", "assert", "env", "env", "env", "env", "__defProp", "version", "domain", "error", "env", "error", "env", "env", "error", "env", "env", "env", "env", "env", "error", "generateDocumentHash", "env", "release", "error", "env", "version", "error", "env", "error", "env", "table", "error", "error", "env", "error", "env", "env", "env", "env", "error", "env", "env"]
}
</file>

<file path=".wrangler/tmp/dev-qGIfSE/index.js">
var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// .wrangler/tmp/bundle-sW1d5E/checked-fetch.js
var urls = /* @__PURE__ */ new Set();
function checkURL(request, init) {
  const url = request instanceof URL ? request : new URL(
    (typeof request === "string" ? new Request(request, init) : request).url
  );
  if (url.port && url.port !== "443" && url.protocol === "https:") {
    if (!urls.has(url.toString())) {
      urls.add(url.toString());
      console.warn(
        `WARNING: known issue with \`fetch()\` requests to custom HTTPS ports in published Workers:
 - ${url.toString()} - the custom port will be ignored when the Worker is published using the \`wrangler deploy\` command.
`
      );
    }
  }
}
__name(checkURL, "checkURL");
globalThis.fetch = new Proxy(globalThis.fetch, {
  apply(target, thisArg, argArray) {
    const [request, init] = argArray;
    checkURL(request, init);
    return Reflect.apply(target, thisArg, argArray);
  }
});

// node_modules/nanoid/url-alphabet/index.js
var urlAlphabet = "useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";

// node_modules/nanoid/index.browser.js
var nanoid = /* @__PURE__ */ __name((size = 21) => {
  let id = "";
  let bytes = crypto.getRandomValues(new Uint8Array(size |= 0));
  while (size--) {
    id += urlAlphabet[bytes[size] & 63];
  }
  return id;
}, "nanoid");

// src/spa.js
async function htmlPage(env) {
  const propsJSON = await env.PROPS_KV.get("props", "text") || "[]";
  const props64 = btoa(unescape(encodeURIComponent(propsJSON)));
  return new Response(`
<!doctype html>
<html lang="en"><meta charset="utf-8">
<title>Activity Waiver</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui;margin:2rem auto;max-width:640px;padding:0 1rem}
  label{display:block;margin:.4rem 0}
  canvas{border:1px solid #999;width:100%;touch-action:none}
  .activities-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:10px;background:#f5f5f5;border-radius:8px}
  .activity-item{display:flex;align-items:center;padding:8px;background:white;border-radius:4px;border:1px solid #ddd;cursor:pointer;transition:all 0.2s}
  .activity-item:hover{background:#f0f7ff;border-color:#0070f3}
  .activity-item input[type="checkbox"]{margin-right:8px;cursor:pointer;width:18px;height:18px}
  .activity-item label{margin:0;cursor:pointer;flex:1}
  .activity-item input[type="text"]{margin-left:auto;width:50px;text-align:center;padding:4px;border:1px solid #ccc;border-radius:4px}
  @media (max-width:480px){.activities-grid{grid-template-columns:1fr}}
</style>

<body>
  <h1>Sign your waiver</h1>
  <form id="form">
    <label>Property
      <select id="prop"></select>
    </label>

    <label>Check-in
      <input type="date" id="date" required>
    </label>

    <label>Name
      <input id="name" required>
    </label>

    <label>E-mail
      <input id="email" type="email" required>
    </label>

    <h3>Activities</h3>
    <div id="activities" class="activities-grid"></div>

    <label>
      <input id="master" type="checkbox" required>
      I have read and accept all risks.
    </label>

    <h3>Signature</h3>
    <canvas id="sign" width="600" height="200"></canvas><br>
    <button id="clearSig" type="button">Clear</button><br><br>

    <button id="submit">Submit</button>
  </form>

  <div id="thanks" hidden></div>

<script type="module">
  /* ---------- bootstrap property list -------------------- */
  let props = JSON.parse(atob('${props64}'));
  console.log("Raw props data:", props);

  // Handle both array and single object formats
  if (!Array.isArray(props)) {
    props = [props];
  }
  console.log("Props after array check:", props);

  const propSel = document.getElementById('prop');
  props.forEach(p => propSel.add(new Option(p.name, p.id)));

  /* ---------- activity checkboxes ------------------------- */
  const actsDiv      = document.getElementById('activities');
  const masterCheck  = document.getElementById('master');
  const chosen       = new Map(); // slug -> {itemDiv, initialInput}

  const activities = props[0]?.activities ?? [];   // assumes all props share list
  console.log("Activities array:", activities);
  console.log("Activities container:", actsDiv);
  activities.forEach(a => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'activity-item';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = 'activity-' + a.slug;
    checkbox.value = a.slug;

    const label = document.createElement('label');
    label.htmlFor = 'activity-' + a.slug;
    label.textContent = a.label;

    const initialInput = document.createElement('input');
    initialInput.type = 'text';
    initialInput.maxLength = 4;
    initialInput.placeholder = 'Init';
    initialInput.style.display = 'none';
    initialInput.dataset.slug = a.slug;
    initialInput.oninput = validateMasterCheckbox;

    checkbox.onchange = () => {
      if (checkbox.checked) {
        chosen.set(a.slug, {itemDiv, initialInput});
        initialInput.style.display = 'block';
      } else {
        chosen.delete(a.slug);
        initialInput.style.display = 'none';
        initialInput.value = '';
      }
      validateMasterCheckbox();
    };

    itemDiv.appendChild(checkbox);
    itemDiv.appendChild(label);
    itemDiv.appendChild(initialInput);

    // Make entire div clickable except initial input
    itemDiv.onclick = (e) => {
      if (e.target !== initialInput) {
        checkbox.checked = !checkbox.checked;
        checkbox.onchange();
      }
    };

    actsDiv.appendChild(itemDiv);
  });

  function validateMasterCheckbox() {
    let allFilled = true;
    for (const [slug, {initialInput}] of chosen) {
      if (!initialInput.value.trim()) {
        allFilled = false;
        break;
      }
    }
    masterCheck.disabled = !allFilled || chosen.size === 0;
    if (masterCheck.disabled) {
      masterCheck.checked = false;
    }
  }

  validateMasterCheckbox();

  /* ---------- signature pad -------------------------------- */
  const canvas = document.getElementById('sign');
  const ctx    = canvas.getContext('2d', { willReadFrequently: true });
  let drawing  = false;

  canvas.addEventListener('pointerdown', e => {
    drawing = true;
    ctx.moveTo(e.offsetX, e.offsetY);
  });
  canvas.addEventListener('pointermove', e => {
    if (!drawing) return;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });
  canvas.addEventListener('pointerup', () => drawing = false);
  document.getElementById('clearSig').onclick =
    () => ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* ---------- submit --------------------------------------- */
  document.getElementById('form').onsubmit = async e => {
    e.preventDefault();

    const data = {
      propertyId  : propSel.value,
      checkinDate : document.getElementById('date').value,
      guestName   : document.getElementById('name').value,
      guestEmail  : document.getElementById('email').value,
      activities  : [...chosen.keys()],
      initials    : Object.fromEntries(
                      [...chosen.entries()].map(([slug, {initialInput}]) =>
                        [slug, initialInput.value])),
      signature   : canvas.toDataURL(),
      accepted    : document.getElementById('master').checked
    };

    console.log("Submitting data:", data);

    try {
      const res  = await fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      console.log("Response status:", res.status);

      if (!res.ok) {
        const errorText = await res.text();
        console.error("Server error:", errorText);
        alert("Error submitting form: " + errorText);
        return;
      }

      const json = await res.json();
      console.log("Response data:", json);

    document.getElementById('form').hidden   = true;
    document.getElementById('thanks').hidden = false;

    if (json.devMode) {
      // Development mode - show download links
      let html = '<h2>Waivers Generated \u2714</h2>';
      html += '<p>Download your waivers:</p>';
      html += '<div style="display:flex;flex-direction:column;gap:10px;margin:20px 0">';

      // Create download buttons for each PDF
      json.downloads.forEach(pdf => {
        html += \`<button onclick="window.open('\${pdf.url}', '_blank')" \`;
        html += 'style="padding:10px 20px;background:#0070f3;color:#fff;border:none;';
        html += 'border-radius:6px;cursor:pointer;font-size:16px">';
        html += '\u{1F4C4} Download ' + pdf.filename + '</button>';
      });

      html += '</div>';

      // Add button to download all at once
      if (json.downloads.length > 1) {
        html += '<button onclick="';
        json.downloads.forEach(pdf => {
          html += \`window.open('\${pdf.url}', '_blank');\`;
        });
        html += '" style="padding:12px 24px;background:#28a745;color:#fff;border:none;';
        html += 'border-radius:6px;cursor:pointer;font-size:16px;margin-top:10px">';
        html += '\u{1F4E6} Download All (' + json.downloads.length + ' PDFs)</button>';
      }

      if (json.pin) {
        html += '<p style="margin-top:20px">Your Archery PIN is <b>' + json.pin + '</b></p>';
      }

      html += '<p style="margin-top:20px;color:#666;font-size:14px">';
      html += '\u26A0\uFE0F Development Mode - PDFs are stored but not emailed</p>';

      document.getElementById('thanks').innerHTML = html;
    } else {
      // Production mode - email confirmation
      document.getElementById('thanks').innerHTML =
        '<h2>Email sent \u2714</h2><p>Attachments:<br>' +
        json.emailed.join('<br>') + '</p>' +
        (json.pin ? '<p>Your Archery PIN is <b>' + json.pin + '</b></p>' : '');
    }
    } catch (error) {
      console.error("Form submission error:", error);
      alert("Error submitting form: " + error.message);
    }
  };
<\/script>
</body>
</html>`, {
    headers: { "content-type": "text/html; charset=utf-8" }
  });
}
__name(htmlPage, "htmlPage");

// src/pdf.js
async function makePDFs(data, subId, env) {
  const now = /* @__PURE__ */ new Date();
  const y = now.getUTCFullYear();
  const m = String(now.getUTCMonth() + 1).padStart(2, "0");
  const d = String(now.getUTCDate()).padStart(2, "0");
  const results = [];
  for (const act of data.activities) {
    const html = `
    <!doctype html><meta charset="utf-8">
    <style>body{font-family:Arial;font-size:11pt;margin:2cm}</style>
    <h1>${act.toUpperCase()} \u2014 Release of Liability</h1>
    <p>Property  : ${data.propertyId}</p>
    <p>Check-in  : ${data.checkinDate}</p>
    <p>Guest     : ${data.guestName}</p>
    <p>Initials  : ${data.initials[act]}</p>
    <img src="${data.signature}" width="300">
    <footer style="position:fixed;bottom:1cm;font-size:8pt;width:100%;text-align:center">
      Version ${env.LEGAL_VERSION} \u2022 hash ${subId}
    </footer>`;
    const pdfBuffer = await env.BROWSER.htmlToPdf({ body: html, cf: { format: "A4" } });
    const shortId = nanoid(6);
    const filename = `${act}.pdf`;
    const key = `waivers/${y}/${m}/${d}/${data.propertyId}/${act}/${data.guestName.toLowerCase().replace(/[^a-z]/g, "-")}-${shortId}.pdf`;
    await env.WAIVERS_R2.put(key, pdfBuffer, {
      httpMetadata: { contentType: "application/pdf" }
    });
    results.push({ id: shortId, activity: act, filename, r2Key: key, bytes: pdfBuffer });
  }
  return results;
}
__name(makePDFs, "makePDFs");

// src/mail.js
async function sendMail(data, pdfs, pin, env) {
  const boundary = "BOUNDARY-" + Math.random().toString(36).slice(2);
  let body = "";
  body += `From: ${env.EMAIL_FROM}\r
`;
  body += `To: ${data.guestEmail}\r
`;
  body += `Subject: Your activity waiver(s)\r
`;
  body += "MIME-Version: 1.0\r\n";
  body += `Content-Type: multipart/mixed; boundary=${boundary}\r
\r
`;
  body += `--${boundary}\r
`;
  body += "Content-Type: text/plain; charset=utf-8\r\n\r\n";
  body += `Hi ${data.guestName},

Thank you for completing your waiver for ${data.propertyId}.
Attached:${pdfs.map((p) => " " + p.filename).join(", ")}

${pin ? "Your Archery PIN is " + pin + "\n\n" : ""}
Regards,
The Rentals Team
\r
`;
  for (const p of pdfs) {
    body += `--${boundary}\r
`;
    body += "Content-Type: application/pdf\r\n";
    body += "Content-Transfer-Encoding: base64\r\n";
    body += `Content-Disposition: attachment; filename="${p.filename}"\r
\r
`;
    body += btoa(String.fromCharCode(...new Uint8Array(p.bytes))) + "\r\n";
  }
  body += `--${boundary}--`;
  await fetch("https://api.cloudflare.com/client/v4/accounts/" + env.CLOUDFLARE_ACCOUNT_ID + "/email/send", {
    method: "POST",
    headers: {
      "Content-Type": "text/plain",
      "Authorization": "Bearer " + env.CLOUDFLARE_API_TOKEN
      // put as secret
    },
    body
  });
}
__name(sendMail, "sendMail");

// src/resp.js
var json = /* @__PURE__ */ __name((obj, status2 = 200) => new Response(JSON.stringify(obj), {
  status: status2,
  headers: { "content-type": "application/json" }
}), "json");
var bad = /* @__PURE__ */ __name((msg) => json({ ok: false, error: msg }, 400), "bad");

// src/index.mjs
var src_default = {
  async fetch(request, env, ctx) {
    const { pathname } = new URL(request.url);
    try {
      if (request.method === "GET" && pathname === "/") return await htmlPage(env);
      if (request.method === "POST" && pathname === "/submit") return submit(request, env);
      if (request.method === "GET" && pathname === "/admin/search") return search(request, env);
      if (request.method === "GET" && pathname === "/status") return status(env);
      if (request.method === "GET" && pathname.startsWith("/download/")) return downloadPDF(request, env);
      return new Response("Not found", { status: 404 });
    } catch (err) {
      console.error(err);
      return new Response("Server error", { status: 500 });
    }
  }
};
async function status(env) {
  try {
    const dbOK = await env.waivers.prepare("SELECT 1").first();
    return json({ ok: true, db: !!dbOK, ts: Date.now() });
  } catch (error) {
    return json({ ok: false, error: error.message, ts: Date.now() });
  }
}
__name(status, "status");
async function search(request, env) {
  const url = new URL(request.url);
  const qName = url.searchParams.get("name") ?? "";
  const qEmail = url.searchParams.get("email") ?? "";
  const qProp = url.searchParams.get("prop") ?? "";
  const qDate = url.searchParams.get("date") ?? "";
  const rows = await env.waivers.prepare(
    `SELECT * FROM submissions
        WHERE guest_name  LIKE ?1
          AND guest_email LIKE ?2
          AND property_id LIKE ?3
          AND checkin_date LIKE ?4
        ORDER BY created_at DESC
        LIMIT 200`
  ).bind(`%${qName}%`, `%${qEmail}%`, `%${qProp}%`, `%${qDate}%`).all();
  return json({ rows });
}
__name(search, "search");
async function submit(request, env) {
  console.log("Submit endpoint called");
  const data = await request.json();
  console.log("Received data:", data);
  const must = [
    "propertyId",
    "checkinDate",
    "guestName",
    "guestEmail",
    "activities",
    "initials",
    "signature",
    "accepted"
  ];
  for (const k of must)
    if (data[k] === void 0 || data[k] === "" || Array.isArray(data[k]) && !data[k].length)
      return bad(`missing ${k}`);
  if (data.accepted !== true)
    return bad("master acceptance not ticked");
  const subId = nanoid(10);
  const now = (/* @__PURE__ */ new Date()).toISOString();
  try {
    await env.waivers.prepare(
      "INSERT INTO submissions VALUES(?1,?2,?3,?4,?5,?6,?7)"
    ).bind(
      subId,
      now,
      data.propertyId,
      data.checkinDate,
      data.guestName,
      data.guestEmail,
      JSON.stringify(data.activities)
    ).run();
    console.log("Submission saved to database");
  } catch (dbError) {
    console.error("Database error:", dbError);
    return json({ ok: false, error: "Database not initialized. Run migrations first." }, 500);
  }
  let pdfInfos;
  try {
    pdfInfos = await makePDFs(data, subId, env);
    console.log("PDFs generated:", pdfInfos.length);
  } catch (pdfError) {
    console.error("PDF generation error:", pdfError);
    return json({ ok: false, error: "PDF generation failed: " + pdfError.message }, 500);
  }
  try {
    for (const p of pdfInfos)
      await env.waivers.prepare(
        "INSERT INTO documents VALUES(?1,?2,?3,?4)"
      ).bind(p.id, subId, p.activity, p.r2Key).run();
    console.log("Document records saved");
  } catch (docError) {
    console.error("Document save error:", docError);
  }
  const pin = data.activities.includes("archery") ? env.ARCHERY_PIN : null;
  if (env.DEV_MODE === "true") {
    const downloads = pdfInfos.map((p) => ({
      filename: p.filename,
      url: `/download/${p.r2Key}`
    }));
    return json({
      ok: true,
      devMode: true,
      downloads,
      pin
    });
  }
  await sendMail(data, pdfInfos, pin, env);
  return json({
    ok: true,
    emailed: pdfInfos.map((p) => p.filename),
    pin
  });
}
__name(submit, "submit");
async function downloadPDF(request, env) {
  const { pathname } = new URL(request.url);
  const r2Key = pathname.replace("/download/", "");
  if (env.DEV_MODE !== "true") {
    return new Response("Downloads only available in dev mode", { status: 403 });
  }
  const object = await env.WAIVERS_R2.get(r2Key);
  if (!object) {
    return new Response("PDF not found", { status: 404 });
  }
  const filename = r2Key.split("/").pop();
  return new Response(object.body, {
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="${filename}"`,
      "Cache-Control": "private, max-age=300"
    }
  });
}
__name(downloadPDF, "downloadPDF");

// ../../../../../../home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts
var drainBody = /* @__PURE__ */ __name(async (request, env, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env);
  } finally {
    try {
      if (request.body !== null && !request.bodyUsed) {
        const reader = request.body.getReader();
        while (!(await reader.read()).done) {
        }
      }
    } catch (e) {
      console.error("Failed to drain the unused request body.", e);
    }
  }
}, "drainBody");
var middleware_ensure_req_body_drained_default = drainBody;

// ../../../../../../home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts
function reduceError(e) {
  return {
    name: e?.name,
    message: e?.message ?? String(e),
    stack: e?.stack,
    cause: e?.cause === void 0 ? void 0 : reduceError(e.cause)
  };
}
__name(reduceError, "reduceError");
var jsonError = /* @__PURE__ */ __name(async (request, env, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env);
  } catch (e) {
    const error = reduceError(e);
    return Response.json(error, {
      status: 500,
      headers: { "MF-Experimental-Error-Stack": "true" }
    });
  }
}, "jsonError");
var middleware_miniflare3_json_error_default = jsonError;

// .wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js
var __INTERNAL_WRANGLER_MIDDLEWARE__ = [
  middleware_ensure_req_body_drained_default,
  middleware_miniflare3_json_error_default
];
var middleware_insertion_facade_default = src_default;

// ../../../../../../home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/common.ts
var __facade_middleware__ = [];
function __facade_register__(...args) {
  __facade_middleware__.push(...args.flat());
}
__name(__facade_register__, "__facade_register__");
function __facade_invokeChain__(request, env, ctx, dispatch, middlewareChain) {
  const [head, ...tail] = middlewareChain;
  const middlewareCtx = {
    dispatch,
    next(newRequest, newEnv) {
      return __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);
    }
  };
  return head(request, env, ctx, middlewareCtx);
}
__name(__facade_invokeChain__, "__facade_invokeChain__");
function __facade_invoke__(request, env, ctx, dispatch, finalMiddleware) {
  return __facade_invokeChain__(request, env, ctx, dispatch, [
    ...__facade_middleware__,
    finalMiddleware
  ]);
}
__name(__facade_invoke__, "__facade_invoke__");

// .wrangler/tmp/bundle-sW1d5E/middleware-loader.entry.ts
var __Facade_ScheduledController__ = class ___Facade_ScheduledController__ {
  constructor(scheduledTime, cron, noRetry) {
    this.scheduledTime = scheduledTime;
    this.cron = cron;
    this.#noRetry = noRetry;
  }
  static {
    __name(this, "__Facade_ScheduledController__");
  }
  #noRetry;
  noRetry() {
    if (!(this instanceof ___Facade_ScheduledController__)) {
      throw new TypeError("Illegal invocation");
    }
    this.#noRetry();
  }
};
function wrapExportedHandler(worker) {
  if (__INTERNAL_WRANGLER_MIDDLEWARE__ === void 0 || __INTERNAL_WRANGLER_MIDDLEWARE__.length === 0) {
    return worker;
  }
  for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
    __facade_register__(middleware);
  }
  const fetchDispatcher = /* @__PURE__ */ __name(function(request, env, ctx) {
    if (worker.fetch === void 0) {
      throw new Error("Handler does not export a fetch() function.");
    }
    return worker.fetch(request, env, ctx);
  }, "fetchDispatcher");
  return {
    ...worker,
    fetch(request, env, ctx) {
      const dispatcher = /* @__PURE__ */ __name(function(type, init) {
        if (type === "scheduled" && worker.scheduled !== void 0) {
          const controller = new __Facade_ScheduledController__(
            Date.now(),
            init.cron ?? "",
            () => {
            }
          );
          return worker.scheduled(controller, env, ctx);
        }
      }, "dispatcher");
      return __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);
    }
  };
}
__name(wrapExportedHandler, "wrapExportedHandler");
function wrapWorkerEntrypoint(klass) {
  if (__INTERNAL_WRANGLER_MIDDLEWARE__ === void 0 || __INTERNAL_WRANGLER_MIDDLEWARE__.length === 0) {
    return klass;
  }
  for (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {
    __facade_register__(middleware);
  }
  return class extends klass {
    #fetchDispatcher = /* @__PURE__ */ __name((request, env, ctx) => {
      this.env = env;
      this.ctx = ctx;
      if (super.fetch === void 0) {
        throw new Error("Entrypoint class does not define a fetch() function.");
      }
      return super.fetch(request);
    }, "#fetchDispatcher");
    #dispatcher = /* @__PURE__ */ __name((type, init) => {
      if (type === "scheduled" && super.scheduled !== void 0) {
        const controller = new __Facade_ScheduledController__(
          Date.now(),
          init.cron ?? "",
          () => {
          }
        );
        return super.scheduled(controller);
      }
    }, "#dispatcher");
    fetch(request) {
      return __facade_invoke__(
        request,
        this.env,
        this.ctx,
        this.#dispatcher,
        this.#fetchDispatcher
      );
    }
  };
}
__name(wrapWorkerEntrypoint, "wrapWorkerEntrypoint");
var WRAPPED_ENTRY;
if (typeof middleware_insertion_facade_default === "object") {
  WRAPPED_ENTRY = wrapExportedHandler(middleware_insertion_facade_default);
} else if (typeof middleware_insertion_facade_default === "function") {
  WRAPPED_ENTRY = wrapWorkerEntrypoint(middleware_insertion_facade_default);
}
var middleware_loader_entry_default = WRAPPED_ENTRY;
export {
  __INTERNAL_WRANGLER_MIDDLEWARE__,
  middleware_loader_entry_default as default
};
//# sourceMappingURL=index.js.map
</file>

<file path=".wrangler/tmp/dev-qGIfSE/index.js.map">
{
  "version": 3,
  "sources": ["../bundle-sW1d5E/checked-fetch.js", "../../../node_modules/nanoid/url-alphabet/index.js", "../../../node_modules/nanoid/index.browser.js", "../../../src/spa.js", "../../../src/pdf.js", "../../../src/mail.js", "../../../src/resp.js", "../../../src/index.mjs", "../../../../../../../../../home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../../../../../../home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-sW1d5E/middleware-insertion-facade.js", "../../../../../../../../../home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/common.ts", "../bundle-sW1d5E/middleware-loader.entry.ts"],
  "sourceRoot": "/mnt/c/Users/scrap/dev/cf/.wrangler/tmp/dev-qGIfSE",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "export const urlAlphabet =\n  'useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict'\n", "/* @ts-self-types=\"./index.d.ts\" */\nimport { urlAlphabet as scopedUrlAlphabet } from './url-alphabet/index.js'\nexport { urlAlphabet } from './url-alphabet/index.js'\nexport let random = bytes => crypto.getRandomValues(new Uint8Array(bytes))\nexport let customRandom = (alphabet, defaultSize, getRandom) => {\n  let mask = (2 << Math.log2(alphabet.length - 1)) - 1\n  let step = -~((1.6 * mask * defaultSize) / alphabet.length)\n  return (size = defaultSize) => {\n    let id = ''\n    while (true) {\n      let bytes = getRandom(step)\n      let j = step | 0\n      while (j--) {\n        id += alphabet[bytes[j] & mask] || ''\n        if (id.length >= size) return id\n      }\n    }\n  }\n}\nexport let customAlphabet = (alphabet, size = 21) =>\n  customRandom(alphabet, size | 0, random)\nexport let nanoid = (size = 21) => {\n  let id = ''\n  let bytes = crypto.getRandomValues(new Uint8Array((size |= 0)))\n  while (size--) {\n    id += scopedUrlAlphabet[bytes[size] & 63]\n  }\n  return id\n}\n", "export async function htmlPage (env) {\n  // property list pulled once from KV and embedded as <script> blob\n  const propsJSON = await env.PROPS_KV.get('props', 'text') || '[]';\n  const props64   = btoa(unescape(encodeURIComponent(propsJSON)));\n\n  return new Response(`\n<!doctype html>\n<html lang=\"en\"><meta charset=\"utf-8\">\n<title>Activity Waiver</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<style>\n  body{font-family:system-ui;margin:2rem auto;max-width:640px;padding:0 1rem}\n  label{display:block;margin:.4rem 0}\n  canvas{border:1px solid #999;width:100%;touch-action:none}\n  .activities-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:10px;background:#f5f5f5;border-radius:8px}\n  .activity-item{display:flex;align-items:center;padding:8px;background:white;border-radius:4px;border:1px solid #ddd;cursor:pointer;transition:all 0.2s}\n  .activity-item:hover{background:#f0f7ff;border-color:#0070f3}\n  .activity-item input[type=\"checkbox\"]{margin-right:8px;cursor:pointer;width:18px;height:18px}\n  .activity-item label{margin:0;cursor:pointer;flex:1}\n  .activity-item input[type=\"text\"]{margin-left:auto;width:50px;text-align:center;padding:4px;border:1px solid #ccc;border-radius:4px}\n  @media (max-width:480px){.activities-grid{grid-template-columns:1fr}}\n</style>\n\n<body>\n  <h1>Sign your waiver</h1>\n  <form id=\"form\">\n    <label>Property\n      <select id=\"prop\"></select>\n    </label>\n\n    <label>Check-in\n      <input type=\"date\" id=\"date\" required>\n    </label>\n\n    <label>Name\n      <input id=\"name\" required>\n    </label>\n\n    <label>E-mail\n      <input id=\"email\" type=\"email\" required>\n    </label>\n\n    <h3>Activities</h3>\n    <div id=\"activities\" class=\"activities-grid\"></div>\n\n    <label>\n      <input id=\"master\" type=\"checkbox\" required>\n      I have read and accept all risks.\n    </label>\n\n    <h3>Signature</h3>\n    <canvas id=\"sign\" width=\"600\" height=\"200\"></canvas><br>\n    <button id=\"clearSig\" type=\"button\">Clear</button><br><br>\n\n    <button id=\"submit\">Submit</button>\n  </form>\n\n  <div id=\"thanks\" hidden></div>\n\n<script type=\"module\">\n  /* ---------- bootstrap property list -------------------- */\n  let props = JSON.parse(atob('${props64}'));\n  console.log(\"Raw props data:\", props);\n\n  // Handle both array and single object formats\n  if (!Array.isArray(props)) {\n    props = [props];\n  }\n  console.log(\"Props after array check:\", props);\n\n  const propSel = document.getElementById('prop');\n  props.forEach(p => propSel.add(new Option(p.name, p.id)));\n\n  /* ---------- activity checkboxes ------------------------- */\n  const actsDiv      = document.getElementById('activities');\n  const masterCheck  = document.getElementById('master');\n  const chosen       = new Map(); // slug -> {itemDiv, initialInput}\n\n  const activities = props[0]?.activities ?? [];   // assumes all props share list\n  console.log(\"Activities array:\", activities);\n  console.log(\"Activities container:\", actsDiv);\n  activities.forEach(a => {\n    const itemDiv = document.createElement('div');\n    itemDiv.className = 'activity-item';\n\n    const checkbox = document.createElement('input');\n    checkbox.type = 'checkbox';\n    checkbox.id = 'activity-' + a.slug;\n    checkbox.value = a.slug;\n\n    const label = document.createElement('label');\n    label.htmlFor = 'activity-' + a.slug;\n    label.textContent = a.label;\n\n    const initialInput = document.createElement('input');\n    initialInput.type = 'text';\n    initialInput.maxLength = 4;\n    initialInput.placeholder = 'Init';\n    initialInput.style.display = 'none';\n    initialInput.dataset.slug = a.slug;\n    initialInput.oninput = validateMasterCheckbox;\n\n    checkbox.onchange = () => {\n      if (checkbox.checked) {\n        chosen.set(a.slug, {itemDiv, initialInput});\n        initialInput.style.display = 'block';\n      } else {\n        chosen.delete(a.slug);\n        initialInput.style.display = 'none';\n        initialInput.value = '';\n      }\n      validateMasterCheckbox();\n    };\n\n    itemDiv.appendChild(checkbox);\n    itemDiv.appendChild(label);\n    itemDiv.appendChild(initialInput);\n\n    // Make entire div clickable except initial input\n    itemDiv.onclick = (e) => {\n      if (e.target !== initialInput) {\n        checkbox.checked = !checkbox.checked;\n        checkbox.onchange();\n      }\n    };\n\n    actsDiv.appendChild(itemDiv);\n  });\n\n  function validateMasterCheckbox() {\n    let allFilled = true;\n    for (const [slug, {initialInput}] of chosen) {\n      if (!initialInput.value.trim()) {\n        allFilled = false;\n        break;\n      }\n    }\n    masterCheck.disabled = !allFilled || chosen.size === 0;\n    if (masterCheck.disabled) {\n      masterCheck.checked = false;\n    }\n  }\n\n  validateMasterCheckbox();\n\n  /* ---------- signature pad -------------------------------- */\n  const canvas = document.getElementById('sign');\n  const ctx    = canvas.getContext('2d', { willReadFrequently: true });\n  let drawing  = false;\n\n  canvas.addEventListener('pointerdown', e => {\n    drawing = true;\n    ctx.moveTo(e.offsetX, e.offsetY);\n  });\n  canvas.addEventListener('pointermove', e => {\n    if (!drawing) return;\n    ctx.lineTo(e.offsetX, e.offsetY);\n    ctx.stroke();\n  });\n  canvas.addEventListener('pointerup', () => drawing = false);\n  document.getElementById('clearSig').onclick =\n    () => ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n  /* ---------- submit --------------------------------------- */\n  document.getElementById('form').onsubmit = async e => {\n    e.preventDefault();\n\n    const data = {\n      propertyId  : propSel.value,\n      checkinDate : document.getElementById('date').value,\n      guestName   : document.getElementById('name').value,\n      guestEmail  : document.getElementById('email').value,\n      activities  : [...chosen.keys()],\n      initials    : Object.fromEntries(\n                      [...chosen.entries()].map(([slug, {initialInput}]) =>\n                        [slug, initialInput.value])),\n      signature   : canvas.toDataURL(),\n      accepted    : document.getElementById('master').checked\n    };\n\n    console.log(\"Submitting data:\", data);\n\n    try {\n      const res  = await fetch('/submit', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data)\n      });\n\n      console.log(\"Response status:\", res.status);\n\n      if (!res.ok) {\n        const errorText = await res.text();\n        console.error(\"Server error:\", errorText);\n        alert(\"Error submitting form: \" + errorText);\n        return;\n      }\n\n      const json = await res.json();\n      console.log(\"Response data:\", json);\n\n    document.getElementById('form').hidden   = true;\n    document.getElementById('thanks').hidden = false;\n\n    if (json.devMode) {\n      // Development mode - show download links\n      let html = '<h2>Waivers Generated \u2714</h2>';\n      html += '<p>Download your waivers:</p>';\n      html += '<div style=\"display:flex;flex-direction:column;gap:10px;margin:20px 0\">';\n\n      // Create download buttons for each PDF\n      json.downloads.forEach(pdf => {\n        html += \\`<button onclick=\"window.open('\\${pdf.url}', '_blank')\" \\`;\n        html += 'style=\"padding:10px 20px;background:#0070f3;color:#fff;border:none;';\n        html += 'border-radius:6px;cursor:pointer;font-size:16px\">';\n        html += '\uD83D\uDCC4 Download ' + pdf.filename + '</button>';\n      });\n\n      html += '</div>';\n\n      // Add button to download all at once\n      if (json.downloads.length > 1) {\n        html += '<button onclick=\"';\n        json.downloads.forEach(pdf => {\n          html += \\`window.open('\\${pdf.url}', '_blank');\\`;\n        });\n        html += '\" style=\"padding:12px 24px;background:#28a745;color:#fff;border:none;';\n        html += 'border-radius:6px;cursor:pointer;font-size:16px;margin-top:10px\">';\n        html += '\uD83D\uDCE6 Download All (' + json.downloads.length + ' PDFs)</button>';\n      }\n\n      if (json.pin) {\n        html += '<p style=\"margin-top:20px\">Your Archery PIN is <b>' + json.pin + '</b></p>';\n      }\n\n      html += '<p style=\"margin-top:20px;color:#666;font-size:14px\">';\n      html += '\u26A0\uFE0F Development Mode - PDFs are stored but not emailed</p>';\n\n      document.getElementById('thanks').innerHTML = html;\n    } else {\n      // Production mode - email confirmation\n      document.getElementById('thanks').innerHTML =\n        '<h2>Email sent \u2714</h2><p>Attachments:<br>' +\n        json.emailed.join('<br>') + '</p>' +\n        (json.pin ? '<p>Your Archery PIN is <b>' + json.pin + '</b></p>' : '');\n    }\n    } catch (error) {\n      console.error(\"Form submission error:\", error);\n      alert(\"Error submitting form: \" + error.message);\n    }\n  };\n</script>\n</body>\n</html>`, {\n    headers: { 'content-type': 'text/html; charset=utf-8' }\n  });\n}\n", "import { nanoid } from 'nanoid';\n\nexport async function makePDFs (data, subId, env) {\n  const now = new Date();\n  const y = now.getUTCFullYear();\n  const m = String(now.getUTCMonth() + 1).padStart(2, '0');\n  const d = String(now.getUTCDate()).padStart(2, '0');\n\n  const results = [];\n\n  for (const act of data.activities) {\n    /* ----- minimal HTML template ---------------------------------- */\n    const html = `\n    <!doctype html><meta charset=\"utf-8\">\n    <style>body{font-family:Arial;font-size:11pt;margin:2cm}</style>\n    <h1>${act.toUpperCase()} \u2014 Release of Liability</h1>\n    <p>Property  : ${data.propertyId}</p>\n    <p>Check-in  : ${data.checkinDate}</p>\n    <p>Guest     : ${data.guestName}</p>\n    <p>Initials  : ${data.initials[act]}</p>\n    <img src=\"${data.signature}\" width=\"300\">\n    <footer style=\"position:fixed;bottom:1cm;font-size:8pt;width:100%;text-align:center\">\n      Version ${env.LEGAL_VERSION} \u2022 hash ${subId}\n    </footer>`;\n\n    /* ----- Cloudflare Browser Rendering --------------------------- */\n    const pdfBuffer = await env.BROWSER.htmlToPdf({ body: html, cf: { format: 'A4' } });\n\n    /* ----- deterministic R2 key ----------------------------------- */\n    const shortId  = nanoid(6);\n    const filename = `${act}.pdf`;\n    const key      = `waivers/${y}/${m}/${d}/${data.propertyId}/${act}/` +\n                     `${data.guestName.toLowerCase().replace(/[^a-z]/g,'-')}-${shortId}.pdf`;\n\n    await env.WAIVERS_R2.put(key, pdfBuffer, {\n      httpMetadata: { contentType: 'application/pdf' }\n    });\n\n    results.push({ id: shortId, activity: act, filename, r2Key: key, bytes: pdfBuffer });\n  }\n\n  return results;\n}\n", "export async function sendMail (data, pdfs, pin, env) {\n  const boundary = 'BOUNDARY-' + Math.random().toString(36).slice(2);\n  let body = '';\n\n  /* ---- headers -------------------------------------------------- */\n  body += `From: ${env.EMAIL_FROM}\\r\\n`;\n  body += `To: ${data.guestEmail}\\r\\n`;\n  body += `Subject: Your activity waiver(s)\\r\\n`;\n  body += 'MIME-Version: 1.0\\r\\n';\n  body += `Content-Type: multipart/mixed; boundary=${boundary}\\r\\n\\r\\n`;\n\n  /* ---- plain-text part ------------------------------------------ */\n  body += `--${boundary}\\r\\n`;\n  body += 'Content-Type: text/plain; charset=utf-8\\r\\n\\r\\n';\n  body += `Hi ${data.guestName},\n\nThank you for completing your waiver for ${data.propertyId}.\nAttached:${pdfs.map(p => ' ' + p.filename).join(', ')}\n\n${pin ? 'Your Archery PIN is ' + pin + '\\n\\n' : ''}\nRegards,\nThe Rentals Team\n\\r\\n`;\n\n  /* ---- one attachment per PDF ----------------------------------- */\n  for (const p of pdfs) {\n    body += `--${boundary}\\r\\n`;\n    body += 'Content-Type: application/pdf\\r\\n';\n    body += 'Content-Transfer-Encoding: base64\\r\\n';\n    body += `Content-Disposition: attachment; filename=\"${p.filename}\"\\r\\n\\r\\n`;\n    body += btoa(String.fromCharCode(...new Uint8Array(p.bytes))) + '\\r\\n';\n  }\n  body += `--${boundary}--`;\n\n  /* ---- send ------------------------------------------------------ */\n  await fetch('https://api.cloudflare.com/client/v4/accounts/' +\n              env.CLOUDFLARE_ACCOUNT_ID + '/email/send', {\n    method:  'POST',\n    headers: {\n      'Content-Type': 'text/plain',\n      'Authorization': 'Bearer ' + env.CLOUDFLARE_API_TOKEN   // put as secret\n    },\n    body\n  });\n}\n", "export const json = (obj, status = 200) =>\n  new Response(JSON.stringify(obj), {\n    status,\n    headers: { 'content-type': 'application/json' }\n  });\n\nexport const bad = msg => json({ ok: false, error: msg }, 400);\n", "import { nanoid }          from 'nanoid';\nimport { htmlPage }        from './spa.js';\nimport { makePDFs }        from './pdf.js';\nimport { sendMail }        from './mail.js';\nimport { json, bad }       from './resp.js';\n\nexport default {\n  async fetch (request, env, ctx) {\n    const { pathname } = new URL(request.url);\n\n    try {\n      if (request.method === 'GET'  && pathname === '/')              return await htmlPage(env);\n      if (request.method === 'POST' && pathname === '/submit')        return submit(request, env);\n      if (request.method === 'GET'  && pathname === '/admin/search')  return search(request, env);\n      if (request.method === 'GET'  && pathname === '/status')        return status(env);\n      if (request.method === 'GET'  && pathname.startsWith('/download/')) return downloadPDF(request, env);\n      return new Response('Not found', { status: 404 });\n    } catch (err) {\n      console.error(err);\n      return new Response('Server error', { status: 500 });\n    }\n  }\n};\n\n/* ---------- /status ---------------------------------------------------- */\nasync function status (env) {\n  try {\n    const dbOK = await env.waivers.prepare('SELECT 1').first();\n    return json({ ok: true, db: !!dbOK, ts: Date.now() });\n  } catch (error) {\n    return json({ ok: false, error: error.message, ts: Date.now() });\n  }\n}\n\n/* ---------- /admin/search --------------------------------------------- */\nasync function search (request, env) {\n  const url = new URL(request.url);\n  const qName  = url.searchParams.get('name')  ?? '';\n  const qEmail = url.searchParams.get('email') ?? '';\n  const qProp  = url.searchParams.get('prop')  ?? '';\n  const qDate  = url.searchParams.get('date')  ?? '';\n\n  const rows = await env.waivers.prepare(\n      `SELECT * FROM submissions\n        WHERE guest_name  LIKE ?1\n          AND guest_email LIKE ?2\n          AND property_id LIKE ?3\n          AND checkin_date LIKE ?4\n        ORDER BY created_at DESC\n        LIMIT 200`\n    )\n    .bind(`%${qName}%`, `%${qEmail}%`, `%${qProp}%`, `%${qDate}%`)\n    .all();\n\n  return json({ rows });\n}\n\n/* ---------- /submit ---------------------------------------------------- */\nasync function submit (request, env) {\n  console.log('Submit endpoint called');\n  const data = await request.json();\n  console.log('Received data:', data);\n\n  /* ---- quick validation ------------------------------------------------ */\n  const must = ['propertyId','checkinDate','guestName','guestEmail',\n                'activities','initials','signature','accepted'];\n  for (const k of must)\n    if (data[k] === undefined || data[k] === '' ||\n        (Array.isArray(data[k]) && !data[k].length))\n      return bad(`missing ${k}`);\n\n  if (data.accepted !== true)\n    return bad('master acceptance not ticked');\n\n  /* ---- write one submission row --------------------------------------- */\n  const subId = nanoid(10);\n  const now   = new Date().toISOString();\n\n  try {\n    await env.waivers.prepare(\n        'INSERT INTO submissions VALUES(?1,?2,?3,?4,?5,?6,?7)'\n      ).bind(\n        subId, now, data.propertyId, data.checkinDate,\n        data.guestName, data.guestEmail, JSON.stringify(data.activities)\n      ).run();\n    console.log('Submission saved to database');\n  } catch (dbError) {\n    console.error('Database error:', dbError);\n    return json({ ok: false, error: 'Database not initialized. Run migrations first.' }, 500);\n  }\n\n  /* ---- generate N PDFs ------------------------------------------------- */\n  let pdfInfos;\n  try {\n    pdfInfos = await makePDFs(data, subId, env);\n    console.log('PDFs generated:', pdfInfos.length);\n  } catch (pdfError) {\n    console.error('PDF generation error:', pdfError);\n    return json({ ok: false, error: 'PDF generation failed: ' + pdfError.message }, 500);\n  }\n\n  /* ---- one row per PDF ------------------------------------------------- */\n  try {\n    for (const p of pdfInfos)\n      await env.waivers.prepare(\n          'INSERT INTO documents VALUES(?1,?2,?3,?4)'\n        ).bind(p.id, subId, p.activity, p.r2Key).run();\n    console.log('Document records saved');\n  } catch (docError) {\n    console.error('Document save error:', docError);\n  }\n\n  const pin = data.activities.includes('archery') ? env.ARCHERY_PIN : null;\n\n  /* ---- check if in dev mode -------------------------------------------- */\n  if (env.DEV_MODE === 'true') {\n    // In dev mode, return download URLs instead of sending email\n    const downloads = pdfInfos.map(p => ({\n      filename: p.filename,\n      url: `/download/${p.r2Key}`\n    }));\n\n    return json({\n      ok: true,\n      devMode: true,\n      downloads,\n      pin\n    });\n  }\n\n  /* ---- e-mail (production only) ---------------------------------------- */\n  await sendMail(data, pdfInfos, pin, env);\n\n  return json({ ok: true,\n                emailed: pdfInfos.map(p => p.filename),\n                pin });\n}\n\n/* ---------- /download/:key --------------------------------------------- */\nasync function downloadPDF (request, env) {\n  const { pathname } = new URL(request.url);\n  const r2Key = pathname.replace('/download/', '');\n\n  // Only allow in dev mode\n  if (env.DEV_MODE !== 'true') {\n    return new Response('Downloads only available in dev mode', { status: 403 });\n  }\n\n  const object = await env.WAIVERS_R2.get(r2Key);\n\n  if (!object) {\n    return new Response('PDF not found', { status: 404 });\n  }\n\n  // Extract filename from the key\n  const filename = r2Key.split('/').pop();\n\n  return new Response(object.body, {\n    headers: {\n      'Content-Type': 'application/pdf',\n      'Content-Disposition': `attachment; filename=\"${filename}\"`,\n      'Cache-Control': 'private, max-age=300'\n    }\n  });\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"/mnt/c/Users/scrap/dev/cf/src/index.mjs\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"/home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"/home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"/mnt/c/Users/scrap/dev/cf/src/index.mjs\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"/mnt/c/Users/scrap/dev/cf/.wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"/home/somark/.nvm/versions/node/v23.11.1/lib/node_modules/wrangler/templates/middleware/common.ts\";\nimport type { WorkerEntrypointConstructor } from \"/mnt/c/Users/scrap/dev/cf/.wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"/mnt/c/Users/scrap/dev/cf/.wrangler/tmp/bundle-sW1d5E/middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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",
  "names": ["status"]
}
</file>

<file path="docs/API.md">
# API Documentation

This document describes the public API endpoints for the waiver management system.

## Endpoints

### GET /

**Description:** Returns the HTML waiver form for guests to fill out and submit.

**Response:** HTML page with embedded property, activity, and risk data.

**Example:**
```bash
curl https://activities.rtxsecured.com/
```

---

### POST /submit

**Description:** Submits a completed waiver form with guest information, selected activities, initials, and signature.

**Request Body:**
```json
{
  "propertyId": "cabin-13",
  "checkinDate": "2025-10-15",
  "guestName": "John Doe",
  "guestEmail": "john@example.com",
  "activities": ["kayaking", "ziplining", "archery"],
  "initials": {
    "kayaking": "JD",
    "ziplining": "JD",
    "archery": "JD"
  },
  "signature": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "accepted": true
}
```

**Response (Production Mode):**
```json
{
  "ok": true,
  "devMode": false,
  "emailed": [
    "cabin-13_kayaking_20251015.pdf",
    "cabin-13_ziplining_20251015.pdf",
    "cabin-13_archery_20251015.pdf"
  ],
  "pin": "1234"
}
```

**Response (Development Mode):**
```json
{
  "ok": true,
  "devMode": true,
  "downloads": [
    {
      "filename": "cabin-13_kayaking_20251015.pdf",
      "url": "/download/abc123def456"
    },
    {
      "filename": "cabin-13_ziplining_20251015.pdf",
      "url": "/download/def456ghi789"
    }
  ],
  "pin": "1234"
}
```

**Notes:**
- The `pin` field is only included if the "archery" activity is selected
- In development mode (`DEV_MODE=true`), PDFs are generated and stored but not emailed
- In production mode, PDFs are emailed to the guest's email address

**Example:**
```bash
curl -X POST https://activities.rtxsecured.com/submit \
  -H "Content-Type: application/json" \
  -d '{
    "propertyId": "cabin-13",
    "checkinDate": "2025-10-15",
    "guestName": "John Doe",
    "guestEmail": "john@example.com",
    "activities": ["kayaking"],
    "initials": {
      "kayaking": "JD"
    },
    "signature": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
    "accepted": true
  }'
```

---

### GET /admin/search

**Description:** Search for waiver submissions by guest name or email. Returns matching submissions with metadata.

**Query Parameters:**
- `q` (required): Search query string (matches against guest name or email)

**Response:**
```json
{
  "ok": true,
  "results": [
    {
      "id": 42,
      "property_id": "cabin-13",
      "checkin_date": "2025-10-15",
      "guest_name": "John Doe",
      "guest_email": "john@example.com",
      "activities": "kayaking,ziplining",
      "signature_key": "signatures/abc123.png",
      "created_at": "2025-10-01T14:30:00.000Z"
    }
  ]
}
```

**Example:**
```bash
# Search by name
curl "https://activities.rtxsecured.com/admin/search?q=John+Doe"

# Search by email
curl "https://activities.rtxsecured.com/admin/search?q=john@example.com"

# Partial search
curl "https://activities.rtxsecured.com/admin/search?q=john"
```

---

### GET /status

**Description:** Check the status of a waiver submission by ID. Returns detailed information about the submission including associated documents.

**Query Parameters:**
- `id` (required): Submission ID

**Response:**
```json
{
  "ok": true,
  "submission": {
    "id": 42,
    "property_id": "cabin-13",
    "checkin_date": "2025-10-15",
    "guest_name": "John Doe",
    "guest_email": "john@example.com",
    "activities": "kayaking,ziplining",
    "signature_key": "signatures/abc123.png",
    "created_at": "2025-10-01T14:30:00.000Z"
  },
  "documents": [
    {
      "id": 84,
      "submission_id": 42,
      "activity_slug": "kayaking",
      "pdf_key": "waivers/cabin-13_kayaking_20251015_abc123.pdf",
      "created_at": "2025-10-01T14:30:01.000Z"
    },
    {
      "id": 85,
      "submission_id": 42,
      "activity_slug": "ziplining",
      "pdf_key": "waivers/cabin-13_ziplining_20251015_abc123.pdf",
      "created_at": "2025-10-01T14:30:02.000Z"
    }
  ]
}
```

**Error Response (Not Found):**
```json
{
  "ok": false,
  "error": "Submission not found"
}
```

**Example:**
```bash
curl "https://activities.rtxsecured.com/status?id=42"
```

---

## Error Responses

All endpoints return errors in the following format:

```json
{
  "ok": false,
  "error": "Error message describing what went wrong"
}
```

Common HTTP status codes:
- `200` - Success
- `400` - Bad Request (missing or invalid parameters)
- `404` - Not Found
- `500` - Internal Server Error

---

## Authentication

Currently, the public endpoints (`/`, `/submit`) do not require authentication. The admin endpoints (`/admin/*`) should be protected by your infrastructure (e.g., Cloudflare Access, firewall rules, etc.).

---

## Rate Limiting

Rate limiting is handled at the Cloudflare level. Contact your administrator for current rate limit policies.

---

## Data Retention

- Submissions are stored indefinitely in the D1 database
- PDF documents are stored indefinitely in R2
- Signature images are stored indefinitely in R2

---

---

## Admin Endpoints

The following endpoints are for administrative purposes and should be protected by authentication (e.g., Cloudflare Access).

### Properties Management

#### GET /admin/properties

**Description:** List all configured properties.

**Response:**
```json
{
  "ok": true,
  "properties": [
    {
      "id": "cabin-13",
      "name": "Cabin 13"
    }
  ]
}
```

**Example:**
```bash
curl https://activities.rtxsecured.com/admin/properties
```

---

#### POST /admin/properties/add

**Description:** Add a new property.

**Request Body:**
```json
{
  "id": "cabin-14",
  "name": "Cabin 14",
  "copyDefaultActivities": true
}
```

**Response:**
```json
{
  "ok": true,
  "properties": [
    {
      "id": "cabin-13",
      "name": "Cabin 13"
    },
    {
      "id": "cabin-14",
      "name": "Cabin 14"
    }
  ],
  "added": "cabin-14"
}
```

**Example:**
```bash
curl -X POST https://activities.rtxsecured.com/admin/properties/add \
  -H "Content-Type: application/json" \
  -d '{
    "id": "cabin-14",
    "name": "Cabin 14",
    "copyDefaultActivities": true
  }'
```

---

#### POST /admin/properties/remove

**Description:** Remove a property (cannot remove if it's the last property).

**Request Body:**
```json
{
  "id": "cabin-14"
}
```

**Response:**
```json
{
  "ok": true,
  "properties": [
    {
      "id": "cabin-13",
      "name": "Cabin 13"
    }
  ],
  "removed": "cabin-14"
}
```

**Example:**
```bash
curl -X POST https://activities.rtxsecured.com/admin/properties/remove \
  -H "Content-Type: application/json" \
  -d '{"id": "cabin-14"}'
```

---

### Activities Management

#### GET /admin/activities

**Description:** Get all activities for a specific property.

**Query Parameters:**
- `property` (optional): Property ID (defaults to "cabin-12")

**Response:**
```json
{
  "ok": true,
  "propertyId": "cabin-13",
  "activities": [
    {
      "slug": "kayaking",
      "label": "Kayaking",
      "risk": "low"
    },
    {
      "slug": "ziplining",
      "label": "Ziplining",
      "risk": "medium"
    }
  ]
}
```

**Example:**
```bash
curl "https://activities.rtxsecured.com/admin/activities?property=cabin-13"
```

---

#### POST /admin/activities/add

**Description:** Add a new activity to a property.

**Query Parameters:**
- `property` (optional): Property ID (defaults to "cabin-12")

**Request Body:**
```json
{
  "slug": "rock-climbing",
  "label": "Rock Climbing",
  "risk": "high"
}
```

**Response:**
```json
{
  "ok": true,
  "propertyId": "cabin-13",
  "activities": [...],
  "added": "rock-climbing"
}
```

**Example:**
```bash
curl -X POST "https://activities.rtxsecured.com/admin/activities/add?property=cabin-13" \
  -H "Content-Type: application/json" \
  -d '{
    "slug": "rock-climbing",
    "label": "Rock Climbing",
    "risk": "high"
  }'
```

---

#### POST /admin/activities/update

**Description:** Update an existing activity's label or risk level.

**Query Parameters:**
- `property` (optional): Property ID (defaults to "cabin-12")

**Request Body:**
```json
{
  "slug": "kayaking",
  "label": "Advanced Kayaking",
  "risk": "medium"
}
```

**Response:**
```json
{
  "ok": true,
  "propertyId": "cabin-13",
  "activities": [...],
  "updated": "kayaking"
}
```

**Example:**
```bash
curl -X POST "https://activities.rtxsecured.com/admin/activities/update?property=cabin-13" \
  -H "Content-Type: application/json" \
  -d '{
    "slug": "kayaking",
    "risk": "medium"
  }'
```

---

#### POST /admin/activities/remove

**Description:** Remove an activity from a property.

**Query Parameters:**
- `property` (optional): Property ID (defaults to "cabin-12")

**Request Body:**
```json
{
  "slug": "rock-climbing"
}
```

**Response:**
```json
{
  "ok": true,
  "propertyId": "cabin-13",
  "activities": [...],
  "removed": "rock-climbing"
}
```

**Example:**
```bash
curl -X POST "https://activities.rtxsecured.com/admin/activities/remove?property=cabin-13" \
  -H "Content-Type: application/json" \
  -d '{"slug": "rock-climbing"}'
```

---

#### POST /admin/activities

**Description:** Replace all activities for a property.

**Query Parameters:**
- `property` (optional): Property ID (defaults to "cabin-12")

**Request Body:**
```json
{
  "activities": [
    {
      "slug": "kayaking",
      "label": "Kayaking",
      "risk": "low"
    },
    {
      "slug": "ziplining",
      "label": "Ziplining",
      "risk": "medium"
    }
  ]
}
```

**Response:**
```json
{
  "ok": true,
  "propertyId": "cabin-13",
  "activities": [...]
}
```

**Example:**
```bash
curl -X POST "https://activities.rtxsecured.com/admin/activities?property=cabin-13" \
  -H "Content-Type: application/json" \
  -d '{
    "activities": [
      {"slug": "kayaking", "label": "Kayaking", "risk": "low"}
    ]
  }'
```

---

### Risk Levels Management

#### GET /admin/risks

**Description:** Get all risk level definitions.

**Response:**
```json
{
  "ok": true,
  "risks": {
    "low": {
      "level": "low",
      "title": "Low Risk",
      "description": "Suitable for all ages and fitness levels. Basic safety equipment provided."
    },
    "medium": {
      "level": "medium",
      "title": "Medium Risk",
      "description": "Moderate physical activity. Some experience recommended."
    },
    "high": {
      "level": "high",
      "title": "High Risk",
      "description": "Advanced activity. Significant physical demands and safety risks."
    }
  }
}
```

**Example:**
```bash
curl https://activities.rtxsecured.com/admin/risks
```

---

#### GET /admin/risks?level={level}

**Description:** Get a specific risk level definition.

**Query Parameters:**
- `level` (required): Risk level (low, medium, or high)

**Response:**
```json
{
  "ok": true,
  "risk": {
    "level": "low",
    "title": "Low Risk",
    "description": "Suitable for all ages and fitness levels."
  }
}
```

**Example:**
```bash
curl "https://activities.rtxsecured.com/admin/risks?level=low"
```

---

#### POST /admin/risks

**Description:** Update a risk level definition.

**Request Body:**
```json
{
  "level": "low",
  "title": "Low Risk",
  "description": "Suitable for all ages and fitness levels. Basic safety equipment provided."
}
```

**Response:**
```json
{
  "ok": true,
  "risk": {
    "level": "low",
    "title": "Low Risk",
    "description": "Suitable for all ages and fitness levels. Basic safety equipment provided."
  }
}
```

**Example:**
```bash
curl -X POST https://activities.rtxsecured.com/admin/risks \
  -H "Content-Type: application/json" \
  -d '{
    "level": "low",
    "title": "Low Risk",
    "description": "Updated description here"
  }'
```

---

### Document Management

#### GET /admin/document

**Description:** Get document metadata by submission ID and activity.

**Query Parameters:**
- `submission` (required): Submission ID
- `activity` (required): Activity slug

**Response:**
```json
{
  "ok": true,
  "document_id": 84,
  "r2_key": "waivers/cabin-13_kayaking_20251015_abc123.pdf"
}
```

**Example:**
```bash
curl "https://activities.rtxsecured.com/admin/document?submission=42&activity=kayaking"
```

---

#### GET /admin/download-all

**Description:** Download all waiver PDFs for a submission as a ZIP file.

**Query Parameters:**
- `submission` (required): Submission ID

**Response:** Binary ZIP file

**Example:**
```bash
curl "https://activities.rtxsecured.com/admin/download-all?submission=42" -o waivers.zip
```

---

### Release Management

#### GET /admin/releases

**Description:** Get all waiver text releases (versioned legal text).

**Response:**
```json
{
  "ok": true,
  "current": {
    "version": "1.0.2",
    "release_date": "2025-10-01",
    "waiver_text": "By signing this waiver...",
    "created_at": "2025-10-01T10:00:00.000Z"
  },
  "releases": [
    {
      "version": "1.0.2",
      "release_date": "2025-10-01",
      "waiver_text": "By signing this waiver...",
      "created_at": "2025-10-01T10:00:00.000Z"
    },
    {
      "version": "1.0.1",
      "release_date": "2025-09-15",
      "waiver_text": "Previous version...",
      "created_at": "2025-09-15T14:00:00.000Z"
    }
  ]
}
```

**Example:**
```bash
curl https://activities.rtxsecured.com/admin/releases
```

---

#### POST /admin/releases/create

**Description:** Create a new waiver text release. Version is auto-incremented if not provided.

**Request Body:**
```json
{
  "version": "1.0.3",
  "waiver_text": "Updated legal waiver text here..."
}
```

**Notes:**
- If `version` is omitted, it will auto-increment from the latest version
- Version must follow semantic versioning format: X.Y.Z
- Version must be unique

**Response:**
```json
{
  "ok": true,
  "version": "1.0.3",
  "release_date": "2025-10-01"
}
```

**Example:**
```bash
curl -X POST https://activities.rtxsecured.com/admin/releases/create \
  -H "Content-Type: application/json" \
  -d '{
    "waiver_text": "Updated legal text..."
  }'
```

---

### Document Verification

#### GET /admin/verify

**Description:** Verify document integrity by comparing stored hash with computed hash.

**Query Parameters:**
- `document` (required): Document ID

**Response:**
```json
{
  "ok": true,
  "verified": true,
  "stored_hash": "abc123def456...",
  "computed_hash": "abc123def456..."
}
```

**Notes:**
- Documents are hashed using SHA-256
- Hash includes: submission data, activity, initials, signature, and release version
- Used to verify documents haven't been tampered with

**Example:**
```bash
curl "https://activities.rtxsecured.com/admin/verify?document=84"
```
</file>

<file path="migrations/0008_add_error_message.sql">
-- Add error_message column to submissions table for async processing failures
ALTER TABLE submissions ADD COLUMN error_message TEXT;

-- Status values:
--   'pending' - Awaiting verification
--   'processing' - PDF generation in progress
--   'emailed' - PDFs generated and emailed successfully
--   'completed' - Legacy/dev mode completion
--   'failed' - PDF generation or email sending failed
</file>

<file path="migrations/backup.sql">
-- Complete database schema backup
-- Generated from production database schema
-- This file represents the current state of the database

-- =====================================================
-- Submissions Table
-- =====================================================
-- Stores waiver submission metadata
CREATE TABLE IF NOT EXISTS submissions (
  submission_id TEXT PRIMARY KEY,
  created_at TEXT NOT NULL,
  property_id TEXT NOT NULL,
  checkin_date TEXT NOT NULL,
  guest_name TEXT NOT NULL,
  guest_email TEXT NOT NULL,
  activities TEXT NOT NULL
);

-- =====================================================
-- Documents Table
-- =====================================================
-- Stores individual waiver documents (one per activity per submission)
CREATE TABLE IF NOT EXISTS documents (
  document_id TEXT PRIMARY KEY,
  submission_id TEXT NOT NULL,
  activity TEXT NOT NULL,
  r2_key TEXT NOT NULL,
  initials TEXT,
  FOREIGN KEY (submission_id) REFERENCES submissions(submission_id) ON DELETE CASCADE
);

-- =====================================================
-- Hashes Table
-- =====================================================
-- Stores cryptographic hashes for document integrity verification
CREATE TABLE IF NOT EXISTS hashes (
  hash_id TEXT PRIMARY KEY,
  document_id TEXT NOT NULL UNIQUE,
  hash_value TEXT NOT NULL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE
);

-- Index for faster hash lookups
CREATE INDEX IF NOT EXISTS idx_hashes_document_id ON hashes(document_id);
CREATE INDEX IF NOT EXISTS idx_hashes_hash_value ON hashes(hash_value);

-- =====================================================
-- Releases Table
-- =====================================================
-- Stores versioned legal waiver text
CREATE TABLE IF NOT EXISTS releases (
  version TEXT PRIMARY KEY,
  release_date TEXT NOT NULL,
  waiver_text TEXT NOT NULL,
  created_at TEXT NOT NULL
);

-- Index for faster release lookups by date
CREATE INDEX IF NOT EXISTS idx_releases_date ON releases(release_date DESC);

-- =====================================================
-- Notes
-- =====================================================
-- 1. All text IDs use nanoid for generation
-- 2. Foreign keys cascade on delete to maintain referential integrity
-- 3. Hash values are SHA-256 hashes of document metadata
-- 4. Release versions follow semantic versioning (X.Y.Z)
-- 5. Timestamps are stored as ISO 8601 strings
</file>

<file path="migrations/schema_full.sql">
-- =============================================================================
-- Waiver Management System - Complete Database Schema
-- =============================================================================
-- This file represents the complete database schema including all migrations
-- Generated: 2025-10-07
--
-- WARNING: Running this will DROP ALL TABLES and recreate them
-- All existing data will be lost. Use only for clean installations.
-- =============================================================================

-- Drop existing tables (in reverse dependency order)
DROP TABLE IF EXISTS submission_activities;
DROP TABLE IF EXISTS hashes;
DROP TABLE IF EXISTS documents;
DROP TABLE IF EXISTS activities;
DROP TABLE IF EXISTS risk_descriptions;
DROP TABLE IF EXISTS properties;
DROP TABLE IF EXISTS releases;
DROP TABLE IF EXISTS submissions;

-- =============================================================================
-- Core Tables
-- =============================================================================

-- Submissions table: One row per waiver form submission
-- All submissions now require verification_token (two-step flow only)
-- Status values:
--   'pending' - Awaiting verification
--   'processing' - PDF generation in progress
--   'emailed' - PDFs generated and emailed successfully
--   'completed' - Legacy/dev mode completion
--   'failed' - PDF generation or email sending failed
CREATE TABLE submissions (
  submission_id TEXT PRIMARY KEY,
  created_at TEXT NOT NULL,
  property_id TEXT NOT NULL,
  checkin_date TEXT NOT NULL,
  guest_name TEXT NOT NULL,
  guest_email TEXT NOT NULL,
  activities TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  verification_token TEXT NOT NULL UNIQUE,
  token_expires_at TEXT NOT NULL,
  completed_at TEXT,
  error_message TEXT
);

-- Documents table: One row per generated PDF waiver document (legacy)
CREATE TABLE documents (
  document_id TEXT PRIMARY KEY,
  submission_id TEXT NOT NULL,
  activity TEXT NOT NULL,
  r2_key TEXT NOT NULL,
  initials TEXT,
  FOREIGN KEY (submission_id) REFERENCES submissions(submission_id) ON DELETE CASCADE
);

-- Hashes table: Document verification via SHA-256 hashing (legacy)
CREATE TABLE hashes (
  hash_id TEXT PRIMARY KEY,
  document_id TEXT NOT NULL UNIQUE,
  hash_value TEXT NOT NULL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE
);

-- Submission Activities table: Activities linked to submissions via verification token
CREATE TABLE submission_activities (
  activity_id TEXT PRIMARY KEY,
  verification_token TEXT NOT NULL,
  activity_slug TEXT NOT NULL,
  activity_label TEXT NOT NULL,
  initials TEXT NOT NULL,
  document_hash TEXT NOT NULL,
  r2_key TEXT NOT NULL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (verification_token) REFERENCES submissions(verification_token) ON DELETE CASCADE
);

-- Releases table: Versioned waiver legal text
CREATE TABLE releases (
  version TEXT PRIMARY KEY,
  release_date TEXT NOT NULL,
  waiver_text TEXT NOT NULL,
  created_at TEXT NOT NULL
);

-- =============================================================================
-- Configuration Tables
-- =============================================================================

-- Properties table: Stores property information
CREATE TABLE properties (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  created_at TEXT NOT NULL
);

-- Activities table: Stores available activities for each property
CREATE TABLE activities (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  property_id TEXT NOT NULL,
  slug TEXT NOT NULL,
  label TEXT NOT NULL,
  risk TEXT,
  created_at TEXT NOT NULL,
  FOREIGN KEY (property_id) REFERENCES properties(id) ON DELETE CASCADE,
  UNIQUE (property_id, slug)
);

-- Risk descriptions table: Stores risk level descriptions
CREATE TABLE risk_descriptions (
  level TEXT PRIMARY KEY,
  description TEXT NOT NULL,
  created_at TEXT NOT NULL
);

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

-- Submissions indexes
CREATE INDEX idx_search ON submissions(guest_name, guest_email, property_id, checkin_date);
CREATE INDEX idx_submissions_token ON submissions(verification_token);
CREATE INDEX idx_submissions_status ON submissions(status);
CREATE UNIQUE INDEX idx_submissions_verification_token_unique ON submissions(verification_token) WHERE verification_token IS NOT NULL;

-- Documents and hashes indexes (legacy)
CREATE INDEX idx_hashes_document_id ON hashes(document_id);
CREATE INDEX idx_hashes_hash_value ON hashes(hash_value);

-- Submission activities indexes
CREATE INDEX idx_activities_token ON submission_activities(verification_token);
CREATE INDEX idx_activities_hash ON submission_activities(document_hash);
CREATE INDEX idx_activities_activity ON submission_activities(activity_slug);

-- Releases indexes
CREATE INDEX idx_releases_date ON releases(release_date DESC);

-- Activities indexes
CREATE INDEX idx_activities_property_id ON activities(property_id);
CREATE INDEX idx_activities_slug ON activities(slug);

-- =============================================================================
-- Seed Data
-- =============================================================================

-- Insert default property (serves as template)
INSERT INTO properties (id, name, created_at)
VALUES ('default', 'Default Activity Template', datetime('now'));

-- Insert default activities template
INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES
  ('default', 'archery', 'Archery', 'low', datetime('now')),
  ('default', 'kayaking', 'Kayaking', 'low', datetime('now')),
  ('default', 'ziplining', 'Ziplining', 'medium', datetime('now')),
  ('default', 'snorkeling', 'Snorkeling', 'low', datetime('now')),
  ('default', 'safari-tour', 'Safari Tour', 'low', datetime('now')),
  ('default', 'boat-tour', 'Boat Tour', 'low', datetime('now')),
  ('default', 'spelunking', 'Spelunking', 'medium', datetime('now')),
  ('default', 'scuba-diving', 'Scuba Diving', 'medium', datetime('now')),
  ('default', 'paragliding', 'Paragliding', 'high', datetime('now')),
  ('default', 'bungee-jumping', 'Bungee Jumping', 'high', datetime('now'));

-- Insert property: Riverside Cabin 12
INSERT INTO properties (id, name, created_at)
VALUES ('cabin-12', 'Riverside Cabin 12', datetime('now'));

-- Insert activities for cabin-12
INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES
  ('cabin-12', 'archery', 'Archery', 'low', datetime('now')),
  ('cabin-12', 'kayaking', 'Kayaking', 'low', datetime('now')),
  ('cabin-12', 'ziplining', 'Ziplining', 'medium', datetime('now')),
  ('cabin-12', 'snorkeling', 'Snorkeling', 'low', datetime('now')),
  ('cabin-12', 'safari-tour', 'Safari Tour', 'low', datetime('now')),
  ('cabin-12', 'boat-tour', 'Boat Tour', 'low', datetime('now')),
  ('cabin-12', 'spelunking', 'Spelunking', 'medium', datetime('now')),
  ('cabin-12', 'scuba-diving', 'Scuba Diving', 'medium', datetime('now')),
  ('cabin-12', 'paragliding', 'Paragliding', 'high', datetime('now')),
  ('cabin-12', 'bungee-jumping', 'Bungee Jumping', 'high', datetime('now'));

-- Insert risk descriptions
INSERT INTO risk_descriptions (level, description, created_at) VALUES
  ('low', 'Low-risk activities with minimal physical demands and safety measures in place.', datetime('now')),
  ('medium', 'Moderate-risk activities requiring basic fitness and adherence to safety protocols.', datetime('now')),
  ('high', 'High-risk activities involving significant physical challenges, heights, or potential for injury.', datetime('now'));

-- =============================================================================
-- Schema Notes
-- =============================================================================
--
-- Table Relationships:
-- 1. submissions -> submission_activities (via verification_token)
-- 2. submissions -> documents (via submission_id) [legacy]
-- 3. documents -> hashes (via document_id) [legacy]
-- 4. properties -> activities (via property_id)
--
-- Two-step Submission Flow:
-- 1. Initial submission creates pending record with verification_token
-- 2. Email verification leads to completion with status='completed'
-- 3. Activities saved to submission_activities table
-- 4. For backward compatibility, also saved to documents/hashes tables
--
-- =============================================================================
</file>

<file path="scripts/test-batch-pdf.js">
#!/usr/bin/env node

/**
 * Test script for batch PDF generation
 * Tests the hybrid single/batch approach with 10 activities
 *
 * NOTE: This test requires DEV_MODE=true in wrangler.toml to work
 * In dev mode, the verification URL is returned directly instead of being emailed
 *
 * Usage:
 *   node scripts/test-batch-pdf.js
 *   node scripts/test-batch-pdf.js --remote  (test against deployed worker)
 */

import crypto from 'crypto';

// Configuration
const TEST_EMAIL = 'lenkasomark@gmail.com';
const TEST_NAME = 'Test Batch User';
const PROPERTY_ID = 'cabin-12';  // Use actual property ID
const CHECKIN_DATE = new Date().toISOString().split('T')[0];

// 10 activities to test batch processing
const ACTIVITIES = [
  'archery',
  'kayaking',
  'rock-climbing',
  'zip-lining',
  'mountain-biking',
  'horseback-riding',
  'atv-riding',
  'fishing',
  'hiking',
  'swimming'
];

// Determine worker URL
const isRemote = process.argv.includes('--remote');
const WORKER_URL = isRemote
  ? 'https://activities.rtxsecured.com'
  : 'http://localhost:8787';

console.log(`\n🧪 Testing batch PDF generation with ${ACTIVITIES.length} activities`);
console.log(`📧 Email: ${TEST_EMAIL}`);
console.log(`🌍 Worker URL: ${WORKER_URL}`);
console.log(`⏱️  Starting test...\n`);

// Generate test signature (base64 PNG)
function generateTestSignature() {
  // Minimal 1x1 transparent PNG
  const pngData = Buffer.from([
    0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, // PNG signature
    0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, // IHDR chunk
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
    0x08, 0x06, 0x00, 0x00, 0x00, 0x1F, 0x15, 0xC4,
    0x89, 0x00, 0x00, 0x00, 0x0A, 0x49, 0x44, 0x41,
    0x54, 0x78, 0x9C, 0x63, 0x00, 0x01, 0x00, 0x00,
    0x05, 0x00, 0x01, 0x0D, 0x0A, 0x2D, 0xB4, 0x00,
    0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE,
    0x42, 0x60, 0x82
  ]);
  return `data:image/png;base64,${pngData.toString('base64')}`;
}

// Generate initials for all activities
function generateInitials() {
  const initials = {};
  ACTIVITIES.forEach(act => {
    initials[act] = 'TB';  // Test Batch
  });
  return initials;
}

async function testBatchPdfGeneration() {
  const startTime = Date.now();

  try {
    // Step 1: Submit initial form
    console.log('📝 Step 1: Submitting initial form...');
    const submitResponse = await fetch(`${WORKER_URL}/submit/initial`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        propertyId: PROPERTY_ID,
        checkinDate: CHECKIN_DATE,
        guestName: TEST_NAME,
        guestEmail: TEST_EMAIL,
        activities: ACTIVITIES
      })
    });

    if (!submitResponse.ok) {
      const errorText = await submitResponse.text();
      throw new Error(`Initial submit failed: ${submitResponse.status} - ${errorText}`);
    }

    const submitResult = await submitResponse.json();

    if (!submitResult.ok) {
      throw new Error(`Submit failed: ${submitResult.error || 'Unknown error'}`);
    }

    // In dev mode, we get verificationUrl directly. In production, check email.
    let verificationToken;
    if (submitResult.devMode && submitResult.verificationUrl) {
      const url = new URL(submitResult.verificationUrl);
      verificationToken = url.searchParams.get('token');
      console.log(`✅ Verification token received (dev mode): ${verificationToken.substring(0, 20)}...`);
    } else {
      console.log(`✅ Submission created: ${submitResult.submissionId}`);
      console.log(`📧 Verification email sent to ${TEST_EMAIL}`);
      console.log(`\n⚠️  This test requires DEV_MODE=true to continue automatically.`);
      console.log(`   Please check your email for the verification link, or enable DEV_MODE in wrangler.toml`);
      process.exit(0);
    }

    // Step 2: Complete submission with signature and initials
    console.log('\n📝 Step 2: Completing submission with signature and initials...');
    const completeResponse = await fetch(`${WORKER_URL}/submit/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        verificationToken,
        signature: generateTestSignature(),
        initials: generateInitials(),
        activities: ACTIVITIES
      })
    });

    if (!completeResponse.ok) {
      const errorText = await completeResponse.text();
      throw new Error(`Complete submit failed: ${completeResponse.status} - ${errorText}`);
    }

    const result = await completeResponse.json();
    const endTime = Date.now();
    const duration = ((endTime - startTime) / 1000).toFixed(2);

    console.log('\n✅ SUCCESS! Batch PDF generation completed');
    console.log(`⏱️  Total time: ${duration} seconds`);
    console.log(`📄 PDFs generated: ${result.pdfs?.length || 0}`);

    if (result.pdfs && result.pdfs.length > 0) {
      console.log('\n📋 Generated PDFs:');
      result.pdfs.forEach((pdf, index) => {
        console.log(`  ${index + 1}. ${pdf.activity} (${pdf.filename})`);
      });
    }

    console.log(`\n📧 Check email at ${TEST_EMAIL} for the waivers`);
    console.log(`🔍 Submission ID: ${result.submissionId || 'N/A'}`);

    return result;

  } catch (error) {
    const endTime = Date.now();
    const duration = ((endTime - startTime) / 1000).toFixed(2);

    console.error('\n❌ TEST FAILED');
    console.error(`⏱️  Failed after ${duration} seconds`);
    console.error(`Error: ${error.message}`);

    if (error.stack) {
      console.error('\nStack trace:');
      console.error(error.stack);
    }

    process.exit(1);
  }
}

// Run the test
testBatchPdfGeneration();
</file>

<file path="src/routes/admin/activities.js">
import { json } from '../../utils/admin.js';

export async function handleAdminActivities(request, env) {
  const url = new URL(request.url);
  const { pathname } = url;
  const propertyId = url.searchParams.get('property') || 'cabin-12';

  if (request.method === 'GET') {
    return await getActivities(env, propertyId);
  }

  if (request.method === 'POST') {
    if (pathname === '/admin/activities/add') {
      return await addActivity(request, env, propertyId);
    }
    if (pathname === '/admin/activities/remove') {
      return await removeActivity(request, env, propertyId);
    }
    if (pathname === '/admin/activities/update') {
      return await updateActivity(request, env, propertyId);
    }
    return await replaceAllActivities(request, env, propertyId);
  }

  return new Response('Method not allowed', { status: 405 });
}

async function getActivities(env, propertyId) {
  const result = await env.waivers.prepare(
    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'
  ).bind(propertyId).all();

  return json({ ok: true, propertyId, activities: result.results || [] });
}

async function addActivity(request, env, propertyId) {
  const data = await request.json();

  if (!data.slug || !data.label || !data.risk) {
    return json({ ok: false, error: 'Must provide slug, label, and risk' }, 400);
  }

  const existingCheck = await env.waivers.prepare(
    'SELECT id FROM activities WHERE property_id = ? AND slug = ?'
  ).bind(propertyId, data.slug).first();

  if (existingCheck) {
    return json({ ok: false, error: 'Activity with this slug already exists' }, 400);
  }

  await env.waivers.prepare(
    'INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)'
  ).bind(propertyId, data.slug, data.label, data.risk, new Date().toISOString()).run();

  const result = await env.waivers.prepare(
    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'
  ).bind(propertyId).all();

  return json({ ok: true, propertyId, activities: result.results || [], added: data.slug });
}

async function removeActivity(request, env, propertyId) {
  const data = await request.json();

  if (!data.slug) {
    return json({ ok: false, error: 'Must provide slug' }, 400);
  }

  const existingCheck = await env.waivers.prepare(
    'SELECT id FROM activities WHERE property_id = ? AND slug = ?'
  ).bind(propertyId, data.slug).first();

  if (!existingCheck) {
    return json({ ok: false, error: 'Activity not found' }, 404);
  }

  await env.waivers.prepare(
    'DELETE FROM activities WHERE property_id = ? AND slug = ?'
  ).bind(propertyId, data.slug).run();

  const result = await env.waivers.prepare(
    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'
  ).bind(propertyId).all();

  return json({ ok: true, propertyId, activities: result.results || [], removed: data.slug });
}

async function updateActivity(request, env, propertyId) {
  const data = await request.json();

  if (!data.slug) {
    return json({ ok: false, error: 'Must provide slug' }, 400);
  }

  const existingCheck = await env.waivers.prepare(
    'SELECT id FROM activities WHERE property_id = ? AND slug = ?'
  ).bind(propertyId, data.slug).first();

  if (!existingCheck) {
    return json({ ok: false, error: 'Activity not found' }, 404);
  }

  const updates = [];
  const bindings = [];

  if (data.label) {
    updates.push('label = ?');
    bindings.push(data.label);
  }
  if (data.risk) {
    updates.push('risk = ?');
    bindings.push(data.risk);
  }

  if (updates.length > 0) {
    bindings.push(propertyId, data.slug);
    await env.waivers.prepare(
      `UPDATE activities SET ${updates.join(', ')} WHERE property_id = ? AND slug = ?`
    ).bind(...bindings).run();
  }

  const result = await env.waivers.prepare(
    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'
  ).bind(propertyId).all();

  return json({ ok: true, propertyId, activities: result.results || [], updated: data.slug });
}

async function replaceAllActivities(request, env, propertyId) {
  const data = await request.json();

  if (!Array.isArray(data.activities)) {
    return json({ ok: false, error: 'activities must be an array' }, 400);
  }

  for (const activity of data.activities) {
    if (!activity.slug || !activity.label || !activity.risk) {
      return json({ ok: false, error: 'Each activity must have slug, label, and risk' }, 400);
    }
  }

  await env.waivers.prepare(
    'DELETE FROM activities WHERE property_id = ?'
  ).bind(propertyId).run();

  const timestamp = new Date().toISOString();
  for (const activity of data.activities) {
    await env.waivers.prepare(
      'INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)'
    ).bind(propertyId, activity.slug, activity.label, activity.risk, timestamp).run();
  }

  const result = await env.waivers.prepare(
    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'
  ).bind(propertyId).all();

  return json({ ok: true, propertyId, activities: result.results || [] });
}
</file>

<file path="src/routes/admin/api-docs.js">
import { readFileSync } from 'fs';
import { join } from 'path';

export async function handleAdminApiDocs() {
  try {
    // In Cloudflare Workers, we need to embed the content at build time
    // For now, we'll just return the markdown content directly
    const apiDocs = `# API Documentation

This document describes the public API endpoints for the waiver management system.

## Endpoints

### GET /

**Description:** Returns the HTML waiver form for guests to fill out and submit.

**Response:** HTML page with embedded property, activity, and risk data.

**Example:**
\`\`\`bash
curl https://activities.rtxsecured.com/
\`\`\`

---

### POST /submit

**Description:** Submits a completed waiver form with guest information, selected activities, initials, and signature.

**Request Body:**
\`\`\`json
{
  "propertyId": "cabin-13",
  "checkinDate": "2025-10-15",
  "guestName": "John Doe",
  "guestEmail": "john@example.com",
  "activities": ["kayaking", "ziplining", "archery"],
  "initials": {
    "kayaking": "JD",
    "ziplining": "JD",
    "archery": "JD"
  },
  "signature": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "accepted": true
}
\`\`\`

**Response (Production Mode):**
\`\`\`json
{
  "ok": true,
  "devMode": false,
  "emailed": [
    "cabin-13_kayaking_20251015.pdf",
    "cabin-13_ziplining_20251015.pdf",
    "cabin-13_archery_20251015.pdf"
  ],
  "pin": "1234"
}
\`\`\`

**Response (Development Mode):**
\`\`\`json
{
  "ok": true,
  "devMode": true,
  "downloads": [
    {
      "filename": "cabin-13_kayaking_20251015.pdf",
      "url": "/download/abc123def456"
    },
    {
      "filename": "cabin-13_ziplining_20251015.pdf",
      "url": "/download/def456ghi789"
    }
  ],
  "pin": "1234"
}
\`\`\`

**Notes:**
- The \`pin\` field is only included if the "archery" activity is selected
- In development mode (\`DEV_MODE=true\`), PDFs are generated and stored but not emailed
- In production mode, PDFs are emailed to the guest's email address

---

### GET /admin/search

**Description:** Search for waiver submissions by guest name or email.

**Query Parameters:**
- \`q\` (required): Search query string

**Response:**
\`\`\`json
{
  "ok": true,
  "results": [...]
}
\`\`\`

---

### GET /status

**Description:** Check the status of a waiver submission by ID.

**Query Parameters:**
- \`id\` (required): Submission ID

**Response:**
\`\`\`json
{
  "ok": true,
  "submission": {...},
  "documents": [...]
}
\`\`\`

---

## Admin Endpoints

### Properties Management

#### GET /admin/properties

List all configured properties.

#### POST /admin/properties/add

Add a new property.

#### POST /admin/properties/remove

Remove a property.

---

### Activities Management

#### GET /admin/activities

Get all activities for a specific property.

**Query Parameters:**
- \`property\` (optional): Property ID

#### POST /admin/activities/add

Add a new activity to a property.

#### POST /admin/activities/update

Update an existing activity.

#### POST /admin/activities/remove

Remove an activity from a property.

---

### Risk Levels Management

#### GET /admin/risks

Get all risk level definitions.

#### POST /admin/risks

Update a risk level definition.

---

### Document Management

#### GET /admin/document

Get document metadata by submission ID and activity.

**Query Parameters:**
- \`submission\` (required): Submission ID
- \`activity\` (required): Activity slug

#### GET /admin/download-all

Download all waiver PDFs for a submission as a ZIP file.

**Query Parameters:**
- \`submission\` (required): Submission ID

---

### Release Management

#### GET /admin/releases

Get all waiver text releases (versioned legal text).

#### POST /admin/releases/create

Create a new waiver text release.

**Request Body:**
\`\`\`json
{
  "version": "1.0.3",
  "waiver_text": "Updated legal waiver text..."
}
\`\`\`

**Notes:**
- If \`version\` is omitted, it will auto-increment from the latest version
- Version must follow semantic versioning format: X.Y.Z
- Version must be unique

---

### Document Verification

#### GET /admin/verify

Verify document integrity by comparing stored hash with computed hash.

**Query Parameters:**
- \`document\` (required): Document ID

**Response:**
\`\`\`json
{
  "ok": true,
  "verified": true,
  "stored_hash": "abc123...",
  "computed_hash": "abc123..."
}
\`\`\`

**Notes:**
- Documents are hashed using SHA-256
- Hash includes: submission data, activity, initials, signature, and release version
- Used to verify documents haven't been tampered with

---

### Debug Panel

#### GET /admin/debug

View KV store and D1 database tables for debugging.

**Query Parameters:**
- \`refresh\` (optional): Set to "true" to force refresh cached data

**Notes:**
- Data is cached for 7 days
- Shows all PROPS_KV keys and values
- Shows all D1 tables with up to 50 rows each
`;

    return new Response(apiDocs, {
      headers: {
        'Content-Type': 'text/plain; charset=utf-8'
      }
    });
  } catch (error) {
    return new Response('Error loading API documentation', { status: 500 });
  }
}
</file>

<file path="src/routes/admin/debug.js">
import { json } from '../../utils/admin.js';

const CACHE_KEY = 'admin_debug_cache';
const CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds

export async function handleAdminDebug(request, env) {
  const url = new URL(request.url);
  const forceRefresh = url.searchParams.get('refresh') === 'true';

  try {
    // Fetch fresh data from database
    const debugData = {
      timestamp: Date.now(),
      d1: {}
    };

    // Get all D1 tables
    const tables = await env.waivers.prepare(
      "SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE '_cf_%' ORDER BY name"
    ).all();

    for (const table of tables.results) {
      const tableName = table.name;

      // Get count
      const countResult = await env.waivers.prepare(
        `SELECT COUNT(*) as count FROM ${tableName}`
      ).first();

      // Get rows
      const rowsResult = await env.waivers.prepare(
        `SELECT * FROM ${tableName} LIMIT 50`
      ).all();

      debugData.d1[tableName] = {
        count: countResult.count,
        rows: rowsResult.results || []
      };
    }

    return json({
      ok: true,
      lastUpdate: new Date(debugData.timestamp).toISOString(),
      d1: debugData.d1
    });

  } catch (error) {
    console.error('Debug data error:', error);
    return json({ ok: false, error: error.message }, 500);
  }
}
</file>

<file path="src/routes/admin/document.js">
import { json } from '../../utils/admin.js';

export async function handleAdminDocument(request, env) {
  const url = new URL(request.url);
  const submissionId = url.searchParams.get('submission');
  const activity = url.searchParams.get('activity');

  if (!submissionId || !activity) {
    return json({ ok: false, error: 'Missing submission or activity' }, 400);
  }

  try {
    const result = await env.waivers.prepare(
      'SELECT document_id, r2_key FROM documents WHERE submission_id = ?1 AND activity = ?2'
    ).bind(submissionId, activity).first();

    if (!result) {
      return json({ ok: false, error: 'Document not found' }, 404);
    }

    return json({
      ok: true,
      document_id: result.document_id,
      r2_key: result.r2_key
    });
  } catch (error) {
    return json({ ok: false, error: error.message }, 500);
  }
}
</file>

<file path="src/routes/admin/download-all.js">
export async function handleAdminDownloadAll(request, env) {
  const url = new URL(request.url);
  const submissionId = url.searchParams.get('submission');

  if (!submissionId) {
    return new Response('Missing submission ID', { status: 400 });
  }

  try {
    // Get all documents for this submission
    const documents = await env.waivers.prepare(
      'SELECT document_id, activity, r2_key FROM documents WHERE submission_id = ?1'
    ).bind(submissionId).all();

    if (!documents.results || documents.results.length === 0) {
      return new Response('No documents found', { status: 404 });
    }

    // Get submission info for filename
    const submission = await env.waivers.prepare(
      'SELECT guest_name, checkin_date FROM submissions WHERE submission_id = ?1'
    ).bind(submissionId).first();

    // For now, we'll use fflate to create a zip file
    // Import at the top of the file when we add it
    const { zipSync, strToU8 } = await import('fflate');

    const files = {};

    // Fetch all PDFs from R2
    for (const doc of documents.results) {
      const obj = await env.WAIVERS_R2.get(doc.r2_key);
      if (obj) {
        const arrayBuffer = await obj.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);
        files[`${doc.activity}-waiver.pdf`] = uint8Array;
      }
    }

    // Create zip file
    const zipped = zipSync(files, { level: 6 });

    // Create filename from guest name and date
    const guestName = submission.guest_name.replace(/[^a-zA-Z0-9]/g, '-');
    const filename = `${guestName}-${submission.checkin_date}-waivers.zip`;

    return new Response(zipped, {
      headers: {
        'Content-Type': 'application/zip',
        'Content-Disposition': `attachment; filename="${filename}"`
      }
    });
  } catch (error) {
    console.error('Error creating zip:', error);
    return new Response('Error creating zip file: ' + error.message, { status: 500 });
  }
}
</file>

<file path="src/routes/admin/properties.js">
import { json } from '../../utils/admin.js';

export async function handleAdminProperties(request, env) {
  const url = new URL(request.url);
  const { pathname } = url;

  if (request.method === 'GET') {
    return await getProperties(env);
  }

  if (request.method === 'POST') {
    if (pathname === '/admin/properties/add') {
      return await addProperty(request, env);
    }
    if (pathname === '/admin/properties/remove') {
      return await removeProperty(request, env);
    }
  }

  return new Response('Method not allowed', { status: 405 });
}

async function getProperties(env) {
  const result = await env.waivers.prepare(
    'SELECT id, name FROM properties WHERE id != ? ORDER BY name'
  ).bind('default').all();

  return json({ ok: true, properties: result.results || [] });
}

async function addProperty(request, env) {
  const data = await request.json();

  if (!data.id || !data.name) {
    return json({ ok: false, error: 'Must provide id and name' }, 400);
  }

  const existingCheck = await env.waivers.prepare(
    'SELECT id FROM properties WHERE id = ?'
  ).bind(data.id).first();

  if (existingCheck) {
    return json({ ok: false, error: 'Property with this ID already exists' }, 400);
  }

  await env.waivers.prepare(
    'INSERT INTO properties (id, name, created_at) VALUES (?, ?, ?)'
  ).bind(data.id, data.name, new Date().toISOString()).run();

  if (data.copyDefaultActivities) {
    const defaultActivities = await env.waivers.prepare(
      'SELECT slug, label, risk FROM activities WHERE property_id = ?'
    ).bind('default').all();

    for (const activity of (defaultActivities.results || [])) {
      await env.waivers.prepare(
        'INSERT INTO activities (property_id, slug, label, risk, created_at) VALUES (?, ?, ?, ?, ?)'
      ).bind(data.id, activity.slug, activity.label, activity.risk, new Date().toISOString()).run();
    }
  }

  const result = await env.waivers.prepare(
    'SELECT id, name FROM properties WHERE id != ? ORDER BY name'
  ).bind('default').all();

  return json({ ok: true, properties: result.results || [], added: data.id });
}

async function removeProperty(request, env) {
  const data = await request.json();

  if (!data.id) {
    return json({ ok: false, error: 'Must provide id' }, 400);
  }

  const countResult = await env.waivers.prepare(
    'SELECT COUNT(*) as count FROM properties WHERE id != ?'
  ).bind('default').first();

  if (countResult.count <= 1) {
    return json({ ok: false, error: 'Cannot delete the last property' }, 400);
  }

  if (data.id === 'default') {
    return json({ ok: false, error: 'Cannot delete the default property template' }, 400);
  }

  const existingCheck = await env.waivers.prepare(
    'SELECT id FROM properties WHERE id = ?'
  ).bind(data.id).first();

  if (!existingCheck) {
    return json({ ok: false, error: 'Property not found' }, 404);
  }

  await env.waivers.prepare(
    'DELETE FROM properties WHERE id = ?'
  ).bind(data.id).run();

  const result = await env.waivers.prepare(
    'SELECT id, name FROM properties WHERE id != ? ORDER BY name'
  ).bind('default').all();

  return json({ ok: true, properties: result.results || [], removed: data.id });
}
</file>

<file path="src/routes/admin/releases.js">
import { json } from '../../utils/admin.js';

async function getLatestRelease(env) {
  return await env.waivers.prepare(
    'SELECT version, release_date, waiver_text, created_at FROM releases ORDER BY release_date DESC, version DESC LIMIT 1'
  ).first();
}

async function getAllReleases(env) {
  const result = await env.waivers.prepare(
    'SELECT version, release_date, waiver_text, created_at FROM releases ORDER BY release_date DESC, version DESC'
  ).all();
  return result.results || [];
}

function incrementVersion(version) {
  if (!version) return '1.0.0';

  const parts = version.split('.');
  if (parts.length !== 3) return '1.0.0';

  const [major, minor, patch] = parts.map(Number);
  return `${major}.${minor}.${patch + 1}`;
}

export async function handleAdminReleases(request, env) {
  const url = new URL(request.url);
  const pathname = url.pathname;

  // GET /admin/releases - Get all releases
  if (request.method === 'GET' && pathname === '/admin/releases') {
    try {
      const current = await getLatestRelease(env);
      const releases = await getAllReleases(env);

      return json({
        ok: true,
        current,
        releases
      });
    } catch (error) {
      return json({ ok: false, error: error.message }, 500);
    }
  }

  // POST /admin/releases/create - Create new release
  if (request.method === 'POST' && pathname === '/admin/releases/create') {
    try {
      const data = await request.json();
      const { version, waiver_text } = data;

      if (!waiver_text || !waiver_text.trim()) {
        return json({ ok: false, error: 'Waiver text is required' }, 400);
      }

      let finalVersion = version;

      // Auto-increment if no version specified
      if (!finalVersion) {
        const latest = await getLatestRelease(env);
        finalVersion = incrementVersion(latest?.version);
      }

      // Validate version format
      if (!/^[0-9]+\.[0-9]+\.[0-9]+$/.test(finalVersion)) {
        return json({ ok: false, error: 'Invalid version format. Must be X.Y.Z (e.g., 1.0.1)' }, 400);
      }

      // Check if version already exists
      const existing = await env.waivers.prepare(
        'SELECT version FROM releases WHERE version = ?1'
      ).bind(finalVersion).first();

      if (existing) {
        return json({ ok: false, error: `Version ${finalVersion} already exists` }, 400);
      }

      // Insert new release
      const now = new Date();
      const releaseDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
      const createdAt = now.toISOString();

      await env.waivers.prepare(
        'INSERT INTO releases (version, release_date, waiver_text, created_at) VALUES (?1, ?2, ?3, ?4)'
      ).bind(finalVersion, releaseDate, waiver_text.trim(), createdAt).run();

      return json({
        ok: true,
        version: finalVersion,
        release_date: releaseDate
      });
    } catch (error) {
      return json({ ok: false, error: error.message }, 500);
    }
  }

  return json({ ok: false, error: 'Not found' }, 404);
}
</file>

<file path="src/routes/admin/risks.js">
import { json } from '../../utils/admin.js';

export async function handleAdminRisks(request, env) {
  const url = new URL(request.url);
  const level = url.searchParams.get('level');

  if (request.method === 'GET') {
    if (level) {
      return await getRisk(env, level);
    }
    return await getAllRisks(env);
  }

  if (request.method === 'POST') {
    return await updateRisk(request, env);
  }

  return new Response('Method not allowed', { status: 405 });
}

async function getAllRisks(env) {
  const result = await env.waivers.prepare(
    'SELECT level, description FROM risk_descriptions'
  ).all();

  const risks = {};
  for (const row of (result.results || [])) {
    risks[row.level] = { level: row.level, description: row.description };
  }

  return json({ ok: true, risks });
}

async function getRisk(env, level) {
  const result = await env.waivers.prepare(
    'SELECT level, description FROM risk_descriptions WHERE level = ?'
  ).bind(level).first();

  if (!result) {
    return json({ ok: false, error: 'Risk level not found' }, 404);
  }

  return json({ ok: true, risk: { level: result.level, description: result.description } });
}

async function updateRisk(request, env) {
  const data = await request.json();

  if (!data.level || !data.description) {
    return json({ ok: false, error: 'Must provide level and description' }, 400);
  }

  if (!['low', 'medium', 'high'].includes(data.level)) {
    return json({ ok: false, error: 'level must be low, medium, or high' }, 400);
  }

  const existingCheck = await env.waivers.prepare(
    'SELECT level FROM risk_descriptions WHERE level = ?'
  ).bind(data.level).first();

  if (existingCheck) {
    await env.waivers.prepare(
      'UPDATE risk_descriptions SET description = ? WHERE level = ?'
    ).bind(data.description, data.level).run();
  } else {
    await env.waivers.prepare(
      'INSERT INTO risk_descriptions (level, description, created_at) VALUES (?, ?, ?)'
    ).bind(data.level, data.description, new Date().toISOString()).run();
  }

  const riskData = {
    level: data.level,
    description: data.description
  };

  return json({ ok: true, risk: riskData });
}
</file>

<file path="src/routes/admin/search.js">
import { json } from '../../utils/admin.js';

export async function handleAdminSearch(request, env) {
  const url = new URL(request.url);
  const qName     = url.searchParams.get('name')     ?? '';
  const qEmail    = url.searchParams.get('email')    ?? '';
  const qProp     = url.searchParams.get('prop')     ?? '';
  const qDate     = url.searchParams.get('date')     ?? '';
  const qActivity = url.searchParams.get('activity') ?? '';

  const conditions = [];
  const params = [];

  if (qName) {
    conditions.push('guest_name LIKE ?');
    params.push(`%${qName}%`);
  }

  if (qEmail) {
    conditions.push('guest_email LIKE ?');
    params.push(`%${qEmail}%`);
  }

  if (qProp) {
    conditions.push('property_id LIKE ?');
    params.push(`%${qProp}%`);
  }

  if (qDate) {
    conditions.push('checkin_date LIKE ?');
    params.push(`%${qDate}%`);
  }

  // If searching by activity, we need to join with submission_activities table
  if (qActivity) {
    // Build query to join with submission_activities
    const baseConditions = conditions.slice(); // Copy existing conditions
    const baseParams = params.slice();

    const whereClause = baseConditions.length > 0
      ? `WHERE ${baseConditions.join(' AND ')}`
      : '';

    const query = `
      SELECT DISTINCT s.*
      FROM submissions s
      LEFT JOIN submission_activities sa ON s.verification_token = sa.verification_token
      ${whereClause}
      ${baseConditions.length > 0 ? 'AND' : 'WHERE'} (
        s.activities LIKE ? OR sa.activity_slug LIKE ?
      )
      ORDER BY s.created_at DESC
      LIMIT 200
    `;

    const allParams = [...baseParams, `%${qActivity}%`, `%${qActivity}%`];
    const rows = await env.waivers.prepare(query).bind(...allParams).all();
    return json({ rows });
  }

  const whereClause = conditions.length > 0
    ? `WHERE ${conditions.join(' AND ')}`
    : '';

  const query = `SELECT * FROM submissions
                 ${whereClause}
                 ORDER BY created_at DESC
                 LIMIT 200`;

  const rows = await env.waivers.prepare(query).bind(...params).all();

  return json({ rows });
}
</file>

<file path="src/routes/admin/verify.js">
import { json } from '../../utils/admin.js';

async function generateDocumentHash(data) {
  const hashInput = JSON.stringify({
    submission_id: data.submission_id,
    property_id: data.property_id,
    checkin_date: data.checkin_date,
    guest_name: data.guest_name,
    guest_email: data.guest_email,
    activity: data.activity,
    activity_label: data.activity_label,
    initials: data.initials,
    signature_key: data.signature_key,
    created_at: data.created_at,
    release_version: data.release_version,
    release_date: data.release_date
  });

  const encoder = new TextEncoder();
  const dataBuffer = encoder.encode(hashInput);
  const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

  return hashHex;
}

export async function handleAdminVerify(request, env) {
  const url = new URL(request.url);
  const documentId = url.searchParams.get('document');

  if (!documentId) {
    return json({ ok: false, error: 'Missing document ID' }, 400);
  }

  try {
    // Get stored hash
    const hashResult = await env.waivers.prepare(
      'SELECT hash_value FROM hashes WHERE document_id = ?1'
    ).bind(documentId).first();

    if (!hashResult) {
      return json({ ok: false, error: 'Hash not found' }, 404);
    }

    // Get document and submission data
    const docData = await env.waivers.prepare(`
      SELECT
        d.activity,
        d.initials,
        s.submission_id,
        s.created_at,
        s.property_id,
        s.checkin_date,
        s.guest_name,
        s.guest_email
      FROM documents d
      JOIN submissions s ON d.submission_id = s.submission_id
      WHERE d.document_id = ?1
    `).bind(documentId).first();

    if (!docData) {
      return json({ ok: false, error: 'Document not found' }, 404);
    }

    // Get activity info for label
    const activityResult = await env.waivers.prepare(
      'SELECT label FROM activities WHERE property_id = ? AND slug = ?'
    ).bind(docData.property_id, docData.activity).first();
    const activityInfo = activityResult ? { label: activityResult.label } : null;

    // Construct signature key (deterministic from submission data)
    const nameParts = docData.guest_name.trim().split(/\s+/);
    const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, '') || 'unknown';
    const lastName = nameParts.length > 1
      ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, '')
      : 'unknown';

    const createdDate = new Date(docData.created_at);
    const y = createdDate.getUTCFullYear();
    const m = String(createdDate.getUTCMonth() + 1).padStart(2, '0');
    const d = String(createdDate.getUTCDate()).padStart(2, '0');

    const signatureKey = `waivers/${y}/${m}/${d}/${docData.property_id}/signatures/${lastName}-${firstName}-${docData.submission_id}.png`;

    // Get latest release at time of document creation
    const release = await env.waivers.prepare(
      'SELECT version, release_date FROM releases WHERE release_date <= ?1 ORDER BY release_date DESC, version DESC LIMIT 1'
    ).bind(docData.created_at.split('T')[0]).first();

    if (!release) {
      return json({ ok: false, error: 'No release found for document creation date' }, 404);
    }

    const hashData = {
      submission_id: docData.submission_id,
      property_id: docData.property_id,
      checkin_date: docData.checkin_date,
      guest_name: docData.guest_name,
      guest_email: docData.guest_email,
      activity: docData.activity,
      activity_label: activityInfo?.label || docData.activity,
      initials: docData.initials || '',
      signature_key: signatureKey,
      created_at: docData.created_at,
      release_version: release.version,
      release_date: release.release_date
    };

    const computedHash = await generateDocumentHash(hashData);
    const verified = computedHash === hashResult.hash_value;

    return json({
      ok: true,
      verified,
      stored_hash: hashResult.hash_value,
      computed_hash: computedHash
    });
  } catch (error) {
    return json({ ok: false, error: error.message }, 500);
  }
}
</file>

<file path="src/routes/download.js">
export async function handleDownload(request, env) {
  const { pathname } = new URL(request.url);
  const r2Key = pathname.replace('/download/', '');

  if (env.DEV_MODE !== 'true') {
    return new Response('Downloads only available in dev mode', { status: 403 });
  }

  const object = await env.WAIVERS_R2.get(r2Key);

  if (!object) {
    return new Response('PDF not found', { status: 404 });
  }

  const filename = r2Key.split('/').pop();

  return new Response(object.body, {
    headers: {
      'Content-Type': 'application/pdf',
      'Content-Disposition': `attachment; filename="${filename}"`,
      'Cache-Control': 'private, max-age=300'
    }
  });
}
</file>

<file path="src/routes/root.js">
import { htmlPage } from '../utils/spa.js';

export async function handleRoot(request, env) {
  const url = new URL(request.url);
  const token = url.searchParams.get('token');

  return await htmlPage(env, token);
}
</file>

<file path="src/routes/status.js">
import { json } from '../utils/admin.js';

export async function handleStatus(env) {
  try {
    const dbOK = await env.waivers.prepare('SELECT 1').first();
    return json({ ok: true, db: !!dbOK, ts: Date.now() });
  } catch (error) {
    return json({ ok: false, error: error.message, ts: Date.now() });
  }
}
</file>

<file path="src/routes/submit.js">
import { nanoid } from '../utils/nanoid.js';
import { makePDFs } from '../services/pdf.js';
import { sendVerificationEmail, sendWaiverEmail } from '../services/mail.js';
import { saveSubmissionActivities, saveDocuments } from '../services/storage.js';
import { processWaiverAsync, validateInitials } from '../services/async-processor.js';

export async function handleInitialSubmit(request, env) {
  try {
    const data = await request.json();

    // Validate required fields
    if (!data.propertyId || !data.checkinDate || !data.guestName || !data.guestEmail) {
      return new Response(JSON.stringify({ ok: false, error: 'Missing required fields' }), {
        status: 400,
        headers: { 'content-type': 'application/json' }
      });
    }

    // Generate submission ID and verification token
    const submissionId = nanoid(12);
    const verificationToken = nanoid(32);
    const createdAt = new Date().toISOString();
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24 hours

    // Create pending submission record
    await env.waivers.prepare(
      `INSERT INTO submissions
       (submission_id, created_at, property_id, checkin_date, guest_name, guest_email, activities,
        status, verification_token, token_expires_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
    ).bind(
      submissionId,
      createdAt,
      data.propertyId,
      data.checkinDate,
      data.guestName,
      data.guestEmail,
      '[]', // Empty activities initially
      'pending',
      verificationToken,
      expiresAt
    ).run();

    // Send verification email
    const verificationUrl = `${new URL(request.url).origin}/?token=${verificationToken}`;

    if (env.DEV_MODE === 'true') {
      console.log('Dev Mode: Verification email would be sent to:', data.guestEmail);
      console.log('Dev Mode: Verification URL:', verificationUrl);

      return new Response(JSON.stringify({
        ok: true,
        devMode: true,
        submissionId,
        verificationUrl
      }), {
        headers: { 'content-type': 'application/json' }
      });
    } else {
      await sendVerificationEmail(data.guestEmail, data.guestName, verificationUrl, env);

      return new Response(JSON.stringify({
        ok: true,
        submissionId
      }), {
        headers: { 'content-type': 'application/json' }
      });
    }
  } catch (error) {
    console.error('Initial submission error:', error);
    return new Response(JSON.stringify({ ok: false, error: error.message }), {
      status: 500,
      headers: { 'content-type': 'application/json' }
    });
  }
}

export async function handleCompleteSubmit(request, env, ctx) {
  try {
    const data = await request.json();

    // Validate required fields
    if (!data.submissionId || !data.activities || !data.initials || !data.signature || !data.accepted) {
      return new Response(JSON.stringify({ ok: false, error: 'Missing required fields' }), {
        status: 400,
        headers: { 'content-type': 'application/json' }
      });
    }

    // Validate initials (all must be the same)
    const initialsValidation = validateInitials(data.activities, data.initials);
    if (!initialsValidation.valid) {
      return new Response(JSON.stringify({ ok: false, error: initialsValidation.error }), {
        status: 400,
        headers: { 'content-type': 'application/json' }
      });
    }

    // Retrieve submission
    const submission = await env.waivers.prepare(
      'SELECT * FROM submissions WHERE submission_id = ? AND status = ?'
    ).bind(data.submissionId, 'pending').first();

    if (!submission) {
      return new Response(JSON.stringify({ ok: false, error: 'Invalid or expired submission' }), {
        status: 404,
        headers: { 'content-type': 'application/json' }
      });
    }

    // Check if token expired
    const expires = new Date(submission.token_expires_at);
    if (expires < new Date()) {
      return new Response(JSON.stringify({ ok: false, error: 'Verification token expired' }), {
        status: 410,
        headers: { 'content-type': 'application/json' }
      });
    }

    // Update submission status to processing
    const completedAt = new Date().toISOString();
    await env.waivers.prepare(
      'UPDATE submissions SET status = ?, completed_at = ?, activities = ? WHERE submission_id = ?'
    ).bind(
      'processing',
      completedAt,
      JSON.stringify(data.activities),
      data.submissionId
    ).run();

    // Prepare submission data
    const submissionData = {
      propertyId: submission.property_id,
      checkinDate: submission.checkin_date,
      guestName: submission.guest_name,
      guestEmail: submission.guest_email,
      activities: data.activities,
      initials: data.initials,
      signature: data.signature
    };

    // Generate archery PIN if needed
    let archeryPin = null;
    if (data.activities.includes('archery')) {
      archeryPin = env.ARCHERY_PIN || '1234';
    }

    // Development mode - synchronous processing with downloads
    if (env.DEV_MODE === 'true') {
      const pdfs = await makePDFs(submissionData, data.submissionId, env);
      await saveDocuments(env, data.submissionId, pdfs);
      await saveSubmissionActivities(env, submission.verification_token, pdfs, completedAt);

      const downloads = pdfs.map(p => ({
        filename: p.filename,
        url: `/download/${p.id}`
      }));

      await env.waivers.prepare(
        'UPDATE submissions SET status = ? WHERE submission_id = ?'
      ).bind('completed', data.submissionId).run();

      return new Response(JSON.stringify({
        ok: true,
        devMode: true,
        downloads,
        pin: archeryPin
      }), {
        headers: { 'content-type': 'application/json' }
      });
    } else {
      // Production mode - async processing with immediate response
      // Process PDFs and send email in background
      ctx.waitUntil(
        processWaiverAsync(submissionData, data.submissionId, submission.verification_token, env)
      );

      // Return immediate success response
      return new Response(JSON.stringify({
        ok: true,
        message: 'Your waivers are being processed and will be emailed to you shortly',
        pin: archeryPin
      }), {
        headers: { 'content-type': 'application/json' }
      });
    }
  } catch (error) {
    console.error('Complete submission error:', error);
    return new Response(JSON.stringify({ ok: false, error: error.message }), {
      status: 500,
      headers: { 'content-type': 'application/json' }
    });
  }
}
</file>

<file path="src/services/async-processor.js">
import { makePDFs } from './pdf.js';
import { sendWaiverEmail } from './mail.js';
import { saveDocuments, saveSubmissionActivities } from './storage.js';

/**
 * Process waiver submission asynchronously with retry logic
 * @param {Object} submissionData - Submission data
 * @param {string} submissionId - Submission ID
 * @param {string} verificationToken - Verification token
 * @param {Object} env - Environment bindings
 * @param {number} retryCount - Current retry attempt (default: 0)
 * @param {number} maxRetries - Maximum retry attempts (default: 3)
 */
export async function processWaiverAsync(submissionData, submissionId, verificationToken, env, retryCount = 0, maxRetries = 3) {
  try {
    console.log(`Processing waiver for submission ${submissionId} (attempt ${retryCount + 1}/${maxRetries + 1})`);

    // Generate PDFs
    const pdfs = await makePDFs(submissionData, submissionId, env);

    // Save to database
    const completedAt = new Date().toISOString();
    await saveDocuments(env, submissionId, pdfs);
    await saveSubmissionActivities(env, verificationToken, pdfs, completedAt);

    // Generate archery PIN if needed
    let archeryPin = null;
    if (submissionData.activities.includes('archery')) {
      archeryPin = env.ARCHERY_PIN || '1234';
    }

    // Send email with waivers
    await sendWaiverEmail(submissionData, pdfs, archeryPin, env);

    console.log(`Successfully processed waiver for submission ${submissionId}`);

    // Update submission status to indicate email sent
    await env.waivers.prepare(
      'UPDATE submissions SET status = ? WHERE submission_id = ?'
    ).bind('emailed', submissionId).run();

  } catch (error) {
    console.error(`Error processing waiver for submission ${submissionId} (attempt ${retryCount + 1}):`, error);

    // Retry with exponential backoff
    if (retryCount < maxRetries) {
      const delayMs = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
      console.log(`Retrying in ${delayMs}ms...`);

      await new Promise(resolve => setTimeout(resolve, delayMs));
      return await processWaiverAsync(submissionData, submissionId, verificationToken, env, retryCount + 1, maxRetries);
    } else {
      console.error(`Failed to process waiver for submission ${submissionId} after ${maxRetries + 1} attempts`);

      // Mark submission as failed
      await env.waivers.prepare(
        'UPDATE submissions SET status = ?, error_message = ? WHERE submission_id = ?'
      ).bind('failed', error.message, submissionId).run();

      throw error;
    }
  }
}

/**
 * Validate initials - ensure all are provided and consistent
 * @param {Array} activities - Array of activity slugs
 * @param {Object} initials - Object mapping activity slug to initials
 * @returns {Object} { valid: boolean, error: string }
 */
export function validateInitials(activities, initials) {
  // Check all activities have initials
  for (const activity of activities) {
    if (!initials[activity] || initials[activity].trim() === '') {
      return {
        valid: false,
        error: `Missing initials for activity: ${activity}`
      };
    }
  }

  // Check all initials are the same (2-3 characters, alphanumeric)
  const initialValues = Object.values(initials);
  const firstInitial = initialValues[0].trim().toUpperCase();

  // Validate format (2-3 characters, letters only)
  if (!/^[A-Z]{2,3}$/.test(firstInitial)) {
    return {
      valid: false,
      error: 'Initials must be 2-3 letters only'
    };
  }

  // Check all match
  for (const initial of initialValues) {
    if (initial.trim().toUpperCase() !== firstInitial) {
      return {
        valid: false,
        error: 'All initials must be the same'
      };
    }
  }

  return { valid: true };
}
</file>

<file path="src/services/mail.js">
import { Resend } from 'resend';
import verificationEmailTemplate from '../templates/email-verification.html';
import verificationTextTemplate from '../templates/email-verification.txt';
import waiverEmailTemplate from '../templates/email-waiver.html';
import waiverTextTemplate from '../templates/email-waiver.txt';
import archeryPinHtmlTemplate from '../templates/archery-pin.html';
import archeryPinTextTemplate from '../templates/archery-pin.txt';

function parseEmailTemplate(template) {
  const lines = template.split('\n');
  const headers = {};
  let bodyStart = 0;

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith('SUBJECT:')) {
      headers.subject = lines[i].substring(8).trim();
    } else if (lines[i].startsWith('FROM:')) {
      headers.from = lines[i].substring(5).trim();
    } else if (lines[i].trim() === '') {
      bodyStart = i + 1;
      break;
    }
  }

  headers.body = lines.slice(bodyStart).join('\n');
  return headers;
}

function replaceTemplateVars(template, replacements) {
  let result = template;
  for (const [key, value] of Object.entries(replacements)) {
    result = result.replace(new RegExp(`{{${key}}}`, 'g'), value);
  }
  return result;
}

async function sendEmail(resend, env, emailData) {
  const { data: responseData, error } = await resend.emails.send({
    ...emailData,
    from: `${emailData.from} <${env.EMAIL_FROM}>`
  });

  if (error) {
    console.error('Resend error:', error);
    throw new Error(error.message);
  }

  return responseData;
}

function buildEmailData(text, html) {
  const { subject, from, body } = parseEmailTemplate(text);
  return {
    from,
    subject,
    text: body,
    html
  };
}

export async function sendVerificationEmail(email, name, verificationUrl, env) {
  const resend = new Resend(env.RESEND_API_KEY);

  const replacements = {
    GUEST_NAME: name,
    VERIFICATION_URL: verificationUrl
  };

  const text = replaceTemplateVars(verificationTextTemplate, replacements);
  const html = replaceTemplateVars(verificationEmailTemplate, replacements);

  const emailData = buildEmailData(text, html);
  emailData.to = email;

  try {
    const responseData = await sendEmail(resend, env, emailData);
    console.log('Verification email sent successfully:', responseData);
  } catch (error) {
    console.error('Verification email send error:', error);
    throw new Error('Failed to send verification email: ' + error.message);
  }
}

export async function sendWaiverEmail(data, pdfs, pin, env) {
  const resend = new Resend(env.RESEND_API_KEY);

  const replacements = {
    GUEST_NAME: data.guestName,
    PROPERTY_ID: data.propertyId,
    PDF_LIST: {
      text: pdfs.map(p => p.filename).join(', '),
      html: pdfs.map(p => `<li>${p.filename}</li>`).join('')
    },
    ARCHERY_PIN: {
      text: pin ? replaceTemplateVars(archeryPinTextTemplate, { PIN: pin }) : '',
      html: pin ? replaceTemplateVars(archeryPinHtmlTemplate, { PIN: pin }) : ''
    }
  };

  const getReplacements = (format) => {
    const result = {};
    for (const [key, value] of Object.entries(replacements)) {
      result[key] = typeof value === 'object' && value !== null ? value[format] : value;
    }
    return result;
  };

  const text = replaceTemplateVars(waiverTextTemplate, getReplacements('text'));
  const html = replaceTemplateVars(waiverEmailTemplate, getReplacements('html'));

  const emailData = buildEmailData(text, html);
  emailData.to = data.guestEmail;
  emailData.attachments = pdfs.map(p => ({
    filename: p.filename,
    content: btoa(String.fromCharCode(...new Uint8Array(p.bytes)))
  }));

  try {
    const responseData = await sendEmail(resend, env, emailData);
    console.log('Email sent successfully:', responseData);
  } catch (error) {
    console.error('Email send error:', error);
    throw new Error('Failed to send email: ' + error.message);
  }
}
</file>

<file path="src/services/pdf.js">
import { nanoid } from '../utils/nanoid.js';
import waiverTemplate from '../templates/waiver.html';
import { getLatestRelease, getActivitiesByProperty, getAllRiskDescriptions } from '../utils/db.js';

function parseGuestName(guestName) {
  const nameParts = guestName.trim().split(/\s+/);
  const firstName = nameParts[0]?.toLowerCase().replace(/[^a-z]/g, '') || 'unknown';
  const lastName = nameParts.length > 1
    ? nameParts[nameParts.length - 1].toLowerCase().replace(/[^a-z]/g, '')
    : 'unknown';
  return { firstName, lastName };
}

async function generateDocumentHash(data) {
  const hashInput = JSON.stringify({
    submission_id: data.submission_id,
    property_id: data.property_id,
    checkin_date: data.checkin_date,
    guest_name: data.guest_name,
    guest_email: data.guest_email,
    activity: data.activity,
    activity_label: data.activity_label,
    initials: data.initials,
    signature_key: data.signature_key,
    created_at: data.created_at,
    release_version: data.release_version,
    release_date: data.release_date
  });

  const encoder = new TextEncoder();
  const dataBuffer = encoder.encode(hashInput);
  const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

  return hashHex;
}

function generateWaiverHTML(data, activityInfo, riskData, latestRelease, documentId, documentHash) {
  const riskLevel = activityInfo?.risk || 'medium';
  const activityLabel = activityInfo?.label || data.activity;

  const riskDescriptionHtml = riskData?.description
    ? `<div class="risk-description">${riskData.description}</div>`
    : '';

  const signatureHtml = data.signature
    ? `<img src="${data.signature}" class="signature-image" alt="Guest signature" />`
    : '<p class="no-signature">No signature provided</p>';

  return waiverTemplate
    .replace('{{ACTIVITY_LABEL}}', activityLabel.toUpperCase())
    .replace('{{PROPERTY_ID}}', data.propertyId)
    .replace('{{CHECKIN_DATE}}', data.checkinDate)
    .replace('{{GUEST_NAME}}', data.guestName)
    .replace('{{INITIALS}}', data.initials[data.activity])
    .replace('{{RISK_LEVEL}}', riskLevel.toUpperCase())
    .replace('{{RISK_DESCRIPTION}}', riskDescriptionHtml)
    .replace('{{WAIVER_TEXT}}', latestRelease.waiver_text)
    .replace('{{SIGNATURE}}', signatureHtml)
    .replace('{{RELEASE_VERSION}}', latestRelease.version)
    .replace('{{RELEASE_DATE}}', latestRelease.release_date)
    .replace('{{DOCUMENT_ID}}', documentId)
    .replace('{{DOCUMENT_HASH_SHORT}}', documentHash.substring(0, 32));
}

export async function makePDFs(data, subId, env) {
  const now = new Date();
  const createdAt = now.toISOString();
  const y = now.getUTCFullYear();
  const m = String(now.getUTCMonth() + 1).padStart(2, '0');
  const d = String(now.getUTCDate()).padStart(2, '0');

  // Fetch latest legal release
  const latestRelease = await getLatestRelease(env);

  if (!latestRelease) {
    throw new Error('No legal release found. Please create a release in the admin panel first.');
  }

  // Fetch activity info from database
  const activities = await getActivitiesByProperty(env, data.propertyId);

  // Fetch risk descriptions from database
  const risks = await getAllRiskDescriptions(env);

  // Save signature to R2 (once per submission, not per activity)
  let signatureKey = null;
  if (data.signature) {
    try {
      const signatureData = data.signature.split(',')[1];
      const signatureBytes = Uint8Array.from(atob(signatureData), c => c.charCodeAt(0));

      const { firstName, lastName } = parseGuestName(data.guestName);

      signatureKey = `waivers/${y}/${m}/${d}/${data.propertyId}/signatures/${lastName}-${firstName}-${subId}.png`;

      await env.WAIVERS_R2.put(signatureKey, signatureBytes, {
        httpMetadata: { contentType: 'image/png' }
      });
    } catch (err) {
      console.error('Error saving signature to R2:', err);
    }
  }

  const { firstName, lastName } = parseGuestName(data.guestName);

  // Pre-generate all hashes concurrently
  const hashPromises = data.activities.map(async (act) => {
    const activityInfo = activities.find(a => a.slug === act);
    const hashData = {
      submission_id: subId,
      property_id: data.propertyId,
      checkin_date: data.checkinDate,
      guest_name: data.guestName,
      guest_email: data.guestEmail,
      activity: act,
      activity_label: activityInfo?.label || act,
      initials: data.initials[act],
      signature_key: signatureKey,
      created_at: createdAt,
      release_version: latestRelease.version,
      release_date: latestRelease.release_date
    };
    return { act, hash: await generateDocumentHash(hashData) };
  });

  const hashes = await Promise.all(hashPromises);
  const hashMap = Object.fromEntries(hashes.map(h => [h.act, h.hash]));

  const results = [];

  // Hybrid approach: single vs batch
  if (data.activities.length === 1) {
    // SINGLE MODE - one activity
    const act = data.activities[0];
    const activityInfo = activities.find(a => a.slug === act);
    const riskLevel = activityInfo?.risk || 'medium';
    const riskData = risks[riskLevel];
    const documentId = nanoid(12);
    const documentHash = hashMap[act];

    const htmlContent = generateWaiverHTML(
      { ...data, activity: act },
      activityInfo,
      riskData,
      latestRelease,
      documentId,
      documentHash
    );

    try {
      const response = await env.BROWSER.fetch('https://render', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          html: htmlContent,
          options: {
            format: 'A4',
            printBackground: true
          }
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Browser rendering failed: ${response.status} ${response.statusText} - ${errorText}`);
      }

      const pdfBytes = await response.arrayBuffer();

      // Save to R2
      const filename = `${lastName}-${firstName}-${act}-${subId}.pdf`;
      const key = `waivers/${y}/${m}/${d}/${data.propertyId}/${act}/${filename}`;

      await env.WAIVERS_R2.put(key, pdfBytes, {
        httpMetadata: { contentType: 'application/pdf' }
      });

      results.push({
        id: documentId,
        activity: act,
        activityLabel: activityInfo?.label || act,
        filename,
        r2Key: key,
        bytes: pdfBytes,
        hash: documentHash,
        initials: data.initials[act]
      });
    } catch (err) {
      console.error('Error generating PDF with browser rendering:', err);
      throw new Error(`Failed to generate PDF for activity ${act}: ${err.message}`);
    }

  } else {
    // BATCH MODE - multiple activities

    // Build all HTML content
    const batchItems = data.activities.map((act) => {
      const activityInfo = activities.find(a => a.slug === act);
      const riskLevel = activityInfo?.risk || 'medium';
      const riskData = risks[riskLevel];
      const documentId = nanoid(12);
      const documentHash = hashMap[act];

      const htmlContent = generateWaiverHTML(
        { ...data, activity: act },
        activityInfo,
        riskData,
        latestRelease,
        documentId,
        documentHash
      );

      return {
        id: documentId,
        act: act,
        activityInfo: activityInfo,
        html: htmlContent,
        options: {
          format: 'A4',
          printBackground: true
        }
      };
    });

    try {
      // Single batch call with concurrency hint
      const response = await env.BROWSER.fetch('https://render', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          batch: batchItems,
          concurrency: 3
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Browser rendering failed: ${response.status} ${response.statusText} - ${errorText}`);
      }

      const { results: pdfResults, failed } = await response.json();

      // Check for any failures
      if (failed > 0) {
        const failedItems = pdfResults.filter(r => !r.success);
        const failedActivities = failedItems.map(r => {
          const item = batchItems.find(b => b.id === r.id);
          return item?.act || r.id;
        }).join(', ');
        throw new Error(`Failed to generate PDFs for: ${failedActivities}`);
      }

      // Save all PDFs to R2 concurrently
      const savePromises = pdfResults.map(async (result) => {
        const batchItem = batchItems.find(b => b.id === result.id);
        const filename = `${lastName}-${firstName}-${batchItem.act}-${subId}.pdf`;
        const key = `waivers/${y}/${m}/${d}/${data.propertyId}/${batchItem.act}/${filename}`;

        // Decode base64 PDF
        const pdfBytes = Uint8Array.from(atob(result.pdf), c => c.charCodeAt(0));

        await env.WAIVERS_R2.put(key, pdfBytes, {
          httpMetadata: { contentType: 'application/pdf' }
        });

        return {
          id: result.id,
          activity: batchItem.act,
          activityLabel: batchItem.activityInfo?.label || batchItem.act,
          filename,
          r2Key: key,
          bytes: pdfBytes,
          hash: hashMap[batchItem.act],
          initials: data.initials[batchItem.act]
        };
      });

      results.push(...await Promise.all(savePromises));

    } catch (err) {
      console.error('Error generating PDFs with browser rendering:', err);
      throw new Error(`Failed to generate PDFs: ${err.message}`);
    }
  }

  return results;
}
</file>

<file path="src/services/storage.js">
import { createDocument, createHash, createSubmissionActivity } from '../utils/db.js';

export async function saveSubmission(env, subId, data, createdAt) {
  await env.waivers.prepare(
      'INSERT INTO submissions VALUES(?1,?2,?3,?4,?5,?6,?7)'
    ).bind(
      subId, createdAt, data.propertyId, data.checkinDate,
      data.guestName, data.guestEmail, JSON.stringify(data.activities)
    ).run();
}

export async function saveDocuments(env, subId, pdfInfos) {
  const now = new Date().toISOString();

  for (const p of pdfInfos) {
    // Insert document (for backward compatibility)
    await createDocument(env, p.id, subId, p.activity, p.r2Key, p.initials);

    // Insert hash (for backward compatibility)
    const hashId = `hash_${p.id}`;
    await createHash(env, hashId, p.id, p.hash, now);
  }
}

export async function saveSubmissionActivities(env, verificationToken, pdfInfos, createdAt) {
  for (const p of pdfInfos) {
    await createSubmissionActivity(
      env,
      p.id,
      verificationToken,
      p.activity,
      p.activityLabel,
      p.initials,
      p.hash,
      p.r2Key,
      createdAt
    );
  }
}
</file>

<file path="src/services/validation.js">
export function validateSubmission(data) {
  const must = ['propertyId','checkinDate','guestName','guestEmail',
                'activities','initials','signature','accepted'];

  for (const k of must) {
    if (data[k] === undefined || data[k] === '' ||
        (Array.isArray(data[k]) && !data[k].length)) {
      return `missing ${k}`;
    }
  }

  if (data.accepted !== true) {
    return 'master acceptance not ticked';
  }

  return null;
}
</file>

<file path="src/templates/admin.html">
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Activity Waivers</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 30px;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover {
      color: #0070f3;
    }
    .tab.active {
      color: #0070f3;
      border-bottom-color: #0070f3;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .search-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
      font-size: 14px;
    }
    input, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #0070f3;
    }
    .button-group {
      grid-column: 1 / -1;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-search, .btn-primary {
      background: #0070f3;
      color: white;
    }
    .btn-search:hover, .btn-primary:hover {
      background: #0051cc;
    }
    .btn-clear {
      background: #eee;
      color: #333;
    }
    .btn-clear:hover {
      background: #ddd;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
      padding: 8px 15px;
      font-size: 13px;
      margin-left: 5px;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-warning {
      background: #ffc107;
      color: #000;
      padding: 8px 15px;
      font-size: 13px;
      margin-left: 5px;
    }
    .btn-warning:hover {
      background: #e0a800;
    }
    .results {
      margin-top: 20px;
    }
    .result-count {
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background: #f9f9f9;
    }
    th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #ddd;
      font-weight: 600;
      color: #555;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .activity-badge {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .activity-badge:hover {
      background: #1976d2;
      color: white;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      padding: 15px;
      background: #fee;
      color: #c33;
      border-radius: 4px;
      margin: 20px 0;
    }
    .message {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .section {
      margin-bottom: 40px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      color: #555;
    }
    .activities-list {
      margin-top: 20px;
    }
    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .activity-info {
      flex: 1;
    }
    .activity-slug {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }
    .activity-label {
      color: #666;
      margin: 5px 0;
    }
    .risk-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 5px;
    }
    .risk-low {
      background: #d4edda;
      color: #155724;
    }
    .risk-medium {
      background: #fff3cd;
      color: #856404;
    }
    .risk-high {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Activity Waivers Admin</h1>

    <div class="tabs">
      <button class="tab active" onclick="showTab('search')">Search Submissions</button>
      <button class="tab" onclick="showTab('activities')">Manage Activities</button>
      <button class="tab" onclick="showTab('properties')">Manage Properties</button>
      <button class="tab" onclick="showTab('releases')">Legal Releases</button>
      <button class="tab" onclick="showTab('debug')">Debug</button>
      <button class="tab" onclick="showTab('api')">API Documentation</button>
    </div>

    <!-- Search Tab -->
    <div id="searchTab" class="tab-content active">
      <form class="search-form" id="searchForm">
        <div class="form-group">
          <label for="name">Guest Name</label>
          <input type="text" id="name" name="name" placeholder="John Doe">
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" placeholder="guest@example.com">
        </div>

        <div class="form-group">
          <label for="prop">Property ID</label>
          <input type="text" id="prop" name="prop" placeholder="cabin-12">
        </div>

        <div class="form-group">
          <label for="date">Check-in Date</label>
          <input type="date" id="date" name="date">
        </div>

        <div class="form-group">
          <label for="activity">Activity</label>
          <input type="text" id="activity" name="activity" placeholder="archery">
        </div>

        <div class="button-group">
          <button type="submit" class="btn-search">Search</button>
          <button type="button" class="btn-clear" onclick="clearForm()">Clear</button>
        </div>
      </form>

      <div class="results" id="results"></div>
    </div>

    <!-- Activities Tab -->
    <div id="activitiesTab" class="tab-content">
      <div id="message"></div>

      <div class="section">
        <h2>Property</h2>
        <div class="form-group">
          <label for="propertySelect">Select Property</label>
          <select id="propertySelect" onchange="loadActivities()">
            <option value="">Loading...</option>
          </select>
        </div>
      </div>

      <div class="section">
        <h2>Add New Activity</h2>
        <form id="addForm">
          <div class="form-group">
            <label for="addSlug">Slug (e.g., rock-climbing)</label>
            <input type="text" id="addSlug" required placeholder="rock-climbing">
          </div>
          <div class="form-group">
            <label for="addLabel">Label (Display Name)</label>
            <input type="text" id="addLabel" required placeholder="Rock Climbing">
          </div>
          <div class="form-group">
            <label for="addRisk">Risk Level</label>
            <select id="addRisk" required>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <button type="submit" class="btn-primary">Add Activity</button>
        </form>
      </div>

      <div class="section">
        <h2>Current Activities</h2>
        <div id="activitiesList" class="activities-list">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Properties Tab -->
    <div id="propertiesTab" class="tab-content">
      <div id="propMessage"></div>

      <div class="section">
        <h2>Add New Property</h2>
        <form id="addPropertyForm">
          <div class="form-group">
            <label for="propId">Property ID (e.g., cabin-12)</label>
            <input type="text" id="propId" required placeholder="cabin-12">
          </div>
          <div class="form-group">
            <label for="propName">Property Name</label>
            <input type="text" id="propName" required placeholder="Cabin 12">
          </div>
          <div class="form-group">
            <label for="copyDefaultActivities" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="copyDefaultActivities" checked style="cursor: pointer;">
              <span>Copy default activities template</span>
            </label>
          </div>
          <button type="submit" class="btn-primary">Add Property</button>
        </form>
      </div>

      <div class="section">
        <h2>Current Properties</h2>
        <div id="propertiesList" class="activities-list">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Legal Releases Tab -->
    <div id="releasesTab" class="tab-content">
      <div id="releaseMessage"></div>

      <div class="section">
        <h2>Current Release</h2>
        <div id="currentRelease" class="current-release">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="section">
        <h2>Create New Release</h2>
        <form id="releaseForm">
          <div class="form-group">
            <label for="releaseVersion">Version</label>
            <input type="text" id="releaseVersion" placeholder="Leave blank to auto-increment" pattern="[0-9]+\.[0-9]+\.[0-9]+">
            <small style="color: #666; margin-top: 5px; display: block;">Format: X.Y.Z (e.g., 1.0.1) - Leave blank to auto-increment patch version</small>
          </div>
          <div class="form-group">
            <label for="waiverText">Legal Waiver Text</label>
            <textarea id="waiverText" required rows="12" style="font-family: system-ui, sans-serif; resize: vertical; min-height: 200px;"></textarea>
          </div>
          <button type="submit" class="btn-primary">Create Release</button>
        </form>
      </div>

      <div class="section">
        <h2>Release History</h2>
        <div id="releaseHistory" class="release-history">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Debug Tab -->
    <div id="debugTab" class="tab-content">
      <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>⚠️ Note:</strong> Debug data is cached and auto-updates every 7 days. Click "Refresh Data" to force an update.
      </div>

      <div style="margin-bottom: 20px;">
        <button class="btn-primary" onclick="loadDebugData(true)" style="padding: 10px 20px;">
          🔄 Refresh Data
        </button>
        <span id="debugLastUpdate" style="margin-left: 15px; color: #666; font-size: 14px;"></span>
      </div>

      <div class="section">
        <h2>KV Store (PROPS_KV)</h2>
        <div id="kvData" style="background: #f9f9f9; padding: 15px; border-radius: 4px; overflow-x: auto;">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="section">
        <h2>D1 Database Tables</h2>
        <div id="d1Tables" style="margin-top: 15px;">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- API Documentation Tab -->
    <div id="apiTab" class="tab-content">
      <div style="max-width: 900px; margin: 0 auto;">
        <div style="background: white; padding: 30px; border-radius: 8px; line-height: 1.6;">
          <div id="apiDocs" style="font-family: system-ui, sans-serif;">
            <!-- API documentation will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentProperties = [];

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        if (tab.textContent.toLowerCase().includes(tabName === 'search' ? 'search' : tabName === 'activities' ? 'activities' : tabName === 'properties' ? 'properties' : tabName === 'releases' ? 'releases' : tabName === 'debug' ? 'debug' : 'api')) {
          tab.classList.add('active');
        }
      });
      document.getElementById(tabName + 'Tab').classList.add('active');

      if (tabName === 'activities') {
        loadPropertySelector();
        loadActivities();
      }
      if (tabName === 'properties') {
        loadProperties();
      }
      if (tabName === 'releases') {
        loadReleases();
      }
      if (tabName === 'debug') {
        loadDebugData();
      }
      if (tabName === 'api') {
        loadApiDocs();
      }
    }

    async function loadPropertySelector() {
      const selector = document.getElementById('propertySelect');
      try {
        const response = await fetch('/admin/properties');
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        currentProperties = data.properties;
        selector.innerHTML = currentProperties.map(p =>
          \`<option value="\${p.id}">\${p.name}</option>\`
        ).join('');

      } catch (error) {
        selector.innerHTML = '<option value="">Error loading properties</option>';
      }
    }

    // Search functionality
    const form = document.getElementById('searchForm');
    const resultsDiv = document.getElementById('results');

    window.addEventListener('load', () => search());

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      search();
    });

    async function search() {
      resultsDiv.innerHTML = '<div class="loading">Loading...</div>';

      const formData = new FormData(form);
      const params = new URLSearchParams();

      for (const [key, value] of formData) {
        if (value.trim()) {
          params.append(key, value.trim());
        }
      }

      try {
        const response = await fetch('/admin/search?' + params.toString());
        const data = await response.json();

        if (!data.rows.success) {
          throw new Error('Search failed');
        }

        displayResults(data.rows.results);
      } catch (error) {
        resultsDiv.innerHTML = '<div class="error">Error loading results: ' + error.message + '</div>';
      }
    }

    function displayResults(results) {
      if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="empty">No results found</div>';
        return;
      }

      const countHtml = '<div class="result-count">Found ' + results.length + ' submission' + (results.length !== 1 ? 's' : '') + '</div>';

      const tableHtml = \`
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Guest Name</th>
              <th>Email</th>
              <th>Property</th>
              <th>Check-in</th>
              <th>Activities</th>
              <th>Download</th>
            </tr>
          </thead>
          <tbody>
            \${results.map(row => {
              const createdDate = new Date(row.created_at).toLocaleString();
              const activities = JSON.parse(row.activities);

              return \`
                <tr>
                  <td>\${createdDate}</td>
                  <td>\${escapeHtml(row.guest_name)}</td>
                  <td>\${escapeHtml(row.guest_email)}</td>
                  <td>\${escapeHtml(row.property_id)}</td>
                  <td>\${row.checkin_date}</td>
                  <td>
                    \${activities.map(a =>
                      '<span class="activity-badge">' +
                      escapeHtml(a) + '</span>'
                    ).join('')}
                  </td>
                  <td>
                    <button class="btn-primary" onclick="downloadAllWaivers('\${escapeHtml(row.submission_id)}')" style="padding: 8px 12px; font-size: 13px;">Download All</button>
                  </td>
                </tr>
              \`;
            }).join('')}
          </tbody>
        </table>
      \`;

      resultsDiv.innerHTML = countHtml + tableHtml;
    }

    function clearForm() {
      form.reset();
      search();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Activities Management
    const messageDiv = document.getElementById('message');
    const activitiesList = document.getElementById('activitiesList');

    function showMessage(text, type = 'success') {
      messageDiv.innerHTML = \`<div class="message \${type}">\${text}</div>\`;
      setTimeout(() => messageDiv.innerHTML = '', 5000);
    }

    async function loadActivities() {
      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      if (!propertyId) return;

      try {
        const response = await fetch(\`/admin/activities?property=\${propertyId}\`);
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        displayActivities(data.activities);
      } catch (error) {
        activitiesList.innerHTML = \`<div class="error">Error loading activities: \${error.message}</div>\`;
      }
    }

    function displayActivities(activities) {
      if (activities.length === 0) {
        activitiesList.innerHTML = '<p>No activities found.</p>';
        return;
      }

      activitiesList.innerHTML = activities.map(activity => \`
        <div class="activity-item">
          <div class="activity-info">
            <div class="activity-slug">\${activity.slug}</div>
            <div class="activity-label">\${activity.label}</div>
            <span class="risk-badge risk-\${activity.risk}">\${activity.risk.toUpperCase()}</span>
          </div>
          <div class="activity-actions">
            <button class="btn-warning" onclick="editActivity('\${activity.slug}', '\${activity.label}', '\${activity.risk}')">Edit</button>
            <button class="btn-danger" onclick="removeActivity('\${activity.slug}')">Remove</button>
          </div>
        </div>
      \`).join('');
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      if (!propertyId) {
        showMessage('Please select a property first', 'error');
        return;
      }

      const slug = document.getElementById('addSlug').value.trim();
      const label = document.getElementById('addLabel').value.trim();
      const risk = document.getElementById('addRisk').value;

      try {
        const response = await fetch(\`/admin/activities/add?property=\${propertyId}\`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, label, risk })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showMessage(\`Activity "\${label}" added successfully!\`);
        document.getElementById('addForm').reset();
        loadActivities();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    });

    async function removeActivity(slug) {
      if (!confirm(\`Remove activity "\${slug}"?\`)) return;

      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      try {
        const response = await fetch(\`/admin/activities/remove?property=\${propertyId}\`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showMessage(\`Activity "\${slug}" removed successfully!\`);
        loadActivities();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    function editActivity(slug, currentLabel, currentRisk) {
      const newLabel = prompt('Enter new label:', currentLabel);
      if (newLabel === null) return;

      const newRisk = prompt('Enter risk level (low/medium/high):', currentRisk);
      if (newRisk === null) return;

      if (!['low', 'medium', 'high'].includes(newRisk.toLowerCase())) {
        showMessage('Invalid risk level. Must be low, medium, or high.', 'error');
        return;
      }

      updateActivity(slug, newLabel, newRisk.toLowerCase());
    }

    async function updateActivity(slug, label, risk) {
      const selector = document.getElementById('propertySelect');
      const propertyId = selector.value;

      try {
        const response = await fetch(\`/admin/activities/update?property=\${propertyId}\`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, label, risk })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showMessage(\`Activity "\${slug}" updated successfully!\`);
        loadActivities();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    // Properties Management
    const propMessageDiv = document.getElementById('propMessage');
    const propertiesList = document.getElementById('propertiesList');

    function showPropMessage(text, type = 'success') {
      propMessageDiv.innerHTML = \`<div class="message \${type}">\${text}</div>\`;
      setTimeout(() => propMessageDiv.innerHTML = '', 5000);
    }

    async function loadProperties() {
      try {
        const response = await fetch('/admin/properties');
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        displayProperties(data.properties);
      } catch (error) {
        propertiesList.innerHTML = \`<div class="error">Error loading properties: \${error.message}</div>\`;
      }
    }

    function displayProperties(properties) {
      if (properties.length === 0) {
        propertiesList.innerHTML = '<p>No properties found.</p>';
        return;
      }

      propertiesList.innerHTML = properties.map(property => \`
        <div class="activity-item">
          <div class="activity-info">
            <div class="activity-slug">\${property.id}</div>
            <div class="activity-label">\${property.name}</div>
          </div>
          <div class="activity-actions">
            <button class="btn-danger" onclick="removeProperty('\${property.id}')">Remove</button>
          </div>
        </div>
      \`).join('');
    }

    document.getElementById('addPropertyForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('propId').value.trim();
      const name = document.getElementById('propName').value.trim();
      const copyDefaults = document.getElementById('copyDefaultActivities').checked;

      try {
        const response = await fetch('/admin/properties/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, name, copyDefaultActivities: copyDefaults })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showPropMessage(\`Property "\${name}" added successfully!\`);
        document.getElementById('addPropertyForm').reset();
        document.getElementById('copyDefaultActivities').checked = true;
        loadProperties();
      } catch (error) {
        showPropMessage(error.message, 'error');
      }
    });

    async function removeProperty(id) {
      if (!confirm(\`Remove property "\${id}"?\`)) return;

      try {
        const response = await fetch('/admin/properties/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showPropMessage(\`Property "\${id}" removed successfully!\`);
        loadProperties();
      } catch (error) {
        showPropMessage(error.message, 'error');
      }
    }

    // Hash verification only
    async function verifyDocumentHash(submissionId, activity) {
      try {
        const docResponse = await fetch('/admin/document?submission=' + submissionId + '&activity=' + activity);
        const docData = await docResponse.json();

        if (!docData.ok) {
          alert('Error: ' + docData.error);
          return;
        }

        const verifyResponse = await fetch('/admin/verify?document=' + docData.document_id);
        const verifyData = await verifyResponse.json();

        if (!verifyData.ok) {
          alert('Error: ' + verifyData.error);
          return;
        }

        if (verifyData.verified) {
          alert('✓ Hash Verified Successfully\\n\\nDocument ID: ' + docData.document_id + '\\nStored Hash: ' + verifyData.stored_hash.substring(0, 16) + '...\\nComputed Hash: ' + verifyData.computed_hash.substring(0, 16) + '...');
        } else {
          alert('✗ Hash Verification Failed\\n\\nDocument may have been tampered with\\nDocument ID: ' + docData.document_id + '\\nStored Hash: ' + verifyData.stored_hash.substring(0, 16) + '...\\nComputed Hash: ' + verifyData.computed_hash.substring(0, 16) + '...');
        }
      } catch (error) {
        alert('Error verifying hash: ' + error.message);
      }
    }

    async function downloadAllWaivers(submissionId) {
      window.location.href = '/admin/download-all?submission=' + submissionId;
    }

    // Legal Releases functionality
    async function loadReleases() {
      const currentReleaseDiv = document.getElementById('currentRelease');
      const historyDiv = document.getElementById('releaseHistory');

      try {
        const response = await fetch('/admin/releases');
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        // Display current release
        if (data.current) {
          const rel = data.current;
          currentReleaseDiv.innerHTML = \`
            <div style="padding: 15px; background: #f0f9ff; border-left: 4px solid #0070f3; border-radius: 4px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="font-size: 18px;">Version \${rel.version}</strong>
                <span style="color: #666; font-size: 14px;">\${new Date(rel.release_date).toLocaleDateString()}</span>
              </div>
              <div style="white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #333; margin-top: 10px;">\${rel.waiver_text}</div>
            </div>
          \`;
        } else {
          currentReleaseDiv.innerHTML = '<div class="empty">No releases yet. Create the first release below.</div>';
        }

        // Display history
        if (data.releases && data.releases.length > 0) {
          historyDiv.innerHTML = data.releases.map(rel => \`
            <div style="padding: 12px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>Version \${rel.version}</strong>
                <span style="color: #666; font-size: 13px;">\${new Date(rel.release_date).toLocaleDateString()}</span>
              </div>
              <div style="white-space: pre-wrap; font-size: 13px; line-height: 1.5; color: #555; margin-top: 8px; max-height: 100px; overflow-y: auto;">\${rel.waiver_text}</div>
            </div>
          \`).join('');
        } else {
          historyDiv.innerHTML = '<div class="empty">No release history</div>';
        }

        // Populate form with current waiver text
        if (data.current) {
          document.getElementById('waiverText').value = data.current.waiver_text;
        }
      } catch (error) {
        currentReleaseDiv.innerHTML = '<div class="error">Error loading releases: ' + error.message + '</div>';
        historyDiv.innerHTML = '';
      }
    }

    document.getElementById('releaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const version = document.getElementById('releaseVersion').value.trim();
      const waiverText = document.getElementById('waiverText').value.trim();

      try {
        const response = await fetch('/admin/releases/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ version: version || null, waiver_text: waiverText })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        showReleaseMessage(\`Release version \${data.version} created successfully!\`);
        document.getElementById('releaseVersion').value = '';
        loadReleases();
      } catch (error) {
        showReleaseMessage(error.message, 'error');
      }
    });

    function showReleaseMessage(msg, type = 'success') {
      const div = document.getElementById('releaseMessage');
      div.innerHTML = \`<div class="\${type === 'error' ? 'error' : 'success'}">\${msg}</div>\`;
      setTimeout(() => div.innerHTML = '', 5000);
    }

    // Debug functionality
    async function loadDebugData(forceRefresh = false) {
      const kvDataDiv = document.getElementById('kvData');
      const d1TablesDiv = document.getElementById('d1Tables');
      const lastUpdateSpan = document.getElementById('debugLastUpdate');

      try {
        kvDataDiv.innerHTML = '<div class="loading">Loading KV data...</div>';
        d1TablesDiv.innerHTML = '<div class="loading">Loading D1 tables...</div>';

        const response = await fetch('/admin/debug' + (forceRefresh ? '?refresh=true' : ''));
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        // Display last update time
        const lastUpdate = new Date(data.lastUpdate);
        lastUpdateSpan.textContent = 'Last updated: ' + lastUpdate.toLocaleString();

        // Display KV data
        let kvHtml = '<h3>All KV Keys</h3>';
        if (data.kv && Object.keys(data.kv).length > 0) {
          for (const [key, value] of Object.entries(data.kv)) {
            kvHtml += '<div style="margin-bottom: 20px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px;">';
            kvHtml += '<strong style="color: #0070f3; font-family: monospace;">' + escapeHtml(key) + '</strong>';
            kvHtml += '<pre style="margin: 10px 0 0 0; padding: 10px; background: #f5f5f5; border-radius: 4px; overflow-x: auto; font-size: 12px;">' + escapeHtml(JSON.stringify(value, null, 2)) + '</pre>';
            kvHtml += '</div>';
          }
        } else {
          kvHtml += '<p style="color: #666;">No KV data found</p>';
        }
        kvDataDiv.innerHTML = kvHtml;

        // Display D1 tables
        let d1Html = '';
        if (data.d1 && Object.keys(data.d1).length > 0) {
          for (const [tableName, tableData] of Object.entries(data.d1)) {
            d1Html += '<div style="margin-bottom: 30px;">';
            d1Html += '<h3 style="margin-bottom: 10px;">' + escapeHtml(tableName) + ' (' + tableData.count + ' rows)</h3>';

            if (tableData.rows && tableData.rows.length > 0) {
              d1Html += '<div style="overflow-x: auto;">';
              d1Html += '<table style="width: 100%; border-collapse: collapse; background: white;">';

              // Table headers
              d1Html += '<thead><tr>';
              const columns = Object.keys(tableData.rows[0]);
              columns.forEach(col => {
                d1Html += '<th style="padding: 10px; text-align: left; background: #f5f5f5; border: 1px solid #ddd; font-weight: 600;">' + escapeHtml(col) + '</th>';
              });
              d1Html += '</tr></thead>';

              // Table rows (limit to first 50 rows)
              d1Html += '<tbody>';
              tableData.rows.slice(0, 50).forEach(row => {
                d1Html += '<tr>';
                columns.forEach(col => {
                  let value = row[col];
                  if (value === null) value = '<em style="color: #999;">null</em>';
                  else if (typeof value === 'object') value = JSON.stringify(value);
                  else value = escapeHtml(String(value));
                  d1Html += '<td style="padding: 10px; border: 1px solid #ddd; font-size: 13px;">' + value + '</td>';
                });
                d1Html += '</tr>';
              });
              d1Html += '</tbody>';
              d1Html += '</table>';
              d1Html += '</div>';

              if (tableData.count > 50) {
                d1Html += '<p style="margin-top: 10px; color: #666; font-size: 13px;"><em>Showing first 50 of ' + tableData.count + ' rows</em></p>';
              }
            } else {
              d1Html += '<p style="color: #666;">No data in this table</p>';
            }
            d1Html += '</div>';
          }
        } else {
          d1Html += '<p style="color: #666;">No D1 tables found</p>';
        }
        d1TablesDiv.innerHTML = d1Html;

      } catch (error) {
        kvDataDiv.innerHTML = '<div class="error">Error loading KV data: ' + escapeHtml(error.message) + '</div>';
        d1TablesDiv.innerHTML = '<div class="error">Error loading D1 data: ' + escapeHtml(error.message) + '</div>';
      }
    }

    // API Documentation functionality
    function loadApiDocs() {
      const apiDocsDiv = document.getElementById('apiDocs');
      apiDocsDiv.innerHTML = \`<div class="loading">Loading API documentation...</div>\`;

      fetch('/admin/api-docs')
        .then(response => response.text())
        .then(markdown => {
          apiDocsDiv.innerHTML = convertMarkdownToHTML(markdown);
        })
        .catch(error => {
          apiDocsDiv.innerHTML = '<div class="error">Error loading API documentation</div>';
        });
    }

    // Simple markdown to HTML converter
    function convertMarkdownToHTML(markdown) {
      let html = markdown
        // Escape HTML
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // Headers
        .replace(/^### (.+)$/gm, '<h3 style="margin-top: 30px; color: #333;">$1</h3>')
        .replace(/^## (.+)$/gm, '<h2 style="margin-top: 40px; color: #0070f3; border-bottom: 2px solid #0070f3; padding-bottom: 10px;">$1</h2>')
        .replace(/^# (.+)$/gm, '<h1 style="color: #0070f3;">$1</h1>')
        // Bold
        .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')
        // Code blocks
        .replace(/\`\`\`(\\w+)?\\n([\\s\\S]*?)\`\`\`/g, '<pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; border: 1px solid #ddd;"><code>$2</code></pre>')
        // Inline code
        .replace(/\`([^\`]+)\`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em;">$1</code>')
        // Horizontal rule
        .replace(/^---$/gm, '<hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">')
        // Lists
        .replace(/^- (.+)$/gm, '<li style="margin: 5px 0;">$1</li>')
        // Wrap consecutive list items
        .replace(/(<li[^>]*>.*<\\/li>\\n?)+/g, '<ul style="margin: 10px 0; padding-left: 30px;">$&</ul>')
        // Paragraphs
        .replace(/^(?!<[h|u|p|l|d|c])(\\S.*)$/gm, '<p style="margin: 10px 0;">$1</p>');

      return html;
    }
  </script>
</body>
</html>
</file>

<file path="src/templates/archery-pin.html">
<div style="background-color: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 16px; margin: 20px 0;">
  <p style="margin: 0; color: #78350f; font-weight: 600;">Your Archery PIN: <strong>{{PIN}}</strong></p>
</div>
</file>

<file path="src/templates/archery-pin.txt">
Your Archery PIN is {{PIN}}
</file>

<file path="src/templates/email-verification.html">
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
  <h2 style="color: #3b82f6;">Complete Your Activity Waiver</h2>
  <p>Hi {{GUEST_NAME}},</p>
  <p>Thank you for starting your activity waiver submission!</p>
  <p>Please click the button below to continue and complete your waiver:</p>
  <div style="margin: 30px 0;">
    <a href="{{VERIFICATION_URL}}" style="background-color: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;">
      Complete Your Waiver
    </a>
  </div>
  <p style="color: #64748b; font-size: 14px;">This link will expire in 24 hours.</p>
  <p style="color: #64748b; font-size: 14px;">If you didn't request this waiver, you can safely ignore this email.</p>
  <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 30px 0;">
  <p style="color: #94a3b8; font-size: 12px;">Regards,<br>The Rentals Team</p>
</div>
</file>

<file path="src/templates/email-verification.txt">
SUBJECT: Complete Your Activity Waiver
FROM: Activity Waivers

Hi {{GUEST_NAME}},

Thank you for starting your activity waiver submission!

Please click the link below to continue and complete your waiver:
{{VERIFICATION_URL}}

This link will expire in 24 hours.

If you didn't request this waiver, you can safely ignore this email.

Regards,
The Rentals Team
</file>

<file path="src/templates/email-waiver.html">
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
  <h2 style="color: #3b82f6;">Your Activity Waivers</h2>
  <p>Hi {{GUEST_NAME}},</p>
  <p>Thank you for completing your waiver for <strong>{{PROPERTY_ID}}</strong>.</p>
  <p>Your signed waivers are attached to this email:</p>
  <ul style="color: #475569; line-height: 1.8;">
    {{PDF_LIST}}
  </ul>
  {{ARCHERY_PIN}}
  <p style="color: #64748b; font-size: 14px; margin-top: 30px;">Please keep these documents for your records.</p>
  <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 30px 0;">
  <p style="color: #94a3b8; font-size: 12px;">Regards,<br>The Rentals Team</p>
</div>
</file>

<file path="src/templates/email-waiver.txt">
SUBJECT: Your activity waiver(s)
FROM: Activity Waivers

Hi {{GUEST_NAME}},

Thank you for completing your waiver for {{PROPERTY_ID}}.
Attached: {{PDF_LIST}}

{{ARCHERY_PIN}}Regards,
The Rentals Team
</file>

<file path="src/templates/spa.html">
<!doctype html>
<html lang="en"><meta charset="utf-8">
<title>Activity Waiver</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;padding:2rem 1rem;background:#f8fafc;color:#1e293b;line-height:1.6}
  .container{max-width:1200px;margin:0 auto;background:white;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);overflow:hidden}
  .header{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);padding:2.5rem 2rem;color:white;text-align:center}
  .header h1{margin:0 0 0.5rem 0;font-size:2rem;font-weight:700}
  .header p{margin:0;opacity:0.9;font-size:1rem}
  .content{padding:2rem}
  .form-group{margin-bottom:1.5rem}
  .form-group label{display:block;margin-bottom:0.5rem;font-weight:600;font-size:0.875rem;color:#475569}
  .form-group input,.form-group select{width:100%;padding:0.75rem 1rem;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;transition:all 0.2s;max-width:400px}
  .form-group input:focus,.form-group select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
  .section-title{font-size:1.25rem;font-weight:700;color:#0f172a;margin:2rem 0 1rem 0;padding-bottom:0.5rem;border-bottom:2px solid #e2e8f0}
  .activities-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;column-gap:24px;padding:0;overflow:hidden}
  .activity-row{display:flex;gap:8px;align-items:center}
  .activity-item{display:flex;align-items:center;padding:12px;background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0;cursor:pointer;transition:all 0.2s;flex:1;position:relative;min-height:68px;overflow:hidden}
  .activity-item:hover{background:#f1f5f9;border-color:#3b82f6}
  .activity-item.checked{background:#eff6ff;border-color:#3b82f6}
  .activity-item input[type="checkbox"]{margin-right:10px;cursor:pointer;width:20px;height:20px;flex-shrink:0;accent-color:#3b82f6}
  .activity-item label{margin:0;cursor:pointer;flex:1;display:flex;align-items:center;gap:8px;position:relative;z-index:1;justify-content:space-between}
  .activity-label-text{white-space:nowrap;flex-shrink:0;min-width:120px;font-weight:600;color:#1e293b}
  .risk-chip-wrapper{display:flex;align-items:center;justify-content:flex-end;min-width:360px;width:360px;transition:all 0.3s ease;position:relative;overflow:visible;z-index:10}
  .risk-chip{padding:6px 14px;border-radius:12px;color:white;font-size:11px;font-weight:600;white-space:nowrap;display:inline-block;width:100px;text-align:center;box-sizing:border-box;flex-shrink:0;position:absolute;right:0;z-index:2}
  .risk-low{background:#10b981}
  .risk-medium{background:#f59e0b}
  .risk-high{background:#ef4444}
  .risk-details{position:absolute;right:110px;width:250px;opacity:0;font-size:9px;line-height:1.3;color:#334155;transition:opacity 0.3s ease;padding:4px 8px;display:block;box-sizing:border-box;max-height:56px;overflow-y:auto;background:white;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);white-space:normal}
  .risk-chip-wrapper:hover .risk-details{opacity:1}
  .activity-initial{width:70px;height:50px;text-align:center;padding:0;border:2px solid #cbd5e1;border-radius:8px;visibility:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;background:white;transition:all 0.2s}
  .activity-initial.visible{visibility:visible;border-color:#3b82f6}
  .activity-initial:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
  .acceptance-box{background:#fef3c7;border:2px solid #fbbf24;border-radius:10px;padding:1rem;margin:1.5rem 0;display:flex;align-items:center;gap:0.75rem;position:relative}
  .acceptance-box input[type="checkbox"]{width:20px;height:20px;accent-color:#f59e0b;cursor:pointer}
  .acceptance-box label{margin:0;font-weight:600;color:#78350f;cursor:pointer}
  .acceptance-box input[type="checkbox"]:disabled{cursor:not-allowed;opacity:0.5}
  .acceptance-box .tooltip{display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#1e293b;color:white;padding:0.5rem 1rem;border-radius:6px;font-size:0.875rem;white-space:nowrap;margin-bottom:0.5rem;font-weight:400}
  .acceptance-box .tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e293b}
  .acceptance-box:has(input[type="checkbox"]:disabled):hover .tooltip{display:block}
  .legal-preview{background:#f8fafc;border:2px solid #e2e8f0;border-radius:10px;padding:1rem;margin:1.5rem 0}
  .legal-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem}
  .legal-preview-title{font-weight:700;font-size:0.875rem;color:#475569}
  .legal-preview-version{font-size:0.75rem;color:#94a3b8}
  .legal-preview-content{max-height:150px;overflow-y:auto;font-size:0.75rem;line-height:1.5;color:#334155;white-space:pre-wrap;padding:0.75rem;background:white;border-radius:6px;border:1px solid #e2e8f0;transition:max-height 0.3s ease}
  .legal-preview-content.expanded{max-height:450px}
  .legal-preview-expand{padding:0.5rem 1rem;background:#64748b;color:white;font-size:0.75rem;font-weight:600;border:none;border-radius:6px;cursor:pointer;margin-top:0.75rem;transition:background 0.2s}
  .legal-preview-expand:hover{background:#475569}
  .signature-container{display:flex;flex-direction:column;align-items:center;gap:12px;padding:1.5rem;background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0}
  canvas{border:2px dashed #cbd5e1;border-radius:8px;width:90%;max-width:600px;touch-action:none;display:block;background:white}
  button{font-weight:600;border:none;cursor:pointer;transition:all 0.2s;font-size:1rem;border-radius:8px;font-family:inherit}
  #clearSig{padding:0.625rem 1.5rem;background:#64748b;color:white}
  #clearSig:hover{background:#475569}
  #submit{width:100%;padding:1rem;background:#3b82f6;color:white;font-size:1.125rem;margin-top:1.5rem;max-width:400px}
  #submit:hover:not(:disabled){background:#2563eb}
  #submit:disabled{opacity:0.5;cursor:not-allowed}
  .thanks{padding:2rem;text-align:center}
  .thanks h2{color:#3b82f6;font-size:1.75rem;margin-bottom:1rem}
  .info-box{background:#eff6ff;border:2px solid #3b82f6;border-radius:10px;padding:1rem;margin-bottom:1.5rem}
  .info-box p{margin:0.25rem 0;color:#1e40af}
  @media (max-width:768px){
    .content{padding:1.5rem}
    .activities-grid{grid-template-columns:1fr}
    .form-group input,.form-group select{width:100%;max-width:100%}
    canvas{width:100%}
  }
</style>

<body>
  <div class="container">
    <div class="header">
      <h1>Activity Waiver</h1>
      <p id="headerSubtitle">Complete your waiver to get started</p>
    </div>

    <div class="content">
      <!-- Initial Info Form -->
      <form id="initialForm">
        <div class="form-group">
          <label>Property</label>
          <select id="prop" required></select>
        </div>

        <div class="form-group">
          <label>Check-in Date</label>
          <input type="date" id="date" required>
        </div>

        <div class="form-group">
          <label>Full Name</label>
          <input id="name" required>
        </div>

        <div class="form-group">
          <label>Email Address</label>
          <input id="email" type="email" required>
        </div>

        <button id="initialSubmit">Continue to Activities</button>
      </form>

      <!-- Activity Selection Form (hidden initially) -->
      <form id="activityForm" hidden>
        <div class="info-box" id="guestInfo"></div>

        <h3 class="section-title">Select Activities</h3>
        <div id="activities" class="activities-grid"></div>

        <div class="legal-preview">
          <div class="legal-preview-header">
            <span class="legal-preview-title">Legal Release Preview</span>
            <span class="legal-preview-version" id="legalVersion"></span>
          </div>
          <div class="legal-preview-content" id="legalContent"></div>
          <button type="button" class="legal-preview-expand" id="expandLegal">Expand Preview</button>
        </div>

        <div class="acceptance-box">
          <input id="master" type="checkbox" required>
          <label for="master">I have read and accept all risks</label>
          <span class="tooltip" id="masterTooltip">Please initial all selected activities first</span>
        </div>

        <h3 class="section-title">Signature</h3>
        <div class="signature-container">
          <canvas id="sign" width="600" height="200"></canvas>
          <button id="clearSig" type="button">Clear</button>
        </div>

        <button id="submit">Submit Waiver</button>
      </form>

      <div id="thanks" class="thanks" hidden></div>
    </div>
  </div>

<script type="module">
{{BOOTSTRAP_SCRIPT}}
</script>
</body>
</html>
</file>

<file path="src/templates/spa.js">
{{BOOTSTRAP_DATA}}

  console.log("Props:", props);
  console.log("Risks:", risks);
  console.log("Submission:", submission);

  if (!Array.isArray(props)) {
    props = [props];
  }

  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePage);
  } else {
    initializePage();
  }

  function initializePage() {
    const propSel = document.getElementById('prop');
    if (!propSel) {
      console.error('Property select element not found');
      return;
    }

    if (!props || props.length === 0) {
      propSel.add(new Option('No properties available', ''));
      propSel.disabled = true;
    } else {
      props.forEach(p => propSel.add(new Option(p.name, p.id)));
    }

    setupFormHandlers();
  }

  function setupFormHandlers() {
    const propSel = document.getElementById('prop');

  /* ---------- Determine which form to show -------------------- */
  const initialForm = document.getElementById('initialForm');
  const activityForm = document.getElementById('activityForm');
  const headerSubtitle = document.getElementById('headerSubtitle');

  if (submission) {
    // Show activity form with pre-filled info
    initialForm.hidden = true;
    activityForm.hidden = false;
    headerSubtitle.textContent = 'Select your activities and sign';

    // Pre-fill property selection
    propSel.value = submission.property_id;
    propSel.disabled = true;

    // Show guest info
    document.getElementById('guestInfo').innerHTML =
      '<p><strong>Property:</strong> ' + props.find(p => p.id === submission.property_id)?.name + '</p>' +
      '<p><strong>Check-in:</strong> ' + submission.checkin_date + '</p>' +
      '<p><strong>Name:</strong> ' + submission.guest_name + '</p>' +
      '<p><strong>Email:</strong> ' + submission.guest_email + '</p>';
  } else {
    // Show initial form
    initialForm.hidden = false;
    activityForm.hidden = true;
  }

  /* ---------- Initial form submission -------------------- */
  document.getElementById('initialForm').onsubmit = async e => {
    e.preventDefault();

    const data = {
      propertyId: propSel.value,
      checkinDate: document.getElementById('date').value,
      guestName: document.getElementById('name').value,
      guestEmail: document.getElementById('email').value
    };

    console.log("Submitting initial form:", data);

    try {
      const res = await fetch('/submit/initial', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error("Server error:", errorText);
        alert("Error: " + errorText);
        return;
      }

      const json = await res.json();
      console.log("Response:", json);

      // Show confirmation message
      initialForm.hidden = true;
      document.getElementById('thanks').hidden = false;
      document.getElementById('thanks').innerHTML =
        '<h2>✓ Check Your Email</h2>' +
        '<p style="color:#64748b;margin-bottom:1.5rem">We\'ve sent a verification link to <strong>' + data.guestEmail + '</strong></p>' +
        '<p style="color:#94a3b8;font-size:0.875rem">Click the link in the email to continue with your waiver.</p>';
    } catch (error) {
      console.error("Form submission error:", error);
      alert("Error: " + error.message);
    }
  };

  /* ---------- activity checkboxes ------------------------- */
  const actsDiv = document.getElementById('activities');
  const masterCheck = document.getElementById('master');
  let chosen = new Map();

  function loadActivities() {
    const selectedProp = props.find(p => p.id === (submission ? submission.property_id : propSel.value));
    const activities = selectedProp?.activities ?? [];

    actsDiv.innerHTML = '';
    chosen.clear();
    masterCheck.disabled = true;
    masterCheck.checked = false;

    activities.forEach(a => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'activity-row';

      const itemDiv = document.createElement('div');
      itemDiv.className = 'activity-item';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = 'activity-' + a.slug;
      checkbox.value = a.slug;

      const label = document.createElement('label');
      label.htmlFor = 'activity-' + a.slug;

      const labelText = document.createElement('span');
      labelText.className = 'activity-label-text';
      labelText.textContent = a.label;
      label.appendChild(labelText);

      if (a.risk) {
        const chipWrapper = document.createElement('div');
        chipWrapper.className = 'risk-chip-wrapper';

        const riskChip = document.createElement('span');
        riskChip.className = 'risk-chip risk-' + a.risk;
        riskChip.textContent = a.risk.charAt(0).toUpperCase() + a.risk.slice(1) + ' Risk';

        const riskDetails = document.createElement('span');
        riskDetails.className = 'risk-details';

        const riskData = risks[a.risk];
        if (riskData) {
          riskDetails.textContent = riskData.description || 'Activity-specific risks apply';
        } else {
          riskDetails.textContent = 'Activity-specific risks apply';
        }

        chipWrapper.appendChild(riskChip);
        chipWrapper.appendChild(riskDetails);
        label.appendChild(chipWrapper);
      }

      const initialInput = document.createElement('input');
      initialInput.type = 'text';
      initialInput.maxLength = 4;
      initialInput.placeholder = 'Initials';
      initialInput.className = 'activity-initial';
      initialInput.dataset.slug = a.slug;
      initialInput.oninput = validateMasterCheckbox;

      checkbox.onchange = () => {
        if (checkbox.checked) {
          chosen.set(a.slug, {itemDiv, initialInput});
          initialInput.classList.add('visible');
          itemDiv.classList.add('checked');
        } else {
          chosen.delete(a.slug);
          initialInput.classList.remove('visible');
          initialInput.value = '';
          itemDiv.classList.remove('checked');
        }
        validateMasterCheckbox();
      };

      itemDiv.appendChild(checkbox);
      itemDiv.appendChild(label);

      itemDiv.onclick = () => {
        checkbox.checked = !checkbox.checked;
        checkbox.onchange();
      };

      rowDiv.appendChild(itemDiv);
      rowDiv.appendChild(initialInput);
      actsDiv.appendChild(rowDiv);
    });
  }

  function validateMasterCheckbox() {
    let allFilled = true;
    for (const [slug, {initialInput}] of chosen) {
      if (!initialInput.value.trim()) {
        allFilled = false;
        break;
      }
    }
    masterCheck.disabled = !allFilled || chosen.size === 0;
    if (masterCheck.disabled) {
      masterCheck.checked = false;
    }
  }

  if (submission) {
    loadActivities();
    validateMasterCheckbox();

    // Populate legal release preview
    if (release) {
      document.getElementById('legalVersion').textContent = 'Version ' + release.version + ' (' + release.release_date + ')';
      document.getElementById('legalContent').textContent = release.waiver_text;
    }
  }

  /* ---------- legal preview expand/collapse -------------------- */
  document.getElementById('expandLegal')?.addEventListener('click', function() {
    const content = document.getElementById('legalContent');
    const isExpanded = content.classList.contains('expanded');

    if (isExpanded) {
      content.classList.remove('expanded');
      this.textContent = 'Expand Preview';
    } else {
      content.classList.add('expanded');
      this.textContent = 'Collapse Preview';
    }
  });

  /* ---------- signature pad -------------------------------- */
  const canvas = document.getElementById('sign');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  let drawing = false;

  canvas.addEventListener('pointerdown', e => {
    drawing = true;
    ctx.moveTo(e.offsetX, e.offsetY);
  });
  canvas.addEventListener('pointermove', e => {
    if (!drawing) return;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });
  canvas.addEventListener('pointerup', () => drawing = false);
  document.getElementById('clearSig').onclick =
    () => ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* ---------- activity form submit --------------------------------------- */
  document.getElementById('activityForm').onsubmit = async e => {
    e.preventDefault();

    if (!submission) {
      alert('Invalid submission. Please start over.');
      return;
    }

    const data = {
      submissionId: submission.submission_id,
      activities: [...chosen.keys()],
      initials: Object.fromEntries(
        [...chosen.entries()].map(([slug, {initialInput}]) =>
          [slug, initialInput.value])),
      signature: canvas.toDataURL(),
      accepted: document.getElementById('master').checked
    };

    console.log("Submitting activity form:", data);

    try {
      const res = await fetch('/submit/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error("Server error:", errorText);
        alert("Error submitting form: " + errorText);
        return;
      }

      const json = await res.json();
      console.log("Response data:", json);

      document.getElementById('activityForm').hidden = true;
      document.getElementById('thanks').hidden = false;

      if (json.devMode) {
        let html = '<h2>✓ Waivers Generated</h2>';
        html += '<p style="color:#64748b;margin-bottom:1.5rem">Your waivers are ready to download</p>';
        html += '<div style="display:flex;flex-direction:column;gap:12px">';

        json.downloads.forEach(pdf => {
          html += '<button onclick="window.open(&quot;' + pdf.url + '&quot;, &quot;_blank&quot;)" ';
          html += 'style="padding:12px 24px;background:#3b82f6;color:white;border:none;';
          html += 'border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;';
          html += 'transition:background 0.2s"';
          html += ' onmouseover="this.style.background=&quot;#2563eb&quot;"';
          html += ' onmouseout="this.style.background=&quot;#3b82f6&quot;">';
          html += '📄 Download ' + pdf.filename + '</button>';
        });

        html += '</div>';

        if (json.downloads.length > 1) {
          html += '<button onclick="';
          json.downloads.forEach(pdf => {
            html += 'window.open(&quot;' + pdf.url + '&quot;, &quot;_blank&quot;);';
          });
          html += '" style="padding:14px 28px;background:#10b981;color:white;border:none;';
          html += 'border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;margin-top:12px;';
          html += 'transition:background 0.2s"';
          html += ' onmouseover="this.style.background=&quot;#059669&quot;"';
          html += ' onmouseout="this.style.background=&quot;#10b981&quot;">';
          html += '📦 Download All (' + json.downloads.length + ' PDFs)</button>';
        }

        if (json.pin) {
          html += '<div style="margin-top:1.5rem;padding:1rem;background:#fef3c7;border:2px solid #fbbf24;border-radius:8px">';
          html += '<p style="margin:0;color:#78350f;font-weight:600">Archery PIN: <strong>' + json.pin + '</strong></p></div>';
        }

        html += '<p style="margin-top:1.5rem;color:#94a3b8;font-size:0.875rem">';
        html += '⚠️ Development Mode - PDFs stored locally, not emailed</p>';

        document.getElementById('thanks').innerHTML = html;
      } else {
        let html = '<h2>✓ Success</h2>';
        html += '<p style="color:#64748b;margin-bottom:1.5rem">Your waivers have been sent to your email</p>';
        if (json.pin) {
          html += '<div style="margin-top:1.5rem;padding:1rem;background:#fef3c7;border:2px solid #fbbf24;border-radius:8px">';
          html += '<p style="margin:0;color:#78350f;font-weight:600">Archery PIN: <strong>' + json.pin + '</strong></p></div>';
        }
        document.getElementById('thanks').innerHTML = html;
      }
    } catch (error) {
      console.error("Form submission error:", error);
      alert("Error submitting form: " + error.message);
    }
  };
  }
</file>

<file path="src/templates/waiver.html">
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @page {
      size: A4;
      margin: 50pt 50pt 80pt 50pt;
    }

    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      font-size: 12pt;
      line-height: 1.6;
      color: #000;
      margin: 0;
      padding: 0;
    }

    h1 {
      font-size: 20pt;
      font-weight: bold;
      margin: 0 0 40px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .details {
      margin-bottom: 40px;
      line-height: 2;
      font-size: 12pt;
    }

    .risk-section {
      margin: 30px 0 40px 0;
    }

    .risk-level {
      font-weight: bold;
      font-size: 12pt;
      margin-bottom: 12px;
    }

    .risk-description {
      color: #4d4d4d;
      font-size: 10pt;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .waiver-section {
      margin: 30px 0 40px 0;
    }

    .waiver-title {
      font-weight: bold;
      font-size: 12pt;
      margin-bottom: 12px;
    }

    .waiver-text {
      font-size: 9pt;
      line-height: 1.55;
      white-space: pre-wrap;
      text-align: justify;
    }

    .signature-section {
      margin-top: 50px;
      page-break-inside: avoid;
    }

    .signature-label {
      font-size: 12pt;
      margin-bottom: 10px;
      font-weight: normal;
    }

    .signature-image {
      max-width: 400px;
      max-height: 150px;
      display: block;
      margin-top: 10px;
    }

    .no-signature {
      color: #808080;
      font-size: 10pt;
      font-style: italic;
    }

    .footer {
      position: fixed;
      bottom: 30pt;
      right: 50pt;
      text-align: right;
      font-size: 7pt;
      color: #808080;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <h1>{{ACTIVITY_LABEL}} — Release of Liability</h1>

  <div class="details">
    Property  : {{PROPERTY_ID}}<br>
    Check-in  : {{CHECKIN_DATE}}<br>
    Guest     : {{GUEST_NAME}}<br>
    Initials  : {{INITIALS}}
  </div>

  <div class="risk-section">
    <div class="risk-level">Risk Level: {{RISK_LEVEL}}</div>
    {{RISK_DESCRIPTION}}
  </div>

  <div class="waiver-section">
    <div class="waiver-title">Waiver and Release:</div>
    <div class="waiver-text">{{WAIVER_TEXT}}</div>
  </div>

  <div class="signature-section">
    <div class="signature-label">Signature:</div>
    {{SIGNATURE}}
  </div>

  <div class="footer">
    Legal Version {{RELEASE_VERSION}} ({{RELEASE_DATE}}) • Document ID: {{DOCUMENT_ID}}<br>
    Verification Hash: {{DOCUMENT_HASH_SHORT}}...
  </div>
</body>
</html>
</file>

<file path="src/utils/admin.js">
import adminTemplate from '../templates/admin.html';

export const json = (obj, status = 200) =>
  new Response(JSON.stringify(obj), {
    status,
    headers: { 'content-type': 'application/json' }
  });

export const bad = msg => json({ ok: false, error: msg }, 400);

export async function handleAdmin() {
  return new Response(adminTemplate, {
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}
</file>

<file path="src/utils/db.js">
// Database query utilities
// Centralized database access layer for D1 database operations

// Submissions
export async function getSubmissionByToken(env, verificationToken) {
  return await env.waivers.prepare(
    'SELECT submission_id, property_id, checkin_date, guest_name, guest_email, status, token_expires_at FROM submissions WHERE verification_token = ?'
  ).bind(verificationToken).first();
}

export async function getSubmissionById(env, submissionId) {
  return await env.waivers.prepare(
    'SELECT * FROM submissions WHERE submission_id = ?'
  ).bind(submissionId).first();
}

export async function createSubmission(env, submissionId, verificationToken, data, createdAt, expiresAt) {
  return await env.waivers.prepare(
    `INSERT INTO submissions
     (submission_id, verification_token, property_id, checkin_date, guest_name, guest_email, status, created_at, token_expires_at)
     VALUES (?, ?, ?, ?, ?, ?, 'pending', ?, ?)`
  ).bind(
    submissionId,
    verificationToken,
    data.propertyId,
    data.checkinDate,
    data.guestName,
    data.guestEmail,
    createdAt,
    expiresAt
  ).run();
}

export async function updateSubmissionStatus(env, submissionId, status, completedAt = null) {
  if (completedAt) {
    return await env.waivers.prepare(
      'UPDATE submissions SET status = ?, completed_at = ? WHERE submission_id = ?'
    ).bind(status, completedAt, submissionId).run();
  }
  return await env.waivers.prepare(
    'UPDATE submissions SET status = ? WHERE submission_id = ?'
  ).bind(status, submissionId).run();
}

export async function updateSubmissionActivities(env, submissionId, activities) {
  return await env.waivers.prepare(
    'UPDATE submissions SET activities = ? WHERE submission_id = ?'
  ).bind(JSON.stringify(activities), submissionId).run();
}

// Properties
export async function getAllProperties(env, excludeDefault = true) {
  if (excludeDefault) {
    const result = await env.waivers.prepare(
      'SELECT id, name FROM properties WHERE id != ? ORDER BY name'
    ).bind('default').all();
    return result.results || [];
  }
  const result = await env.waivers.prepare(
    'SELECT id, name FROM properties ORDER BY name'
  ).all();
  return result.results || [];
}

export async function getPropertyById(env, propertyId) {
  return await env.waivers.prepare(
    'SELECT * FROM properties WHERE id = ?'
  ).bind(propertyId).first();
}

export async function createProperty(env, id, name) {
  return await env.waivers.prepare(
    'INSERT INTO properties (id, name) VALUES (?, ?)'
  ).bind(id, name).run();
}

export async function deleteProperty(env, id) {
  return await env.waivers.prepare(
    'DELETE FROM properties WHERE id = ?'
  ).bind(id).run();
}

// Activities
export async function getActivitiesByProperty(env, propertyId) {
  const result = await env.waivers.prepare(
    'SELECT slug, label, risk FROM activities WHERE property_id = ? ORDER BY label'
  ).bind(propertyId).all();
  return result.results || [];
}

export async function getActivityBySlug(env, propertyId, slug) {
  return await env.waivers.prepare(
    'SELECT * FROM activities WHERE property_id = ? AND slug = ?'
  ).bind(propertyId, slug).first();
}

export async function createActivity(env, propertyId, slug, label, risk) {
  return await env.waivers.prepare(
    'INSERT INTO activities (property_id, slug, label, risk) VALUES (?, ?, ?, ?)'
  ).bind(propertyId, slug, label, risk).run();
}

export async function updateActivity(env, propertyId, slug, label, risk) {
  return await env.waivers.prepare(
    'UPDATE activities SET label = ?, risk = ? WHERE property_id = ? AND slug = ?'
  ).bind(label, risk, propertyId, slug).run();
}

export async function deleteActivity(env, propertyId, slug) {
  return await env.waivers.prepare(
    'DELETE FROM activities WHERE property_id = ? AND slug = ?'
  ).bind(propertyId, slug).run();
}

export async function copyActivitiesFromDefault(env, targetPropertyId) {
  const defaultActivities = await getActivitiesByProperty(env, 'default');
  for (const activity of defaultActivities) {
    await createActivity(env, targetPropertyId, activity.slug, activity.label, activity.risk);
  }
}

// Risk Descriptions
export async function getAllRiskDescriptions(env) {
  const result = await env.waivers.prepare(
    'SELECT level, description FROM risk_descriptions'
  ).all();
  const risks = {};
  for (const row of (result.results || [])) {
    risks[row.level] = { description: row.description };
  }
  return risks;
}

export async function updateRiskDescription(env, level, description) {
  return await env.waivers.prepare(
    'INSERT OR REPLACE INTO risk_descriptions (level, description) VALUES (?, ?)'
  ).bind(level, description).run();
}

// Legal Releases
export async function getLatestRelease(env) {
  return await env.waivers.prepare(
    'SELECT version, release_date, waiver_text FROM releases ORDER BY release_date DESC, version DESC LIMIT 1'
  ).first();
}

export async function getAllReleases(env) {
  const result = await env.waivers.prepare(
    'SELECT version, release_date, waiver_text FROM releases ORDER BY release_date DESC, version DESC'
  ).all();
  return result.results || [];
}

export async function createRelease(env, version, releaseDate, waiverText) {
  return await env.waivers.prepare(
    'INSERT INTO releases (version, release_date, waiver_text) VALUES (?, ?, ?)'
  ).bind(version, releaseDate, waiverText).run();
}

// Documents (legacy)
export async function getDocumentById(env, documentId) {
  return await env.waivers.prepare(
    'SELECT * FROM documents WHERE document_id = ?'
  ).bind(documentId).first();
}

export async function getDocumentsBySubmission(env, submissionId) {
  const result = await env.waivers.prepare(
    'SELECT document_id, activity FROM documents WHERE submission_id = ? ORDER BY created_at'
  ).bind(submissionId).all();
  return result.results || [];
}

export async function createDocument(env, documentId, submissionId, activity, r2Key, initials) {
  return await env.waivers.prepare(
    'INSERT INTO documents (document_id, submission_id, activity, r2_key, initials) VALUES (?, ?, ?, ?, ?)'
  ).bind(documentId, submissionId, activity, r2Key, initials).run();
}

// Document Hashes (legacy)
export async function createHash(env, hashId, documentId, hashValue, createdAt) {
  return await env.waivers.prepare(
    'INSERT INTO hashes (hash_id, document_id, hash_value, created_at) VALUES (?, ?, ?, ?)'
  ).bind(hashId, documentId, hashValue, createdAt).run();
}

export async function getHashByDocument(env, documentId) {
  return await env.waivers.prepare(
    'SELECT * FROM hashes WHERE document_id = ?'
  ).bind(documentId).first();
}

// Submission Activities (new structure)
export async function createSubmissionActivity(env, activityId, verificationToken, activitySlug, activityLabel, initials, documentHash, r2Key, createdAt) {
  return await env.waivers.prepare(
    `INSERT INTO submission_activities
     (activity_id, verification_token, activity_slug, activity_label, initials, document_hash, r2_key, created_at)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
  ).bind(
    activityId,
    verificationToken,
    activitySlug,
    activityLabel,
    initials,
    documentHash,
    r2Key,
    createdAt
  ).run();
}

export async function getSubmissionActivitiesByToken(env, verificationToken) {
  const result = await env.waivers.prepare(
    'SELECT * FROM submission_activities WHERE verification_token = ?'
  ).bind(verificationToken).all();
  return result.results || [];
}

// Search
export async function searchSubmissions(env, whereClause, params) {
  const query = `
    SELECT * FROM submissions
    ${whereClause}
    ORDER BY created_at DESC
    LIMIT 200
  `;
  const result = await env.waivers.prepare(query).bind(...params).all();
  return result.results || [];
}

export async function searchSubmissionsByActivity(env, whereClause, baseParams, activity) {
  const query = `
    SELECT DISTINCT s.*
    FROM submissions s
    LEFT JOIN submission_activities sa ON s.verification_token = sa.verification_token
    ${whereClause}
    ${baseParams.length > 0 ? 'AND' : 'WHERE'} (
      s.activities LIKE ? OR sa.activity_slug LIKE ?
    )
    ORDER BY s.created_at DESC
    LIMIT 200
  `;
  const allParams = [...baseParams, `%${activity}%`, `%${activity}%`];
  const result = await env.waivers.prepare(query).bind(...allParams).all();
  return result.results || [];
}
</file>

<file path="src/utils/nanoid.js">
// In-house nanoid implementation
// Generates cryptographically secure random IDs

const urlAlphabet = 'useandom26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict';

export function nanoid(size = 21) {
  let id = '';
  const bytes = crypto.getRandomValues(new Uint8Array(size));

  while (size--) {
    id += urlAlphabet[bytes[size] & 63];
  }

  return id;
}

export function customAlphabet(alphabet, defaultSize = 21) {
  return (size = defaultSize) => {
    let id = '';
    const mask = (2 << Math.log2(alphabet.length - 1)) - 1;
    const step = -~((1.6 * mask * size) / alphabet.length);

    while (true) {
      const bytes = crypto.getRandomValues(new Uint8Array(step));
      let i = step;

      while (i--) {
        id += alphabet[bytes[i] & mask] || '';
        if (id.length >= size) return id;
      }
    }
  };
}
</file>

<file path="src/utils/spa.js">
import spaTemplate from '../templates/spa.html';
import spaScript from '../templates/spa.js';
import {
  getSubmissionByToken,
  getAllProperties,
  getActivitiesByProperty,
  getAllRiskDescriptions,
  getLatestRelease
} from './db.js';

export async function htmlPage(env, submissionToken = null) {
  // Helper function to encode data to base64
  function encodeToBase64(data) {
    const json = data === null || data === undefined ? 'null' : JSON.stringify(data);
    return btoa(unescape(encodeURIComponent(json)));
  }

  let submissionData = null;

  // If token provided, fetch submission details
  if (submissionToken) {
    const result = await getSubmissionByToken(env, submissionToken);

    if (result && result.status === 'pending') {
      const expires = new Date(result.token_expires_at);
      if (expires > new Date()) {
        submissionData = result;
      }
    }
  }

  // Fetch all properties from database (excluding default template)
  const properties = await getAllProperties(env, true);

  // Fetch activities for each property
  const propsData = [];
  for (const property of properties) {
    const activities = await getActivitiesByProperty(env, property.id);

    propsData.push({
      id: property.id,
      name: property.name,
      activities
    });
  }

  // Fetch risk descriptions from database
  const risks = await getAllRiskDescriptions(env);

  // Fetch latest legal release
  const latestRelease = await getLatestRelease(env);

  const props64 = encodeToBase64(propsData);
  const risks64 = encodeToBase64(risks);
  const submission64 = encodeToBase64(submissionData);
  const release64 = encodeToBase64(latestRelease);

  const bootstrapData = `
  let props = JSON.parse(atob('${props64}'));
  const risks = JSON.parse(atob('${risks64}'));
  const submission = JSON.parse(atob('${submission64}'));
  const release = JSON.parse(atob('${release64}'));
  `;

  const fullScript = spaScript.replace('{{BOOTSTRAP_DATA}}', bootstrapData);
  const html = spaTemplate.replace('{{BOOTSTRAP_SCRIPT}}', fullScript);

  return new Response(html, {
    headers: { 'content-type': 'text/html; charset=utf-8' }
  });
}
</file>

<file path="src/index.js">
import { handleRoot } from './routes/root.js';
import { handleInitialSubmit, handleCompleteSubmit } from './routes/submit.js';
import { handleAdminSearch } from './routes/admin/search.js';
import { handleAdminActivities } from './routes/admin/activities.js';
import { handleAdminRisks } from './routes/admin/risks.js';
import { handleAdminProperties } from './routes/admin/properties.js';
import { handleAdminDocument } from './routes/admin/document.js';
import { handleAdminVerify } from './routes/admin/verify.js';
import { handleAdminReleases } from './routes/admin/releases.js';
import { handleAdminDownloadAll } from './routes/admin/download-all.js';
import { handleAdminDebug } from './routes/admin/debug.js';
import { handleAdminApiDocs } from './routes/admin/api-docs.js';
import { handleStatus } from './routes/status.js';
import { handleDownload } from './routes/download.js';
import { handleAdmin } from './utils/admin.js';

export default {
  async fetch(request, env, ctx) {
    const { pathname } = new URL(request.url);

    try {
      if (request.method === 'GET'  && pathname === '/')                      return await handleRoot(request, env);
      if (request.method === 'POST' && pathname === '/submit/initial')        return await handleInitialSubmit(request, env);
      if (request.method === 'POST' && pathname === '/submit/complete')       return await handleCompleteSubmit(request, env, ctx);
      if (request.method === 'GET'  && pathname === '/admin/search')          return await handleAdminSearch(request, env);
      if (request.method === 'GET'  && pathname === '/status')                return await handleStatus(env);
      
      if (request.method === 'GET'  && pathname === '/admin')                 return await handleAdmin();
	  if (request.method === 'GET'  && pathname === '/admin/document')        return await handleAdminDocument(request, env);
      if (request.method === 'GET'  && pathname === '/admin/verify')          return await handleAdminVerify(request, env);
      if (request.method === 'GET'  && pathname === '/admin/download-all')    return await handleAdminDownloadAll(request, env);
      if (request.method === 'GET'  && pathname === '/admin/debug')           return await handleAdminDebug(request, env);
      if (request.method === 'GET'  && pathname === '/admin/api-docs')        return await handleAdminApiDocs();
      if ((request.method === 'GET' || request.method === 'POST') && pathname.startsWith('/admin/releases'))	return await handleAdminReleases(request, env);
      if ((request.method === 'GET' || request.method === 'POST') && pathname.startsWith('/admin/activities')) 	return await handleAdminActivities(request, env);
      if ((request.method === 'GET' || request.method === 'POST') && pathname.startsWith('/admin/properties'))	return await handleAdminProperties(request, env);
      if ((request.method === 'GET' || request.method === 'POST') && pathname === '/admin/risks')				return await handleAdminRisks(request, env);
      if (request.method === 'GET'  && pathname.startsWith('/download/'))     return await handleDownload(request, env);

      return new Response('Not found', { status: 404 });
    } catch (err) {
      console.error(err);
      return new Response('Server error', { status: 500 });
    }
  }
};
</file>

<file path=".gitignore">
node_modules/
dist/
.env
.dev.vars
.claude/
CLAUDE.md
generate_test_data.js
</file>

<file path="package.json">
{
  "name": "cf",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "resend": "^6.1.1"
  }
}
</file>

<file path="README.md">
# Waiver Worker - Activity Liability Waiver System

A Cloudflare Workers-based application for managing digital liability waivers for rental properties and activities. This system collects guest signatures, generates PDF waivers, and emails them automatically.

## Overview

This application provides a complete digital waiver management solution built on Cloudflare's edge platform:
- **Digital Signature Collection**: Web-based form for guests to sign waivers
- **PDF Generation**: Automatic PDF creation with signatures using Cloudflare Browser Rendering
- **Email Delivery**: Automated waiver delivery to guests via Cloudflare Email
- **Data Storage**: Persistent storage using D1 (database) and R2 (object storage)
- **Activity-Specific Waivers**: Separate waivers for different activities (kayaking, pool, archery, sauna)

## Architecture

### Core Components

#### Main Worker (`waiver-worker`)
- **Location**: `src/index.mjs`
- **Routes**:
  - `GET /` - Serves the single-page application for waiver signing
  - `POST /submit` - Processes waiver submissions
  - `GET /admin/search` - Admin search interface for submitted waivers
  - `GET /status` - Health check endpoint

#### Browser Rendering Worker
- **Location**: `browser-worker/`
- **Purpose**: Converts HTML to PDF using Cloudflare's Browser Rendering API
- **RPC Method**: `htmlToPdf()` - Called by main worker via service binding

### Data Flow

1. **Guest fills out waiver form** (`spa.js`)
   - Selects property and check-in date
   - Chooses activities requiring waivers
   - Provides initials for each activity
   - Signs digitally on canvas
   - Accepts terms

2. **Form submission** (`index.mjs`)
   - Validates all required fields
   - Generates unique submission ID
   - Stores submission in D1 database

3. **PDF generation** (`pdf.js`)
   - Creates one PDF per selected activity
   - Uses Browser Rendering Worker for HTML-to-PDF conversion
   - Stores PDFs in R2 bucket with structured key format:
     ```
     waivers/YYYY/MM/DD/property-id/activity/guest-name-{id}.pdf
     ```

4. **Email delivery** (`mail.js`)
   - Constructs MIME multipart email with PDF attachments
   - Sends via Cloudflare Email API
   - Includes archery PIN if applicable

## Database Schema

### `submissions` Table
- `id` - Unique identifier (nanoid)
- `created_at` - ISO timestamp
- `property_id` - Property identifier
- `checkin_date` - Guest check-in date
- `guest_name` - Guest full name
- `guest_email` - Guest email address
- `activities` - JSON array of selected activity slugs

### `documents` Table
- `id` - Document identifier
- `submission_id` - Foreign key to submissions
- `activity` - Activity name
- `r2_key` - R2 storage key for PDF

## Configuration

### Environment Variables (via `wrangler.toml`)

**Public Variables**:
- `ARCHERY_PIN` - PIN code for archery activity (default: "1234")
- `LEGAL_VERSION` - Version identifier for legal documents (default: "2024-06")
- `EMAIL_FROM` - From address for waiver emails (default: "waivers@example.com")
- `DEV_MODE` - Enable development mode with PDF downloads instead of email (default: "true", set to "false" for production)

**Bindings**:
- `PROPS_KV` - KV namespace for property data
- `WAIVERS_R2` - R2 bucket for PDF storage
- `DB` (waivers) - D1 database for submissions
- `BROWSER` - Service binding to browser-worker

**Secrets** (must be configured):
- `CLOUDFLARE_ACCOUNT_ID` - Your Cloudflare account ID
- `CLOUDFLARE_API_TOKEN` - API token with email send permissions

## Setup Instructions

### Prerequisites
- Cloudflare account with Workers subscription
- Node.js and npm installed
- Wrangler CLI installed (`npm install -g wrangler`)
- Cloudflare API token (for remote deployment)

### Installation Steps

1. **Install dependencies**:
   ```bash
   npm install
   cd browser-worker && npm install && cd ..
   ```

2. **Create Cloudflare resources**:
   ```bash
   # Create production KV namespace
   wrangler kv namespace create PROPS_KV

   # Create development KV namespace
   wrangler kv namespace create DEV_PROPS_KV

   # Create D1 database
   wrangler d1 create waivers

   # Create R2 bucket (via Cloudflare dashboard)
   # Navigate to R2 and create bucket named "waivers"
   ```

3. **Update `wrangler.toml`** with your resource IDs:
   - Production KV namespace ID (id field)
   - Development KV namespace ID (preview_id field)
   - D1 database ID
   - Update email configuration

4. **Initialize database**:
   ```bash
   # Local database
   wrangler d1 execute waivers --local --file=migrations/0001_init.sql

   # Remote database (requires API token)
   wrangler d1 execute waivers --remote --file=migrations/0001_init.sql
   ```

5. **Deploy browser rendering worker**:
   ```bash
   cd browser-worker
   wrangler deploy
   cd ..
   ```

6. **Configure secrets** (for production):
   ```bash
   wrangler secret put CLOUDFLARE_ACCOUNT_ID
   wrangler secret put CLOUDFLARE_API_TOKEN
   ```

7. **Populate property data** in KV:
   ```bash
   # Development namespace
   wrangler kv key put --binding=PROPS_KV props '[{"id":"cabin-12","name":"Riverside Cabin 12","activities":[{"slug":"archery","label":"Archery"},{"slug":"kayaking","label":"Kayaking"},{"slug":"ziplining","label":"Ziplining"},{"slug":"snorkeling","label":"Snorkeling"},{"slug":"safari-tour","label":"Safari Tour"},{"slug":"boat-tour","label":"Boat Tour"},{"slug":"spelunking","label":"Spelunking"},{"slug":"scuba-diving","label":"Scuba Diving"},{"slug":"paragliding","label":"Paragliding"},{"slug":"bungee-jumping","label":"Bungee Jumping"}]}]' --preview

   # Production namespace
   wrangler kv key put --binding=PROPS_KV props '[{"id":"cabin-12","name":"Riverside Cabin 12","activities":[{"slug":"archery","label":"Archery"},{"slug":"kayaking","label":"Kayaking"},{"slug":"ziplining","label":"Ziplining"},{"slug":"snorkeling","label":"Snorkeling"},{"slug":"safari-tour","label":"Safari Tour"},{"slug":"boat-tour","label":"Boat Tour"},{"slug":"spelunking","label":"Spelunking"},{"slug":"scuba-diving","label":"Scuba Diving"},{"slug":"paragliding","label":"Paragliding"},{"slug":"bungee-jumping","label":"Bungee Jumping"}]}]'
   ```

8. **Deploy main worker**:
   ```bash
   wrangler deploy
   ```

## Development

### Development Mode

The application includes a development mode that bypasses email sending and allows direct PDF downloads. This is useful for testing without configuring email services.

**When `DEV_MODE="true"` in `wrangler.toml`:**
- Form submissions generate PDFs as normal
- PDFs are stored in R2 but NOT emailed
- User receives download buttons for each PDF
- Multiple PDFs can be downloaded individually or all at once
- A `/download/:key` endpoint is available for retrieving PDFs

**To enable/disable development mode:**
```toml
# wrangler.toml
[vars]
DEV_MODE = "true"   # Development - PDFs downloadable
# DEV_MODE = "false" # Production - PDFs emailed
```

### Local Development

#### Using Remote Browser Worker
Since the Browser Rendering API requires Cloudflare's infrastructure, local development uses the deployed browser-worker:

```bash
# Option 1: Use remote flag (all remote resources)
wrangler dev --remote

# Option 2: Use development config with selective remote bindings
wrangler dev --config wrangler.dev.toml --local
```

#### Development Setup
1. Browser-worker must be deployed to Cloudflare first
2. Local development uses:
   - Local D1 database
   - Local preview KV namespace (DEV_PROPS_KV)
   - Local R2 storage
   - **Remote browser-worker service** for PDF generation

**Development Mode Features:**
- Individual download buttons for each activity waiver
- "Download All" button when multiple PDFs are generated
- Visual indicator showing development mode is active
- No email configuration required
- PDFs still stored in R2 for persistence
- Real PDF generation using remote browser service

### Testing
Browser worker includes test setup with Vitest:
```bash
cd browser-worker
npm test
```

## File Structure

```
.
├── src/                      # Main worker source code
│   ├── index.mjs            # Main entry point and route handlers
│   ├── spa.js               # Single-page application (HTML/JS)
│   ├── pdf.js               # PDF generation logic
│   ├── mail.js              # Email composition and sending
│   └── resp.js              # Response utilities
├── browser-worker/          # Browser rendering service
│   ├── src/index.js        # Browser worker implementation
│   ├── package.json         # Browser worker dependencies
│   └── test/                # Test files
├── migrations/              # Database schema
│   └── 0001_init.sql        # Initial database setup
├── wrangler.toml           # Cloudflare Workers configuration
├── package.json            # Main project dependencies
└── tmp.json                # Sample property data
```

## Features

### Guest Interface
- **Responsive design**: Works on desktop and mobile devices
- **Digital signature pad**: Touch-enabled signature capture
- **Activity selection**: Click-to-select chip interface
- **Real-time validation**: Form validation before submission
- **Email confirmation**: Immediate feedback with attachment list

### Admin Features
- **Search interface** (`/admin/search`): Query submissions by:
  - Guest name
  - Email address
  - Property ID
  - Check-in date
- **Health check** (`/status`): Monitor database connectivity

### Security Features
- **Input validation**: Server-side validation of all form inputs
- **Secure storage**: PDFs stored in R2 with structured keys
- **Email authentication**: API token-based email sending
- **Activity-specific PINs**: Special codes for high-risk activities

## Deployment

The application is configured for deployment on Cloudflare Workers:

```bash
# Deploy to production
wrangler deploy

# View logs
wrangler tail
```

## Monitoring

- **Logs**: Available via `wrangler tail` or Cloudflare dashboard
- **Metrics**: Worker invocations and performance in Cloudflare dashboard
- **Storage**: Monitor R2 usage and D1 queries in respective dashboards

## Dependencies

### Main Worker
- `nanoid` (v5.1.6) - Unique ID generation

### Browser Worker
- `@cloudflare/puppeteer` - Browser automation for PDF generation
- `wrangler` - Cloudflare Workers CLI
- `vitest` - Testing framework

## License

ISC License (as specified in package.json)

## Support

For issues or questions:
1. Check Cloudflare Workers documentation
2. Review error logs with `wrangler tail`
3. Verify all environment variables and bindings are configured
4. Ensure D1 database is initialized with migration script
</file>

<file path="wrangler.toml">
# Wrangler configuration using JSONC format
# This allows comments and trailing commas for better maintainability

name               = "activities-worker"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat_v2"]
main               = "src/index.js"
workers_dev        = true                # "waiver-worker.<account>.workers.dev"
route = { pattern = "activities.rtxsecured.com/*", zone_name = "rtxsecured.com" }

[build]
command = ""

[[rules]]
type = "Text"
globs = ["**/*.html"]
fallthrough = true

[[rules]]
type = "Text"
globs = ["**/*.txt"]
fallthrough = true

[[rules]]
type = "Text"
globs = ["**/templates/*.js"]
fallthrough = true

# wrangler.toml (wrangler v3.88.0^)
[observability.logs]
enabled = true

[vars]                                 # quick, non-secret config
ARCHERY_PIN   = "1234"
EMAIL_FROM    = "noreply@waivers.rtxsecured.com"
DEV_MODE      = "false"                 # Set to "false" in production

[[r2_buckets]]
binding     = "WAIVERS_R2"
bucket_name = "waivers"                 # production bucket
preview_bucket_name = "dev-waivers"     # development bucket for local testing

[[d1_databases]]
binding        = "waivers"
database_name  = "waivers"
database_id    = "0846e6ed-6eea-4b4f-a8dd-f9b9b232430e"
# preview_database_id = "a26bc6c3-64d9-45ab-80c8-8a10be058c27"           # Disabled - using production only

[[services]]
binding = "BROWSER"
service = "browser-worker"
</file>

</files>
